

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>db folder - object/index &mdash; BItShares Developers Portal  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Protocols" href="lib_protocols.html" />
    <link rel="prev" title="Block" href="lib_block.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> BItShares Developers Portal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/architectures.html">Introduction &amp; Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/environments.html">Development Environments</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="components.html">System Components Elements</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="lib_database.html">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_block.html">Block</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">db folder - object/index</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#index-cpp">index.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#save-undo">save_undo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-add">on_add</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-remove">on_remove</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-modify">on_modify</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#object-database-cpp">object_database.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#find-object">find_object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-object">get_object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-index">get_index</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-mutable-index">get_mutable_index</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flush">flush</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wipe">wipe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#open">open</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pop-undo">pop_undo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">save_undo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#save-undo-add">save_undo_add</a></li>
<li class="toctree-l4"><a class="reference internal" href="#save-undo-remove">save_undo_remove</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#undo-database-cpp">undo_database.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#on-create">on_create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">on_modify</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">on_remove</a></li>
<li class="toctree-l4"><a class="reference internal" href="#undo">undo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#merge">merge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#commit">commit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pop-commit">pop_commit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#head">head</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#generic-index-hpp">generic_index.hpp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#index-hpp">index.hpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#index-observer">index_observer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#index">index</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secondary-index">secondary_index</a></li>
<li class="toctree-l4"><a class="reference internal" href="#base-primary-index">base_primary_index</a></li>
<li class="toctree-l4"><a class="reference internal" href="#primary-index">primary_index</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#object-hpp">object.hpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#object">object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#abstract-object">abstract_object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#annotated-object">annotated_object</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#object-database-hpp">object_database.hpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#object-database">object_database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#object-id-hpp">object_id.hpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#object-id-type">object_id_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="#object-id">object_id</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#simple-index-hpp">simple_index.hpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-index">simple_index</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#undu-database-hpp">undu_database.hpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#undo-state">undo_state</a></li>
<li class="toctree-l4"><a class="reference internal" href="#undo-database">undo_database</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lib_protocols.html">Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_evalustors.html">Evaluators</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_objects.html">Objects and Elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_chain_db.html">Chain - db_xxx.cpp</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_net.html">Net</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_app.html">libraries - app</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_wallet.html">libraries - wallet</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bts_guide/accounts/bts_account.html">BitShares Accounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/integration.html">Integration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/interaction.html">Blockchain Interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testnets.html">Testnets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/bsip.html">BitShares Improvement Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supports_dev/supports.html">Support and Optimizations</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/api_about.html">1. API Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/restrictions.html">2. API Access and Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/calls.html">3. Available Calls, Object, and IDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/blockchain_api.html">4. Blockchain API(s)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/wallet_api.html">5. Wallet API - Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/objects_ids.html">6. Objects and IDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces.html">7. Graphene - Namespaces</a></li>
</ul>
<p class="caption"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bts_guide/tutorials/index.html">Developer Guide (Tutorials)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bts_guide/index_faq.html">Frequently Asked Questions (FAQ)</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references/info_comunities.html">BitShares Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/info_comunities.html#bitshares-blockchain">BitShares Blockchain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/info_bbf_events.html">BitShares Blockchain Foundation Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/tech_articles.html">BitShares Developers’ Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/tech_articles.html#articles">Articles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/githubrepo.html">BitShares Repositories</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BItShares Developers Portal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="components.html">System Components Elements</a> &raquo;</li>
        
      <li>db folder - object/index</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="db-folder-object-index">
<span id="lib-db"></span><h1>db folder - object/index<a class="headerlink" href="#db-folder-object-index" title="Permalink to this headline">¶</a></h1>
<p>This section shows each (db object/index information) process file in the db folder.</p>
<p>File directory: (../ibraries/db/include/graphene/db/xxxxx.hhp)</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#index-cpp" id="id4">index.cpp</a><ul>
<li><a class="reference internal" href="#save-undo" id="id5">save_undo</a></li>
<li><a class="reference internal" href="#on-add" id="id6">on_add</a></li>
<li><a class="reference internal" href="#on-remove" id="id7">on_remove</a></li>
<li><a class="reference internal" href="#on-modify" id="id8">on_modify</a></li>
</ul>
</li>
<li><a class="reference internal" href="#object-database-cpp" id="id9">object_database.cpp</a><ul>
<li><a class="reference internal" href="#find-object" id="id10">find_object</a></li>
<li><a class="reference internal" href="#get-object" id="id11">get_object</a></li>
<li><a class="reference internal" href="#get-index" id="id12">get_index</a></li>
<li><a class="reference internal" href="#get-mutable-index" id="id13">get_mutable_index</a></li>
<li><a class="reference internal" href="#flush" id="id14">flush</a></li>
<li><a class="reference internal" href="#wipe" id="id15">wipe</a></li>
<li><a class="reference internal" href="#open" id="id16">open</a></li>
<li><a class="reference internal" href="#pop-undo" id="id17">pop_undo</a></li>
<li><a class="reference internal" href="#id1" id="id18">save_undo</a></li>
<li><a class="reference internal" href="#save-undo-add" id="id19">save_undo_add</a></li>
<li><a class="reference internal" href="#save-undo-remove" id="id20">save_undo_remove</a></li>
</ul>
</li>
<li><a class="reference internal" href="#undo-database-cpp" id="id21">undo_database.cpp</a><ul>
<li><a class="reference internal" href="#on-create" id="id22">on_create</a></li>
<li><a class="reference internal" href="#id2" id="id23">on_modify</a></li>
<li><a class="reference internal" href="#id3" id="id24">on_remove</a></li>
<li><a class="reference internal" href="#undo" id="id25">undo</a></li>
<li><a class="reference internal" href="#merge" id="id26">merge</a></li>
<li><a class="reference internal" href="#commit" id="id27">commit</a></li>
<li><a class="reference internal" href="#pop-commit" id="id28">pop_commit</a></li>
<li><a class="reference internal" href="#head" id="id29">head</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generic-index-hpp" id="id30">generic_index.hpp</a></li>
<li><a class="reference internal" href="#index-hpp" id="id31">index.hpp</a><ul>
<li><a class="reference internal" href="#index-observer" id="id32">index_observer</a></li>
<li><a class="reference internal" href="#index" id="id33">index</a></li>
<li><a class="reference internal" href="#secondary-index" id="id34">secondary_index</a></li>
<li><a class="reference internal" href="#base-primary-index" id="id35">base_primary_index</a></li>
<li><a class="reference internal" href="#primary-index" id="id36">primary_index</a></li>
</ul>
</li>
<li><a class="reference internal" href="#object-hpp" id="id37">object.hpp</a><ul>
<li><a class="reference internal" href="#object" id="id38">object</a></li>
<li><a class="reference internal" href="#abstract-object" id="id39">abstract_object</a></li>
<li><a class="reference internal" href="#annotated-object" id="id40">annotated_object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#object-database-hpp" id="id41">object_database.hpp</a><ul>
<li><a class="reference internal" href="#object-database" id="id42">object_database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#object-id-hpp" id="id43">object_id.hpp</a><ul>
<li><a class="reference internal" href="#object-id-type" id="id44">object_id_type</a></li>
<li><a class="reference internal" href="#object-id" id="id45">object_id</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simple-index-hpp" id="id46">simple_index.hpp</a><ul>
<li><a class="reference internal" href="#simple-index" id="id47">simple_index</a></li>
</ul>
</li>
<li><a class="reference internal" href="#undu-database-hpp" id="id48">undu_database.hpp</a><ul>
<li><a class="reference internal" href="#undo-state" id="id49">undo_state</a></li>
<li><a class="reference internal" href="#undo-database" id="id50">undo_database</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<hr class="docutils" />
<div class="section" id="index-cpp">
<h2><a class="toc-backref" href="#id4">index.cpp</a><a class="headerlink" href="#index-cpp" title="Permalink to this headline">¶</a></h2>
<p><strong>base_primary_index</strong></p>
<div class="section" id="save-undo">
<h3><a class="toc-backref" href="#id5">save_undo</a><a class="headerlink" href="#save-undo" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">base_primary_index</span><span class="o">::</span><span class="n">save_undo</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span> <span class="n">_db</span><span class="p">.</span><span class="n">save_undo</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="on-add">
<h3><a class="toc-backref" href="#id6">on_add</a><a class="headerlink" href="#on-add" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">base_primary_index</span><span class="o">::</span><span class="n">on_add</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">_db</span><span class="p">.</span><span class="n">save_undo_add</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="nl">ob</span> <span class="p">:</span> <span class="n">_observers</span> <span class="p">)</span> <span class="n">ob</span><span class="o">-&gt;</span><span class="n">on_add</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="on-remove">
<h3><a class="toc-backref" href="#id7">on_remove</a><a class="headerlink" href="#on-remove" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">base_primary_index</span><span class="o">::</span><span class="n">on_remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span> <span class="n">_db</span><span class="p">.</span><span class="n">save_undo_remove</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span> <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="nl">ob</span> <span class="p">:</span> <span class="n">_observers</span> <span class="p">)</span> <span class="n">ob</span><span class="o">-&gt;</span><span class="n">on_remove</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="on-modify">
<h3><a class="toc-backref" href="#id8">on_modify</a><a class="headerlink" href="#on-modify" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">base_primary_index</span><span class="o">::</span><span class="n">on_modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span><span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="nl">ob</span> <span class="p">:</span> <span class="n">_observers</span> <span class="p">)</span> <span class="n">ob</span><span class="o">-&gt;</span><span class="n">on_modify</span><span class="p">(</span>  <span class="n">obj</span> <span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="object-database-cpp">
<h2><a class="toc-backref" href="#id9">object_database.cpp</a><a class="headerlink" href="#object-database-cpp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">object_database</span><span class="o">::</span><span class="n">object_database</span><span class="p">()</span>
<span class="o">:</span><span class="n">_undo_db</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">_index</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">object_database</span><span class="o">::~</span><span class="n">object_database</span><span class="p">(){}</span>

<span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">close</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>object_database</strong></p>
<div class="section" id="find-object">
<h3><a class="toc-backref" href="#id10">find_object</a><a class="headerlink" href="#find-object" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">object</span><span class="o">*</span> <span class="n">object_database</span><span class="o">::</span><span class="n">find_object</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_index</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">()).</span><span class="n">find</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-object">
<h3><a class="toc-backref" href="#id11">get_object</a><a class="headerlink" href="#get-object" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">object_database</span><span class="o">::</span><span class="n">get_object</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_index</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">()).</span><span class="n">get</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-index">
<h3><a class="toc-backref" href="#id12">get_index</a><a class="headerlink" href="#get-index" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">index</span><span class="o">&amp;</span> <span class="n">object_database</span><span class="o">::</span><span class="n">get_index</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">space_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">type_id</span><span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_index</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">space_id</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;space_id&quot;</span><span class="p">,</span><span class="n">space_id</span><span class="p">)(</span><span class="s">&quot;type_id&quot;</span><span class="p">,</span><span class="n">type_id</span><span class="p">)(</span><span class="s">&quot;index.size&quot;</span><span class="p">,</span><span class="n">_index</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_index</span><span class="p">[</span><span class="n">space_id</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">type_id</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;space_id&quot;</span><span class="p">,</span><span class="n">space_id</span><span class="p">)(</span><span class="s">&quot;type_id&quot;</span><span class="p">,</span><span class="n">type_id</span><span class="p">)(</span><span class="s">&quot;index[space_id].size&quot;</span><span class="p">,</span><span class="n">_index</span><span class="p">[</span><span class="n">space_id</span><span class="p">].</span><span class="n">size</span><span class="p">())</span> <span class="p">);</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">_index</span><span class="p">[</span><span class="n">space_id</span><span class="p">][</span><span class="n">type_id</span><span class="p">];</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">tmp</span> <span class="p">);</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-mutable-index">
<h3><a class="toc-backref" href="#id13">get_mutable_index</a><a class="headerlink" href="#get-mutable-index" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">index</span><span class="o">&amp;</span> <span class="n">object_database</span><span class="o">::</span><span class="n">get_mutable_index</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">space_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">type_id</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_index</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">space_id</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;space_id&quot;</span><span class="p">,</span><span class="n">space_id</span><span class="p">)(</span><span class="s">&quot;type_id&quot;</span><span class="p">,</span><span class="n">type_id</span><span class="p">)(</span><span class="s">&quot;index.size&quot;</span><span class="p">,</span><span class="n">_index</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_index</span><span class="p">[</span><span class="n">space_id</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">type_id</span> <span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;space_id&quot;</span><span class="p">,</span><span class="n">space_id</span><span class="p">)(</span><span class="s">&quot;type_id&quot;</span><span class="p">,</span><span class="n">type_id</span><span class="p">)(</span><span class="s">&quot;index[space_id].size&quot;</span><span class="p">,</span><span class="n">_index</span><span class="p">[</span><span class="n">space_id</span><span class="p">].</span><span class="n">size</span><span class="p">())</span> <span class="p">);</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">_index</span><span class="p">[</span><span class="n">space_id</span><span class="p">][</span><span class="n">type_id</span><span class="p">];</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">idx</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;space&quot;</span><span class="p">,</span><span class="n">space_id</span><span class="p">)(</span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="n">type_id</span><span class="p">)</span> <span class="p">);</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="flush">
<h3><a class="toc-backref" href="#id14">flush</a><a class="headerlink" href="#flush" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">flush</span><span class="p">()</span>
<span class="p">{</span>
<span class="c1">//   ilog(&quot;Save object_database in ${d}&quot;, (&quot;d&quot;, _data_dir));</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">create_directories</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.tmp&quot;</span> <span class="o">/</span> <span class="s">&quot;lock&quot;</span> <span class="p">);</span>
   <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">space</span> <span class="o">&lt;</span> <span class="n">_index</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">space</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">create_directories</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.tmp&quot;</span> <span class="o">/</span> <span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="p">);</span>
          <span class="k">const</span> <span class="k">auto</span> <span class="n">types</span> <span class="o">=</span> <span class="n">_index</span><span class="p">[</span><span class="n">space</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
          <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">type</span>  <span class="o">&lt;</span>  <span class="n">types</span><span class="p">;</span> <span class="o">++</span><span class="n">type</span> <span class="p">)</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">_index</span><span class="p">[</span><span class="n">space</span><span class="p">][</span><span class="n">type</span><span class="p">]</span> <span class="p">)</span>
                        <span class="n">_index</span><span class="p">[</span><span class="n">space</span><span class="p">][</span><span class="n">type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.tmp&quot;</span> <span class="o">/</span> <span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">space</span><span class="p">)</span><span class="o">/</span><span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">remove_all</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.tmp&quot;</span> <span class="o">/</span> <span class="s">&quot;lock&quot;</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database&quot;</span> <span class="p">)</span> <span class="p">)</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">rename</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database&quot;</span><span class="p">,</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.old&quot;</span> <span class="p">);</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">rename</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.tmp&quot;</span><span class="p">,</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database&quot;</span> <span class="p">);</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">remove_all</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database.old&quot;</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="wipe">
<h3><a class="toc-backref" href="#id15">wipe</a><a class="headerlink" href="#wipe" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">wipe</span><span class="p">(</span><span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">close</span><span class="p">();</span>
   <span class="n">ilog</span><span class="p">(</span><span class="s">&quot;Wiping object database...&quot;</span><span class="p">);</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">remove_all</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database&quot;</span><span class="p">);</span>
   <span class="n">ilog</span><span class="p">(</span><span class="s">&quot;Done wiping object databse.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="open">
<h3><a class="toc-backref" href="#id16">open</a><a class="headerlink" href="#open" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">_data_dir</span> <span class="o">=</span> <span class="n">data_dir</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database&quot;</span> <span class="o">/</span> <span class="s">&quot;lock&quot;</span> <span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
           <span class="n">wlog</span><span class="p">(</span><span class="s">&quot;Ignoring locked object_database&quot;</span><span class="p">);</span>
           <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">ilog</span><span class="p">(</span><span class="s">&quot;Opening object database from ${d} ...&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">));</span>
   <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">space</span> <span class="o">&lt;</span> <span class="n">_index</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">space</span> <span class="p">)</span>
          <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">type</span>  <span class="o">&lt;</span> <span class="n">_index</span><span class="p">[</span><span class="n">space</span><span class="p">].</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">type</span> <span class="p">)</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">_index</span><span class="p">[</span><span class="n">space</span><span class="p">][</span><span class="n">type</span><span class="p">]</span> <span class="p">)</span>
                        <span class="n">_index</span><span class="p">[</span><span class="n">space</span><span class="p">][</span><span class="n">type</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span> <span class="n">_data_dir</span> <span class="o">/</span> <span class="s">&quot;object_database&quot;</span> <span class="o">/</span> <span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">space</span><span class="p">)</span><span class="o">/</span><span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">);</span>
   <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Done opening object database.&quot;</span> <span class="p">);</span>

<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pop-undo">
<h3><a class="toc-backref" href="#id17">pop_undo</a><a class="headerlink" href="#pop-undo" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">pop_undo</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">pop_commit</span><span class="p">();</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id18">save_undo</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">save_undo</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">on_modify</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="save-undo-add">
<h3><a class="toc-backref" href="#id19">save_undo_add</a><a class="headerlink" href="#save-undo-add" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">save_undo_add</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">on_create</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="save-undo-remove">
<h3><a class="toc-backref" href="#id20">save_undo_remove</a><a class="headerlink" href="#save-undo-remove" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">object_database</span><span class="o">::</span><span class="n">save_undo_remove</span><span class="p">(</span><span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">on_remove</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="undo-database-cpp">
<h2><a class="toc-backref" href="#id21">undo_database.cpp</a><a class="headerlink" href="#undo-database-cpp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">enable</span><span class="p">()</span>  <span class="p">{</span> <span class="n">_disabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">disable</span><span class="p">()</span> <span class="p">{</span> <span class="n">_disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>

<span class="n">undo_database</span><span class="o">::</span><span class="n">session</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">start_undo_session</span><span class="p">(</span> <span class="kt">bool</span> <span class="n">force_enable</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_disabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force_enable</span> <span class="p">)</span> <span class="k">return</span> <span class="n">session</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="kt">bool</span> <span class="n">disable_on_exit</span> <span class="o">=</span> <span class="n">_disabled</span>  <span class="o">&amp;&amp;</span> <span class="n">force_enable</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">force_enable</span> <span class="p">)</span>
          <span class="n">_disabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

   <span class="k">while</span><span class="p">(</span> <span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">_stack</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>

   <span class="n">_stack</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">();</span>
   <span class="o">++</span><span class="n">_active_sessions</span><span class="p">;</span>
   <span class="k">return</span> <span class="nf">session</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">disable_on_exit</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>undo_database</strong></p>
<div class="section" id="on-create">
<h3><a class="toc-backref" href="#id22">on_create</a><a class="headerlink" href="#on-create" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">on_create</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_disabled</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">_stack</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">_stack</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">();</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">index_id</span> <span class="o">=</span> <span class="n">object_id_type</span><span class="p">(</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">(),</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">old_index_next_ids</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">index_id</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">itr</span> <span class="o">==</span> <span class="n">state</span><span class="p">.</span><span class="n">old_index_next_ids</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">state</span><span class="p">.</span><span class="n">old_index_next_ids</span><span class="p">[</span><span class="n">index_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
   <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id23">on_modify</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">on_modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_disabled</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">_stack</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">_stack</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">();</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span>  <span class="n">state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
   <span class="n">state</span><span class="p">.</span><span class="n">old_values</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id24">on_remove</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">on_remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_disabled</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">_stack</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">_stack</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">();</span>
   <span class="n">undo_state</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">state</span><span class="p">.</span><span class="n">removed</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">old_values</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">]);</span>
          <span class="n">state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">state</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
   <span class="n">state</span><span class="p">.</span><span class="n">removed</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="undo">
<h3><a class="toc-backref" href="#id25">undo</a><a class="headerlink" href="#undo" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">undo</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">_disabled</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_active_sessions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">disable</span><span class="p">();</span>

   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">old_values</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">_db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){</span> <span class="n">obj</span><span class="p">.</span><span class="n">move_from</span><span class="p">(</span> <span class="o">*</span><span class="n">item</span><span class="p">.</span><span class="n">second</span> <span class="p">);</span> <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">ritr</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">ritr</span> <span class="o">!=</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">ritr</span>  <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">_db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">old_index_next_ids</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_db</span><span class="p">.</span><span class="n">get_mutable_index</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="p">).</span><span class="n">set_next_id</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">removed</span> <span class="p">)</span>
          <span class="n">_db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">);</span>

   <span class="n">_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
   <span class="n">enable</span><span class="p">();</span>
   <span class="o">--</span><span class="n">_active_sessions</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="merge">
<h3><a class="toc-backref" href="#id26">merge</a><a class="headerlink" href="#merge" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">merge</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_active_sessions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_active_sessions</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">_stack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
          <span class="o">--</span><span class="n">_active_sessions</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_stack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span><span class="mi">2</span> <span class="p">);</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">prev_state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">[</span><span class="n">_stack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>

   <span class="c1">// An object&#39;s relationship to a state can be:</span>
   <span class="c1">// in new_ids            : new</span>
   <span class="c1">// in old_values (was=X) : upd(was=X)</span>
   <span class="c1">// in removed (was=X)    : del(was=X)</span>
   <span class="c1">// not in any of above   : nop</span>
   <span class="c1">//</span>
   <span class="c1">// When merging A=prev_state and B=state we have a 4x4 matrix of all possibilities:</span>
   <span class="c1">//</span>
   <span class="c1">//                   |--------------------- B ----------------------|</span>
   <span class="c1">//</span>
   <span class="c1">//                +------------+------------+------------+------------+</span>
   <span class="c1">//                | new        | upd(was=Y) | del(was=Y) | nop        |</span>
   <span class="c1">//   +------------+------------+------------+------------+------------+</span>
   <span class="c1">// / | new        | N/A        | new       A| nop       C| new       A|</span>
   <span class="c1">// | +------------+------------+------------+------------+------------+</span>
   <span class="c1">// | | upd(was=X) | N/A        | upd(was=X)A| del(was=X)C| upd(was=X)A|</span>
   <span class="c1">// A +------------+------------+------------+------------+------------+</span>
   <span class="c1">// | | del(was=X) | N/A        | N/A        | N/A        | del(was=X)A|</span>
   <span class="c1">// | +------------+------------+------------+------------+------------+</span>
   <span class="c1">// \ | nop        | new       B| upd(was=Y)B| del(was=Y)B| nop      AB|</span>
   <span class="c1">//   +------------+------------+------------+------------+------------+</span>
   <span class="c1">//</span>
   <span class="c1">// Each entry was composed by labelling what should occur in the given case.</span>
   <span class="c1">//</span>
   <span class="c1">// Type A means the composition of states contains the same entry as the first of the two merged states for that object.</span>
   <span class="c1">// Type B means the composition of states contains the same entry as the second of the two merged states for that object.</span>
   <span class="c1">// Type C means the composition of states contains an entry different from either of the merged states for that object.</span>
   <span class="c1">// Type N/A means the composition of states violates causal timing.</span>
   <span class="c1">// Type AB means both type A and type B simultaneously.</span>
   <span class="c1">//</span>
   <span class="c1">// The merge() operation is defined as modifying prev_state in-place to be the state object which represents the composition of</span>
   <span class="c1">// state A and B.</span>
   <span class="c1">//</span>
   <span class="c1">// Type A (and AB) can be implemented as a no-op; prev_state already contains the correct value for the merged state.</span>
   <span class="c1">// Type B (and AB) can be implemented by copying from state to prev_state.</span>
   <span class="c1">// Type C needs special case-by-case logic.</span>
   <span class="c1">// Type N/A can be ignored or assert(false) as it can only occur if prev_state and state have illegal values</span>
   <span class="c1">// (a serious logic error which should never happen).</span>
   <span class="c1">//</span>

   <span class="c1">// We can only be outside type A/AB (the nop path) if B is not nop, so it suffices to iterate through B&#39;s three containers.</span>

   <span class="c1">// *+upd</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">obj</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">old_values</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// new+upd -&gt; new, type A</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// upd(was=X) + upd(was=Y) -&gt; upd(was=X), type A</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="c1">// del+upd -&gt; N/A</span>
          <span class="n">assert</span><span class="p">(</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>
          <span class="c1">// nop+upd(was=Y) -&gt; upd(was=Y), type B</span>
          <span class="n">prev_state</span><span class="p">.</span><span class="n">old_values</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// *+new, but we assume the N/A cases don&#39;t happen, leaving type B nop+new -&gt; new</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="nl">id</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span> <span class="p">)</span>
          <span class="n">prev_state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

   <span class="c1">// old_index_next_ids can only be updated, iterate over *+upd cases</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">old_index_next_ids</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">old_index_next_ids</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span> <span class="p">)</span> <span class="o">==</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">old_index_next_ids</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// nop+upd(was=Y) -&gt; upd(was=Y), type B</span>
                 <span class="n">prev_state</span><span class="p">.</span><span class="n">old_index_next_ids</span><span class="p">[</span><span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="c1">// upd(was=X)+upd(was=Y) -&gt; upd(was=X), type A</span>
                 <span class="c1">// type A implementation is a no-op, as discussed above, so there is no code here</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// *+del</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">obj</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">removed</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// new + del -&gt; nop (type C)</span>
                 <span class="n">prev_state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// upd(was=X) + del(was=Y) -&gt; del(was=X)</span>
                 <span class="n">prev_state</span><span class="p">.</span><span class="n">removed</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
                 <span class="n">prev_state</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="c1">// del + del -&gt; N/A</span>
          <span class="n">assert</span><span class="p">(</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">)</span> <span class="o">==</span> <span class="n">prev_state</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>
          <span class="c1">// nop + del(was=Y) -&gt; del(was=Y)</span>
          <span class="n">prev_state</span><span class="p">.</span><span class="n">removed</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
   <span class="o">--</span><span class="n">_active_sessions</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="commit">
<h3><a class="toc-backref" href="#id27">commit</a><a class="headerlink" href="#commit" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">commit</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_active_sessions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="o">--</span><span class="n">_active_sessions</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pop-commit">
<h3><a class="toc-backref" href="#id28">pop_commit</a><a class="headerlink" href="#pop-commit" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">pop_commit</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">_active_sessions</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">_stack</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">);</span>

   <span class="n">disable</span><span class="p">();</span>
   <span class="k">try</span> <span class="p">{</span>
          <span class="k">auto</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>

          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">old_values</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">_db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){</span> <span class="n">obj</span><span class="p">.</span><span class="n">move_from</span><span class="p">(</span> <span class="o">*</span><span class="n">item</span><span class="p">.</span><span class="n">second</span> <span class="p">);</span> <span class="p">}</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">ritr</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">ritr</span> <span class="o">!=</span> <span class="n">state</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">ritr</span>  <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">_db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">old_index_next_ids</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_db</span><span class="p">.</span><span class="n">get_mutable_index</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="p">).</span><span class="n">set_next_id</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">removed</span> <span class="p">)</span>
                 <span class="n">_db</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">);</span>

          <span class="n">_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;error popping commit ${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">()</span> <span class="p">)</span>  <span class="p">);</span>
          <span class="n">enable</span><span class="p">();</span>
          <span class="k">throw</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">enable</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="head">
<h3><a class="toc-backref" href="#id29">head</a><a class="headerlink" href="#head" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">undo_state</span><span class="o">&amp;</span> <span class="n">undo_database</span><span class="o">::</span><span class="n">head</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">_stack</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">);</span>
   <span class="k">return</span> <span class="n">_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
</div>
</div>
<hr class="docutils" />
<div class="section" id="generic-index-hpp">
<h2><a class="toc-backref" href="#id30">generic_index.hpp</a><a class="headerlink" href="#generic-index-hpp" title="Permalink to this headline">¶</a></h2>
</div>
<hr class="docutils" />
<div class="section" id="index-hpp">
<h2><a class="toc-backref" href="#id31">index.hpp</a><a class="headerlink" href="#index-hpp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">object_database</span><span class="p">;</span>
<span class="k">using</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="index-observer">
<h3><a class="toc-backref" href="#id32">index_observer</a><a class="headerlink" href="#index-observer" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>used to get callbacks when objects change</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">index_observer</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="k">virtual</span> <span class="o">~</span><span class="n">index_observer</span><span class="p">(){}</span>
      <span class="cm">/** called just after the object is added */</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">on_add</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){}</span>
      <span class="cm">/** called just before obj is removed */</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">on_remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){}</span>
      <span class="cm">/** called just after obj is modified with new value*/</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">on_modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){}</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="index">
<h3><a class="toc-backref" href="#id33">index</a><a class="headerlink" href="#index" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>abstract base class for accessing objects indexed in various ways.</li>
<li>All indexes assume that there exists an object ID space that will grow forever in a seqential manner.  These IDs are used to identify the index, type, and instance of the object.</li>
<li>Items in an index can only be modified via a call to modify and all references to objects outside of that callback are const references.</li>
<li>Most implementations will probably be some form of boost::multi_index_container which means that they can covnert a reference to an object to an iterator.  When at all possible save a pointer/reference to your objects rather than constantly looking them up by ID.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">index</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="k">virtual</span> <span class="o">~</span><span class="n">index</span><span class="p">(){}</span>

      <span class="k">virtual</span> <span class="kt">uint8_t</span> <span class="n">object_space_id</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">uint8_t</span> <span class="nf">object_type_id</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">virtual</span> <span class="n">object_id_type</span> <span class="nf">get_next_id</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span>           <span class="nf">use_next_id</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span>           <span class="nf">set_next_id</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span>  <span class="n">load</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&amp;</span> <span class="n">data</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="cm">/**</span>
<span class="cm">       *  Polymorphically insert by moving an object into the index.</span>
<span class="cm">       *  this should throw if the object is already in the database.</span>
<span class="cm">       */</span>
      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="cm">/**</span>
<span class="cm">       * Builds a new object and assigns it the next available ID and then</span>
<span class="cm">       * initializes it with constructor and lastly inserts it into the index.</span>
<span class="cm">       */</span>
      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span>  <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;</span> <span class="n">constructor</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="cm">/**</span>
<span class="cm">       *  Opens the index loading objects from a file</span>
<span class="cm">       */</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">open</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">save</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



      <span class="cm">/** @return the object with id or nullptr if not found */</span>
      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">*</span>      <span class="nf">find</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="cm">/**</span>
<span class="cm">       * This version will automatically check for nullptr and throw an exception if the</span>
<span class="cm">       * object ID could not be found.</span>
<span class="cm">       */</span>
      <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span>              <span class="n">get</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="k">auto</span> <span class="n">maybe_found</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
         <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">maybe_found</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">,</span> <span class="s">&quot;Unable to find Object ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="o">*</span><span class="n">maybe_found</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span>               <span class="n">modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span>               <span class="nf">remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="cm">/**</span>
<span class="cm">       *   When forming your lambda to modify obj, it is natural to have Object&amp; be the signature, but</span>
<span class="cm">       *   that is not compatible with the type erasue required by the virtual method.  This method</span>
<span class="cm">       *   provides a helper to wrap the lambda in a form compatible with the virtual modify call.</span>
<span class="cm">       *   @note Lambda should have the signature:  void(Object&amp;)</span>
<span class="cm">       */</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Object</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Lambda</span><span class="o">&gt;</span>
      <span class="kt">void</span> <span class="n">modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">Object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="n">Lambda</span><span class="o">&amp;</span> <span class="n">l</span> <span class="p">)</span> <span class="p">{</span>
         <span class="n">modify</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">object</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">o</span> <span class="p">){</span> <span class="n">l</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="p">);</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span>               <span class="n">inspect_all_objects</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">inspector</span><span class="p">)</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span>        <span class="n">hash</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span>               <span class="nf">add_observer</span><span class="p">(</span> <span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">index_observer</span><span class="o">&gt;&amp;</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">virtual</span> <span class="kt">void</span>               <span class="nf">object_from_variant</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">variant</span><span class="o">&amp;</span> <span class="n">var</span><span class="p">,</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">max_depth</span> <span class="p">)</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span>               <span class="nf">object_default</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="secondary-index">
<h3><a class="toc-backref" href="#id34">secondary_index</a><a class="headerlink" href="#secondary-index" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">secondary_index</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="k">virtual</span> <span class="o">~</span><span class="n">secondary_index</span><span class="p">(){};</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">object_inserted</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){};</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">object_removed</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){};</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">about_to_modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">before</span> <span class="p">){};</span>
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">object_modified</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">after</span>  <span class="p">){};</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="base-primary-index">
<h3><a class="toc-backref" href="#id35">base_primary_index</a><a class="headerlink" href="#base-primary-index" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Defines the common implementation</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">base_primary_index</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="n">base_primary_index</span><span class="p">(</span> <span class="n">object_database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span><span class="o">:</span><span class="n">_db</span><span class="p">(</span><span class="n">db</span><span class="p">){}</span>

      <span class="cm">/** called just before obj is modified */</span>
      <span class="kt">void</span> <span class="n">save_undo</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>

      <span class="cm">/** called just after the object is added */</span>
      <span class="kt">void</span> <span class="nf">on_add</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>

      <span class="cm">/** called just before obj is removed */</span>
      <span class="kt">void</span> <span class="nf">on_remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>

      <span class="cm">/** called just after obj is modified */</span>
      <span class="kt">void</span> <span class="nf">on_modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
      <span class="n">T</span><span class="o">*</span> <span class="n">add_secondary_index</span><span class="p">(</span><span class="n">Args</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="n">_sindex</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="k">new</span> <span class="n">T</span><span class="p">(</span><span class="n">args</span><span class="p">...)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_sindex</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">get</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">get_secondary_index</span><span class="p">()</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
         <span class="p">{</span>
            <span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">result</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">)</span> <span class="k">return</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="n">FC_THROW_EXCEPTION</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">assert_exception</span><span class="p">,</span> <span class="s">&quot;invalid index type&quot;</span> <span class="p">);</span>
      <span class="p">}</span>

   <span class="k">protected</span><span class="o">:</span>
      <span class="n">vector</span><span class="o">&lt;</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">index_observer</span><span class="o">&gt;</span> <span class="o">&gt;</span>   <span class="n">_observers</span><span class="p">;</span>
      <span class="n">vector</span><span class="o">&lt;</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">secondary_index</span><span class="o">&gt;</span> <span class="o">&gt;</span>  <span class="n">_sindex</span><span class="p">;</span>

   <span class="k">private</span><span class="o">:</span>
      <span class="n">object_database</span><span class="o">&amp;</span> <span class="n">_db</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="primary-index">
<h3><a class="toc-backref" href="#id36">primary_index</a><a class="headerlink" href="#primary-index" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Wraps a derived index to intercept calls to create, modify, and remove so that callbacks may be fired and undo state saved.</li>
<li>&#64;see <a class="reference external" href="http://en.wikipedia.org/wiki/Curiously_recurring_template_pattern">http://en.wikipedia.org/wiki/Curiously_recurring_template_pattern</a></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">DerivedIndex</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">primary_index</span>  <span class="o">:</span> <span class="k">public</span> <span class="n">DerivedIndex</span><span class="p">,</span> <span class="k">public</span> <span class="n">base_primary_index</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="k">typedef</span> <span class="k">typename</span> <span class="n">DerivedIndex</span><span class="o">::</span><span class="n">object_type</span> <span class="n">object_type</span><span class="p">;</span>

      <span class="n">primary_index</span><span class="p">(</span> <span class="n">object_database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
      <span class="o">:</span><span class="n">base_primary_index</span><span class="p">(</span><span class="n">db</span><span class="p">),</span><span class="n">_next_id</span><span class="p">(</span><span class="n">object_type</span><span class="o">::</span><span class="n">space_id</span><span class="p">,</span><span class="n">object_type</span><span class="o">::</span><span class="n">type_id</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

      <span class="k">virtual</span> <span class="kt">uint8_t</span> <span class="n">object_space_id</span><span class="p">()</span><span class="k">const</span> <span class="k">override</span>
      <span class="p">{</span> <span class="k">return</span> <span class="n">object_type</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">uint8_t</span> <span class="n">object_type_id</span><span class="p">()</span><span class="k">const</span> <span class="k">override</span>
      <span class="p">{</span> <span class="k">return</span> <span class="n">object_type</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">virtual</span> <span class="n">object_id_type</span> <span class="n">get_next_id</span><span class="p">()</span><span class="k">const</span> <span class="k">override</span>              <span class="p">{</span> <span class="k">return</span> <span class="n">_next_id</span><span class="p">;</span>    <span class="p">}</span>
      <span class="k">virtual</span> <span class="kt">void</span>           <span class="n">use_next_id</span><span class="p">()</span><span class="k">override</span>                    <span class="p">{</span> <span class="o">++</span><span class="n">_next_id</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>  <span class="p">}</span>
      <span class="k">virtual</span> <span class="kt">void</span>           <span class="n">set_next_id</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">override</span> <span class="p">{</span> <span class="n">_next_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>      <span class="p">}</span>

      <span class="n">fc</span><span class="o">::</span><span class="n">sha256</span> <span class="n">get_object_version</span><span class="p">()</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">;</span><span class="c1">//get_type_description&lt;object_type&gt;();</span>
         <span class="k">return</span> <span class="n">fc</span><span class="o">::</span><span class="n">sha256</span><span class="o">::</span><span class="n">hash</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">open</span><span class="p">(</span> <span class="k">const</span> <span class="n">path</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span><span class="k">override</span>
      <span class="p">{</span>
         <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">fc</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span> <span class="n">db</span> <span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">file_mapping</span> <span class="n">fm</span><span class="p">(</span> <span class="n">db</span><span class="p">.</span><span class="n">generic_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">fc</span><span class="o">::</span><span class="n">read_only</span> <span class="p">);</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">mapped_region</span> <span class="n">mr</span><span class="p">(</span> <span class="n">fm</span><span class="p">,</span> <span class="n">fc</span><span class="o">::</span><span class="n">read_only</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fc</span><span class="o">::</span><span class="n">file_size</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">);</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">datastream</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">ds</span><span class="p">(</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">mr</span><span class="p">.</span><span class="n">get_address</span><span class="p">(),</span> <span class="n">mr</span><span class="p">.</span><span class="n">get_size</span><span class="p">()</span> <span class="p">);</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">sha256</span> <span class="n">open_ver</span><span class="p">;</span>

         <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">_next_id</span><span class="p">);</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">open_ver</span><span class="p">);</span>
         <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">open_ver</span> <span class="o">==</span> <span class="n">get_object_version</span><span class="p">(),</span> <span class="s">&quot;Incompatible Version, the serialization of objects in this index has changed&quot;</span> <span class="p">);</span>
         <span class="k">try</span> <span class="p">{</span>
            <span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
            <span class="p">{</span>
               <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span> <span class="n">ds</span><span class="p">,</span> <span class="n">tmp</span> <span class="p">);</span>
               <span class="n">load</span><span class="p">(</span> <span class="n">tmp</span> <span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span>  <span class="p">){}</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">save</span><span class="p">(</span> <span class="k">const</span> <span class="n">path</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">out</span><span class="p">(</span> <span class="n">db</span><span class="p">.</span><span class="n">generic_string</span><span class="p">(),</span>
                            <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">::</span><span class="n">out</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">::</span><span class="n">trunc</span> <span class="p">);</span>
         <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">out</span> <span class="p">);</span>
         <span class="k">auto</span> <span class="n">ver</span>  <span class="o">=</span> <span class="n">get_object_version</span><span class="p">();</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">_next_id</span> <span class="p">);</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack</span><span class="p">(</span> <span class="n">out</span><span class="p">,</span> <span class="n">ver</span> <span class="p">);</span>
         <span class="k">this</span><span class="o">-&gt;</span><span class="n">inspect_all_objects</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">o</span> <span class="p">)</span> <span class="p">{</span>
             <span class="k">auto</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">object_type</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="p">);</span>
             <span class="k">auto</span> <span class="n">packed_vec</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack</span><span class="p">(</span> <span class="n">vec</span> <span class="p">);</span>
             <span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span> <span class="n">packed_vec</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">packed_vec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
         <span class="p">});</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span>  <span class="n">load</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&amp;</span> <span class="n">data</span> <span class="p">)</span><span class="k">override</span>
      <span class="p">{</span>
         <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">DerivedIndex</span><span class="o">::</span><span class="n">insert</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">unpack</span><span class="o">&lt;</span><span class="n">object_type</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">);</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
            <span class="n">item</span><span class="o">-&gt;</span><span class="n">object_inserted</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
         <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>


      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span>  <span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;</span> <span class="n">constructor</span> <span class="p">)</span><span class="k">override</span>
      <span class="p">{</span>
         <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">DerivedIndex</span><span class="o">::</span><span class="n">create</span><span class="p">(</span> <span class="n">constructor</span> <span class="p">);</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
            <span class="n">item</span><span class="o">-&gt;</span><span class="n">object_inserted</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
         <span class="n">on_add</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
         <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">DerivedIndex</span><span class="o">::</span><span class="n">insert</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span> <span class="n">obj</span> <span class="p">)</span> <span class="p">);</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
            <span class="n">item</span><span class="o">-&gt;</span><span class="n">object_inserted</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
         <span class="n">on_add</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
         <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span>  <span class="n">remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
            <span class="n">item</span><span class="o">-&gt;</span><span class="n">object_removed</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
         <span class="n">on_remove</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
         <span class="n">DerivedIndex</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;</span> <span class="n">m</span> <span class="p">)</span><span class="k">override</span>
      <span class="p">{</span>
         <span class="n">save_undo</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
            <span class="n">item</span><span class="o">-&gt;</span><span class="n">about_to_modify</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
         <span class="n">DerivedIndex</span><span class="o">::</span><span class="n">modify</span><span class="p">(</span> <span class="n">obj</span><span class="p">,</span> <span class="n">m</span> <span class="p">);</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">_sindex</span> <span class="p">)</span>
            <span class="n">item</span><span class="o">-&gt;</span><span class="n">object_modified</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
         <span class="n">on_modify</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">add_observer</span><span class="p">(</span> <span class="k">const</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">index_observer</span><span class="o">&gt;&amp;</span> <span class="n">o</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">_observers</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">o</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">object_from_variant</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">variant</span><span class="o">&amp;</span> <span class="n">var</span><span class="p">,</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">max_depth</span> <span class="p">)</span><span class="k">const</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">object_id_type</span> <span class="n">id</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
         <span class="n">object_type</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">object_type</span><span class="o">*&gt;</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">obj</span> <span class="p">);</span>
         <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">result</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">from_variant</span><span class="p">(</span> <span class="n">var</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">max_depth</span> <span class="p">);</span>
         <span class="n">obj</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">object_default</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span><span class="k">const</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">object_id_type</span> <span class="n">id</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
         <span class="n">object_type</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">object_type</span><span class="o">*&gt;</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">obj</span> <span class="p">);</span>
         <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">result</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
         <span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span> <span class="o">=</span> <span class="n">object_type</span><span class="p">();</span>
         <span class="n">obj</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
      <span class="p">}</span>

   <span class="k">private</span><span class="o">:</span>
      <span class="n">object_id_type</span> <span class="n">_next_id</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="object-hpp">
<h2><a class="toc-backref" href="#id37">object.hpp</a><a class="headerlink" href="#object-hpp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="object">
<h3><a class="toc-backref" href="#id38">object</a><a class="headerlink" href="#object" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>base for all database objects</li>
<li>The object is the fundamental building block of the database and is the level upon which undo/redo operations are performed.  Objects are used to track data and their relationships and provide an efficient means to find and update information.</li>
<li>Objects are assigned a unique and sequential object ID by the database within the id_space defined in the object.</li>
<li>All objects must be serializable via FC_REFLECT() and their content must be faithfully restored.   Additionally all objects must be copy-constructable and assignable in a relatively efficient manner.  In general this means that objects should only refer to other objects by ID and avoid expensive operations when they are copied, especially if they are modified frequently.</li>
<li>Additionally all objects may be annotated by plugins which wish to maintain additional information to an object.  There can be at most one annotation  per id_space for each object.   An example of an annotation would be tracking extra data not required by validation such as the name and description of a user asset.  By carefully organizing how information is organized and tracked systems can minimize the workload to only that which is necessary to perform their function.</li>
<li>&#64;note Do not use multiple inheritance with object because the code assumes a static_cast will work between object and derived types.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">object</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="n">object</span><span class="p">(){}</span>
      <span class="k">virtual</span> <span class="o">~</span><span class="n">object</span><span class="p">(){}</span>

      <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">space_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">type_id</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


      <span class="c1">// serialized</span>
      <span class="n">object_id_type</span>          <span class="n">id</span><span class="p">;</span>

      <span class="c1">/// these methods are implemented for derived classes by inheriting abstract_object&lt;DerivedClass&gt;</span>
      <span class="k">virtual</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="kt">void</span>               <span class="nf">move_from</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="n">variant</span>            <span class="nf">to_variant</span><span class="p">()</span><span class="k">const</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span>       <span class="n">pack</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">virtual</span> <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span>        <span class="n">hash</span><span class="p">()</span><span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="abstract-object">
<h3><a class="toc-backref" href="#id39">abstract_object</a><a class="headerlink" href="#abstract-object" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Use the Curiously Recurring Template Pattern to automatically add the ability to clone, serialize, and move objects polymorphically.</li>
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Curiously_recurring_template_pattern">http://en.wikipedia.org/wiki/Curiously_recurring_template_pattern</a></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">DerivedClass</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">abstract_object</span> <span class="o">:</span> <span class="k">public</span> <span class="n">object</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="k">virtual</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">()</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="k">return</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">DerivedClass</span><span class="p">(</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DerivedClass</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">));</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span>    <span class="n">move_from</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">DerivedClass</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">DerivedClass</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">virtual</span> <span class="n">variant</span> <span class="n">to_variant</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">variant</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DerivedClass</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">),</span> <span class="n">MAX_NESTING</span> <span class="p">);</span> <span class="p">}</span>
      <span class="k">virtual</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">pack</span><span class="p">()</span><span class="k">const</span>  <span class="p">{</span> <span class="k">return</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DerivedClass</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
      <span class="k">virtual</span> <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span>  <span class="n">hash</span><span class="p">()</span><span class="k">const</span>  <span class="p">{</span>
          <span class="k">auto</span> <span class="n">tmp</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">pack</span><span class="p">();</span>
          <span class="k">return</span> <span class="n">fc</span><span class="o">::</span><span class="n">city_hash_crc_128</span><span class="p">(</span> <span class="n">tmp</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">tmp</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
      <span class="p">}</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">flat_map</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span> <span class="n">object_id_type</span><span class="o">&gt;</span> <span class="n">annotation_map</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="annotated-object">
<h3><a class="toc-backref" href="#id40">annotated_object</a><a class="headerlink" href="#annotated-object" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>An object that is easily extended by providing pointers to other objects, one for each space.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">DerivedClass</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">annotated_object</span> <span class="o">:</span> <span class="k">public</span> <span class="n">abstract_object</span><span class="o">&lt;</span><span class="n">DerivedClass</span><span class="o">&gt;</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="cm">/** return object_id_type() if no anotation is found for id_space */</span>
      <span class="n">object_id_type</span>          <span class="n">get_annotation</span><span class="p">(</span> <span class="kt">uint8_t</span> <span class="n">annotation_id_space</span> <span class="p">)</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">annotation_id_space</span><span class="p">);</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">annotations</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
         <span class="k">return</span> <span class="nf">object_id_type</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="kt">void</span>                    <span class="n">set_annotation</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="n">annotations</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">()]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/**</span>
<span class="cm">       *  Annotations should be accessed via get_annotation and set_annotation so</span>
<span class="cm">       *  that they can be maintained in sorted order.</span>
<span class="cm">       */</span>
      <span class="n">annotation_map</span> <span class="n">annotations</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="object-database-hpp">
<h2><a class="toc-backref" href="#id41">object_database.hpp</a><a class="headerlink" href="#object-database-hpp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="object-database">
<h3><a class="toc-backref" href="#id42">object_database</a><a class="headerlink" href="#object-database" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>maintains a set of indexed objects that can be modified with multi-level rollback support</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">object_database</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="n">object_database</span><span class="p">();</span>
      <span class="o">~</span><span class="n">object_database</span><span class="p">();</span>

      <span class="kt">void</span> <span class="nf">reset_indexes</span><span class="p">()</span> <span class="p">{</span> <span class="n">_index</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span> <span class="n">_index</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span> <span class="p">}</span>

      <span class="kt">void</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">data_dir</span> <span class="p">);</span>

      <span class="cm">/**</span>
<span class="cm">       * Saves the complete state of the object_database to disk, this could take a while</span>
<span class="cm">       */</span>
      <span class="kt">void</span> <span class="nf">flush</span><span class="p">();</span>
      <span class="kt">void</span> <span class="nf">wipe</span><span class="p">(</span><span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">data_dir</span><span class="p">);</span> <span class="c1">// remove from disk</span>
      <span class="kt">void</span> <span class="nf">close</span><span class="p">();</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">create</span><span class="p">(</span> <span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">constructor</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_mutable_index</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span> <span class="n">idx</span><span class="p">.</span><span class="n">create</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">object</span><span class="o">&amp;</span> <span class="n">o</span><span class="p">)</span>
         <span class="p">{</span>
            <span class="n">assert</span><span class="p">(</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">);</span>
            <span class="n">constructor</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="p">);</span>
         <span class="p">}</span> <span class="p">));</span>
      <span class="p">}</span>

      <span class="c1">///These methods are used to retrieve indexes on the object_database. All public index accessors are const-access only.</span>
      <span class="c1">/// @{</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">IndexType</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">IndexType</span><span class="o">&amp;</span> <span class="n">get_index_type</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span>
         <span class="k">static_assert</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">is_base_of</span><span class="o">&lt;</span><span class="n">index</span><span class="p">,</span><span class="n">IndexType</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;Type must be an index type&quot;</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">IndexType</span><span class="o">&amp;&gt;</span><span class="p">(</span> <span class="n">get_index</span><span class="p">(</span> <span class="n">IndexType</span><span class="o">::</span><span class="n">object_type</span><span class="o">::</span><span class="n">space_id</span><span class="p">,</span> <span class="n">IndexType</span><span class="o">::</span><span class="n">object_type</span><span class="o">::</span><span class="n">type_id</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">index</span><span class="o">&amp;</span>  <span class="n">get_index</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">get_index</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="n">space_id</span><span class="p">,</span><span class="n">T</span><span class="o">::</span><span class="n">type_id</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">const</span> <span class="n">index</span><span class="o">&amp;</span>  <span class="n">get_index</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">space_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">type_id</span><span class="p">)</span><span class="k">const</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">index</span><span class="o">&amp;</span>  <span class="n">get_index</span><span class="p">(</span><span class="n">object_id_type</span> <span class="n">id</span><span class="p">)</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">get_index</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">());</span> <span class="p">}</span>
      <span class="c1">/// @}</span>

      <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">get_object</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">object</span><span class="o">*</span> <span class="nf">find_object</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span><span class="p">;</span>

      <span class="c1">/// These methods are mutators of the object_database. You must use these methods to make changes to the object_database,</span>
      <span class="c1">/// in order to maintain proper undo history.</span>
      <span class="c1">///@{</span>

      <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">get_mutable_index</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">).</span><span class="n">insert</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
      <span class="kt">void</span>          <span class="n">remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="p">{</span> <span class="n">get_mutable_index</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">).</span><span class="n">remove</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span> <span class="p">}</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Lambda</span><span class="o">&gt;</span>
      <span class="kt">void</span> <span class="n">modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="n">Lambda</span><span class="o">&amp;</span> <span class="n">m</span> <span class="p">)</span> <span class="p">{</span>
         <span class="n">get_mutable_index</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">).</span><span class="n">modify</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">m</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">///@}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">static</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">cast</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="n">assert</span><span class="p">(</span> <span class="k">nullptr</span> <span class="o">!=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">cast</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="n">assert</span><span class="p">(</span> <span class="k">nullptr</span> <span class="o">!=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
         <span class="n">assert</span><span class="p">(</span> <span class="k">nullptr</span> <span class="o">!=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">find</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
      <span class="p">{</span>
         <span class="k">const</span> <span class="n">object</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">find_object</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
         <span class="n">assert</span><span class="p">(</span>  <span class="o">!</span><span class="n">obj</span> <span class="o">||</span> <span class="k">nullptr</span> <span class="o">!=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="kt">uint8_t</span> <span class="n">SpaceID</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">TypeID</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">find</span><span class="p">(</span> <span class="n">object_id</span><span class="o">&lt;</span><span class="n">SpaceID</span><span class="p">,</span><span class="n">TypeID</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">find</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> <span class="p">}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="kt">uint8_t</span> <span class="n">SpaceID</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">TypeID</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">(</span> <span class="n">object_id</span><span class="o">&lt;</span><span class="n">SpaceID</span><span class="p">,</span><span class="n">TypeID</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">get</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> <span class="p">}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">IndexType</span><span class="o">&gt;</span>
      <span class="n">IndexType</span><span class="o">*</span> <span class="n">add_index</span><span class="p">()</span>
      <span class="p">{</span>
         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">IndexType</span><span class="o">::</span><span class="n">object_type</span> <span class="n">ObjectType</span><span class="p">;</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">_index</span><span class="p">[</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">space_id</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">ObjectType</span><span class="o">::</span><span class="n">type_id</span>  <span class="p">)</span>
             <span class="n">_index</span><span class="p">[</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">space_id</span><span class="p">].</span><span class="n">resize</span><span class="p">(</span> <span class="mi">255</span> <span class="p">);</span>
         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_index</span><span class="p">[</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">space_id</span><span class="p">][</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">type_id</span><span class="p">]);</span>
         <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">index</span><span class="o">&gt;</span> <span class="n">indexptr</span><span class="p">(</span> <span class="k">new</span> <span class="n">IndexType</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">);</span>
         <span class="n">_index</span><span class="p">[</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">space_id</span><span class="p">][</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">type_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">indexptr</span><span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">IndexType</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_index</span><span class="p">[</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">space_id</span><span class="p">][</span><span class="n">ObjectType</span><span class="o">::</span><span class="n">type_id</span><span class="p">].</span><span class="n">get</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">IndexType</span><span class="p">,</span> <span class="k">typename</span> <span class="n">SecondaryIndexType</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
      <span class="n">SecondaryIndexType</span><span class="o">*</span> <span class="n">add_secondary_index</span><span class="p">(</span> <span class="n">Args</span><span class="p">...</span> <span class="n">args</span> <span class="p">)</span>
      <span class="p">{</span>
         <span class="k">return</span> <span class="n">get_mutable_index_type</span><span class="o">&lt;</span><span class="n">IndexType</span><span class="o">&gt;</span><span class="p">().</span><span class="k">template</span> <span class="n">add_secondary_index</span><span class="o">&lt;</span><span class="n">SecondaryIndexType</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">...);</span>
      <span class="p">}</span>

      <span class="kt">void</span> <span class="n">pop_undo</span><span class="p">();</span>

      <span class="n">fc</span><span class="o">::</span><span class="n">path</span> <span class="n">get_data_dir</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_data_dir</span><span class="p">;</span> <span class="p">}</span>

      <span class="cm">/** public for testing purposes only... should be private in practice. */</span>
      <span class="n">undo_database</span>                          <span class="n">_undo_db</span><span class="p">;</span>
  <span class="k">protected</span><span class="o">:</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">IndexType</span><span class="o">&gt;</span>
      <span class="n">IndexType</span><span class="o">&amp;</span>    <span class="n">get_mutable_index_type</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">static_assert</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">is_base_of</span><span class="o">&lt;</span><span class="n">index</span><span class="p">,</span><span class="n">IndexType</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;Type must be an index type&quot;</span> <span class="p">);</span>
         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">IndexType</span><span class="o">&amp;&gt;</span><span class="p">(</span> <span class="n">get_mutable_index</span><span class="p">(</span> <span class="n">IndexType</span><span class="o">::</span><span class="n">object_type</span><span class="o">::</span><span class="n">space_id</span><span class="p">,</span> <span class="n">IndexType</span><span class="o">::</span><span class="n">object_type</span><span class="o">::</span><span class="n">type_id</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
      <span class="n">index</span><span class="o">&amp;</span> <span class="n">get_mutable_index</span><span class="p">()</span>
              <span class="p">{</span> <span class="k">return</span> <span class="n">get_mutable_index</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="n">space_id</span><span class="p">,</span><span class="n">T</span><span class="o">::</span><span class="n">type_id</span><span class="p">);</span> <span class="p">}</span>
      <span class="n">index</span><span class="o">&amp;</span> <span class="n">get_mutable_index</span><span class="p">(</span><span class="n">object_id_type</span> <span class="n">id</span><span class="p">)</span>
              <span class="p">{</span> <span class="k">return</span> <span class="n">get_mutable_index</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>   <span class="p">}</span>
      <span class="n">index</span><span class="o">&amp;</span> <span class="n">get_mutable_index</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">space_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">type_id</span><span class="p">);</span>

  <span class="k">private</span><span class="o">:</span>

      <span class="k">friend</span> <span class="k">class</span> <span class="nc">base_primary_index</span><span class="p">;</span>
      <span class="k">friend</span> <span class="k">class</span> <span class="nc">undo_database</span><span class="p">;</span>
      <span class="kt">void</span> <span class="nf">save_undo</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>
      <span class="kt">void</span> <span class="nf">save_undo_add</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>
      <span class="kt">void</span> <span class="nf">save_undo_remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>

      <span class="n">fc</span><span class="o">::</span><span class="n">path</span>                                 <span class="n">_data_dir</span><span class="p">;</span>
      <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">index</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span>    <span class="n">_index</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="object-id-hpp">
<h2><a class="toc-backref" href="#id43">object_id.hpp</a><a class="headerlink" href="#object-id-hpp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span>  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="p">;</span>
<span class="k">using</span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="p">;</span>
<span class="k">using</span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span>
<span class="k">using</span>  <span class="n">fc</span><span class="o">::</span><span class="n">flat_map</span><span class="p">;</span>
<span class="k">using</span>  <span class="n">fc</span><span class="o">::</span><span class="n">variant</span><span class="p">;</span>
<span class="k">using</span>  <span class="n">fc</span><span class="o">::</span><span class="n">unsigned_int</span><span class="p">;</span>
<span class="k">using</span>  <span class="n">fc</span><span class="o">::</span><span class="n">signed_int</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="object-id-type">
<h3><a class="toc-backref" href="#id44">object_id_type</a><a class="headerlink" href="#object-id-type" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">object_id_type</span>
<span class="p">{</span>
   <span class="n">object_id_type</span><span class="p">(</span> <span class="kt">uint8_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">t</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">i</span> <span class="p">)</span>
   <span class="p">{</span>
      <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;instance overflow&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;instance&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
      <span class="n">number</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">56</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">48</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">object_id_type</span><span class="p">(){</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

   <span class="kt">uint8_t</span>  <span class="n">space</span><span class="p">()</span><span class="k">const</span>       <span class="p">{</span> <span class="k">return</span> <span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">;</span>              <span class="p">}</span>
   <span class="kt">uint8_t</span>  <span class="n">type</span><span class="p">()</span><span class="k">const</span>        <span class="p">{</span> <span class="k">return</span> <span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>     <span class="p">}</span>
   <span class="kt">uint16_t</span> <span class="n">space_type</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>              <span class="p">}</span>
   <span class="kt">uint64_t</span> <span class="n">instance</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">number</span> <span class="o">&amp;</span> <span class="n">GRAPHENE_DB_MAX_INSTANCE_ID</span><span class="p">;</span> <span class="p">}</span>
   <span class="kt">bool</span>     <span class="n">is_null</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">explicit</span> <span class="k">operator</span> <span class="kt">uint64_t</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">number</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">==</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">number</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">!=</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">number</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">&lt;</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">number</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">&gt;</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">number</span><span class="p">;</span> <span class="p">}</span>

   <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="o">++</span><span class="n">number</span><span class="p">;</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
   <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span>    <span class="p">{</span> <span class="o">++</span><span class="n">number</span><span class="p">;</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">friend</span> <span class="n">object_id_type</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">object_id_type</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span> <span class="n">a</span><span class="p">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">a</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="k">friend</span> <span class="n">object_id_type</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">delta</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">object_id_type</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span> <span class="n">a</span><span class="p">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">a</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">size_t</span> <span class="n">hash_value</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">v</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">v</span><span class="p">.</span><span class="n">number</span><span class="p">);</span> <span class="p">}</span>

   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">&gt;</span>
   <span class="kt">bool</span> <span class="n">is</span><span class="p">()</span> <span class="k">const</span>
   <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">T</span><span class="o">::</span><span class="n">space_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="n">type_id</span><span class="p">));</span>
   <span class="p">}</span>

   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">&gt;</span>
   <span class="n">T</span> <span class="n">as</span><span class="p">()</span> <span class="k">const</span>
   <span class="p">{</span>
      <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">is</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">);</span>
      <span class="k">return</span> <span class="nf">T</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">explicit</span> <span class="k">operator</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">()</span> <span class="k">const</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">space</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">type</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">fc</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">instance</span><span class="p">());</span>
   <span class="p">}</span>

   <span class="kt">uint64_t</span>       <span class="n">number</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="object-id">
<h3><a class="toc-backref" href="#id45">object_id</a><a class="headerlink" href="#object-id" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">object</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">object_database</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="kt">uint8_t</span> <span class="n">SpaceID</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">TypeID</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">=</span> <span class="n">object</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">object_id</span>
<span class="p">{</span>
   <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">space_id</span> <span class="o">=</span> <span class="n">SpaceID</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">type_id</span> <span class="o">=</span> <span class="n">TypeID</span><span class="p">;</span>

   <span class="n">object_id</span><span class="p">(){}</span>
   <span class="n">object_id</span><span class="p">(</span> <span class="n">unsigned_int</span> <span class="n">i</span> <span class="p">)</span><span class="o">:</span><span class="n">instance</span><span class="p">(</span><span class="n">i</span><span class="p">){}</span>
   <span class="k">explicit</span> <span class="n">object_id</span><span class="p">(</span> <span class="kt">uint64_t</span> <span class="n">i</span> <span class="p">)</span><span class="o">:</span><span class="n">instance</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="n">object_id</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="o">:</span><span class="n">instance</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">())</span>
   <span class="p">{</span>
   <span class="p">}</span>

   <span class="k">friend</span> <span class="n">object_id</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">object_id</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">delta</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">object_id</span><span class="p">(</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="p">);</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="n">object_id</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">object_id</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">object_id</span><span class="p">(</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="p">);</span> <span class="p">}</span>

   <span class="k">operator</span> <span class="n">object_id_type</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">object_id_type</span><span class="p">(</span> <span class="n">SpaceID</span><span class="p">,</span> <span class="n">TypeID</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">value</span> <span class="p">);</span> <span class="p">}</span>
   <span class="k">explicit</span> <span class="k">operator</span> <span class="kt">uint64_t</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">object_id_type</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">).</span><span class="n">number</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">DB</span><span class="o">&gt;</span>
   <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">DB</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">)</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">db</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span> <span class="p">}</span>

   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">==</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">instance</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">instance</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">!=</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">instance</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">instance</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">==</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">object_id_type</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">!=</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">object_id_type</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">==</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">object_id_type</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">!=</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id_type</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">object_id_type</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>

   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">&lt;</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">friend</span> <span class="kt">bool</span>  <span class="k">operator</span> <span class="o">&gt;</span> <span class="p">(</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">object_id</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">friend</span> <span class="kt">size_t</span> <span class="n">hash_value</span><span class="p">(</span> <span class="n">object_id</span> <span class="n">v</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">v</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>

   <span class="n">unsigned_int</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="simple-index-hpp">
<h2><a class="toc-backref" href="#id46">simple_index.hpp</a><a class="headerlink" href="#simple-index-hpp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="simple-index">
<h3><a class="toc-backref" href="#id47">simple_index</a><a class="headerlink" href="#simple-index" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A simple index uses a vector&lt;unique_ptr&lt;T&gt;&gt; to store data</li>
<li>This index is preferred in situations where the data will never be removed from main memory and when access by ID is the only kind of access that is necessary.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">simple_index</span> <span class="o">:</span> <span class="k">public</span> <span class="n">index</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="k">typedef</span> <span class="n">T</span> <span class="n">object_type</span><span class="p">;</span>

      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span>  <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;</span> <span class="n">constructor</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
          <span class="k">auto</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_next_id</span><span class="p">();</span>
          <span class="k">auto</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">instance</span> <span class="o">&gt;=</span> <span class="n">_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span> <span class="n">_objects</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">instance</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">);</span>
          <span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
          <span class="n">constructor</span><span class="p">(</span> <span class="o">*</span><span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="p">);</span>
          <span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span> <span class="c1">// just in case it changed</span>
          <span class="n">use_next_id</span><span class="p">();</span>
          <span class="k">return</span> <span class="o">*</span><span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;&amp;</span> <span class="n">modify_callback</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">assert</span><span class="p">(</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
         <span class="n">modify_callback</span><span class="p">(</span> <span class="o">*</span><span class="n">_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">()]</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">insert</span><span class="p">(</span> <span class="n">object</span><span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="p">)</span><span class="k">override</span>
      <span class="p">{</span>
         <span class="k">auto</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">();</span>
         <span class="n">assert</span><span class="p">(</span> <span class="k">nullptr</span> <span class="o">!=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">instance</span> <span class="p">)</span> <span class="n">_objects</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">instance</span><span class="o">+</span><span class="mi">1</span> <span class="p">);</span>
         <span class="n">assert</span><span class="p">(</span> <span class="o">!</span><span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="p">);</span>
         <span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span> <span class="k">new</span> <span class="n">T</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
         <span class="k">return</span> <span class="o">*</span><span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">assert</span><span class="p">(</span> <span class="k">nullptr</span> <span class="o">!=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">const</span> <span class="k">auto</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">();</span>
         <span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">].</span><span class="n">reset</span><span class="p">();</span>
         <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_objects</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">_objects</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="k">const</span> <span class="n">object</span><span class="o">*</span> <span class="n">find</span><span class="p">(</span> <span class="n">object_id_type</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="n">assert</span><span class="p">(</span> <span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">()</span> <span class="o">==</span> <span class="n">T</span><span class="o">::</span><span class="n">space_id</span> <span class="p">);</span>
         <span class="n">assert</span><span class="p">(</span> <span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">T</span><span class="o">::</span><span class="n">type_id</span> <span class="p">);</span>

         <span class="k">const</span> <span class="k">auto</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">();</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">instance</span> <span class="o">&gt;=</span> <span class="n">_objects</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
         <span class="k">return</span> <span class="n">_objects</span><span class="p">[</span><span class="n">instance</span><span class="p">].</span><span class="n">get</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">virtual</span> <span class="kt">void</span> <span class="n">inspect_all_objects</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">inspector</span><span class="p">)</span><span class="k">const</span> <span class="k">override</span>
      <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">ptr</span> <span class="p">:</span> <span class="n">_objects</span> <span class="p">)</span>
            <span class="p">{</span>
               <span class="k">if</span><span class="p">(</span> <span class="n">ptr</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="p">)</span>
                  <span class="n">inspector</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span>
      <span class="p">}</span>
      <span class="k">virtual</span> <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span> <span class="n">hash</span><span class="p">()</span><span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
         <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span> <span class="n">result</span><span class="p">;</span>
         <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">ptr</span> <span class="p">:</span> <span class="n">_objects</span> <span class="p">)</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">();</span>

         <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">class</span> <span class="nc">const_iterator</span>
      <span class="p">{</span>
         <span class="k">public</span><span class="o">:</span>
            <span class="n">const_iterator</span><span class="p">(</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;&gt;&amp;</span> <span class="n">objects</span> <span class="p">)</span><span class="o">:</span><span class="n">_objects</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="p">{}</span>
            <span class="n">const_iterator</span><span class="p">(</span>
               <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;&gt;&amp;</span> <span class="n">objects</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;&gt;::</span><span class="n">const_iterator</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span><span class="o">:</span><span class="n">_itr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">_objects</span><span class="p">(</span><span class="n">objects</span><span class="p">){}</span>
            <span class="k">friend</span> <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span> <span class="k">const</span> <span class="n">const_iterator</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">const_iterator</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">_itr</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">_itr</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">friend</span> <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span> <span class="k">const</span> <span class="n">const_iterator</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">const_iterator</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">_itr</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">_itr</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">_itr</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">());</span> <span class="p">}</span>
            <span class="n">const_iterator</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>     <span class="c1">// postfix</span>
            <span class="p">{</span>
               <span class="n">const_iterator</span> <span class="n">result</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
               <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
               <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">const_iterator</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span>       <span class="c1">// prefix</span>
            <span class="p">{</span>
               <span class="o">++</span><span class="n">_itr</span><span class="p">;</span>
               <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">_itr</span> <span class="o">!=</span> <span class="n">_objects</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">_itr</span><span class="p">)</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="p">)</span> <span class="p">)</span>
                  <span class="o">++</span><span class="n">_itr</span><span class="p">;</span>
               <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">forward_iterator_tag</span> <span class="n">iterator_category</span><span class="p">;</span>
            <span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">value_type</span> <span class="n">value_type</span><span class="p">;</span>
            <span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">difference_type</span> <span class="n">difference_type</span><span class="p">;</span>
            <span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">pointer</span> <span class="n">pointer</span><span class="p">;</span>
            <span class="k">typedef</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">reference</span> <span class="n">reference</span><span class="p">;</span>
         <span class="k">private</span><span class="o">:</span>
            <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;&gt;::</span><span class="n">const_iterator</span> <span class="n">_itr</span><span class="p">;</span>
            <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;&gt;&amp;</span> <span class="n">_objects</span><span class="p">;</span>
      <span class="p">};</span>
      <span class="n">const_iterator</span> <span class="nf">begin</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">const_iterator</span><span class="p">(</span><span class="n">_objects</span><span class="p">,</span> <span class="n">_objects</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span> <span class="p">}</span>
      <span class="n">const_iterator</span> <span class="nf">end</span><span class="p">()</span><span class="k">const</span>   <span class="p">{</span> <span class="k">return</span> <span class="n">const_iterator</span><span class="p">(</span><span class="n">_objects</span><span class="p">,</span> <span class="n">_objects</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>   <span class="p">}</span>

      <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_objects</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="p">}</span>
   <span class="k">private</span><span class="o">:</span>
      <span class="n">vector</span><span class="o">&lt;</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">_objects</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="undu-database-hpp">
<h2><a class="toc-backref" href="#id48">undu_database.hpp</a><a class="headerlink" href="#undu-database-hpp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="undo-state">
<h3><a class="toc-backref" href="#id49">undo_state</a><a class="headerlink" href="#undo-state" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="p">;</span>
<span class="k">using</span> <span class="n">fc</span><span class="o">::</span><span class="n">flat_set</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">object_database</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">undo_state</span>
<span class="p">{</span>
   <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="p">,</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">old_values</span><span class="p">;</span>
   <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="p">,</span> <span class="n">object_id_type</span><span class="o">&gt;</span>      <span class="n">old_index_next_ids</span><span class="p">;</span>
   <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="o">&gt;</span>                 <span class="n">new_ids</span><span class="p">;</span>
   <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="p">,</span> <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">object</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">removed</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="undo-database">
<h3><a class="toc-backref" href="#id50">undo_database</a><a class="headerlink" href="#undo-database" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>tracks changes to the state and allows changes to be undone</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">undo_database</span>
<span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
      <span class="n">undo_database</span><span class="p">(</span> <span class="n">object_database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span><span class="o">:</span><span class="n">_db</span><span class="p">(</span><span class="n">db</span><span class="p">){}</span>

      <span class="k">class</span> <span class="nc">session</span>
      <span class="p">{</span>
         <span class="k">public</span><span class="o">:</span>
            <span class="n">session</span><span class="p">(</span> <span class="n">session</span><span class="o">&amp;&amp;</span> <span class="n">mv</span> <span class="p">)</span>
            <span class="o">:</span><span class="n">_db</span><span class="p">(</span><span class="n">mv</span><span class="p">.</span><span class="n">_db</span><span class="p">),</span><span class="n">_apply_undo</span><span class="p">(</span><span class="n">mv</span><span class="p">.</span><span class="n">_apply_undo</span><span class="p">)</span>
            <span class="p">{</span>
               <span class="n">mv</span><span class="p">.</span><span class="n">_apply_undo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="o">~</span><span class="n">session</span><span class="p">()</span> <span class="p">{</span>
               <span class="k">try</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span> <span class="n">_apply_undo</span> <span class="p">)</span> <span class="n">_db</span><span class="p">.</span><span class="n">undo</span><span class="p">();</span>
               <span class="p">}</span>
               <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span>
               <span class="p">{</span>
                  <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
                  <span class="k">throw</span><span class="p">;</span> <span class="c1">// maybe crash..</span>
               <span class="p">}</span>
               <span class="k">if</span><span class="p">(</span> <span class="n">_disable_on_exit</span> <span class="p">)</span> <span class="n">_db</span><span class="p">.</span><span class="n">disable</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="kt">void</span> <span class="n">commit</span><span class="p">()</span> <span class="p">{</span> <span class="n">_apply_undo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="n">_db</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>  <span class="p">}</span>
            <span class="kt">void</span> <span class="n">undo</span><span class="p">()</span>   <span class="p">{</span> <span class="k">if</span><span class="p">(</span> <span class="n">_apply_undo</span> <span class="p">)</span> <span class="n">_db</span><span class="p">.</span><span class="n">undo</span><span class="p">();</span> <span class="n">_apply_undo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span>
            <span class="kt">void</span> <span class="n">merge</span><span class="p">()</span>  <span class="p">{</span> <span class="k">if</span><span class="p">(</span> <span class="n">_apply_undo</span> <span class="p">)</span> <span class="n">_db</span><span class="p">.</span><span class="n">merge</span><span class="p">();</span> <span class="n">_apply_undo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span>

            <span class="n">session</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">=</span> <span class="p">(</span> <span class="n">session</span><span class="o">&amp;&amp;</span> <span class="n">mv</span> <span class="p">)</span>
            <span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
               <span class="k">if</span><span class="p">(</span> <span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mv</span> <span class="p">)</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
               <span class="k">if</span><span class="p">(</span> <span class="n">_apply_undo</span> <span class="p">)</span> <span class="n">_db</span><span class="p">.</span><span class="n">undo</span><span class="p">();</span>
               <span class="n">_apply_undo</span> <span class="o">=</span> <span class="n">mv</span><span class="p">.</span><span class="n">_apply_undo</span><span class="p">;</span>
               <span class="n">mv</span><span class="p">.</span><span class="n">_apply_undo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
               <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
            <span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>

         <span class="k">private</span><span class="o">:</span>
            <span class="k">friend</span> <span class="k">class</span> <span class="nc">undo_database</span><span class="p">;</span>
            <span class="n">session</span><span class="p">(</span><span class="n">undo_database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">disable_on_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span><span class="o">:</span> <span class="n">_db</span><span class="p">(</span><span class="n">db</span><span class="p">),</span><span class="n">_disable_on_exit</span><span class="p">(</span><span class="n">disable_on_exit</span><span class="p">)</span> <span class="p">{}</span>
            <span class="n">undo_database</span><span class="o">&amp;</span> <span class="n">_db</span><span class="p">;</span>
            <span class="kt">bool</span> <span class="n">_apply_undo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="kt">bool</span> <span class="n">_disable_on_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="kt">void</span>    <span class="nf">disable</span><span class="p">();</span>
      <span class="kt">void</span>    <span class="nf">enable</span><span class="p">();</span>
      <span class="kt">bool</span>    <span class="nf">enabled</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">_disabled</span><span class="p">;</span> <span class="p">}</span>

      <span class="n">session</span> <span class="nf">start_undo_session</span><span class="p">(</span> <span class="kt">bool</span> <span class="n">force_enable</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">);</span>
      <span class="cm">/**</span>
<span class="cm">       * This should be called just after an object is created</span>
<span class="cm">       */</span>
      <span class="kt">void</span> <span class="nf">on_create</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>
      <span class="cm">/**</span>
<span class="cm">       * This should be called just before an object is modified</span>
<span class="cm">       *</span>
<span class="cm">       * If it&#39;s a new object as of this undo state, its pre-modification value is not stored, because prior to this</span>
<span class="cm">       * undo state, it did not exist. Any modifications in this undo state are irrelevant, as the object will simply</span>
<span class="cm">       * be removed if we undo.</span>
<span class="cm">       */</span>
      <span class="kt">void</span> <span class="nf">on_modify</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>
      <span class="cm">/**</span>
<span class="cm">       * This should be called just before an object is removed.</span>
<span class="cm">       *</span>
<span class="cm">       * If it&#39;s a new object as of this undo state, its pre-removal value is not stored, because prior to this undo</span>
<span class="cm">       * state, it did not exist. Now that it&#39;s been removed, it doesn&#39;t exist again, so nothing has happened.</span>
<span class="cm">       * Instead, remove it from the list of newly created objects (which must be deleted if we undo), as we don&#39;t</span>
<span class="cm">       * want to re-delete it if this state is undone.</span>
<span class="cm">       */</span>
      <span class="kt">void</span> <span class="nf">on_remove</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">);</span>

      <span class="cm">/**</span>
<span class="cm">       *  Removes the last committed session,</span>
<span class="cm">       *  note... this is dangerous if there are</span>
<span class="cm">       *  active sessions... thus active sessions should</span>
<span class="cm">       *  track</span>
<span class="cm">       */</span>
      <span class="kt">void</span> <span class="nf">pop_commit</span><span class="p">();</span>

      <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_stack</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="p">}</span>
      <span class="kt">void</span> <span class="n">set_max_size</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">new_max_size</span><span class="p">)</span> <span class="p">{</span> <span class="n">_max_size</span> <span class="o">=</span> <span class="n">new_max_size</span><span class="p">;</span> <span class="p">}</span>
      <span class="kt">size_t</span> <span class="n">max_size</span><span class="p">()</span><span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_max_size</span><span class="p">;</span> <span class="p">}</span>

      <span class="k">const</span> <span class="n">undo_state</span><span class="o">&amp;</span> <span class="n">head</span><span class="p">()</span><span class="k">const</span><span class="p">;</span>

   <span class="k">private</span><span class="o">:</span>
      <span class="kt">void</span> <span class="n">undo</span><span class="p">();</span>
      <span class="kt">void</span> <span class="nf">merge</span><span class="p">();</span>
      <span class="kt">void</span> <span class="nf">commit</span><span class="p">();</span>

      <span class="kt">uint32_t</span>                <span class="n">_active_sessions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">bool</span>                    <span class="n">_disabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">undo_state</span><span class="o">&gt;</span>  <span class="n">_stack</span><span class="p">;</span>
      <span class="n">object_database</span><span class="o">&amp;</span>        <span class="n">_db</span><span class="p">;</span>
      <span class="kt">size_t</span>                  <span class="n">_max_size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lib_protocols.html" class="btn btn-neutral float-right" title="Protocols" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lib_block.html" class="btn btn-neutral" title="Block" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright BitShares Blockchain Foundation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>