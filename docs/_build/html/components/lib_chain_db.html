

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Chain - db_xxx.cpp &mdash; BItShares Developers Portal  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Net" href="lib_net.html" />
    <link rel="prev" title="Plugins" href="lib_plugins.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> BItShares Developers Portal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/architectures.html">Introduction &amp; Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/environments.html">Development Environments</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="components.html">System Components Elements</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="lib_database.html">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_block.html">Block</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_db.html">db folder - object/index</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_protocols.html">Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_evalustors.html">Evaluators</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_objects.html">Objects and Elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_plugins.html">Plugins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Chain - db_xxx.cpp</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#db-balance-cpp">db_balance.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#get-balance">get_balance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">get_balance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#to-pretty-string">to_pretty_string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adjust-balance">adjust_balance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deposit-lazy-vesting">deposit_lazy_vesting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deposit-cashback">deposit_cashback</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deposit-witness-pay">deposit_witness_pay</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-block">db_block</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-known-block">is_known_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-known-transaction">is_known_transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-block-id-for-num">get_block_id_for_num</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fetch-block-by-id">fetch_block_by_id</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fetch-block-by-number">fetch_block_by_number</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-recent-transaction">get_recent_transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-block-ids-on-fork">get_block_ids_on_fork</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push-block">push_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push-transaction">push_transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validate-transaction">validate_transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push-proposal-nesting-guard">push_proposal_nesting_guard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push-proposal">push_proposal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-block">generate_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pop-block">pop_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clear-pending">clear_pending</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push-applied-operation">push_applied_operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#set-applied-operation-result">set_applied_operation_result</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-applied-operations">get_applied_operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apply-block">apply_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apply-transaction">apply_transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apply-operation">apply_operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validate-block-header">validate_block_header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-block-summary">create_block_summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-checkpoints">add_checkpoints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#before-last-checkpoint">before_last_checkpoint</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-debug-cpp">db_debug.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#debug-dump">debug_dump</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debug-apply-update">debug_apply_update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apply-debug-updates">apply_debug_updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debug-update">debug_update</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-getter-cpp">db_getter.cpp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#db-init-cpp">db_init.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#initialize-evaluators">initialize_evaluators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initialize-indexes">initialize_indexes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#init-genesis">init_genesis</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-maint-cpp">db_maint.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sort-votable-objects">sort_votable_objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#perform-account-maintenance">perform_account_maintenance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worker-pay-visitor">worker_pay_visitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-worker-votes">update_worker_votes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pay-workers">pay_workers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-active-witnesses">update_active_witnesses</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-active-committee-members">update_active_committee_members</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initialize-budget-record">initialize_budget_record</a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-budget">process_budget</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visit-special-authorities">visit_special_authorities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-top-n-authorities">update_top_n_authorities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#split-fba-balance">split_fba_balance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distribute-fba-balances">distribute_fba_balances</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-buyback-orders">create_buyback_orders</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deprecate-annual-members">deprecate_annual_members</a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-bids">process_bids</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-and-match-call-orders">update_and_match_call_orders</a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-bitassets">process_bitassets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-hf-868-890">process_hf_868_890</a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-hf-935">process_hf_935</a></li>
<li class="toctree-l4"><a class="reference internal" href="#perform-chain-maintenance">perform_chain_maintenance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-management">db_management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reindex">reindex</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wipe">wipe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#open">open</a></li>
<li class="toctree-l4"><a class="reference internal" href="#close">close</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-market">db_market</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#globally-settle-asset">globally_settle_asset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#revive-bitasset">revive_bitasset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cancel-bids-and-revive-mpa">_cancel_bids_and_revive_mpa</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cancel-bid">cancel_bid</a></li>
<li class="toctree-l4"><a class="reference internal" href="#execute-bid">execute_bid</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cancel-settle-order">cancel_settle_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cancel-limit-order">cancel_limit_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#maybe-cull-small-order">maybe_cull_small_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apply-order-before-hardfork-625">apply_order_before_hardfork_625</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apply-order">apply_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-int-database">match (int database)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-asset-database">match (asset database)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fill-limit-order">fill_limit_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fill-call-order">fill_call_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fill-settle-order">fill_settle_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#check-call-orders">check_call_orders</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pay-order">pay_order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calculate-market-fee">calculate_market_fee</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pay-market-fees">pay_market_fees</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-notify">db_notify</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#get-impacted-account-visitor">get_impacted_account_visitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#operation-get-impacted-accounts">operation_get_impacted_accounts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#transaction-get-impacted-accounts">transaction_get_impacted_accounts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-relevant-accounts">get_relevant_accounts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notify-applied-block">notify_applied_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notify-on-pending-transaction">notify_on_pending_transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notify-changed-objects">notify_changed_objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-update">db_update</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#update-global-dynamic-data">update_global_dynamic_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-signing-witness">update_signing_witness</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-last-irreversible-block">update_last_irreversible_block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clear-expired-transactions">clear_expired_transactions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clear-expired-proposals">clear_expired_proposals</a></li>
<li class="toctree-l4"><a class="reference internal" href="#check-for-blackswan">check_for_blackswan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clear-expired-orders">clear_expired_orders</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-expired-feeds">update_expired_feeds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-core-exchange-rates">update_core_exchange_rates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-maintenance-flag">update_maintenance_flag</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-withdraw-permissions">update_withdraw_permissions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#db-witness-schedule-cpp">db_witness_schedule.cpp</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#get-scheduled-witness">get_scheduled_witness</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-slot-time">get_slot_time</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-slot-at-time">get_slot_at_time</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-witness-missed-blocks">update_witness_missed_blocks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#witness-participation-rate">witness_participation_rate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-witness-schedule">update_witness_schedule</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lib_net.html">Net</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_app.html">libraries - app</a></li>
<li class="toctree-l2"><a class="reference internal" href="lib_wallet.html">libraries - wallet</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/installation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bts_guide/accounts/bts_account.html">BitShares Accounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/integration.html">Integration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/interaction.html">Blockchain Interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testnets.html">Testnets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/bsip.html">BitShares Improvement Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supports_dev/supports.html">Support and Optimizations</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/api_about.html">1. API Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/restrictions.html">2. API Access and Restrictions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/calls.html">3. Available Calls, Object, and IDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/blockchain_api.html">4. Blockchain API(s)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/wallet_api.html">5. Wallet API - Calls</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/objects_ids.html">6. Objects and IDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces.html">7. Graphene - Namespaces</a></li>
</ul>
<p class="caption"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bts_guide/tutorials/index.html">Developer Guide (Tutorials)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bts_guide/index_faq.html">Frequently Asked Questions (FAQ)</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references/info_comunities.html">BitShares Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/info_comunities.html#bitshares-blockchain">BitShares Blockchain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/tech_articles.html">BitShares Developers’ Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/tech_articles.html#articles">Articles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/githubrepo.html">BitShares Repositories</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BItShares Developers Portal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="components.html">System Components Elements</a> &raquo;</li>
        
      <li>Chain - db_xxx.cpp</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="chain-db-xxx-cpp">
<span id="lib-chain-db"></span><h1>Chain - db_xxx.cpp<a class="headerlink" href="#chain-db-xxx-cpp" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>File directory: (../ibraries/chain/xxx.cpp)</li>
</ul>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#db-balance-cpp" id="id6">db_balance.cpp</a><ul>
<li><a class="reference internal" href="#get-balance" id="id7">get_balance</a></li>
<li><a class="reference internal" href="#id1" id="id8">get_balance</a></li>
<li><a class="reference internal" href="#to-pretty-string" id="id9">to_pretty_string</a></li>
<li><a class="reference internal" href="#adjust-balance" id="id10">adjust_balance</a></li>
<li><a class="reference internal" href="#deposit-lazy-vesting" id="id11">deposit_lazy_vesting</a></li>
<li><a class="reference internal" href="#deposit-cashback" id="id12">deposit_cashback</a></li>
<li><a class="reference internal" href="#deposit-witness-pay" id="id13">deposit_witness_pay</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-block" id="id14">db_block</a><ul>
<li><a class="reference internal" href="#is-known-block" id="id15">is_known_block</a></li>
<li><a class="reference internal" href="#is-known-transaction" id="id16">is_known_transaction</a></li>
<li><a class="reference internal" href="#get-block-id-for-num" id="id17">get_block_id_for_num</a></li>
<li><a class="reference internal" href="#fetch-block-by-id" id="id18">fetch_block_by_id</a></li>
<li><a class="reference internal" href="#fetch-block-by-number" id="id19">fetch_block_by_number</a></li>
<li><a class="reference internal" href="#get-recent-transaction" id="id20">get_recent_transaction</a></li>
<li><a class="reference internal" href="#get-block-ids-on-fork" id="id21">get_block_ids_on_fork</a></li>
<li><a class="reference internal" href="#push-block" id="id22">push_block</a></li>
<li><a class="reference internal" href="#push-transaction" id="id23">push_transaction</a></li>
<li><a class="reference internal" href="#validate-transaction" id="id24">validate_transaction</a></li>
<li><a class="reference internal" href="#push-proposal-nesting-guard" id="id25">push_proposal_nesting_guard</a></li>
<li><a class="reference internal" href="#push-proposal" id="id26">push_proposal</a></li>
<li><a class="reference internal" href="#generate-block" id="id27">generate_block</a></li>
<li><a class="reference internal" href="#pop-block" id="id28">pop_block</a></li>
<li><a class="reference internal" href="#clear-pending" id="id29">clear_pending</a></li>
<li><a class="reference internal" href="#push-applied-operation" id="id30">push_applied_operation</a></li>
<li><a class="reference internal" href="#set-applied-operation-result" id="id31">set_applied_operation_result</a></li>
<li><a class="reference internal" href="#get-applied-operations" id="id32">get_applied_operations</a></li>
<li><a class="reference internal" href="#apply-block" id="id33">apply_block</a></li>
<li><a class="reference internal" href="#apply-transaction" id="id34">apply_transaction</a></li>
<li><a class="reference internal" href="#apply-operation" id="id35">apply_operation</a></li>
<li><a class="reference internal" href="#validate-block-header" id="id36">validate_block_header</a></li>
<li><a class="reference internal" href="#create-block-summary" id="id37">create_block_summary</a></li>
<li><a class="reference internal" href="#add-checkpoints" id="id38">add_checkpoints</a></li>
<li><a class="reference internal" href="#before-last-checkpoint" id="id39">before_last_checkpoint</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-debug-cpp" id="id40">db_debug.cpp</a><ul>
<li><a class="reference internal" href="#debug-dump" id="id41">debug_dump</a></li>
<li><a class="reference internal" href="#debug-apply-update" id="id42">debug_apply_update</a></li>
<li><a class="reference internal" href="#apply-debug-updates" id="id43">apply_debug_updates</a></li>
<li><a class="reference internal" href="#debug-update" id="id44">debug_update</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-getter-cpp" id="id45">db_getter.cpp</a></li>
<li><a class="reference internal" href="#db-init-cpp" id="id46">db_init.cpp</a><ul>
<li><a class="reference internal" href="#initialize-evaluators" id="id47">initialize_evaluators</a></li>
<li><a class="reference internal" href="#initialize-indexes" id="id48">initialize_indexes</a></li>
<li><a class="reference internal" href="#init-genesis" id="id49">init_genesis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-maint-cpp" id="id50">db_maint.cpp</a><ul>
<li><a class="reference internal" href="#sort-votable-objects" id="id51">sort_votable_objects</a></li>
<li><a class="reference internal" href="#perform-account-maintenance" id="id52">perform_account_maintenance</a></li>
<li><a class="reference internal" href="#worker-pay-visitor" id="id53">worker_pay_visitor</a></li>
<li><a class="reference internal" href="#update-worker-votes" id="id54">update_worker_votes</a></li>
<li><a class="reference internal" href="#pay-workers" id="id55">pay_workers</a></li>
<li><a class="reference internal" href="#update-active-witnesses" id="id56">update_active_witnesses</a></li>
<li><a class="reference internal" href="#update-active-committee-members" id="id57">update_active_committee_members</a></li>
<li><a class="reference internal" href="#initialize-budget-record" id="id58">initialize_budget_record</a></li>
<li><a class="reference internal" href="#process-budget" id="id59">process_budget</a></li>
<li><a class="reference internal" href="#visit-special-authorities" id="id60">visit_special_authorities</a></li>
<li><a class="reference internal" href="#update-top-n-authorities" id="id61">update_top_n_authorities</a></li>
<li><a class="reference internal" href="#split-fba-balance" id="id62">split_fba_balance</a></li>
<li><a class="reference internal" href="#distribute-fba-balances" id="id63">distribute_fba_balances</a></li>
<li><a class="reference internal" href="#create-buyback-orders" id="id64">create_buyback_orders</a></li>
<li><a class="reference internal" href="#deprecate-annual-members" id="id65">deprecate_annual_members</a></li>
<li><a class="reference internal" href="#process-bids" id="id66">process_bids</a></li>
<li><a class="reference internal" href="#update-and-match-call-orders" id="id67">update_and_match_call_orders</a></li>
<li><a class="reference internal" href="#process-bitassets" id="id68">process_bitassets</a></li>
<li><a class="reference internal" href="#process-hf-868-890" id="id69">process_hf_868_890</a></li>
<li><a class="reference internal" href="#process-hf-935" id="id70">process_hf_935</a></li>
<li><a class="reference internal" href="#perform-chain-maintenance" id="id71">perform_chain_maintenance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-management" id="id72">db_management</a><ul>
<li><a class="reference internal" href="#reindex" id="id73">reindex</a></li>
<li><a class="reference internal" href="#wipe" id="id74">wipe</a></li>
<li><a class="reference internal" href="#open" id="id75">open</a></li>
<li><a class="reference internal" href="#close" id="id76">close</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-market" id="id77">db_market</a><ul>
<li><a class="reference internal" href="#globally-settle-asset" id="id78">globally_settle_asset</a></li>
<li><a class="reference internal" href="#revive-bitasset" id="id79">revive_bitasset</a></li>
<li><a class="reference internal" href="#cancel-bids-and-revive-mpa" id="id80">_cancel_bids_and_revive_mpa</a></li>
<li><a class="reference internal" href="#cancel-bid" id="id81">cancel_bid</a></li>
<li><a class="reference internal" href="#execute-bid" id="id82">execute_bid</a></li>
<li><a class="reference internal" href="#cancel-settle-order" id="id83">cancel_settle_order</a></li>
<li><a class="reference internal" href="#cancel-limit-order" id="id84">cancel_limit_order</a></li>
<li><a class="reference internal" href="#maybe-cull-small-order" id="id85">maybe_cull_small_order</a></li>
<li><a class="reference internal" href="#apply-order-before-hardfork-625" id="id86">apply_order_before_hardfork_625</a></li>
<li><a class="reference internal" href="#apply-order" id="id87">apply_order</a></li>
<li><a class="reference internal" href="#match-int-database" id="id88">match (int database)</a></li>
<li><a class="reference internal" href="#match-asset-database" id="id89">match (asset database)</a></li>
<li><a class="reference internal" href="#fill-limit-order" id="id90">fill_limit_order</a></li>
<li><a class="reference internal" href="#fill-call-order" id="id91">fill_call_order</a></li>
<li><a class="reference internal" href="#fill-settle-order" id="id92">fill_settle_order</a></li>
<li><a class="reference internal" href="#check-call-orders" id="id93">check_call_orders</a></li>
<li><a class="reference internal" href="#pay-order" id="id94">pay_order</a></li>
<li><a class="reference internal" href="#calculate-market-fee" id="id95">calculate_market_fee</a></li>
<li><a class="reference internal" href="#pay-market-fees" id="id96">pay_market_fees</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-notify" id="id97">db_notify</a><ul>
<li><a class="reference internal" href="#get-impacted-account-visitor" id="id98">get_impacted_account_visitor</a></li>
<li><a class="reference internal" href="#operation-get-impacted-accounts" id="id99">operation_get_impacted_accounts</a></li>
<li><a class="reference internal" href="#transaction-get-impacted-accounts" id="id100">transaction_get_impacted_accounts</a></li>
<li><a class="reference internal" href="#get-relevant-accounts" id="id101">get_relevant_accounts</a></li>
<li><a class="reference internal" href="#notify-applied-block" id="id102">notify_applied_block</a></li>
<li><a class="reference internal" href="#notify-on-pending-transaction" id="id103">notify_on_pending_transaction</a></li>
<li><a class="reference internal" href="#notify-changed-objects" id="id104">notify_changed_objects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-update" id="id105">db_update</a><ul>
<li><a class="reference internal" href="#update-global-dynamic-data" id="id106">update_global_dynamic_data</a></li>
<li><a class="reference internal" href="#update-signing-witness" id="id107">update_signing_witness</a></li>
<li><a class="reference internal" href="#update-last-irreversible-block" id="id108">update_last_irreversible_block</a></li>
<li><a class="reference internal" href="#clear-expired-transactions" id="id109">clear_expired_transactions</a></li>
<li><a class="reference internal" href="#clear-expired-proposals" id="id110">clear_expired_proposals</a></li>
<li><a class="reference internal" href="#check-for-blackswan" id="id111">check_for_blackswan</a></li>
<li><a class="reference internal" href="#clear-expired-orders" id="id112">clear_expired_orders</a></li>
<li><a class="reference internal" href="#update-expired-feeds" id="id113">update_expired_feeds</a></li>
<li><a class="reference internal" href="#update-core-exchange-rates" id="id114">update_core_exchange_rates</a></li>
<li><a class="reference internal" href="#update-maintenance-flag" id="id115">update_maintenance_flag</a></li>
<li><a class="reference internal" href="#update-withdraw-permissions" id="id116">update_withdraw_permissions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#db-witness-schedule-cpp" id="id117">db_witness_schedule.cpp</a><ul>
<li><a class="reference internal" href="#get-scheduled-witness" id="id118">get_scheduled_witness</a></li>
<li><a class="reference internal" href="#get-slot-time" id="id119">get_slot_time</a></li>
<li><a class="reference internal" href="#get-slot-at-time" id="id120">get_slot_at_time</a></li>
<li><a class="reference internal" href="#update-witness-missed-blocks" id="id121">update_witness_missed_blocks</a></li>
<li><a class="reference internal" href="#witness-participation-rate" id="id122">witness_participation_rate</a></li>
<li><a class="reference internal" href="#update-witness-schedule" id="id123">update_witness_schedule</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="db-balance-cpp">
<h2><a class="toc-backref" href="#id6">db_balance.cpp</a><a class="headerlink" href="#db-balance-cpp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-balance">
<h3><a class="toc-backref" href="#id7">get_balance</a><a class="headerlink" href="#get-balance" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">asset</span> <span class="n">database</span><span class="o">::</span><span class="n">get_balance</span><span class="p">(</span><span class="n">account_id_type</span> <span class="n">owner</span><span class="p">,</span> <span class="n">asset_id_type</span> <span class="n">asset_id</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_balance_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_account_asset</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">));</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">itr</span> <span class="o">==</span> <span class="n">index</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">asset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">get_balance</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id8">get_balance</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">asset</span> <span class="n">database</span><span class="o">::</span><span class="n">get_balance</span><span class="p">(</span><span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">owner</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">asset_obj</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_balance</span><span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="n">asset_obj</span><span class="p">.</span><span class="n">get_id</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="to-pretty-string">
<h3><a class="toc-backref" href="#id9">to_pretty_string</a><a class="headerlink" href="#to-pretty-string" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">string</span> <span class="n">database</span><span class="o">::</span><span class="n">to_pretty_string</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">amount_to_pretty_string</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">amount</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="adjust-balance">
<h3><a class="toc-backref" href="#id10">adjust_balance</a><a class="headerlink" href="#adjust-balance" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">adjust_balance</span><span class="p">(</span><span class="n">account_id_type</span> <span class="n">account</span><span class="p">,</span> <span class="n">asset</span> <span class="n">delta</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">delta</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>

   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_balance_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_account_asset</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">delta</span><span class="p">.</span><span class="n">asset_id</span><span class="p">));</span>
   <span class="k">if</span><span class="p">(</span><span class="n">itr</span> <span class="o">==</span> <span class="n">index</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
   <span class="p">{</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">delta</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Insufficient Balance: ${a}&#39;s balance of ${b} is less than required ${r}&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="n">account</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
                                 <span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="n">to_pretty_string</span><span class="p">(</span><span class="n">asset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">delta</span><span class="p">.</span><span class="n">asset_id</span><span class="p">)))</span>
                                 <span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span><span class="n">to_pretty_string</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)));</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">account_balance_object</span><span class="o">&gt;</span><span class="p">([</span><span class="n">account</span><span class="p">,</span><span class="o">&amp;</span><span class="n">delta</span><span class="p">](</span><span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">account</span><span class="p">;</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">asset_type</span> <span class="o">=</span> <span class="n">delta</span><span class="p">.</span><span class="n">asset_id</span><span class="p">;</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">delta</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">b</span><span class="p">.</span><span class="n">asset_type</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span> <span class="c1">// CORE asset</span>
                        <span class="n">b</span><span class="p">.</span><span class="n">maintenance_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">delta</span><span class="p">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">get_balance</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="s">&quot;Insufficient Balance: ${a}&#39;s balance of ${b} is less than required ${r}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="n">account</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">name</span><span class="p">)(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="n">to_pretty_string</span><span class="p">(</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">get_balance</span><span class="p">()))(</span><span class="s">&quot;r&quot;</span><span class="p">,</span><span class="n">to_pretty_string</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)));</span>
          <span class="n">modify</span><span class="p">(</span><span class="o">*</span><span class="n">itr</span><span class="p">,</span> <span class="p">[</span><span class="n">delta</span><span class="p">](</span><span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">adjust_balance</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
          <span class="p">});</span>
   <span class="p">}</span>

<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">account</span><span class="p">)(</span><span class="n">delta</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deposit-lazy-vesting">
<h3><a class="toc-backref" href="#id11">deposit_lazy_vesting</a><a class="headerlink" href="#deposit-lazy-vesting" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">optional</span><span class="o">&lt;</span> <span class="n">vesting_balance_id_type</span> <span class="o">&gt;</span> <span class="n">database</span><span class="o">::</span><span class="n">deposit_lazy_vesting</span><span class="p">(</span>
   <span class="k">const</span> <span class="n">optional</span><span class="o">&lt;</span> <span class="n">vesting_balance_id_type</span> <span class="o">&gt;&amp;</span> <span class="n">ovbid</span><span class="p">,</span>
   <span class="n">share_type</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">req_vesting_seconds</span><span class="p">,</span>
   <span class="n">account_id_type</span> <span class="n">req_owner</span><span class="p">,</span>
   <span class="kt">bool</span> <span class="n">require_vesting</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">optional</span><span class="o">&lt;</span> <span class="n">vesting_balance_id_type</span> <span class="o">&gt;</span><span class="p">();</span>

   <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">now</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>

   <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">ovbid</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">const</span> <span class="n">vesting_balance_object</span><span class="o">&amp;</span> <span class="n">vbo</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ovbid</span><span class="p">)(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">vbo</span><span class="p">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">req_owner</span> <span class="p">)</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">vbo</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">which</span><span class="p">()</span> <span class="o">!=</span> <span class="n">vesting_policy</span><span class="o">::</span><span class="n">tag</span><span class="o">&lt;</span> <span class="n">cdd_vesting_policy</span> <span class="o">&gt;::</span><span class="n">value</span> <span class="p">)</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">vbo</span><span class="p">.</span><span class="n">policy</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">cdd_vesting_policy</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">vesting_seconds</span> <span class="o">!=</span> <span class="n">req_vesting_seconds</span> <span class="p">)</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">vbo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">vesting_balance_object</span><span class="o">&amp;</span> <span class="n">_vbo</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">require_vesting</span> <span class="p">)</span>
                        <span class="n">_vbo</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
                 <span class="k">else</span>
                        <span class="n">_vbo</span><span class="p">.</span><span class="n">deposit_vested</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
          <span class="p">}</span> <span class="p">);</span>
          <span class="k">return</span> <span class="n">optional</span><span class="o">&lt;</span> <span class="n">vesting_balance_id_type</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="k">const</span> <span class="n">vesting_balance_object</span><span class="o">&amp;</span> <span class="n">vbo</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span> <span class="n">vesting_balance_object</span> <span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">vesting_balance_object</span><span class="o">&amp;</span> <span class="n">_vbo</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_vbo</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">req_owner</span><span class="p">;</span>
          <span class="n">_vbo</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">amount</span><span class="p">;</span>

          <span class="n">cdd_vesting_policy</span> <span class="n">policy</span><span class="p">;</span>
          <span class="n">policy</span><span class="p">.</span><span class="n">vesting_seconds</span> <span class="o">=</span> <span class="n">req_vesting_seconds</span><span class="p">;</span>
          <span class="n">policy</span><span class="p">.</span><span class="n">coin_seconds_earned</span> <span class="o">=</span> <span class="n">require_vesting</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">amount</span><span class="p">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">policy</span><span class="p">.</span><span class="n">vesting_seconds</span><span class="p">;</span>
          <span class="n">policy</span><span class="p">.</span><span class="n">coin_seconds_earned_last_update</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

          <span class="n">_vbo</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span><span class="p">;</span>
   <span class="p">}</span> <span class="p">);</span>

   <span class="k">return</span> <span class="n">vbo</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deposit-cashback">
<h3><a class="toc-backref" href="#id12">deposit_cashback</a><a class="headerlink" href="#deposit-cashback" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">deposit_cashback</span><span class="p">(</span><span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">acct</span><span class="p">,</span> <span class="n">share_type</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">require_vesting</span><span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// If we don&#39;t have a VBO, or if it has the wrong maturity</span>
   <span class="c1">// due to a policy change, cut it loose.</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">acct</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_COMMITTEE_ACCOUNT</span> <span class="o">||</span> <span class="n">acct</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_WITNESS_ACCOUNT</span> <span class="o">||</span>
           <span class="n">acct</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_RELAXED_COMMITTEE_ACCOUNT</span> <span class="o">||</span> <span class="n">acct</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_NULL_ACCOUNT</span> <span class="o">||</span>
           <span class="n">acct</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_TEMP_ACCOUNT</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="c1">// The blockchain&#39;s accounts do not get cashback; it simply goes to the reserve pool.</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">get_core_dynamic_data</span><span class="p">(),</span> <span class="p">[</span><span class="n">amount</span><span class="p">](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">d</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">optional</span><span class="o">&lt;</span> <span class="n">vesting_balance_id_type</span> <span class="o">&gt;</span> <span class="n">new_vbid</span> <span class="o">=</span> <span class="n">deposit_lazy_vesting</span><span class="p">(</span>
          <span class="n">acct</span><span class="p">.</span><span class="n">cashback_vb</span><span class="p">,</span>
          <span class="n">amount</span><span class="p">,</span>
          <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">cashback_vesting_period_seconds</span><span class="p">,</span>
          <span class="n">acct</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
          <span class="n">require_vesting</span> <span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">new_vbid</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">acct</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">new_vbid</span><span class="p">](</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">_acct</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_acct</span><span class="p">.</span><span class="n">cashback_vb</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_vbid</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">acct</span><span class="p">.</span><span class="n">statistics</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">),</span> <span class="p">[](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">aso</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">aso</span><span class="p">.</span><span class="n">has_cashback_vb</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deposit-witness-pay">
<h3><a class="toc-backref" href="#id13">deposit_witness_pay</a><a class="headerlink" href="#deposit-witness-pay" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">deposit_witness_pay</span><span class="p">(</span><span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">wit</span><span class="p">,</span> <span class="n">share_type</span> <span class="n">amount</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>

   <span class="n">optional</span><span class="o">&lt;</span> <span class="n">vesting_balance_id_type</span> <span class="o">&gt;</span> <span class="n">new_vbid</span> <span class="o">=</span> <span class="n">deposit_lazy_vesting</span><span class="p">(</span>
          <span class="n">wit</span><span class="p">.</span><span class="n">pay_vb</span><span class="p">,</span>
          <span class="n">amount</span><span class="p">,</span>
          <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">witness_pay_vesting_seconds</span><span class="p">,</span>
          <span class="n">wit</span><span class="p">.</span><span class="n">witness_account</span><span class="p">,</span>
          <span class="nb">true</span> <span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">new_vbid</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">wit</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">_wit</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_wit</span><span class="p">.</span><span class="n">pay_vb</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_vbid</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-block">
<h2><a class="toc-backref" href="#id14">db_block</a><a class="headerlink" href="#db-block" title="Permalink to this headline">¶</a></h2>
<div class="section" id="is-known-block">
<h3><a class="toc-backref" href="#id15">is_known_block</a><a class="headerlink" href="#is-known-block" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">is_known_block</span><span class="p">(</span> <span class="k">const</span> <span class="n">block_id_type</span><span class="o">&amp;</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">_fork_db</span><span class="p">.</span><span class="n">is_known_block</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="is-known-transaction">
<h3><a class="toc-backref" href="#id16">is_known_transaction</a><a class="headerlink" href="#is-known-transaction" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Only return true <em>if</em> the transaction has not expired or been invalidated. If this method is called with a VERY old transaction we will return false, they should query things by blocks if they are that old.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">is_known_transaction</span><span class="p">(</span> <span class="k">const</span> <span class="n">transaction_id_type</span><span class="o">&amp;</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">trx_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">transaction_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_trx_id</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">return</span> <span class="n">trx_idx</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">id</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">trx_idx</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-block-id-for-num">
<h3><a class="toc-backref" href="#id17">get_block_id_for_num</a><a class="headerlink" href="#get-block-id-for-num" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">block_id_type</span>  <span class="n">database</span><span class="o">::</span><span class="n">get_block_id_for_num</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">block_num</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">fetch_block_id</span><span class="p">(</span> <span class="n">block_num</span> <span class="p">);</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">block_num</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fetch-block-by-id">
<h3><a class="toc-backref" href="#id18">fetch_block_by_id</a><a class="headerlink" href="#fetch-block-by-id" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">optional</span><span class="o">&lt;</span><span class="n">signed_block</span><span class="o">&gt;</span> <span class="n">database</span><span class="o">::</span><span class="n">fetch_block_by_id</span><span class="p">(</span> <span class="k">const</span> <span class="n">block_id_type</span><span class="o">&amp;</span> <span class="n">id</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_fork_db</span><span class="p">.</span><span class="n">fetch_block</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">b</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">fetch_optional</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fetch-block-by-number">
<h3><a class="toc-backref" href="#id19">fetch_block_by_number</a><a class="headerlink" href="#fetch-block-by-number" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">optional</span><span class="o">&lt;</span><span class="n">signed_block</span><span class="o">&gt;</span> <span class="n">database</span><span class="o">::</span><span class="n">fetch_block_by_number</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">num</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">results</span> <span class="o">=</span> <span class="n">_fork_db</span><span class="p">.</span><span class="n">fetch_block_by_number</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">results</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
   <span class="k">else</span>
          <span class="k">return</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">fetch_by_number</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">optional</span><span class="o">&lt;</span><span class="n">signed_block</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-recent-transaction">
<h3><a class="toc-backref" href="#id20">get_recent_transaction</a><a class="headerlink" href="#get-recent-transaction" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_recent_transaction</span><span class="p">(</span><span class="k">const</span> <span class="n">transaction_id_type</span><span class="o">&amp;</span> <span class="n">trx_id</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">transaction_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_trx_id</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">trx_id</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">itr</span> <span class="o">!=</span> <span class="n">index</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
   <span class="k">return</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">trx</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-block-ids-on-fork">
<h3><a class="toc-backref" href="#id21">get_block_ids_on_fork</a><a class="headerlink" href="#get-block-ids-on-fork" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">block_id_type</span><span class="o">&gt;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_block_ids_on_fork</span><span class="p">(</span><span class="n">block_id_type</span> <span class="n">head_of_fork</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="n">pair</span><span class="o">&lt;</span><span class="n">fork_database</span><span class="o">::</span><span class="n">branch_type</span><span class="p">,</span> <span class="n">fork_database</span><span class="o">::</span><span class="n">branch_type</span><span class="o">&gt;</span> <span class="n">branches</span> <span class="o">=</span> <span class="n">_fork_db</span><span class="p">.</span><span class="n">fetch_branch_from</span><span class="p">(</span><span class="n">head_block_id</span><span class="p">(),</span> <span class="n">head_of_fork</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">previous_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">previous_id</span><span class="p">()))</span> <span class="p">)</span>
  <span class="p">{</span>
         <span class="n">edump</span><span class="p">(</span> <span class="p">(</span><span class="n">head_of_fork</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">head_block_id</span><span class="p">())</span>
                        <span class="p">(</span><span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
                        <span class="p">(</span><span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">);</span>
         <span class="n">assert</span><span class="p">(</span><span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">previous_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">previous_id</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">block_id_type</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">item_ptr</span><span class="o">&amp;</span> <span class="nl">fork_block</span> <span class="p">:</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">fork_block</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
  <span class="n">result</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">previous_id</span><span class="p">());</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="push-block">
<h3><a class="toc-backref" href="#id22">push_block</a><a class="headerlink" href="#push-block" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Push block “may fail” in which case every partial change is unwound.  After push block is successful the block is appended to the chain database on disk.</li>
<li>&#64;return true if we switched forks as a result of this push.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">push_block</span><span class="p">(</span><span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">new_block</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">//   idump((new_block.block_num())(new_block.id())(new_block.timestamp)(new_block.previous));</span>
   <span class="kt">bool</span> <span class="n">result</span><span class="p">;</span>
   <span class="n">detail</span><span class="o">::</span><span class="n">with_skip_flags</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
   <span class="p">{</span>
          <span class="n">detail</span><span class="o">::</span><span class="n">without_pending_transactions</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">_pending_tx</span><span class="p">),</span>
          <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
          <span class="p">{</span>
                 <span class="n">result</span> <span class="o">=</span> <span class="n">_push_block</span><span class="p">(</span><span class="n">new_block</span><span class="p">);</span>
          <span class="p">});</span>
   <span class="p">});</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">_push_block</span><span class="p">(</span><span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">new_block</span><span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="kt">uint32_t</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">get_node_properties</span><span class="p">().</span><span class="n">skip_flags</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span><span class="o">&amp;</span><span class="n">skip_fork_db</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="c1">/// TODO: if the block is greater than the head block and before the next maitenance interval</span>
          <span class="c1">// verify that the block signer is in the current set of active witnesses.</span>

          <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">fork_item</span><span class="o">&gt;</span> <span class="n">new_head</span> <span class="o">=</span> <span class="n">_fork_db</span><span class="p">.</span><span class="n">push_block</span><span class="p">(</span><span class="n">new_block</span><span class="p">);</span>
          <span class="c1">//If the head block from the longest chain does not build off of the current head, we need to switch forks.</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">new_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">previous</span> <span class="o">!=</span> <span class="n">head_block_id</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">//If the newly pushed block is the same height as head, we get head back in new_head</span>
                 <span class="c1">//Only switch forks if new_head is actually higher than head</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">new_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">block_num</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Switching to fork: ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">new_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">id</span><span class="p">())</span> <span class="p">);</span>
                        <span class="k">auto</span> <span class="n">branches</span> <span class="o">=</span> <span class="n">_fork_db</span><span class="p">.</span><span class="n">fetch_branch_from</span><span class="p">(</span><span class="n">new_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">id</span><span class="p">(),</span> <span class="n">head_block_id</span><span class="p">());</span>

                        <span class="c1">// pop blocks until we hit the forked block</span>
                        <span class="k">while</span><span class="p">(</span> <span class="n">head_block_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">previous</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;popping block #${n} ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">head_block_id</span><span class="p">())</span> <span class="p">);</span>
                           <span class="n">pop_block</span><span class="p">();</span>
                        <span class="p">}</span>

                        <span class="c1">// push all blocks on the new fork</span>
                        <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">ritr</span> <span class="o">=</span> <span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">ritr</span> <span class="o">!=</span> <span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">rend</span><span class="p">();</span> <span class="o">++</span><span class="n">ritr</span> <span class="p">)</span>
                        <span class="p">{</span>
                                <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;pushing block from fork #${n} ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">block_num</span><span class="p">())(</span><span class="s">&quot;id&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
                                <span class="n">optional</span><span class="o">&lt;</span><span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&gt;</span> <span class="n">except</span><span class="p">;</span>
                                <span class="k">try</span> <span class="p">{</span>
                                   <span class="n">undo_database</span><span class="o">::</span><span class="n">session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>
                                   <span class="n">apply_block</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skip</span> <span class="p">);</span>
                                   <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">store</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span> <span class="p">);</span>
                                   <span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
                                <span class="p">}</span>
                                <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span> <span class="p">{</span> <span class="n">except</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> <span class="p">}</span>
                                <span class="k">if</span><span class="p">(</span> <span class="n">except</span> <span class="p">)</span>
                                <span class="p">{</span>
                                   <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;exception thrown while switching forks ${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span><span class="n">except</span><span class="o">-&gt;</span><span class="n">to_detail_string</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
                                   <span class="c1">// remove the rest of branches.first from the fork_db, those blocks are invalid</span>
                                   <span class="k">while</span><span class="p">(</span> <span class="n">ritr</span> <span class="o">!=</span> <span class="n">branches</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">rend</span><span class="p">()</span> <span class="p">)</span>
                                   <span class="p">{</span>
                                          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;removing block from fork_db #${n} ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">block_num</span><span class="p">())(</span><span class="s">&quot;id&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
                                          <span class="n">_fork_db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">);</span>
                                          <span class="o">++</span><span class="n">ritr</span><span class="p">;</span>
                                   <span class="p">}</span>
                                   <span class="n">_fork_db</span><span class="p">.</span><span class="n">set_head</span><span class="p">(</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="p">);</span>

                                   <span class="c1">// pop all blocks from the bad fork</span>
                                   <span class="k">while</span><span class="p">(</span> <span class="n">head_block_id</span><span class="p">()</span> <span class="o">!=</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">previous</span> <span class="p">)</span>
                                   <span class="p">{</span>
                                          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;popping block #${n} ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">head_block_id</span><span class="p">())</span> <span class="p">);</span>
                                          <span class="n">pop_block</span><span class="p">();</span>
                                   <span class="p">}</span>

                                   <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Switching back to fork: ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">id</span><span class="p">())</span> <span class="p">);</span>
                                   <span class="c1">// restore all blocks from the good fork</span>
                                   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">ritr2</span> <span class="o">=</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">ritr2</span> <span class="o">!=</span> <span class="n">branches</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">rend</span><span class="p">();</span> <span class="o">++</span><span class="n">ritr2</span> <span class="p">)</span>
                                   <span class="p">{</span>
                                          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;pushing block #${n} ${id}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">ritr2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">block_num</span><span class="p">())(</span><span class="s">&quot;id&quot;</span><span class="p">,(</span><span class="o">*</span><span class="n">ritr2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
                                          <span class="k">auto</span> <span class="n">session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>
                                          <span class="n">apply_block</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skip</span> <span class="p">);</span>
                                          <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">store</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">ritr2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span> <span class="p">);</span>
                                          <span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
                                   <span class="p">}</span>
                                   <span class="k">throw</span> <span class="o">*</span><span class="n">except</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="k">else</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">try</span> <span class="p">{</span>
          <span class="k">auto</span> <span class="n">session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>
          <span class="n">apply_block</span><span class="p">(</span><span class="n">new_block</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
          <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">new_block</span><span class="p">.</span><span class="n">id</span><span class="p">(),</span> <span class="n">new_block</span><span class="p">);</span>
          <span class="n">session</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">elog</span><span class="p">(</span><span class="s">&quot;Failed to push new block:</span><span class="se">\n</span><span class="s">${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">()));</span>
          <span class="n">_fork_db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">new_block</span><span class="p">.</span><span class="n">id</span><span class="p">());</span>
          <span class="k">throw</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">new_block</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="push-transaction">
<h3><a class="toc-backref" href="#id23">push_transaction</a><a class="headerlink" href="#push-transaction" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Attempts to push the transaction into the pending queue When called to push a locally generated transaction, set the skip_block_size_check bit on the skip argument. This will allow the transaction to be pushed even if it causes the pending block size to exceed the maximum block size.</li>
<li>Although the transaction will probably not propagate further now, as the peers are likely to have their pending queues full as well, it will be kept in the queue to be propagated later when a new block flushes out the pending  queues.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">processed_transaction</span> <span class="n">database</span><span class="o">::</span><span class="n">push_transaction</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">trx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">skip</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">processed_transaction</span> <span class="n">result</span><span class="p">;</span>
   <span class="n">detail</span><span class="o">::</span><span class="n">with_skip_flags</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
   <span class="p">{</span>
          <span class="n">result</span> <span class="o">=</span> <span class="n">_push_transaction</span><span class="p">(</span> <span class="n">trx</span> <span class="p">);</span>
   <span class="p">}</span> <span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">trx</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>


<span class="n">processed_transaction</span> <span class="n">database</span><span class="o">::</span><span class="n">_push_transaction</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">trx</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// If this is the first transaction pushed after applying a block, start a new undo session.</span>
   <span class="c1">// This allows us to quickly rewind to the clean state of the head block, in case a new block arrives.</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">_pending_tx_session</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">_pending_tx_session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>

   <span class="c1">// Create a temporary undo session as a child of _pending_tx_session.</span>
   <span class="c1">// The temporary session will be discarded by the destructor if</span>
   <span class="c1">// _apply_transaction fails.  If we make it to merge(), we</span>
   <span class="c1">// apply the changes.</span>

   <span class="k">auto</span> <span class="n">temp_session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">processed_trx</span> <span class="o">=</span> <span class="n">_apply_transaction</span><span class="p">(</span> <span class="n">trx</span> <span class="p">);</span>
   <span class="n">_pending_tx</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">processed_trx</span><span class="p">);</span>

   <span class="c1">// notify_changed_objects();</span>
   <span class="c1">// The transaction applied successfully. Merge its changes into the pending block session.</span>
   <span class="n">temp_session</span><span class="p">.</span><span class="n">merge</span><span class="p">();</span>

   <span class="c1">// notify anyone listening to pending transactions</span>
   <span class="n">notify_on_pending_transaction</span><span class="p">(</span> <span class="n">trx</span> <span class="p">);</span>
   <span class="k">return</span> <span class="n">processed_trx</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="validate-transaction">
<h3><a class="toc-backref" href="#id24">validate_transaction</a><a class="headerlink" href="#validate-transaction" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">processed_transaction</span> <span class="n">database</span><span class="o">::</span><span class="n">validate_transaction</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">trx</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>
   <span class="k">return</span> <span class="nf">_apply_transaction</span><span class="p">(</span> <span class="n">trx</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="push-proposal-nesting-guard">
<h3><a class="toc-backref" href="#id25">push_proposal_nesting_guard</a><a class="headerlink" href="#push-proposal-nesting-guard" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">push_proposal_nesting_guard</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
   <span class="n">push_proposal_nesting_guard</span><span class="p">(</span> <span class="kt">uint32_t</span><span class="o">&amp;</span> <span class="n">nesting_counter</span><span class="p">,</span> <span class="k">const</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
          <span class="o">:</span> <span class="n">orig_value</span><span class="p">(</span><span class="n">nesting_counter</span><span class="p">),</span> <span class="n">counter</span><span class="p">(</span><span class="n">nesting_counter</span><span class="p">)</span>
   <span class="p">{</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">db</span><span class="p">.</span><span class="n">get_global_properties</span><span class="p">().</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Max proposal nesting depth exceeded!&quot;</span> <span class="p">);</span>
          <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="o">~</span><span class="n">push_proposal_nesting_guard</span><span class="p">()</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="n">counter</span> <span class="o">!=</span> <span class="n">orig_value</span> <span class="p">)</span>
                 <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;Unexpected proposal nesting count value: ${n} != ${o}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">counter</span><span class="p">)(</span><span class="s">&quot;o&quot;</span><span class="p">,</span><span class="n">orig_value</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
        <span class="k">const</span> <span class="kt">uint32_t</span>  <span class="n">orig_value</span><span class="p">;</span>
        <span class="kt">uint32_t</span><span class="o">&amp;</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="push-proposal">
<h3><a class="toc-backref" href="#id26">push_proposal</a><a class="headerlink" href="#push-proposal" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">processed_transaction</span> <span class="n">database</span><span class="o">::</span><span class="n">push_proposal</span><span class="p">(</span><span class="k">const</span> <span class="n">proposal_object</span><span class="o">&amp;</span> <span class="n">proposal</span><span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">transaction_evaluation_state</span> <span class="n">eval_state</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
   <span class="n">eval_state</span><span class="p">.</span><span class="n">_is_proposed_trx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

   <span class="n">eval_state</span><span class="p">.</span><span class="n">operation_results</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">proposal</span><span class="p">.</span><span class="n">proposed_transaction</span><span class="p">.</span><span class="n">operations</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
   <span class="n">processed_transaction</span> <span class="nf">ptrx</span><span class="p">(</span><span class="n">proposal</span><span class="p">.</span><span class="n">proposed_transaction</span><span class="p">);</span>
   <span class="n">eval_state</span><span class="p">.</span><span class="n">_trx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ptrx</span><span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">old_applied_ops_size</span> <span class="o">=</span> <span class="n">_applied_ops</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

   <span class="k">try</span> <span class="p">{</span>
          <span class="n">push_proposal_nesting_guard</span> <span class="n">guard</span><span class="p">(</span> <span class="n">_push_proposal_nesting_depth</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">max_size</span><span class="p">()</span> <span class="p">)</span>
                 <span class="n">_undo_db</span><span class="p">.</span><span class="n">set_max_size</span><span class="p">(</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="k">auto</span> <span class="n">session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">op</span> <span class="p">:</span> <span class="n">proposal</span><span class="p">.</span><span class="n">proposed_transaction</span><span class="p">.</span><span class="n">operations</span> <span class="p">)</span>
                 <span class="n">eval_state</span><span class="p">.</span><span class="n">operation_results</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">eval_state</span><span class="p">,</span> <span class="n">op</span><span class="p">));</span>
          <span class="n">remove</span><span class="p">(</span><span class="n">proposal</span><span class="p">);</span>
          <span class="n">session</span><span class="p">.</span><span class="n">merge</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_483_TIME</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">for</span><span class="p">(</span> <span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="n">old_applied_ops_size</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">_applied_ops</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;removing failed operation from applied_ops: ${op}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;op&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_applied_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">);</span>
                        <span class="n">_applied_ops</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reset</span><span class="p">();</span>
                 <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="n">_applied_ops</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">old_applied_ops_size</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">throw</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">ptrx</span><span class="p">.</span><span class="n">operation_results</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">eval_state</span><span class="p">.</span><span class="n">operation_results</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">ptrx</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">proposal</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-block">
<h3><a class="toc-backref" href="#id27">generate_block</a><a class="headerlink" href="#generate-block" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">signed_block</span> <span class="n">database</span><span class="o">::</span><span class="n">generate_block</span><span class="p">(</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">when</span><span class="p">,</span>
   <span class="n">witness_id_type</span> <span class="n">witness_id</span><span class="p">,</span>
   <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">ecc</span><span class="o">::</span><span class="n">private_key</span><span class="o">&amp;</span> <span class="n">block_signing_private_key</span><span class="p">,</span>
   <span class="kt">uint32_t</span> <span class="n">skip</span> <span class="cm">/* = 0 */</span>
   <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">signed_block</span> <span class="n">result</span><span class="p">;</span>
   <span class="n">detail</span><span class="o">::</span><span class="n">with_skip_flags</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
   <span class="p">{</span>
          <span class="n">result</span> <span class="o">=</span> <span class="n">_generate_block</span><span class="p">(</span> <span class="n">when</span><span class="p">,</span> <span class="n">witness_id</span><span class="p">,</span> <span class="n">block_signing_private_key</span> <span class="p">);</span>
   <span class="p">}</span> <span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>


<span class="n">signed_block</span> <span class="n">database</span><span class="o">::</span><span class="n">_generate_block</span><span class="p">(</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">when</span><span class="p">,</span>
   <span class="n">witness_id_type</span> <span class="n">witness_id</span><span class="p">,</span>
   <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">ecc</span><span class="o">::</span><span class="n">private_key</span><span class="o">&amp;</span> <span class="n">block_signing_private_key</span>
   <span class="p">)</span>
<span class="p">{</span>
   <span class="k">try</span> <span class="p">{</span>
   <span class="kt">uint32_t</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">get_node_properties</span><span class="p">().</span><span class="n">skip_flags</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">slot_num</span> <span class="o">=</span> <span class="n">get_slot_at_time</span><span class="p">(</span> <span class="n">when</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">slot_num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">witness_id_type</span> <span class="n">scheduled_witness</span> <span class="o">=</span> <span class="n">get_scheduled_witness</span><span class="p">(</span> <span class="n">slot_num</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">scheduled_witness</span> <span class="o">==</span> <span class="n">witness_id</span> <span class="p">);</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">witness_obj</span> <span class="o">=</span> <span class="n">witness_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="n">skip_witness_signature</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">witness_obj</span><span class="p">.</span><span class="n">signing_key</span> <span class="o">==</span> <span class="n">block_signing_private_key</span><span class="p">.</span><span class="n">get_public_key</span><span class="p">()</span> <span class="p">);</span>

   <span class="k">static</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">max_block_header_size</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack_size</span><span class="p">(</span> <span class="n">signed_block_header</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">maximum_block_size</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">maximum_block_size</span><span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">total_block_size</span> <span class="o">=</span> <span class="n">max_block_header_size</span><span class="p">;</span>

   <span class="n">signed_block</span> <span class="n">pending_block</span><span class="p">;</span>

   <span class="c1">//</span>
   <span class="c1">// The following code throws away existing pending_tx_session and</span>
   <span class="c1">// rebuilds it by re-applying pending transactions.</span>
   <span class="c1">//</span>
   <span class="c1">// This rebuild is necessary because pending transactions&#39; validity</span>
   <span class="c1">// and semantics may have changed since they were received, because</span>
   <span class="c1">// time-based semantics are evaluated based on the current block</span>
   <span class="c1">// time.  These changes can only be reflected in the database when</span>
   <span class="c1">// the value of the &quot;when&quot; variable is known, which means we need to</span>
   <span class="c1">// re-apply pending transactions in this method.</span>
   <span class="c1">//</span>
   <span class="n">_pending_tx_session</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
   <span class="n">_pending_tx_session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>

   <span class="kt">uint64_t</span> <span class="n">postponed_tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="c1">// pop pending state (reset to head block state)</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">processed_transaction</span><span class="o">&amp;</span> <span class="nl">tx</span> <span class="p">:</span> <span class="n">_pending_tx</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="kt">size_t</span> <span class="n">new_total_size</span> <span class="o">=</span> <span class="n">total_block_size</span> <span class="o">+</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack_size</span><span class="p">(</span> <span class="n">tx</span> <span class="p">);</span>

          <span class="c1">// postpone transaction if it would make block too big</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">new_total_size</span> <span class="o">&gt;=</span> <span class="n">maximum_block_size</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">postponed_tx_count</span><span class="o">++</span><span class="p">;</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">try</span>
          <span class="p">{</span>
                 <span class="k">auto</span> <span class="n">temp_session</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">start_undo_session</span><span class="p">();</span>
                 <span class="n">processed_transaction</span> <span class="n">ptx</span> <span class="o">=</span> <span class="n">_apply_transaction</span><span class="p">(</span> <span class="n">tx</span> <span class="p">);</span>
                 <span class="n">temp_session</span><span class="p">.</span><span class="n">merge</span><span class="p">();</span>

                 <span class="c1">// We have to recompute pack_size(ptx) because it may be different</span>
                 <span class="c1">// than pack_size(tx) (i.e. if one or more results increased</span>
                 <span class="c1">// their size)</span>
                 <span class="n">total_block_size</span> <span class="o">+=</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack_size</span><span class="p">(</span> <span class="n">ptx</span> <span class="p">);</span>
                 <span class="n">pending_block</span><span class="p">.</span><span class="n">transactions</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">ptx</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// Do nothing, transaction will not be re-applied</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Transaction was not processed while generating block due to ${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">);</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;The transaction was ${t}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">postponed_tx_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Postponed ${n} transactions due to block size limit&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">postponed_tx_count</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="n">_pending_tx_session</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>

   <span class="c1">// We have temporarily broken the invariant that</span>
   <span class="c1">// _pending_tx_session is the result of applying _pending_tx, as</span>
   <span class="c1">// _pending_tx now consists of the set of postponed transactions.</span>
   <span class="c1">// However, the push_block() call below will re-create the</span>
   <span class="c1">// _pending_tx_session.</span>

   <span class="n">pending_block</span><span class="p">.</span><span class="n">previous</span> <span class="o">=</span> <span class="n">head_block_id</span><span class="p">();</span>
   <span class="n">pending_block</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">when</span><span class="p">;</span>
   <span class="n">pending_block</span><span class="p">.</span><span class="n">transaction_merkle_root</span> <span class="o">=</span> <span class="n">pending_block</span><span class="p">.</span><span class="n">calculate_merkle_root</span><span class="p">();</span>
   <span class="n">pending_block</span><span class="p">.</span><span class="n">witness</span> <span class="o">=</span> <span class="n">witness_id</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="n">skip_witness_signature</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">pending_block</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span> <span class="n">block_signing_private_key</span> <span class="p">);</span>

   <span class="c1">// TODO:  Move this to _push_block() so session is restored.</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="n">skip_block_size_check</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">raw</span><span class="o">::</span><span class="n">pack_size</span><span class="p">(</span><span class="n">pending_block</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">maximum_block_size</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="n">push_block</span><span class="p">(</span> <span class="n">pending_block</span><span class="p">,</span> <span class="n">skip</span> <span class="p">);</span>

   <span class="k">return</span> <span class="n">pending_block</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">witness_id</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pop-block">
<h3><a class="toc-backref" href="#id28">pop_block</a><a class="headerlink" href="#pop-block" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Removes the most recent block from the database and undoes any changes it made.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">pop_block</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">_pending_tx_session</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_block_id</span><span class="p">();</span>
   <span class="n">optional</span><span class="o">&lt;</span><span class="n">signed_block</span><span class="o">&gt;</span> <span class="n">head_block</span> <span class="o">=</span> <span class="n">fetch_block_by_id</span><span class="p">(</span> <span class="n">head_id</span> <span class="p">);</span>
   <span class="n">GRAPHENE_ASSERT</span><span class="p">(</span> <span class="n">head_block</span><span class="p">.</span><span class="n">valid</span><span class="p">(),</span> <span class="n">pop_empty_chain</span><span class="p">,</span> <span class="s">&quot;there are no blocks to pop&quot;</span> <span class="p">);</span>

   <span class="n">_fork_db</span><span class="p">.</span><span class="n">pop_block</span><span class="p">();</span>
   <span class="n">pop_undo</span><span class="p">();</span>

   <span class="n">_popped_tx</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">_popped_tx</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">head_block</span><span class="o">-&gt;</span><span class="n">transactions</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">head_block</span><span class="o">-&gt;</span><span class="n">transactions</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>

<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="clear-pending">
<h3><a class="toc-backref" href="#id29">clear_pending</a><a class="headerlink" href="#clear-pending" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">clear_pending</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">assert</span><span class="p">(</span> <span class="p">(</span><span class="n">_pending_tx</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">_pending_tx_session</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">_pending_tx</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
   <span class="n">_pending_tx_session</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="push-applied-operation">
<h3><a class="toc-backref" href="#id30">push_applied_operation</a><a class="headerlink" href="#push-applied-operation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span> <span class="n">database</span><span class="o">::</span><span class="n">push_applied_operation</span><span class="p">(</span> <span class="k">const</span> <span class="n">operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">_applied_ops</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
   <span class="n">operation_history_object</span><span class="o">&amp;</span> <span class="n">oh</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_applied_ops</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
   <span class="n">oh</span><span class="p">.</span><span class="n">block_num</span>    <span class="o">=</span> <span class="n">_current_block_num</span><span class="p">;</span>
   <span class="n">oh</span><span class="p">.</span><span class="n">trx_in_block</span> <span class="o">=</span> <span class="n">_current_trx_in_block</span><span class="p">;</span>
   <span class="n">oh</span><span class="p">.</span><span class="n">op_in_trx</span>    <span class="o">=</span> <span class="n">_current_op_in_trx</span><span class="p">;</span>
   <span class="n">oh</span><span class="p">.</span><span class="n">virtual_op</span>   <span class="o">=</span> <span class="n">_current_virtual_op</span><span class="o">++</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">_applied_ops</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="set-applied-operation-result">
<h3><a class="toc-backref" href="#id31">set_applied_operation_result</a><a class="headerlink" href="#set-applied-operation-result" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">set_applied_operation_result</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">op_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">operation_result</span><span class="o">&amp;</span> <span class="n">result</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">assert</span><span class="p">(</span> <span class="n">op_id</span> <span class="o">&lt;</span> <span class="n">_applied_ops</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_applied_ops</span><span class="p">[</span><span class="n">op_id</span><span class="p">]</span> <span class="p">)</span>
          <span class="n">_applied_ops</span><span class="p">[</span><span class="n">op_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
   <span class="k">else</span>
   <span class="p">{</span>
          <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;Could not set operation result (head_block_num=${b})&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-applied-operations">
<h3><a class="toc-backref" href="#id32">get_applied_operations</a><a class="headerlink" href="#get-applied-operations" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">optional</span><span class="o">&lt;</span> <span class="n">operation_history_object</span> <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_applied_operations</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">_applied_ops</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apply-block">
<h3><a class="toc-backref" href="#id33">apply_block</a><a class="headerlink" href="#apply-block" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>//////////////////// private methods ////////////////////</p>
<p>void database::apply_block( const signed_block&amp; next_block, uint32_t skip )
{</p>
<blockquote>
<div><p>auto block_num = next_block.block_num();
if( _checkpoints.size() &amp;&amp; _checkpoints.rbegin()-&gt;second != block_id_type() )
{</p>
<blockquote>
<div><p>auto itr = _checkpoints.find( block_num );
if( itr != _checkpoints.end() )</p>
<blockquote>
<div>FC_ASSERT( next_block.id() == itr-&gt;second, “Block did not match checkpoint”, (“checkpoint”,*itr)(“block_id”,next_block.id()) );</div></blockquote>
<dl class="docutils">
<dt>if( _checkpoints.rbegin()-&gt;first &gt;= block_num )</dt>
<dd>skip = ~0;// WE CAN SKIP ALMOST EVERYTHING</dd>
</dl>
</div></blockquote>
<p>}</p>
<p>detail::with_skip_flags( <a href="#id2"><span class="problematic" id="id3">*</span></a>this, skip, [&amp;]()
{</p>
<blockquote>
<div>_apply_block( next_block );</div></blockquote>
<p>} );
return;</p>
</div></blockquote>
<p>}</p>
<p>void database::_apply_block( const signed_block&amp; next_block )
{ try {</p>
<blockquote>
<div><p>uint32_t next_block_num = next_block.block_num();
uint32_t skip = get_node_properties().skip_flags;
_applied_ops.clear();</p>
<p>FC_ASSERT( (skip &amp; skip_merkle_check) || next_block.transaction_merkle_root == next_block.calculate_merkle_root(), “”, (“next_block.transaction_merkle_root”,next_block.transaction_merkle_root)(“calc”,next_block.calculate_merkle_root())(“next_block”,next_block)(“id”,next_block.id()) );</p>
<p>const witness_object&amp; signing_witness = validate_block_header(skip, next_block);
const auto&amp; global_props = get_global_properties();
const auto&amp; dynamic_global_props = get_dynamic_global_properties();
bool maint_needed = (dynamic_global_props.next_maintenance_time &lt;= next_block.timestamp);</p>
<p>_current_block_num    = next_block_num;
_current_trx_in_block = 0;</p>
<p>_issue_453_affected_assets.clear();</p>
<p>for( const auto&amp; trx : next_block.transactions )
{</p>
<blockquote>
<div><dl class="docutils">
<dt>/* We do not need to push the undo state for each transaction</dt>
<dd><ul class="first simple">
<li>because they either all apply and are valid or the</li>
<li>entire block fails to apply.  We only need an “undo” state</li>
<li>for transactions when validating broadcast transactions or</li>
<li>when building a block.</li>
</ul>
<p class="last"><a href="#id4"><span class="problematic" id="id5">*</span></a>/</p>
</dd>
</dl>
<p>apply_transaction( trx, skip );
++_current_trx_in_block;</p>
</div></blockquote>
<p>}</p>
<p>const uint32_t missed = update_witness_missed_blocks( next_block );
update_global_dynamic_data( next_block, missed );
update_signing_witness(signing_witness, next_block);
update_last_irreversible_block();</p>
<p>// Are we at the maintenance interval?
if( maint_needed )</p>
<blockquote>
<div>perform_chain_maintenance(next_block, global_props);</div></blockquote>
<p>create_block_summary(next_block);
clear_expired_transactions();
clear_expired_proposals();
clear_expired_orders();
update_expired_feeds();       // this will update expired feeds and some core exchange rates
update_core_exchange_rates(); // this will update remaining core exchange rates
update_withdraw_permissions();</p>
<p>// n.b., update_maintenance_flag() happens this late
// because get_slot_time() / get_slot_at_time() is needed above
// TODO:  figure out if we could collapse this function into
// update_global_dynamic_data() as perhaps these methods only need
// to be called for header validation?
update_maintenance_flag( maint_needed );
update_witness_schedule();
if( !_node_property_object.debug_updates.empty() )</p>
<blockquote>
<div>apply_debug_updates();</div></blockquote>
<p>// notify observers that the block has been applied
notify_applied_block( next_block ); //emit
_applied_ops.clear();</p>
<p>notify_changed_objects();</p>
</div></blockquote>
<p>} FC_CAPTURE_AND_RETHROW( (next_block.block_num()) )  }</p>
</div></blockquote>
</div>
<div class="section" id="apply-transaction">
<h3><a class="toc-backref" href="#id34">apply_transaction</a><a class="headerlink" href="#apply-transaction" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">processed_transaction</span> <span class="n">database</span><span class="o">::</span><span class="n">apply_transaction</span><span class="p">(</span><span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">trx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">processed_transaction</span> <span class="n">result</span><span class="p">;</span>
   <span class="n">detail</span><span class="o">::</span><span class="n">with_skip_flags</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
   <span class="p">{</span>
          <span class="n">result</span> <span class="o">=</span> <span class="n">_apply_transaction</span><span class="p">(</span><span class="n">trx</span><span class="p">);</span>
   <span class="p">});</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">processed_transaction</span> <span class="n">database</span><span class="o">::</span><span class="n">_apply_transaction</span><span class="p">(</span><span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">trx</span><span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="kt">uint32_t</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">get_node_properties</span><span class="p">().</span><span class="n">skip_flags</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="nb">true</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span><span class="o">&amp;</span><span class="n">skip_validate</span><span class="p">)</span> <span class="p">)</span>   <span class="cm">/* issue #505 explains why this skip_flag is disabled */</span>
          <span class="n">trx</span><span class="p">.</span><span class="n">validate</span><span class="p">();</span>

   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">trx_idx</span> <span class="o">=</span> <span class="n">get_mutable_index_type</span><span class="o">&lt;</span><span class="n">transaction_index</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">chain_id_type</span><span class="o">&amp;</span> <span class="n">chain_id</span> <span class="o">=</span> <span class="n">get_chain_id</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">trx_id</span> <span class="o">=</span> <span class="n">trx</span><span class="p">.</span><span class="n">id</span><span class="p">();</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="n">skip_transaction_dupe_check</span><span class="p">)</span> <span class="o">||</span>
                          <span class="n">trx_idx</span><span class="p">.</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_trx_id</span><span class="o">&gt;</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="n">trx_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">trx_idx</span><span class="p">.</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_trx_id</span><span class="o">&gt;</span><span class="p">().</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">transaction_evaluation_state</span> <span class="nf">eval_state</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">chain_parameters</span><span class="o">&amp;</span> <span class="n">chain_parameters</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">;</span>
   <span class="n">eval_state</span><span class="p">.</span><span class="n">_trx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">trx</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">skip_transaction_signatures</span> <span class="o">|</span> <span class="n">skip_authority_check</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">auto</span> <span class="n">get_active</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_id_type</span> <span class="n">id</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">active</span><span class="p">;</span> <span class="p">};</span>
          <span class="k">auto</span> <span class="n">get_owner</span>  <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_id_type</span> <span class="n">id</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">owner</span><span class="p">;</span>  <span class="p">};</span>
          <span class="n">trx</span><span class="p">.</span><span class="n">verify_authority</span><span class="p">(</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">get_active</span><span class="p">,</span> <span class="n">get_owner</span><span class="p">,</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">max_authority_depth</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">//Skip all manner of expiration and TaPoS checking if we&#39;re on block 1; It&#39;s impossible that the transaction is</span>
   <span class="c1">//expired, and TaPoS makes no sense as no blocks exist.</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">BOOST_LIKELY</span><span class="p">(</span><span class="n">head_block_num</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="n">skip_tapos_check</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">tapos_block_summary</span> <span class="o">=</span> <span class="n">block_summary_id_type</span><span class="p">(</span> <span class="n">trx</span><span class="p">.</span><span class="n">ref_block_num</span> <span class="p">)(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

                 <span class="c1">//Verify TaPoS block summary has correct ID prefix, and that this block&#39;s time is not past the expiration</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">trx</span><span class="p">.</span><span class="n">ref_block_prefix</span> <span class="o">==</span> <span class="n">tapos_block_summary</span><span class="p">.</span><span class="n">block_id</span><span class="p">.</span><span class="n">_hash</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">now</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>

          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">trx</span><span class="p">.</span><span class="n">expiration</span> <span class="o">&lt;=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">chain_parameters</span><span class="p">.</span><span class="n">maximum_time_until_expiration</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s">&quot;trx.expiration&quot;</span><span class="p">,</span><span class="n">trx</span><span class="p">.</span><span class="n">expiration</span><span class="p">)(</span><span class="s">&quot;now&quot;</span><span class="p">,</span><span class="n">now</span><span class="p">)(</span><span class="s">&quot;max_til_exp&quot;</span><span class="p">,</span><span class="n">chain_parameters</span><span class="p">.</span><span class="n">maximum_time_until_expiration</span><span class="p">));</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="n">trx</span><span class="p">.</span><span class="n">expiration</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;now&quot;</span><span class="p">,</span><span class="n">now</span><span class="p">)(</span><span class="s">&quot;trx.exp&quot;</span><span class="p">,</span><span class="n">trx</span><span class="p">.</span><span class="n">expiration</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">//Insert transaction into unique transactions database.</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span> <span class="o">&amp;</span> <span class="n">skip_transaction_dupe_check</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">transaction_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">transaction_object</span><span class="o">&amp;</span> <span class="n">transaction</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">transaction</span><span class="p">.</span><span class="n">trx_id</span> <span class="o">=</span> <span class="n">trx_id</span><span class="p">;</span>
                 <span class="n">transaction</span><span class="p">.</span><span class="n">trx</span> <span class="o">=</span> <span class="n">trx</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>

   <span class="n">eval_state</span><span class="p">.</span><span class="n">operation_results</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">trx</span><span class="p">.</span><span class="n">operations</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

   <span class="c1">//Finally process the operations</span>
   <span class="n">processed_transaction</span> <span class="nf">ptrx</span><span class="p">(</span><span class="n">trx</span><span class="p">);</span>
   <span class="n">_current_op_in_trx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">op</span> <span class="p">:</span> <span class="n">ptrx</span><span class="p">.</span><span class="n">operations</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">eval_state</span><span class="p">.</span><span class="n">operation_results</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">eval_state</span><span class="p">,</span> <span class="n">op</span><span class="p">));</span>
          <span class="o">++</span><span class="n">_current_op_in_trx</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">ptrx</span><span class="p">.</span><span class="n">operation_results</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">eval_state</span><span class="p">.</span><span class="n">operation_results</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">HARDFORK_CORE_1040_TIME</span> <span class="p">)</span> <span class="c1">// TODO totally remove this code block after hard fork</span>
   <span class="p">{</span>
          <span class="c1">//Make sure the temp account has no non-zero balances</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_balance_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_account_asset</span><span class="o">&gt;</span><span class="p">();</span>
          <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">equal_range</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">GRAPHENE_TEMP_ACCOUNT</span> <span class="p">)</span> <span class="p">);</span>
          <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="p">[](</span><span class="k">const</span> <span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="p">});</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">ptrx</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">trx</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apply-operation">
<h3><a class="toc-backref" href="#id35">apply_operation</a><a class="headerlink" href="#apply-operation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">operation_result</span> <span class="n">database</span><span class="o">::</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">transaction_evaluation_state</span><span class="o">&amp;</span> <span class="n">eval_state</span><span class="p">,</span> <span class="k">const</span> <span class="n">operation</span><span class="o">&amp;</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">i_which</span> <span class="o">=</span> <span class="n">op</span><span class="p">.</span><span class="n">which</span><span class="p">();</span>
   <span class="kt">uint64_t</span> <span class="n">u_which</span> <span class="o">=</span> <span class="kt">uint64_t</span><span class="p">(</span> <span class="n">i_which</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">i_which</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Negative operation tag in operation ${op}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;op&quot;</span><span class="p">,</span><span class="n">op</span><span class="p">)</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">u_which</span> <span class="o">&lt;</span> <span class="n">_operation_evaluators</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="s">&quot;No registered evaluator for operation ${op}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;op&quot;</span><span class="p">,</span><span class="n">op</span><span class="p">)</span> <span class="p">);</span>
   <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">op_evaluator</span><span class="o">&gt;&amp;</span> <span class="n">eval</span> <span class="o">=</span> <span class="n">_operation_evaluators</span><span class="p">[</span> <span class="n">u_which</span> <span class="p">];</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">eval</span><span class="p">,</span> <span class="s">&quot;No registered evaluator for operation ${op}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;op&quot;</span><span class="p">,</span><span class="n">op</span><span class="p">)</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">op_id</span> <span class="o">=</span> <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">op</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">eval</span><span class="o">-&gt;</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">eval_state</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="nb">true</span> <span class="p">);</span>
   <span class="n">set_applied_operation_result</span><span class="p">(</span> <span class="n">op_id</span><span class="p">,</span> <span class="n">result</span> <span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="validate-block-header">
<h3><a class="toc-backref" href="#id36">validate_block_header</a><a class="headerlink" href="#validate-block-header" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">validate_block_header</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">skip</span><span class="p">,</span> <span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">next_block</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">head_block_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">next_block</span><span class="p">.</span><span class="n">previous</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;head_block_id&quot;</span><span class="p">,</span><span class="n">head_block_id</span><span class="p">())(</span><span class="s">&quot;next.prev&quot;</span><span class="p">,</span><span class="n">next_block</span><span class="p">.</span><span class="n">previous</span><span class="p">)</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">next_block</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;head_block_time&quot;</span><span class="p">,</span><span class="n">head_block_time</span><span class="p">())(</span><span class="s">&quot;next&quot;</span><span class="p">,</span><span class="n">next_block</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)(</span><span class="s">&quot;blocknum&quot;</span><span class="p">,</span><span class="n">next_block</span><span class="p">.</span><span class="n">block_num</span><span class="p">())</span> <span class="p">);</span>
   <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">witness</span> <span class="o">=</span> <span class="n">next_block</span><span class="p">.</span><span class="n">witness</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span><span class="o">&amp;</span><span class="n">skip_witness_signature</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">next_block</span><span class="p">.</span><span class="n">validate_signee</span><span class="p">(</span> <span class="n">witness</span><span class="p">.</span><span class="n">signing_key</span> <span class="p">)</span> <span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">skip</span><span class="o">&amp;</span><span class="n">skip_witness_schedule_check</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="kt">uint32_t</span> <span class="n">slot_num</span> <span class="o">=</span> <span class="n">get_slot_at_time</span><span class="p">(</span> <span class="n">next_block</span><span class="p">.</span><span class="n">timestamp</span> <span class="p">);</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">slot_num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>

          <span class="n">witness_id_type</span> <span class="n">scheduled_witness</span> <span class="o">=</span> <span class="n">get_scheduled_witness</span><span class="p">(</span> <span class="n">slot_num</span> <span class="p">);</span>

          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">next_block</span><span class="p">.</span><span class="n">witness</span> <span class="o">==</span> <span class="n">scheduled_witness</span><span class="p">,</span> <span class="s">&quot;Witness produced block at wrong time&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s">&quot;block witness&quot;</span><span class="p">,</span><span class="n">next_block</span><span class="p">.</span><span class="n">witness</span><span class="p">)(</span><span class="s">&quot;scheduled&quot;</span><span class="p">,</span><span class="n">scheduled_witness</span><span class="p">)(</span><span class="s">&quot;slot_num&quot;</span><span class="p">,</span><span class="n">slot_num</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">witness</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="create-block-summary">
<h3><a class="toc-backref" href="#id37">create_block_summary</a><a class="headerlink" href="#create-block-summary" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">create_block_summary</span><span class="p">(</span><span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">next_block</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">block_summary_id_type</span> <span class="n">sid</span><span class="p">(</span><span class="n">next_block</span><span class="p">.</span><span class="n">block_num</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span> <span class="p">);</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">sid</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">block_summary_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">p</span><span class="p">.</span><span class="n">block_id</span> <span class="o">=</span> <span class="n">next_block</span><span class="p">.</span><span class="n">id</span><span class="p">();</span>
   <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="add-checkpoints">
<h3><a class="toc-backref" href="#id38">add_checkpoints</a><a class="headerlink" href="#add-checkpoints" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">add_checkpoints</span><span class="p">(</span> <span class="k">const</span> <span class="n">flat_map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="n">block_id_type</span><span class="o">&gt;&amp;</span> <span class="n">checkpts</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">i</span> <span class="p">:</span> <span class="n">checkpts</span> <span class="p">)</span>
          <span class="n">_checkpoints</span><span class="p">[</span><span class="n">i</span><span class="p">.</span><span class="n">first</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="before-last-checkpoint">
<h3><a class="toc-backref" href="#id39">before_last_checkpoint</a><a class="headerlink" href="#before-last-checkpoint" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">before_last_checkpoint</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">_checkpoints</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_checkpoints</span><span class="p">.</span><span class="n">rbegin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">&gt;=</span> <span class="n">head_block_num</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-debug-cpp">
<h2><a class="toc-backref" href="#id40">db_debug.cpp</a><a class="headerlink" href="#db-debug-cpp" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>This method dumps the state of the blockchain in a semi-human readable form for the purpose of tracking down funds and mismatches in currency allocation</li>
</ul>
<div class="section" id="debug-dump">
<h3><a class="toc-backref" href="#id41">debug_dump</a><a class="headerlink" href="#debug-dump" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">debug_dump</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">db</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">core_asset_data</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_core_asset</span><span class="p">().</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">balance_index</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_balance_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">statistics_index</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_stats_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bids</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">collateral_bid_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">settle_index</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">force_settlement_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
   <span class="n">map</span><span class="o">&lt;</span><span class="n">asset_id_type</span><span class="p">,</span><span class="n">share_type</span><span class="o">&gt;</span> <span class="n">total_balances</span><span class="p">;</span>
   <span class="n">map</span><span class="o">&lt;</span><span class="n">asset_id_type</span><span class="p">,</span><span class="n">share_type</span><span class="o">&gt;</span> <span class="n">total_debts</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">core_in_orders</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">reported_core_in_orders</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">balance_index</span> <span class="p">)</span>
   <span class="p">{</span>
        <span class="c1">//  idump((&quot;balance&quot;)(a));</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">asset_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="p">.</span><span class="n">balance</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">force_settlement_object</span><span class="o">&amp;</span> <span class="nl">s</span> <span class="p">:</span> <span class="n">settle_index</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">vesting_balance_object</span><span class="o">&amp;</span> <span class="nl">vbo</span> <span class="p">:</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">vesting_balance_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">total_balances</span><span class="p">[</span> <span class="n">vbo</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">vbo</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="nl">fba</span> <span class="p">:</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">simple_index</span><span class="o">&lt;</span> <span class="n">fba_accumulator_object</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">total_balances</span><span class="p">[</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="nl">s</span> <span class="p">:</span> <span class="n">statistics_index</span> <span class="p">)</span>
   <span class="p">{</span>
        <span class="c1">//  idump((&quot;statistics&quot;)(s));</span>
          <span class="n">reported_core_in_orders</span> <span class="o">+=</span> <span class="n">s</span><span class="p">.</span><span class="n">total_core_in_orders</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="nl">b</span> <span class="p">:</span> <span class="n">bids</span> <span class="p">)</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">b</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="nl">o</span> <span class="p">:</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">limit_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
 <span class="c1">//     idump((&quot;limit_order&quot;)(o));</span>
          <span class="k">auto</span> <span class="n">for_sale</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">for_sale</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span> <span class="n">core_in_orders</span> <span class="o">+=</span> <span class="n">for_sale</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">for_sale</span><span class="p">.</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">for_sale</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="nl">o</span> <span class="p">:</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">call_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
<span class="c1">//      idump((&quot;call_order&quot;)(o));</span>
          <span class="k">auto</span> <span class="n">col</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">col</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span> <span class="n">core_in_orders</span> <span class="o">+=</span> <span class="n">col</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">col</span><span class="p">.</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">col</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="n">total_debts</span><span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">get_debt</span><span class="p">().</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">o</span><span class="p">.</span><span class="n">get_debt</span><span class="p">().</span><span class="n">amount</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="nl">asset_obj</span> <span class="p">:</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">asset_obj</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">asset_obj</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="n">db</span><span class="p">).</span><span class="n">accumulated_fees</span><span class="p">;</span>
          <span class="n">total_balances</span><span class="p">[</span><span class="n">asset_id_type</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">asset_obj</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="n">db</span><span class="p">).</span><span class="n">fee_pool</span><span class="p">;</span>
<span class="c1">//      edump((total_balances[asset_obj.id])(asset_obj.dynamic_asset_data_id(db).current_supply ) );</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">total_balances</span><span class="p">[</span><span class="n">asset_id_type</span><span class="p">()].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">core_asset_data</span><span class="p">.</span><span class="n">current_supply</span><span class="p">.</span><span class="n">value</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">FC_THROW</span><span class="p">(</span> <span class="s">&quot;computed balance of CORE mismatch&quot;</span><span class="p">,</span>
                                <span class="p">(</span><span class="s">&quot;computed value&quot;</span><span class="p">,</span><span class="n">total_balances</span><span class="p">[</span><span class="n">asset_id_type</span><span class="p">()].</span><span class="n">value</span><span class="p">)</span>
                                <span class="p">(</span><span class="s">&quot;current supply&quot;</span><span class="p">,</span><span class="n">core_asset_data</span><span class="p">.</span><span class="n">current_supply</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>


   <span class="cm">/*</span>
<span class="cm">   const auto&amp; vbidx = db.get_index_type&lt;simple_index&lt;vesting_balance_object&gt;&gt;();</span>
<span class="cm">   for( const auto&amp; s : vbidx )</span>
<span class="cm">   {</span>
<span class="cm">//      idump((&quot;vesting_balance&quot;)(s));</span>
<span class="cm">   }</span>
<span class="cm">   */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="debug-apply-update">
<h3><a class="toc-backref" href="#id42">debug_apply_update</a><a class="headerlink" href="#debug-apply-update" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">debug_apply_update</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">,</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">variant_object</span><span class="o">&amp;</span> <span class="n">vo</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span>
          <span class="n">db_action_nil</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="n">db_action_create</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
          <span class="n">db_action_write</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
          <span class="n">db_action_update</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
          <span class="n">db_action_delete</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

   <span class="c1">// &quot;_action&quot; : &quot;create&quot;   object must not exist, unspecified fields take defaults</span>
   <span class="c1">// &quot;_action&quot; : &quot;write&quot;    object may exist, is replaced entirely, unspecified fields take defaults</span>
   <span class="c1">// &quot;_action&quot; : &quot;update&quot;   object must exist, unspecified fields don&#39;t change</span>
   <span class="c1">// &quot;_action&quot; : &quot;delete&quot;   object must exist, will be deleted</span>

   <span class="c1">// if _action is unspecified:</span>
   <span class="c1">// - delete if object contains only ID field</span>
   <span class="c1">// - otherwise, write</span>

   <span class="n">object_id_type</span> <span class="n">oid</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="n">action</span> <span class="o">=</span> <span class="n">db_action_nil</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">it_id</span> <span class="o">=</span> <span class="n">vo</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">it_id</span> <span class="o">!=</span> <span class="n">vo</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>

   <span class="n">from_variant</span><span class="p">(</span> <span class="n">it_id</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">(),</span> <span class="n">oid</span> <span class="p">);</span>
   <span class="n">action</span> <span class="o">=</span> <span class="p">(</span> <span class="n">vo</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">?</span> <span class="nl">db_action_delete</span> <span class="p">:</span> <span class="n">db_action_write</span><span class="p">;</span>

   <span class="n">from_variant</span><span class="p">(</span> <span class="n">vo</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">],</span> <span class="n">oid</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">vo</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
          <span class="n">action</span> <span class="o">=</span> <span class="n">db_action_delete</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">it_action</span> <span class="o">=</span> <span class="n">vo</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;_action&quot;</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">it_action</span> <span class="o">!=</span> <span class="n">vo</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">str_action</span> <span class="o">=</span> <span class="n">it_action</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">().</span><span class="n">get_string</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">str_action</span> <span class="o">==</span> <span class="s">&quot;create&quot;</span> <span class="p">)</span>
                 <span class="n">action</span> <span class="o">=</span> <span class="n">db_action_create</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">str_action</span> <span class="o">==</span> <span class="s">&quot;write&quot;</span> <span class="p">)</span>
                 <span class="n">action</span> <span class="o">=</span> <span class="n">db_action_write</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">str_action</span> <span class="o">==</span> <span class="s">&quot;update&quot;</span> <span class="p">)</span>
                 <span class="n">action</span> <span class="o">=</span> <span class="n">db_action_update</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">str_action</span> <span class="o">==</span> <span class="s">&quot;delete&quot;</span> <span class="p">)</span>
                 <span class="n">action</span> <span class="o">=</span> <span class="n">db_action_delete</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index</span><span class="p">(</span> <span class="n">oid</span> <span class="p">);</span>

   <span class="k">switch</span><span class="p">(</span> <span class="n">action</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">case</span> <span class="nl">db_action_create</span><span class="p">:</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="nb">false</span> <span class="p">);</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="nl">db_action_write</span><span class="p">:</span>
                 <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span> <span class="n">oid</span> <span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">idx</span><span class="p">.</span><span class="n">object_default</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
                        <span class="n">idx</span><span class="p">.</span><span class="n">object_from_variant</span><span class="p">(</span> <span class="n">vo</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">GRAPHENE_MAX_NESTED_OBJECTS</span> <span class="p">);</span>
                 <span class="p">}</span> <span class="p">);</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="nl">db_action_update</span><span class="p">:</span>
                 <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span> <span class="n">oid</span> <span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">idx</span><span class="p">.</span><span class="n">object_from_variant</span><span class="p">(</span> <span class="n">vo</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">GRAPHENE_MAX_NESTED_OBJECTS</span> <span class="p">);</span>
                 <span class="p">}</span> <span class="p">);</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="nl">db_action_delete</span><span class="p">:</span>
                 <span class="n">db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">db</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span> <span class="n">oid</span> <span class="p">)</span> <span class="p">);</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">default</span><span class="o">:</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="nb">false</span> <span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apply-debug-updates">
<h3><a class="toc-backref" href="#id43">apply_debug_updates</a><a class="headerlink" href="#apply-debug-updates" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">apply_debug_updates</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">block_id_type</span> <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_block_id</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">_node_property_object</span><span class="p">.</span><span class="n">debug_updates</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">head_id</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">it</span> <span class="o">==</span> <span class="n">_node_property_object</span><span class="p">.</span><span class="n">debug_updates</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">variant_object</span><span class="o">&amp;</span> <span class="nl">update</span> <span class="p">:</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">)</span>
          <span class="n">debug_apply_update</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">update</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="debug-update">
<h3><a class="toc-backref" href="#id44">debug_update</a><a class="headerlink" href="#debug-update" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">debug_update</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">variant_object</span><span class="o">&amp;</span> <span class="n">update</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">block_id_type</span> <span class="n">head_id</span> <span class="o">=</span> <span class="n">head_block_id</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">_node_property_object</span><span class="p">.</span><span class="n">debug_updates</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">head_id</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">it</span> <span class="o">==</span> <span class="n">_node_property_object</span><span class="p">.</span><span class="n">debug_updates</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">it</span> <span class="o">=</span> <span class="n">_node_property_object</span><span class="p">.</span><span class="n">debug_updates</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span> <span class="n">head_id</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">fc</span><span class="o">::</span><span class="n">variant_object</span> <span class="o">&gt;</span><span class="p">()</span> <span class="p">).</span><span class="n">first</span><span class="p">;</span>
   <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">update</span> <span class="p">);</span>

   <span class="n">optional</span><span class="o">&lt;</span><span class="n">signed_block</span><span class="o">&gt;</span> <span class="n">head_block</span> <span class="o">=</span> <span class="n">fetch_block_by_id</span><span class="p">(</span> <span class="n">head_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">head_block</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">);</span>

   <span class="c1">// What the last block does has been changed by adding to node_property_object, so we have to re-apply it</span>
   <span class="n">pop_block</span><span class="p">();</span>
   <span class="n">push_block</span><span class="p">(</span> <span class="o">*</span><span class="n">head_block</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-getter-cpp">
<h2><a class="toc-backref" href="#id45">db_getter.cpp</a><a class="headerlink" href="#db-getter-cpp" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_core_asset</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">_p_core_asset_obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_core_dynamic_data</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">_p_core_dynamic_data_obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_global_properties</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">_p_global_prop_obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">chain_property_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_chain_properties</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">_p_chain_property_obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_dynamic_global_properties</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">_p_dyn_global_prop_obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">fee_schedule</span><span class="o">&amp;</span>  <span class="n">database</span><span class="o">::</span><span class="n">current_fee_schedule</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">current_fees</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">time_point_sec</span> <span class="n">database</span><span class="o">::</span><span class="n">head_block_time</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">time</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="n">database</span><span class="o">::</span><span class="n">head_block_num</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">head_block_number</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">block_id_type</span> <span class="n">database</span><span class="o">::</span><span class="n">head_block_id</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">head_block_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">decltype</span><span class="p">(</span> <span class="n">chain_parameters</span><span class="o">::</span><span class="n">block_interval</span> <span class="p">)</span> <span class="n">database</span><span class="o">::</span><span class="n">block_interval</span><span class="p">(</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">block_interval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">chain_id_type</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_chain_id</span><span class="p">(</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">get_chain_properties</span><span class="p">().</span><span class="n">chain_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">node_property_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_node_properties</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">_node_property_object</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">node_property_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">node_properties</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">_node_property_object</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="n">database</span><span class="o">::</span><span class="n">last_non_undoable_block_num</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">-</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_account_stats_by_owner</span><span class="p">(</span> <span class="n">account_id_type</span> <span class="n">owner</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_stats_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_owner</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">owner</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="s">&quot;Can not find account statistics object for owner ${a}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="n">owner</span><span class="p">)</span> <span class="p">);</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">witness_schedule_object</span><span class="o">&amp;</span> <span class="n">database</span><span class="o">::</span><span class="n">get_witness_schedule_object</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="n">_p_witness_schedule_obj</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="db-init-cpp">
<h2><a class="toc-backref" href="#id46">db_init.cpp</a><a class="headerlink" href="#db-init-cpp" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>C++ requires that static class variables declared and initialized in headers must also have a definition in a single source file, else linker errors will occur [1].</li>
<li>The purpose of this source file is to collect such definitions in a single place.</li>
<li>[1] <a class="reference external" href="http://stackoverflow.com/questions/8016780/undefined-reference-to-static-constexpr-char">http://stackoverflow.com/questions/8016780/undefined-reference-to-static-constexpr-char</a></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">account_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">account_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">asset_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">asset_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">block_summary_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">block_summary_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">call_order_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">call_order_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">committee_member_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">committee_member_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">force_settlement_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">force_settlement_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">global_property_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">global_property_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">limit_order_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">limit_order_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">operation_history_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">operation_history_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">proposal_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">proposal_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">transaction_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">transaction_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">vesting_balance_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">vesting_balance_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">withdraw_permission_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">withdraw_permission_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">witness_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">witness_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">worker_object</span><span class="o">::</span><span class="n">space_id</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">worker_object</span><span class="o">::</span><span class="n">type_id</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="initialize-evaluators">
<h3><a class="toc-backref" href="#id47">initialize_evaluators</a><a class="headerlink" href="#initialize-evaluators" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">initialize_evaluators</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">_operation_evaluators</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">account_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">account_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">account_upgrade_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">account_whitelist_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">committee_member_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">committee_member_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">committee_member_update_global_parameters_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">custom_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_issue_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_reserve_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_update_bitasset_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_update_feed_producers_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_settle_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_global_settle_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">assert_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">limit_order_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">limit_order_cancel_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">call_order_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">bid_collateral_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">transfer_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">override_transfer_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_fund_fee_pool_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_publish_feeds_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">proposal_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">proposal_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">proposal_delete_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">vesting_balance_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">vesting_balance_withdraw_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">witness_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">witness_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">withdraw_permission_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">withdraw_permission_claim_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">withdraw_permission_update_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">withdraw_permission_delete_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">worker_create_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">balance_claim_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">transfer_to_blind_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">transfer_from_blind_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">blind_transfer_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_claim_fees_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_update_issuer_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">register_evaluator</span><span class="o">&lt;</span><span class="n">asset_claim_pool_evaluator</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="initialize-indexes">
<h3><a class="toc-backref" href="#id48">initialize_indexes</a><a class="headerlink" href="#initialize-indexes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">initialize_indexes</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">reset_indexes</span><span class="p">();</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">set_max_size</span><span class="p">(</span> <span class="n">GRAPHENE_MIN_UNDO_HISTORY</span> <span class="p">);</span>

   <span class="c1">//Protocol object indexes</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">force_settlement_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>

   <span class="k">auto</span> <span class="n">acnt_index</span> <span class="o">=</span> <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">account_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">acnt_index</span><span class="o">-&gt;</span><span class="n">add_secondary_index</span><span class="o">&lt;</span><span class="n">account_member_index</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">acnt_index</span><span class="o">-&gt;</span><span class="n">add_secondary_index</span><span class="o">&lt;</span><span class="n">account_referrer_index</span><span class="o">&gt;</span><span class="p">();</span>

   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">committee_member_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">witness_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">limit_order_index</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">call_order_index</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>

   <span class="k">auto</span> <span class="n">prop_index</span> <span class="o">=</span> <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">proposal_index</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">prop_index</span><span class="o">-&gt;</span><span class="n">add_secondary_index</span><span class="o">&lt;</span><span class="n">required_approval_index</span><span class="o">&gt;</span><span class="p">();</span>

   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">withdraw_permission_index</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">vesting_balance_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">worker_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">balance_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">blinded_balance_index</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>

   <span class="c1">//Implementation object indexes</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">transaction_index</span>                             <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">account_balance_index</span>                         <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">asset_bitasset_data_index</span>                     <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">global_property_object</span>          <span class="o">&gt;&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">dynamic_global_property_object</span>  <span class="o">&gt;&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">account_stats_index</span>                           <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">asset_dynamic_data_object</span>       <span class="o">&gt;&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">block_summary_object</span>            <span class="o">&gt;&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">chain_property_object</span>          <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">witness_schedule_object</span>        <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">simple_index</span><span class="o">&lt;</span><span class="n">budget_record_object</span>           <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span> <span class="n">special_authority_index</span>                      <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span> <span class="n">buyback_index</span>                                <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span><span class="n">collateral_bid_index</span>                          <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>

   <span class="n">add_index</span><span class="o">&lt;</span> <span class="n">primary_index</span><span class="o">&lt;</span> <span class="n">simple_index</span><span class="o">&lt;</span> <span class="n">fba_accumulator_object</span>       <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="init-genesis">
<h3><a class="toc-backref" href="#id49">init_genesis</a><a class="headerlink" href="#init-genesis" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">init_genesis</span><span class="p">(</span><span class="k">const</span> <span class="n">genesis_state_type</span><span class="o">&amp;</span> <span class="n">genesis_state</span><span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_timestamp</span> <span class="o">!=</span> <span class="n">time_point_sec</span><span class="p">(),</span> <span class="s">&quot;Must initialize genesis timestamp.&quot;</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_timestamp</span><span class="p">.</span><span class="n">sec_since_epoch</span><span class="p">()</span> <span class="o">%</span> <span class="n">GRAPHENE_DEFAULT_BLOCK_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s">&quot;Genesis timestamp must be divisible by GRAPHENE_DEFAULT_BLOCK_INTERVAL.&quot;</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_witness_candidates</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s">&quot;Cannot start a chain with zero witnesses.&quot;</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_active_witnesses</span> <span class="o">&lt;=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_witness_candidates</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
                         <span class="s">&quot;initial_active_witnesses is larger than the number of candidate witnesses.&quot;</span><span class="p">);</span>

   <span class="n">_undo_db</span><span class="p">.</span><span class="n">disable</span><span class="p">();</span>
   <span class="k">struct</span> <span class="n">auth_inhibitor</span> <span class="p">{</span>
          <span class="n">auth_inhibitor</span><span class="p">(</span><span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">)</span> <span class="o">:</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="p">),</span> <span class="n">old_flags</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">node_properties</span><span class="p">().</span><span class="n">skip_flags</span><span class="p">)</span>
          <span class="p">{</span> <span class="n">db</span><span class="p">.</span><span class="n">node_properties</span><span class="p">().</span><span class="n">skip_flags</span> <span class="o">|=</span> <span class="n">skip_authority_check</span><span class="p">;</span> <span class="p">}</span>
          <span class="o">~</span><span class="n">auth_inhibitor</span><span class="p">()</span>
          <span class="p">{</span> <span class="n">db</span><span class="p">.</span><span class="n">node_properties</span><span class="p">().</span><span class="n">skip_flags</span> <span class="o">=</span> <span class="n">old_flags</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">private</span><span class="o">:</span>
          <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">;</span>
          <span class="kt">uint32_t</span> <span class="n">old_flags</span><span class="p">;</span>
   <span class="p">}</span> <span class="n">inhibitor</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="n">transaction_evaluation_state</span> <span class="nf">genesis_eval_state</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

   <span class="c1">// Create blockchain accounts</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">ecc</span><span class="o">::</span><span class="n">private_key</span> <span class="n">null_private_key</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">ecc</span><span class="o">::</span><span class="n">private_key</span><span class="o">::</span><span class="n">regenerate</span><span class="p">(</span><span class="n">fc</span><span class="o">::</span><span class="n">sha256</span><span class="o">::</span><span class="n">hash</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;null_key&quot;</span><span class="p">)));</span>
   <span class="n">create</span><span class="o">&lt;</span><span class="n">account_balance_object</span><span class="o">&gt;</span><span class="p">([](</span><span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">b</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">GRAPHENE_MAX_SHARE_SUPPLY</span><span class="p">;</span>
   <span class="p">});</span>
   <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">committee_account</span> <span class="o">=</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;committee-account&quot;</span><span class="p">;</span>
                 <span class="n">n</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">n</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                   <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                   <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                                   <span class="n">s</span><span class="p">.</span><span class="n">core_in_balance</span> <span class="o">=</span> <span class="n">GRAPHENE_MAX_SHARE_SUPPLY</span><span class="p">;</span>
                                                <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">committee_account</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_COMMITTEE_ACCOUNT</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;witness-account&quot;</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                          <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">referrer</span> <span class="o">=</span> <span class="n">GRAPHENE_WITNESS_ACCOUNT</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
           <span class="n">a</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
   <span class="p">}).</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_WITNESS_ACCOUNT</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;relaxed-committee-account&quot;</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                          <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">referrer</span> <span class="o">=</span> <span class="n">GRAPHENE_RELAXED_COMMITTEE_ACCOUNT</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
           <span class="n">a</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
   <span class="p">}).</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_RELAXED_COMMITTEE_ACCOUNT</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;null-account&quot;</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                          <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">referrer</span> <span class="o">=</span> <span class="n">GRAPHENE_NULL_ACCOUNT</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
           <span class="n">a</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span><span class="p">;</span>
   <span class="p">}).</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_NULL_ACCOUNT</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;temp-account&quot;</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                          <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">referrer</span> <span class="o">=</span> <span class="n">GRAPHENE_TEMP_ACCOUNT</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
           <span class="n">a</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
   <span class="p">}).</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_TEMP_ACCOUNT</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;proxy-to-self&quot;</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                 <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                          <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">referrer</span> <span class="o">=</span> <span class="n">GRAPHENE_NULL_ACCOUNT</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
           <span class="n">a</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span><span class="p">;</span>
   <span class="p">}).</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">GRAPHENE_PROXY_TO_SELF_ACCOUNT</span><span class="p">);</span>

   <span class="c1">// Create more special accounts</span>
   <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="kt">uint64_t</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_index</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">().</span><span class="n">get_next_id</span><span class="p">().</span><span class="n">instance</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">.</span><span class="n">num_special_accounts</span> <span class="p">)</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">acct</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="n">id</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;special-account-&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">account_statistics_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">a</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
                                                        <span class="n">s</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                                                        <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
                                                 <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">referrer</span> <span class="o">=</span> <span class="n">account_id_type</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">membership_expiration_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">network_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
                  <span class="n">a</span><span class="p">.</span><span class="n">lifetime_referrer_fee_percentage</span> <span class="o">=</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">GRAPHENE_DEFAULT_NETWORK_PERCENT_OF_FEE</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">acct</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">account_id_type</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
          <span class="n">remove</span><span class="p">(</span> <span class="n">acct</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Create core asset</span>
   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">dyn_asset</span> <span class="o">=</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_dynamic_data_object</span><span class="o">&gt;</span><span class="p">([](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">=</span> <span class="n">GRAPHENE_MAX_SHARE_SUPPLY</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">core_asset</span> <span class="o">=</span>
         <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_object</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">genesis_state</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dyn_asset</span><span class="p">](</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">GRAPHENE_SYMBOL</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">max_supply</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">max_core_supply</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">GRAPHENE_BLOCKCHAIN_PRECISION_DIGITS</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">issuer_permissions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">issuer</span> <span class="o">=</span> <span class="n">GRAPHENE_NULL_ACCOUNT</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">=</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">=</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span> <span class="o">=</span> <span class="n">dyn_asset</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">dyn_asset</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">asset_dynamic_data_id_type</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="n">core_asset</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">asset</span><span class="p">().</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">get_balance</span><span class="p">(</span><span class="n">account_id_type</span><span class="p">(),</span> <span class="n">asset_id_type</span><span class="p">())</span> <span class="o">==</span> <span class="n">asset</span><span class="p">(</span><span class="n">dyn_asset</span><span class="p">.</span><span class="n">current_supply</span><span class="p">)</span> <span class="p">);</span>
   <span class="n">_p_core_asset_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">core_asset</span><span class="p">;</span>
   <span class="n">_p_core_dynamic_data_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dyn_asset</span><span class="p">;</span>
   <span class="c1">// Create more special assets</span>
   <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="kt">uint64_t</span> <span class="n">id</span> <span class="o">=</span> <span class="n">get_index</span><span class="o">&lt;</span><span class="n">asset_object</span><span class="o">&gt;</span><span class="p">().</span><span class="n">get_next_id</span><span class="p">().</span><span class="n">instance</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">.</span><span class="n">num_special_assets</span> <span class="p">)</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">dyn_asset</span> <span class="o">=</span>
                 <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_dynamic_data_object</span><span class="o">&gt;</span><span class="p">([](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">a</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="p">});</span>
          <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">asset_obj</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_object</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dyn_asset</span><span class="p">](</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="s">&quot;SPECIAL&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span> <span class="n">id</span> <span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">max_supply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">GRAPHENE_BLOCKCHAIN_PRECISION_DIGITS</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">issuer_permissions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">issuer</span> <span class="o">=</span> <span class="n">GRAPHENE_NULL_ACCOUNT</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">=</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">=</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span> <span class="o">=</span> <span class="n">dyn_asset</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">asset_obj</span><span class="p">.</span><span class="n">get_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
          <span class="n">remove</span><span class="p">(</span> <span class="n">asset_obj</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="n">chain_id_type</span> <span class="n">chain_id</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">compute_chain_id</span><span class="p">();</span>

   <span class="c1">// Create global properties</span>
   <span class="n">_p_global_prop_obj</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">global_property_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">genesis_state</span><span class="p">](</span><span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">p</span><span class="p">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_parameters</span><span class="p">;</span>
           <span class="c1">// Set fees to zero initially, so that genesis initialization needs not pay them</span>
           <span class="c1">// We&#39;ll fix it at the end of the function</span>
           <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">current_fees</span><span class="o">-&gt;</span><span class="n">zero_all_fees</span><span class="p">();</span>

   <span class="p">});</span>
   <span class="n">_p_dyn_global_prop_obj</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">dynamic_global_property_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">genesis_state</span><span class="p">](</span><span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">p</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_timestamp</span><span class="p">;</span>
          <span class="n">p</span><span class="p">.</span><span class="n">dynamic_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">p</span><span class="p">.</span><span class="n">witness_budget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">p</span><span class="p">.</span><span class="n">recent_slots_filled</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span><span class="o">::</span><span class="n">max_value</span><span class="p">();</span>
   <span class="p">});</span>

   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">.</span><span class="n">min_witness_count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;min_witness_count must be odd&quot;</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">.</span><span class="n">min_committee_member_count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;min_committee_member_count must be odd&quot;</span> <span class="p">);</span>

   <span class="n">_p_chain_property_obj</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">chain_property_object</span><span class="o">&gt;</span><span class="p">([</span><span class="n">chain_id</span><span class="p">,</span><span class="o">&amp;</span><span class="n">genesis_state</span><span class="p">](</span><span class="n">chain_property_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span>
   <span class="p">{</span>
          <span class="n">p</span><span class="p">.</span><span class="n">chain_id</span> <span class="o">=</span> <span class="n">chain_id</span><span class="p">;</span>
          <span class="n">p</span><span class="p">.</span><span class="n">immutable_parameters</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">;</span>
   <span class="p">}</span> <span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">block_summary_object</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">block_summary_object</span><span class="o">&amp;</span><span class="p">)</span> <span class="p">{});</span>

   <span class="c1">// Create initial accounts</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">account</span> <span class="p">:</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_accounts</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">account_create_operation</span> <span class="n">cop</span><span class="p">;</span>
          <span class="n">cop</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
          <span class="n">cop</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">GRAPHENE_TEMP_ACCOUNT</span><span class="p">;</span>
          <span class="n">cop</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">authority</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">owner_key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">account</span><span class="p">.</span><span class="n">active_key</span> <span class="o">==</span> <span class="n">public_key_type</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">cop</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">cop</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
                 <span class="n">cop</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">memo_key</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">owner_key</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="n">cop</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">authority</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">active_key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                 <span class="n">cop</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">memo_key</span> <span class="o">=</span> <span class="n">account</span><span class="p">.</span><span class="n">active_key</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">account_id_type</span> <span class="n">account_id</span><span class="p">(</span><span class="n">apply_operation</span><span class="p">(</span><span class="n">genesis_eval_state</span><span class="p">,</span> <span class="n">cop</span><span class="p">).</span><span class="n">get</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="o">&gt;</span><span class="p">());</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">account</span><span class="p">.</span><span class="n">is_lifetime_member</span> <span class="p">)</span>
          <span class="p">{</span>
                  <span class="n">account_upgrade_operation</span> <span class="n">op</span><span class="p">;</span>
                  <span class="n">op</span><span class="p">.</span><span class="n">account_to_upgrade</span> <span class="o">=</span> <span class="n">account_id</span><span class="p">;</span>
                  <span class="n">op</span><span class="p">.</span><span class="n">upgrade_to_lifetime_member</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                  <span class="n">apply_operation</span><span class="p">(</span><span class="n">genesis_eval_state</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// Helper function to get account ID by name</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">accounts_by_name</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_name</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">get_account_id</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">accounts_by_name</span><span class="p">](</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">accounts_by_name</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">itr</span> <span class="o">!=</span> <span class="n">accounts_by_name</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                <span class="s">&quot;Unable to find account &#39;${acct}&#39;. Did you forget to add a record for it to initial_accounts?&quot;</span><span class="p">,</span>
                                <span class="p">(</span><span class="s">&quot;acct&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
          <span class="k">return</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">();</span>
   <span class="p">};</span>

   <span class="c1">// Helper function to get asset ID by symbol</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">assets_by_symbol</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_symbol</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">get_asset_id</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">assets_by_symbol</span><span class="p">](</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">symbol</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">assets_by_symbol</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">symbol</span><span class="p">);</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">itr</span> <span class="o">!=</span> <span class="n">assets_by_symbol</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                <span class="s">&quot;Unable to find asset &#39;${sym}&#39;. Did you forget to add a record for it to initial_assets?&quot;</span><span class="p">,</span>
                                <span class="p">(</span><span class="s">&quot;sym&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">));</span>
          <span class="k">return</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">get_id</span><span class="p">();</span>
   <span class="p">};</span>

   <span class="n">map</span><span class="o">&lt;</span><span class="n">asset_id_type</span><span class="p">,</span> <span class="n">share_type</span><span class="o">&gt;</span> <span class="n">total_supplies</span><span class="p">;</span>
   <span class="n">map</span><span class="o">&lt;</span><span class="n">asset_id_type</span><span class="p">,</span> <span class="n">share_type</span><span class="o">&gt;</span> <span class="n">total_debts</span><span class="p">;</span>

   <span class="c1">// Create initial assets</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">genesis_state_type</span><span class="o">::</span><span class="n">initial_asset_type</span><span class="o">&amp;</span> <span class="nl">asset</span> <span class="p">:</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_assets</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">asset_id_type</span> <span class="n">new_asset_id</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">get_next_id</span><span class="p">();</span>
          <span class="n">total_supplies</span><span class="p">[</span> <span class="n">new_asset_id</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

          <span class="n">asset_dynamic_data_id_type</span> <span class="n">dynamic_data_id</span><span class="p">;</span>
          <span class="n">optional</span><span class="o">&lt;</span><span class="n">asset_bitasset_data_id_type</span><span class="o">&gt;</span> <span class="n">bitasset_data_id</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">asset</span><span class="p">.</span><span class="n">is_bitasset</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="kt">int</span> <span class="n">collateral_holder_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">total_debts</span><span class="p">[</span> <span class="n">new_asset_id</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">collateral_rec</span> <span class="p">:</span> <span class="n">asset</span><span class="p">.</span><span class="n">collateral_records</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">account_create_operation</span> <span class="n">cop</span><span class="p">;</span>
                        <span class="n">cop</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">symbol</span> <span class="o">+</span> <span class="s">&quot;-collateral-holder-&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">collateral_holder_number</span><span class="p">);</span>
                        <span class="n">boost</span><span class="o">::</span><span class="n">algorithm</span><span class="o">::</span><span class="n">to_lower</span><span class="p">(</span><span class="n">cop</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
                        <span class="n">cop</span><span class="p">.</span><span class="n">registrar</span> <span class="o">=</span> <span class="n">GRAPHENE_TEMP_ACCOUNT</span><span class="p">;</span>
                        <span class="n">cop</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">authority</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">collateral_rec</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                        <span class="n">cop</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">cop</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
                        <span class="n">account_id_type</span> <span class="n">owner_account_id</span> <span class="o">=</span> <span class="n">apply_operation</span><span class="p">(</span><span class="n">genesis_eval_state</span><span class="p">,</span> <span class="n">cop</span><span class="p">).</span><span class="n">get</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="o">&gt;</span><span class="p">();</span>

                        <span class="n">modify</span><span class="p">(</span> <span class="n">owner_account_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">statistics</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">collateral_rec</span><span class="p">](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">o</span> <span class="p">)</span> <span class="p">{</span>
                           <span class="n">o</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">=</span> <span class="n">collateral_rec</span><span class="p">.</span><span class="n">collateral</span><span class="p">;</span>
                        <span class="p">});</span>

                        <span class="n">create</span><span class="o">&lt;</span><span class="n">call_order_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
                           <span class="n">c</span><span class="p">.</span><span class="n">borrower</span> <span class="o">=</span> <span class="n">owner_account_id</span><span class="p">;</span>
                           <span class="n">c</span><span class="p">.</span><span class="n">collateral</span> <span class="o">=</span> <span class="n">collateral_rec</span><span class="p">.</span><span class="n">collateral</span><span class="p">;</span>
                           <span class="n">c</span><span class="p">.</span><span class="n">debt</span> <span class="o">=</span> <span class="n">collateral_rec</span><span class="p">.</span><span class="n">debt</span><span class="p">;</span>
                           <span class="n">c</span><span class="p">.</span><span class="n">call_price</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">call_price</span><span class="p">(</span><span class="n">chain</span><span class="o">::</span><span class="n">asset</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">debt</span><span class="p">,</span> <span class="n">new_asset_id</span><span class="p">),</span>
                                                                                                <span class="n">chain</span><span class="o">::</span><span class="n">asset</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">collateral</span><span class="p">,</span> <span class="n">core_asset</span><span class="p">.</span><span class="n">id</span><span class="p">),</span>
                                                                                                <span class="n">GRAPHENE_DEFAULT_MAINTENANCE_COLLATERAL_RATIO</span><span class="p">);</span>
                        <span class="p">});</span>

                        <span class="n">total_supplies</span><span class="p">[</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">collateral_rec</span><span class="p">.</span><span class="n">collateral</span><span class="p">;</span>
                        <span class="n">total_debts</span><span class="p">[</span> <span class="n">new_asset_id</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">collateral_rec</span><span class="p">.</span><span class="n">debt</span><span class="p">;</span>
                        <span class="o">++</span><span class="n">collateral_holder_number</span><span class="p">;</span>
                 <span class="p">}</span>

                 <span class="n">bitasset_data_id</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_bitasset_data_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">core_asset</span><span class="p">,</span><span class="n">new_asset_id</span><span class="p">](</span><span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">b</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span> <span class="o">=</span> <span class="n">core_asset</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                        <span class="n">b</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">minimum_feeds</span> <span class="o">=</span> <span class="n">GRAPHENE_DEFAULT_MINIMUM_FEEDS</span><span class="p">;</span>
                        <span class="n">b</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">=</span> <span class="n">new_asset_id</span><span class="p">;</span>
                 <span class="p">}).</span><span class="n">id</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="n">dynamic_data_id</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_dynamic_data_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">asset</span><span class="p">](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">d</span><span class="p">.</span><span class="n">accumulated_fees</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">accumulated_fees</span><span class="p">;</span>
          <span class="p">}).</span><span class="n">id</span><span class="p">;</span>

          <span class="n">total_supplies</span><span class="p">[</span> <span class="n">new_asset_id</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">asset</span><span class="p">.</span><span class="n">accumulated_fees</span><span class="p">;</span>

          <span class="n">create</span><span class="o">&lt;</span><span class="n">asset_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">symbol</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">description</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">precision</span><span class="p">;</span>
                 <span class="n">string</span> <span class="n">issuer_name</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">issuer_name</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">issuer</span> <span class="o">=</span> <span class="n">get_account_id</span><span class="p">(</span><span class="n">issuer_name</span><span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">max_supply</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">max_supply</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">witness_fed_asset</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">issuer_permissions</span> <span class="o">=</span> <span class="n">charge_market_fee</span> <span class="o">|</span> <span class="n">override_authority</span> <span class="o">|</span> <span class="n">white_list</span> <span class="o">|</span> <span class="n">transfer_restricted</span> <span class="o">|</span> <span class="n">disable_confidential</span> <span class="o">|</span>
                                                                           <span class="p">(</span> <span class="n">asset</span><span class="p">.</span><span class="n">is_bitasset</span> <span class="o">?</span> <span class="n">disable_force_settle</span> <span class="o">|</span> <span class="n">global_settle</span> <span class="o">|</span> <span class="n">witness_fed_asset</span> <span class="o">|</span> <span class="nl">committee_fed_asset</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">);</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span> <span class="o">=</span> <span class="n">dynamic_data_id</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">bitasset_data_id</span> <span class="o">=</span> <span class="n">bitasset_data_id</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>

   <span class="c1">// Create initial balances</span>
   <span class="n">share_type</span> <span class="n">total_allocation</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">handout</span> <span class="p">:</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_balances</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span> <span class="n">asset_id</span> <span class="o">=</span> <span class="n">get_asset_id</span><span class="p">(</span><span class="n">handout</span><span class="p">.</span><span class="n">asset_symbol</span><span class="p">);</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">balance_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="n">handout</span><span class="p">,</span><span class="n">total_allocation</span><span class="p">,</span><span class="n">asset_id</span><span class="p">](</span><span class="n">balance_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span><span class="n">handout</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">);</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">handout</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="n">total_supplies</span><span class="p">[</span> <span class="n">asset_id</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">handout</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// Create initial vesting balances</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">genesis_state_type</span><span class="o">::</span><span class="n">initial_vesting_balance_type</span><span class="o">&amp;</span> <span class="nl">vest</span> <span class="p">:</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_vesting_balances</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span> <span class="n">asset_id</span> <span class="o">=</span> <span class="n">get_asset_id</span><span class="p">(</span><span class="n">vest</span><span class="p">.</span><span class="n">asset_symbol</span><span class="p">);</span>
          <span class="n">create</span><span class="o">&lt;</span><span class="n">balance_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">balance_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">vest</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
                 <span class="n">b</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span><span class="n">vest</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">);</span>

                 <span class="n">linear_vesting_policy</span> <span class="n">policy</span><span class="p">;</span>
                 <span class="n">policy</span><span class="p">.</span><span class="n">begin_timestamp</span> <span class="o">=</span> <span class="n">vest</span><span class="p">.</span><span class="n">begin_timestamp</span><span class="p">;</span>
                 <span class="n">policy</span><span class="p">.</span><span class="n">vesting_cliff_seconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">policy</span><span class="p">.</span><span class="n">vesting_duration_seconds</span> <span class="o">=</span> <span class="n">vest</span><span class="p">.</span><span class="n">vesting_duration_seconds</span><span class="p">;</span>
                 <span class="n">policy</span><span class="p">.</span><span class="n">begin_balance</span> <span class="o">=</span> <span class="n">vest</span><span class="p">.</span><span class="n">begin_balance</span><span class="p">;</span>

                 <span class="n">b</span><span class="p">.</span><span class="n">vesting_policy</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">policy</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="n">total_supplies</span><span class="p">[</span> <span class="n">asset_id</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">vest</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">total_supplies</span><span class="p">[</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
           <span class="n">adjust_balance</span><span class="p">(</span><span class="n">GRAPHENE_COMMITTEE_ACCOUNT</span><span class="p">,</span> <span class="o">-</span><span class="n">get_balance</span><span class="p">(</span><span class="n">GRAPHENE_COMMITTEE_ACCOUNT</span><span class="p">,{}));</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
           <span class="n">total_supplies</span><span class="p">[</span> <span class="n">asset_id_type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">GRAPHENE_MAX_SHARE_SUPPLY</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_symbol</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
   <span class="kt">bool</span> <span class="n">has_imbalanced_assets</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

   <span class="k">while</span><span class="p">(</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">bitasset_data_id</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">auto</span> <span class="n">supply_itr</span> <span class="o">=</span> <span class="n">total_supplies</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">);</span>
                 <span class="k">auto</span> <span class="n">debt_itr</span> <span class="o">=</span> <span class="n">total_debts</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">);</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">supply_itr</span> <span class="o">!=</span> <span class="n">total_supplies</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">debt_itr</span> <span class="o">!=</span> <span class="n">total_debts</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">);</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">supply_itr</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">!=</span> <span class="n">debt_itr</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">has_imbalanced_assets</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;Genesis for asset ${aname} is not balanced</span><span class="se">\n</span><span class="s">&quot;</span>
                                  <span class="s">&quot;   Debt is ${debt}</span><span class="se">\n</span><span class="s">&quot;</span>
                                  <span class="s">&quot;   Supply is ${supply}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="s">&quot;aname&quot;</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">)</span>
                                  <span class="p">(</span><span class="s">&quot;debt&quot;</span><span class="p">,</span> <span class="n">debt_itr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
                                  <span class="p">(</span><span class="s">&quot;supply&quot;</span><span class="p">,</span> <span class="n">supply_itr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
                                <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">}</span>
          <span class="o">++</span><span class="n">it</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">has_imbalanced_assets</span> <span class="p">);</span>

   <span class="c1">// Save tallied supplies</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">total_supplies</span> <span class="p">)</span>
   <span class="p">{</span>
           <span class="k">const</span> <span class="k">auto</span> <span class="n">asset_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
           <span class="k">const</span> <span class="k">auto</span> <span class="n">total_supply</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>

           <span class="n">modify</span><span class="p">(</span> <span class="n">get</span><span class="p">(</span> <span class="n">asset_id</span> <span class="p">),</span> <span class="p">[</span> <span class="o">&amp;</span> <span class="p">](</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">asset</span> <span class="p">)</span> <span class="p">{</span>
                   <span class="n">modify</span><span class="p">(</span> <span class="n">get</span><span class="p">(</span> <span class="n">asset</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span> <span class="p">),</span> <span class="p">[</span> <span class="o">&amp;</span> <span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">asset_data</span> <span class="p">)</span> <span class="p">{</span>
                           <span class="n">asset_data</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">=</span> <span class="n">total_supply</span><span class="p">;</span>
                   <span class="p">}</span> <span class="p">);</span>
           <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Create special witness account</span>
   <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">wit</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">witness_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">w</span><span class="p">)</span> <span class="p">{});</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">wit</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">GRAPHENE_NULL_WITNESS</span> <span class="p">);</span>
   <span class="n">remove</span><span class="p">(</span><span class="n">wit</span><span class="p">);</span>

   <span class="c1">// Create initial witnesses</span>
   <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_witness_candidates</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_witness_candidates</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                 <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">genesis_state_type</span><span class="o">::</span><span class="n">initial_witness_type</span><span class="o">&amp;</span> <span class="n">witness</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">witness_create_operation</span> <span class="n">op</span><span class="p">;</span>
          <span class="n">op</span><span class="p">.</span><span class="n">witness_account</span> <span class="o">=</span> <span class="n">get_account_id</span><span class="p">(</span><span class="n">witness</span><span class="p">.</span><span class="n">owner_name</span><span class="p">);</span>
          <span class="n">op</span><span class="p">.</span><span class="n">block_signing_key</span> <span class="o">=</span> <span class="n">witness</span><span class="p">.</span><span class="n">block_signing_key</span><span class="p">;</span>
          <span class="n">apply_operation</span><span class="p">(</span><span class="n">genesis_eval_state</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
   <span class="p">});</span>

   <span class="c1">// Create initial committee members</span>
   <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_committee_candidates</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_committee_candidates</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                 <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">genesis_state_type</span><span class="o">::</span><span class="n">initial_committee_member_type</span><span class="o">&amp;</span> <span class="n">member</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">committee_member_create_operation</span> <span class="n">op</span><span class="p">;</span>
          <span class="n">op</span><span class="p">.</span><span class="n">committee_member_account</span> <span class="o">=</span> <span class="n">get_account_id</span><span class="p">(</span><span class="n">member</span><span class="p">.</span><span class="n">owner_name</span><span class="p">);</span>
          <span class="n">apply_operation</span><span class="p">(</span><span class="n">genesis_eval_state</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
   <span class="p">});</span>

   <span class="c1">// Create initial workers</span>
   <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_worker_candidates</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_worker_candidates</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                  <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">genesis_state_type</span><span class="o">::</span><span class="n">initial_worker_type</span><span class="o">&amp;</span> <span class="n">worker</span><span class="p">)</span>
   <span class="p">{</span>
           <span class="n">worker_create_operation</span> <span class="n">op</span><span class="p">;</span>
           <span class="n">op</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_account_id</span><span class="p">(</span><span class="n">worker</span><span class="p">.</span><span class="n">owner_name</span><span class="p">);</span>
           <span class="n">op</span><span class="p">.</span><span class="n">work_begin_date</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_timestamp</span><span class="p">;</span>
           <span class="n">op</span><span class="p">.</span><span class="n">work_end_date</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
           <span class="n">op</span><span class="p">.</span><span class="n">daily_pay</span> <span class="o">=</span> <span class="n">worker</span><span class="p">.</span><span class="n">daily_pay</span><span class="p">;</span>
           <span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Genesis-Worker-&quot;</span> <span class="o">+</span> <span class="n">worker</span><span class="p">.</span><span class="n">owner_name</span><span class="p">;</span>
           <span class="n">op</span><span class="p">.</span><span class="n">initializer</span> <span class="o">=</span> <span class="n">vesting_balance_worker_initializer</span><span class="p">{</span><span class="kt">uint16_t</span><span class="p">(</span><span class="mi">0</span><span class="p">)};</span>

           <span class="n">apply_operation</span><span class="p">(</span><span class="n">genesis_eval_state</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">op</span><span class="p">));</span>
   <span class="p">});</span>

   <span class="c1">// Set active witnesses</span>
           <span class="n">modify</span><span class="p">(</span><span class="n">get_global_properties</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">genesis_state</span><span class="p">](</span><span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_active_witnesses</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
                  <span class="p">{</span>
                         <span class="n">p</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">witness_id_type</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                  <span class="p">}</span>
           <span class="p">});</span>

           <span class="c1">// Enable fees</span>
           <span class="n">modify</span><span class="p">(</span><span class="n">get_global_properties</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">genesis_state</span><span class="p">](</span><span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">current_fees</span> <span class="o">=</span> <span class="n">genesis_state</span><span class="p">.</span><span class="n">initial_parameters</span><span class="p">.</span><span class="n">current_fees</span><span class="p">;</span>
           <span class="p">});</span>

           <span class="c1">// Create witness scheduler</span>
           <span class="n">_p_witness_schedule_obj</span> <span class="o">=</span> <span class="o">&amp;</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">witness_schedule_object</span><span class="o">&gt;</span><span class="p">([</span><span class="k">this</span><span class="p">](</span> <span class="n">witness_schedule_object</span><span class="o">&amp;</span> <span class="n">wso</span> <span class="p">)</span>
           <span class="p">{</span>
                  <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_id_type</span><span class="o">&amp;</span> <span class="nl">wid</span> <span class="p">:</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">active_witnesses</span> <span class="p">)</span>
                         <span class="n">wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">wid</span> <span class="p">);</span>
           <span class="p">});</span>

           <span class="c1">// Create FBA counters</span>
           <span class="n">create</span><span class="o">&lt;</span><span class="n">fba_accumulator_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="n">acc</span> <span class="p">)</span>
           <span class="p">{</span>
                  <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">acc</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fba_accumulator_id_type</span><span class="p">(</span> <span class="n">fba_accumulator_id_transfer_to_blind</span> <span class="p">)</span> <span class="p">);</span>
                  <span class="n">acc</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="cp">#ifdef GRAPHENE_FBA_STEALTH_DESIGNATED_ASSET</span>
                  <span class="n">acc</span><span class="p">.</span><span class="n">designated_asset</span> <span class="o">=</span> <span class="n">GRAPHENE_FBA_STEALTH_DESIGNATED_ASSET</span><span class="p">;</span>
                <span class="cp">#endif</span>
           <span class="p">});</span>

           <span class="n">create</span><span class="o">&lt;</span><span class="n">fba_accumulator_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="n">acc</span> <span class="p">)</span>
           <span class="p">{</span>
                  <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">acc</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fba_accumulator_id_type</span><span class="p">(</span> <span class="n">fba_accumulator_id_blind_transfer</span> <span class="p">)</span> <span class="p">);</span>
                  <span class="n">acc</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="cp">#ifdef GRAPHENE_FBA_STEALTH_DESIGNATED_ASSET</span>
                  <span class="n">acc</span><span class="p">.</span><span class="n">designated_asset</span> <span class="o">=</span> <span class="n">GRAPHENE_FBA_STEALTH_DESIGNATED_ASSET</span><span class="p">;</span>
                <span class="cp">#endif</span>
           <span class="p">});</span>

           <span class="n">create</span><span class="o">&lt;</span><span class="n">fba_accumulator_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="n">acc</span> <span class="p">)</span>
           <span class="p">{</span>
                  <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">acc</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fba_accumulator_id_type</span><span class="p">(</span> <span class="n">fba_accumulator_id_transfer_from_blind</span> <span class="p">)</span> <span class="p">);</span>
                  <span class="n">acc</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="cp">#ifdef GRAPHENE_FBA_STEALTH_DESIGNATED_ASSET</span>
                  <span class="n">acc</span><span class="p">.</span><span class="n">designated_asset</span> <span class="o">=</span> <span class="n">GRAPHENE_FBA_STEALTH_DESIGNATED_ASSET</span><span class="p">;</span>
           <span class="cp">#endif</span>
           <span class="p">});</span>

           <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">get_index</span><span class="o">&lt;</span><span class="n">fba_accumulator_object</span><span class="o">&gt;</span><span class="p">().</span><span class="n">get_next_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">fba_accumulator_id_type</span><span class="p">(</span> <span class="n">fba_accumulator_id_count</span> <span class="p">)</span> <span class="p">);</span>

           <span class="c1">//debug_dump();</span>

           <span class="n">_undo_db</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
        <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-maint-cpp">
<h2><a class="toc-backref" href="#id50">db_maint.cpp</a><a class="headerlink" href="#db-maint-cpp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sort-votable-objects">
<h3><a class="toc-backref" href="#id51">sort_votable_objects</a><a class="headerlink" href="#sort-votable-objects" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Index</span><span class="o">&gt;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">reference_wrapper</span><span class="o">&lt;</span><span class="k">const</span> <span class="k">typename</span> <span class="n">Index</span><span class="o">::</span><span class="n">object_type</span><span class="o">&gt;&gt;</span> <span class="n">database</span><span class="o">::</span><span class="n">sort_votable_objects</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
   <span class="k">using</span> <span class="n">ObjectType</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Index</span><span class="o">::</span><span class="n">object_type</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">all_objects</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
   <span class="n">count</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">all_objects</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
   <span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">reference_wrapper</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">ObjectType</span><span class="o">&gt;&gt;</span> <span class="n">refs</span><span class="p">;</span>
   <span class="n">refs</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">all_objects</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
   <span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">all_objects</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">all_objects</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                  <span class="n">std</span><span class="o">::</span><span class="n">back_inserter</span><span class="p">(</span><span class="n">refs</span><span class="p">),</span>
                                  <span class="p">[](</span><span class="k">const</span> <span class="n">ObjectType</span><span class="o">&amp;</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">cref</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="p">});</span>
   <span class="n">std</span><span class="o">::</span><span class="n">partial_sort</span><span class="p">(</span><span class="n">refs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">refs</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">refs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                   <span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">ObjectType</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">ObjectType</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span><span class="o">-&gt;</span><span class="kt">bool</span> <span class="p">{</span>
          <span class="n">share_type</span> <span class="n">oa_vote</span> <span class="o">=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">vote_id</span><span class="p">];</span>
          <span class="n">share_type</span> <span class="n">ob_vote</span> <span class="o">=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">b</span><span class="p">.</span><span class="n">vote_id</span><span class="p">];</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">oa_vote</span> <span class="o">!=</span> <span class="n">ob_vote</span> <span class="p">)</span>
                 <span class="k">return</span> <span class="n">oa_vote</span> <span class="o">&gt;</span> <span class="n">ob_vote</span><span class="p">;</span>
          <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">vote_id</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">vote_id</span><span class="p">;</span>
   <span class="p">});</span>

   <span class="n">refs</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">refs</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
   <span class="k">return</span> <span class="n">refs</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="perform-account-maintenance">
<h3><a class="toc-backref" href="#id52">perform_account_maintenance</a><a class="headerlink" href="#perform-account-maintenance" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Type</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">perform_account_maintenance</span><span class="p">(</span><span class="n">Type</span> <span class="n">tally_helper</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bal_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">account_balance_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">by_maintenance_flag</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">!=</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">auto</span> <span class="n">bal_itr</span> <span class="o">=</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span>
          <span class="k">while</span><span class="p">(</span> <span class="n">bal_itr</span><span class="o">-&gt;</span><span class="n">maintenance_flag</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">const</span> <span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="n">bal_obj</span> <span class="o">=</span> <span class="o">*</span><span class="n">bal_itr</span><span class="p">;</span>

                 <span class="n">modify</span><span class="p">(</span> <span class="n">get_account_stats_by_owner</span><span class="p">(</span> <span class="n">bal_obj</span><span class="p">.</span><span class="n">owner</span> <span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">bal_obj</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">aso</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">aso</span><span class="p">.</span><span class="n">core_in_balance</span> <span class="o">=</span> <span class="n">bal_obj</span><span class="p">.</span><span class="n">balance</span><span class="p">;</span>
                 <span class="p">});</span>

                 <span class="n">modify</span><span class="p">(</span> <span class="n">bal_obj</span><span class="p">,</span> <span class="p">[](</span> <span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="n">abo</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">abo</span><span class="p">.</span><span class="n">maintenance_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                 <span class="p">});</span>

                 <span class="n">bal_itr</span> <span class="o">=</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">stats_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">account_stats_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">by_maintenance_seq</span> <span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">stats_itr</span> <span class="o">=</span> <span class="n">stats_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>

   <span class="k">while</span><span class="p">(</span> <span class="n">stats_itr</span> <span class="o">!=</span> <span class="n">stats_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">acc_stat</span> <span class="o">=</span> <span class="o">*</span><span class="n">stats_itr</span><span class="p">;</span>
          <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">acc_obj</span> <span class="o">=</span> <span class="n">acc_stat</span><span class="p">.</span><span class="n">owner</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
          <span class="o">++</span><span class="n">stats_itr</span><span class="p">;</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">acc_stat</span><span class="p">.</span><span class="n">has_some_core_voting</span><span class="p">()</span> <span class="p">)</span>
                 <span class="n">tally_helper</span><span class="p">(</span> <span class="n">acc_obj</span><span class="p">,</span> <span class="n">acc_stat</span> <span class="p">);</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">acc_stat</span><span class="p">.</span><span class="n">has_pending_fees</span><span class="p">()</span> <span class="p">)</span>
                 <span class="n">acc_stat</span><span class="p">.</span><span class="n">process_fees</span><span class="p">(</span> <span class="n">acc_obj</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="worker-pay-visitor">
<h3><a class="toc-backref" href="#id53">worker_pay_visitor</a><a class="headerlink" href="#worker-pay-visitor" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A visitor for &#64;ref worker_type which calls pay_worker on the worker within</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">worker_pay_visitor</span>
<span class="p">{</span>
   <span class="k">private</span><span class="o">:</span>
          <span class="n">share_type</span> <span class="n">pay</span><span class="p">;</span>
          <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">;</span>

   <span class="k">public</span><span class="o">:</span>
          <span class="n">worker_pay_visitor</span><span class="p">(</span><span class="n">share_type</span> <span class="n">pay</span><span class="p">,</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">)</span>
                 <span class="o">:</span> <span class="n">pay</span><span class="p">(</span><span class="n">pay</span><span class="p">),</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">{}</span>

          <span class="k">typedef</span> <span class="kt">void</span> <span class="n">result_type</span><span class="p">;</span>
          <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">W</span><span class="o">&gt;</span>
          <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">W</span><span class="o">&amp;</span> <span class="n">worker</span><span class="p">)</span><span class="k">const</span>
          <span class="p">{</span>
                 <span class="n">worker</span><span class="p">.</span><span class="n">pay_worker</span><span class="p">(</span><span class="n">pay</span><span class="p">,</span> <span class="n">db</span><span class="p">);</span>
          <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="update-worker-votes">
<h3><a class="toc-backref" href="#id54">update_worker_votes</a><a class="headerlink" href="#update-worker-votes" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_worker_votes</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">worker_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_account</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr_end</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
   <span class="kt">bool</span> <span class="n">allow_negative_votes</span> <span class="o">=</span> <span class="p">(</span><span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">HARDFORK_607_TIME</span><span class="p">);</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">itr_end</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="o">*</span><span class="n">itr</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="n">allow_negative_votes</span><span class="p">](</span> <span class="n">worker_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">total_votes_for</span> <span class="o">=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">vote_for</span><span class="p">];</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">total_votes_against</span> <span class="o">=</span> <span class="n">allow_negative_votes</span> <span class="o">?</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">vote_against</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pay-workers">
<h3><a class="toc-backref" href="#id55">pay_workers</a><a class="headerlink" href="#pay-workers" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">pay_workers</span><span class="p">(</span> <span class="n">share_type</span><span class="o">&amp;</span> <span class="n">budget</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">head_time</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>
<span class="c1">//   ilog(&quot;Processing payroll! Available budget is ${b}&quot;, (&quot;b&quot;, budget));</span>
   <span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">reference_wrapper</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">worker_object</span><span class="o">&gt;&gt;</span> <span class="n">active_workers</span><span class="p">;</span>
   <span class="c1">// TODO optimization: add by_expiration index to avoid iterating through all objects</span>
   <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">worker_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">inspect_all_objects</span><span class="p">([</span><span class="n">head_time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">active_workers</span><span class="p">](</span><span class="k">const</span> <span class="n">object</span><span class="o">&amp;</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">const</span> <span class="n">worker_object</span><span class="o">&amp;</span> <span class="n">w</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">worker_object</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">w</span><span class="p">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">head_time</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="p">.</span><span class="n">approving_stake</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
                 <span class="n">active_workers</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
   <span class="p">});</span>

   <span class="c1">// worker with more votes is preferred</span>
   <span class="c1">// if two workers exactly tie for votes, worker with lower ID is preferred</span>
   <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">active_workers</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">active_workers</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[](</span><span class="k">const</span> <span class="n">worker_object</span><span class="o">&amp;</span> <span class="n">wa</span><span class="p">,</span> <span class="k">const</span> <span class="n">worker_object</span><span class="o">&amp;</span> <span class="n">wb</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">share_type</span> <span class="n">wa_vote</span> <span class="o">=</span> <span class="n">wa</span><span class="p">.</span><span class="n">approving_stake</span><span class="p">();</span>
          <span class="n">share_type</span> <span class="n">wb_vote</span> <span class="o">=</span> <span class="n">wb</span><span class="p">.</span><span class="n">approving_stake</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">wa_vote</span> <span class="o">!=</span> <span class="n">wb_vote</span> <span class="p">)</span>
                 <span class="k">return</span> <span class="n">wa_vote</span> <span class="o">&gt;</span> <span class="n">wb_vote</span><span class="p">;</span>
          <span class="k">return</span> <span class="n">wa</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">wb</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
   <span class="p">});</span>

   <span class="k">const</span> <span class="k">auto</span> <span class="n">last_budget_time</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">last_budget_time</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">passed_time_ms</span> <span class="o">=</span> <span class="n">head_time</span> <span class="o">-</span> <span class="n">last_budget_time</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">passed_time_count</span> <span class="o">=</span> <span class="n">passed_time_ms</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">day_count</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">days</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
   <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">active_workers</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">worker_object</span><span class="o">&amp;</span> <span class="n">active_worker</span> <span class="o">=</span> <span class="n">active_workers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="n">share_type</span> <span class="n">requested_pay</span> <span class="o">=</span> <span class="n">active_worker</span><span class="p">.</span><span class="n">daily_pay</span><span class="p">;</span>

          <span class="c1">// Note: if there is a good chance that passed_time_count == day_count,</span>
          <span class="c1">//       for better performance, can avoid the 128 bit calculation by adding a check.</span>
          <span class="c1">//       Since it&#39;s not the case on BitShares mainnet, we&#39;re not using a check here.</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span> <span class="n">pay</span><span class="p">(</span><span class="n">requested_pay</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
          <span class="n">pay</span> <span class="o">*=</span> <span class="n">passed_time_count</span><span class="p">;</span>
          <span class="n">pay</span> <span class="o">/=</span> <span class="n">day_count</span><span class="p">;</span>
          <span class="n">requested_pay</span> <span class="o">=</span> <span class="n">pay</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">();</span>

          <span class="n">share_type</span> <span class="n">actual_pay</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">requested_pay</span><span class="p">);</span>
          <span class="c1">//ilog(&quot; ==&gt; Paying ${a} to worker ${w}&quot;, (&quot;w&quot;, active_worker.id)(&quot;a&quot;, actual_pay));</span>
          <span class="n">modify</span><span class="p">(</span><span class="n">active_worker</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">worker_object</span><span class="o">&amp;</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">w</span><span class="p">.</span><span class="n">worker</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="n">worker_pay_visitor</span><span class="p">(</span><span class="n">actual_pay</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">));</span>
          <span class="p">});</span>

          <span class="n">budget</span> <span class="o">-=</span> <span class="n">actual_pay</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-active-witnesses">
<h3><a class="toc-backref" href="#id56">update_active_witnesses</a><a class="headerlink" href="#update-active-witnesses" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_active_witnesses</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">assert</span><span class="p">(</span> <span class="n">_witness_count_histogram_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">share_type</span> <span class="n">stake_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">_total_voting_stake</span><span class="o">-</span><span class="n">_witness_count_histogram_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

   <span class="c1">/// accounts that vote for 0 or 1 witness do not get to express an opinion on</span>
   <span class="c1">/// the number of witnesses to have (they abstain and are non-voting accounts)</span>

   <span class="n">share_type</span> <span class="n">stake_tally</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="kt">size_t</span> <span class="n">witness_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">stake_target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">witness_count</span> <span class="o">&lt;</span> <span class="n">_witness_count_histogram_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stake_tally</span> <span class="o">&lt;=</span> <span class="n">stake_target</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">stake_tally</span> <span class="o">+=</span> <span class="n">_witness_count_histogram_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">witness_count</span><span class="p">];</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">const</span> <span class="n">chain_property_object</span><span class="o">&amp;</span> <span class="n">cpo</span> <span class="o">=</span> <span class="n">get_chain_properties</span><span class="p">();</span>

   <span class="n">witness_count</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">witness_count</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">cpo</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">.</span><span class="n">min_witness_count</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">wits</span> <span class="o">=</span> <span class="n">sort_votable_objects</span><span class="o">&lt;</span><span class="n">witness_index</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">witness_count</span> <span class="p">);</span>

   <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>

   <span class="k">auto</span> <span class="n">update_witness_total_votes</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">](</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">wit</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">wit</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">](</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">total_votes</span> <span class="o">=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">vote_id</span><span class="p">];</span>
          <span class="p">});</span>
   <span class="p">};</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">_track_standby_votes</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">all_witnesses</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">witness_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="nl">wit</span> <span class="p">:</span> <span class="n">all_witnesses</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">update_witness_total_votes</span><span class="p">(</span> <span class="n">wit</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="nl">wit</span> <span class="p">:</span> <span class="n">wits</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">update_witness_total_votes</span><span class="p">(</span> <span class="n">wit</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// Update witness authority</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">get</span><span class="p">(</span><span class="n">GRAPHENE_WITNESS_ACCOUNT</span><span class="p">),</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wits</span><span class="p">](</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">HARDFORK_533_TIME</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="kt">uint64_t</span> <span class="n">total_votes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">map</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">weights</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

                 <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="nl">wit</span> <span class="p">:</span> <span class="n">wits</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">weights</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">wit</span><span class="p">.</span><span class="n">witness_account</span><span class="p">,</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">wit</span><span class="p">.</span><span class="n">vote_id</span><span class="p">]);</span>
                        <span class="n">total_votes</span> <span class="o">+=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">wit</span><span class="p">.</span><span class="n">vote_id</span><span class="p">];</span>
                 <span class="p">}</span>

                 <span class="c1">// total_votes is 64 bits. Subtract the number of leading low bits from 64 to get the number of useful bits,</span>
                 <span class="c1">// then I want to keep the most significant 16 bits of what&#39;s left.</span>
                 <span class="kt">int8_t</span> <span class="n">bits_to_drop</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">multiprecision</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">find_msb</span><span class="p">(</span><span class="n">total_votes</span><span class="p">))</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                 <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">weight</span> <span class="p">:</span> <span class="n">weights</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="c1">// Ensure that everyone has at least one vote. Zero weights aren&#39;t allowed.</span>
                        <span class="kt">uint16_t</span> <span class="n">votes</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">((</span><span class="n">weight</span><span class="p">.</span><span class="n">second</span> <span class="o">&gt;&gt;</span> <span class="n">bits_to_drop</span><span class="p">),</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
                        <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">account_auths</span><span class="p">[</span><span class="n">weight</span><span class="p">.</span><span class="n">first</span><span class="p">]</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span>
                        <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span>
                 <span class="p">}</span>

                 <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="n">vote_counter</span> <span class="n">vc</span><span class="p">;</span>
                 <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="nl">wit</span> <span class="p">:</span> <span class="n">wits</span> <span class="p">)</span>
                        <span class="n">vc</span><span class="p">.</span><span class="n">add</span><span class="p">(</span> <span class="n">wit</span><span class="p">.</span><span class="n">witness_account</span><span class="p">,</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">wit</span><span class="p">.</span><span class="n">vote_id</span><span class="p">]</span> <span class="p">);</span>
                 <span class="n">vc</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">active</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span> <span class="p">);</span>

   <span class="n">modify</span><span class="p">(</span> <span class="n">gpo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">wits</span><span class="p">](</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gp</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">gp</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
          <span class="n">gp</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">wits</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
          <span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">wits</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">wits</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                         <span class="n">std</span><span class="o">::</span><span class="n">inserter</span><span class="p">(</span><span class="n">gp</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">,</span> <span class="n">gp</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">end</span><span class="p">()),</span>
                                         <span class="p">[](</span><span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">return</span> <span class="n">w</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">});</span>

<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-active-committee-members">
<h3><a class="toc-backref" href="#id57">update_active_committee_members</a><a class="headerlink" href="#update-active-committee-members" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_active_committee_members</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">assert</span><span class="p">(</span> <span class="n">_committee_count_histogram_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">share_type</span> <span class="n">stake_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">_total_voting_stake</span><span class="o">-</span><span class="n">_committee_count_histogram_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

   <span class="c1">/// accounts that vote for 0 or 1 witness do not get to express an opinion on</span>
   <span class="c1">/// the number of witnesses to have (they abstain and are non-voting accounts)</span>
   <span class="kt">uint64_t</span> <span class="n">stake_tally</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// _committee_count_histogram_buffer[0];</span>
   <span class="kt">size_t</span> <span class="n">committee_member_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">stake_target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">committee_member_count</span> <span class="o">&lt;</span> <span class="n">_committee_count_histogram_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stake_tally</span> <span class="o">&lt;=</span> <span class="n">stake_target</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">stake_tally</span> <span class="o">+=</span> <span class="n">_committee_count_histogram_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">committee_member_count</span><span class="p">];</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">const</span> <span class="n">chain_property_object</span><span class="o">&amp;</span> <span class="n">cpo</span> <span class="o">=</span> <span class="n">get_chain_properties</span><span class="p">();</span>

   <span class="n">committee_member_count</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">committee_member_count</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">cpo</span><span class="p">.</span><span class="n">immutable_parameters</span><span class="p">.</span><span class="n">min_committee_member_count</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">committee_members</span> <span class="o">=</span> <span class="n">sort_votable_objects</span><span class="o">&lt;</span><span class="n">committee_member_index</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">committee_member_count</span> <span class="p">);</span>

   <span class="k">auto</span> <span class="n">update_committee_member_total_votes</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">](</span> <span class="k">const</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="n">cm</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">cm</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">](</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">total_votes</span> <span class="o">=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">obj</span><span class="p">.</span><span class="n">vote_id</span><span class="p">];</span>
          <span class="p">});</span>
   <span class="p">};</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">_track_standby_votes</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">all_committee_members</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">committee_member_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">();</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="nl">cm</span> <span class="p">:</span> <span class="n">all_committee_members</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">update_committee_member_total_votes</span><span class="p">(</span> <span class="n">cm</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="nl">cm</span> <span class="p">:</span> <span class="n">committee_members</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">update_committee_member_total_votes</span><span class="p">(</span> <span class="n">cm</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// Update committee authorities</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">committee_members</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">committee_account</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">GRAPHENE_COMMITTEE_ACCOUNT</span><span class="p">);</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">committee_account</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="o">&amp;</span><span class="n">committee_members</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">HARDFORK_533_TIME</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="kt">uint64_t</span> <span class="n">total_votes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">map</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">weights</span><span class="p">;</span>
                        <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

                        <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="nl">cm</span> <span class="p">:</span> <span class="n">committee_members</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">weights</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span> <span class="n">cm</span><span class="p">.</span><span class="n">committee_member_account</span><span class="p">,</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">cm</span><span class="p">.</span><span class="n">vote_id</span><span class="p">]</span> <span class="p">);</span>
                           <span class="n">total_votes</span> <span class="o">+=</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">cm</span><span class="p">.</span><span class="n">vote_id</span><span class="p">];</span>
                        <span class="p">}</span>

                        <span class="c1">// total_votes is 64 bits. Subtract the number of leading low bits from 64 to get the number of useful bits,</span>
                        <span class="c1">// then I want to keep the most significant 16 bits of what&#39;s left.</span>
                        <span class="kt">int8_t</span> <span class="n">bits_to_drop</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">multiprecision</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">find_msb</span><span class="p">(</span><span class="n">total_votes</span><span class="p">))</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">weight</span> <span class="p">:</span> <span class="n">weights</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="c1">// Ensure that everyone has at least one vote. Zero weights aren&#39;t allowed.</span>
                           <span class="kt">uint16_t</span> <span class="n">votes</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">((</span><span class="n">weight</span><span class="p">.</span><span class="n">second</span> <span class="o">&gt;&gt;</span> <span class="n">bits_to_drop</span><span class="p">),</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
                           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">account_auths</span><span class="p">[</span><span class="n">weight</span><span class="p">.</span><span class="n">first</span><span class="p">]</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span>
                           <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">+=</span> <span class="n">votes</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
                        <span class="n">a</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">weight_threshold</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="k">else</span>
                 <span class="p">{</span>
                        <span class="n">vote_counter</span> <span class="n">vc</span><span class="p">;</span>
                        <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="nl">cm</span> <span class="p">:</span> <span class="n">committee_members</span> <span class="p">)</span>
                           <span class="n">vc</span><span class="p">.</span><span class="n">add</span><span class="p">(</span> <span class="n">cm</span><span class="p">.</span><span class="n">committee_member_account</span><span class="p">,</span> <span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">cm</span><span class="p">.</span><span class="n">vote_id</span><span class="p">]</span> <span class="p">);</span>
                        <span class="n">vc</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">active</span> <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">});</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">get</span><span class="p">(</span><span class="n">GRAPHENE_RELAXED_COMMITTEE_ACCOUNT</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">committee_account</span><span class="p">](</span><span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">a</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">committee_account</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">get_global_properties</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">committee_members</span><span class="p">](</span><span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gp</span><span class="p">)</span>
   <span class="p">{</span>
          <span class="n">gp</span><span class="p">.</span><span class="n">active_committee_members</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
          <span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">committee_members</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">committee_members</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                                         <span class="n">std</span><span class="o">::</span><span class="n">inserter</span><span class="p">(</span><span class="n">gp</span><span class="p">.</span><span class="n">active_committee_members</span><span class="p">,</span> <span class="n">gp</span><span class="p">.</span><span class="n">active_committee_members</span><span class="p">.</span><span class="n">begin</span><span class="p">()),</span>
                                         <span class="p">[](</span><span class="k">const</span> <span class="n">committee_member_object</span><span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">;</span> <span class="p">});</span>
   <span class="p">});</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="initialize-budget-record">
<h3><a class="toc-backref" href="#id58">initialize_budget_record</a><a class="headerlink" href="#initialize-budget-record" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">initialize_budget_record</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">now</span><span class="p">,</span> <span class="n">budget_record</span><span class="o">&amp;</span> <span class="n">rec</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">core</span> <span class="o">=</span> <span class="n">get_core_asset</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">core_dd</span> <span class="o">=</span> <span class="n">get_core_dynamic_data</span><span class="p">();</span>

   <span class="n">rec</span><span class="p">.</span><span class="n">from_initial_reserve</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">reserved</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">rec</span><span class="p">.</span><span class="n">from_accumulated_fees</span> <span class="o">=</span> <span class="n">core_dd</span><span class="p">.</span><span class="n">accumulated_fees</span><span class="p">;</span>
   <span class="n">rec</span><span class="p">.</span><span class="n">from_unused_witness_budget</span> <span class="o">=</span> <span class="n">dpo</span><span class="p">.</span><span class="n">witness_budget</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span>    <span class="p">(</span><span class="n">dpo</span><span class="p">.</span><span class="n">last_budget_time</span> <span class="o">==</span> <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span><span class="p">())</span>
           <span class="o">||</span> <span class="p">(</span><span class="n">now</span> <span class="o">&lt;=</span> <span class="n">dpo</span><span class="p">.</span><span class="n">last_budget_time</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">time_since_last_budget</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kt">int64_t</span> <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">dpo</span><span class="p">.</span><span class="n">last_budget_time</span><span class="p">).</span><span class="n">to_seconds</span><span class="p">();</span>
   <span class="n">rec</span><span class="p">.</span><span class="n">time_since_last_budget</span> <span class="o">=</span> <span class="kt">uint64_t</span><span class="p">(</span> <span class="n">dt</span> <span class="p">);</span>

   <span class="c1">// We&#39;ll consider accumulated_fees to be reserved at the BEGINNING</span>
   <span class="c1">// of the maintenance interval.  However, for speed we only</span>
   <span class="c1">// call modify() on the asset_dynamic_data_object once at the</span>
   <span class="c1">// end of the maintenance interval.  Thus the accumulated_fees</span>
   <span class="c1">// are available for the budget at this point, but not included</span>
   <span class="c1">// in core.reserved().</span>
   <span class="n">share_type</span> <span class="n">reserve</span> <span class="o">=</span> <span class="n">rec</span><span class="p">.</span><span class="n">from_initial_reserve</span> <span class="o">+</span> <span class="n">core_dd</span><span class="p">.</span><span class="n">accumulated_fees</span><span class="p">;</span>
   <span class="c1">// Similarly, we consider leftover witness_budget to be burned</span>
   <span class="c1">// at the BEGINNING of the maintenance interval.</span>
   <span class="n">reserve</span> <span class="o">+=</span> <span class="n">dpo</span><span class="p">.</span><span class="n">witness_budget</span><span class="p">;</span>

   <span class="n">fc</span><span class="o">::</span><span class="n">uint128_t</span> <span class="n">budget_u128</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
   <span class="n">budget_u128</span> <span class="o">*=</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>
   <span class="n">budget_u128</span> <span class="o">*=</span> <span class="n">GRAPHENE_CORE_ASSET_CYCLE_RATE</span><span class="p">;</span>
   <span class="c1">//round up to the nearest satoshi -- this is necessary to ensure</span>
   <span class="c1">//   there isn&#39;t an &quot;untouchable&quot; reserve, and we will eventually</span>
   <span class="c1">//   be able to use the entire reserve</span>
   <span class="n">budget_u128</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">GRAPHENE_CORE_ASSET_CYCLE_RATE_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">budget_u128</span> <span class="o">&gt;&gt;=</span> <span class="n">GRAPHENE_CORE_ASSET_CYCLE_RATE_BITS</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">budget_u128</span> <span class="o">&lt;</span> <span class="n">reserve</span><span class="p">.</span><span class="n">value</span> <span class="p">)</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">total_budget</span> <span class="o">=</span> <span class="n">share_type</span><span class="p">(</span><span class="n">budget_u128</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">());</span>
   <span class="k">else</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">total_budget</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">;</span>

   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="process-budget">
<h3><a class="toc-backref" href="#id59">process_budget</a><a class="headerlink" href="#process-budget" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Update the budget for witnesses and workers.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">process_budget</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">try</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>
          <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>
          <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">core</span> <span class="o">=</span> <span class="n">get_core_dynamic_data</span><span class="p">();</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">now</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>

          <span class="kt">int64_t</span> <span class="n">time_to_maint</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpo</span><span class="p">.</span><span class="n">next_maintenance_time</span> <span class="o">-</span> <span class="n">now</span><span class="p">).</span><span class="n">to_seconds</span><span class="p">();</span>
          <span class="c1">//</span>
          <span class="c1">// The code that generates the next maintenance time should</span>
          <span class="c1">//    only produce a result in the future.  If this assert</span>
          <span class="c1">//    fails, then the next maintenance time algorithm is buggy.</span>
          <span class="c1">//</span>
          <span class="n">assert</span><span class="p">(</span> <span class="n">time_to_maint</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
          <span class="c1">//</span>
          <span class="c1">// Code for setting chain parameters should validate</span>
          <span class="c1">//    block_interval &gt; 0 (as well as the humans proposing /</span>
          <span class="c1">//    voting on changes to block interval).</span>
          <span class="c1">//</span>
          <span class="n">assert</span><span class="p">(</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">block_interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>
          <span class="kt">uint64_t</span> <span class="n">blocks_to_maint</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">(</span><span class="n">time_to_maint</span><span class="p">)</span> <span class="o">+</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">block_interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">block_interval</span><span class="p">;</span>

          <span class="c1">// blocks_to_maint &gt; 0 because time_to_maint &gt; 0,</span>
          <span class="c1">// which means numerator is at least equal to block_interval</span>

          <span class="n">budget_record</span> <span class="n">rec</span><span class="p">;</span>
          <span class="n">initialize_budget_record</span><span class="p">(</span> <span class="n">now</span><span class="p">,</span> <span class="n">rec</span> <span class="p">);</span>
          <span class="n">share_type</span> <span class="n">available_funds</span> <span class="o">=</span> <span class="n">rec</span><span class="p">.</span><span class="n">total_budget</span><span class="p">;</span>

          <span class="n">share_type</span> <span class="n">witness_budget</span> <span class="o">=</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">witness_pay_per_block</span><span class="p">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">blocks_to_maint</span><span class="p">;</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">requested_witness_budget</span> <span class="o">=</span> <span class="n">witness_budget</span><span class="p">;</span>
          <span class="n">witness_budget</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">witness_budget</span><span class="p">,</span> <span class="n">available_funds</span><span class="p">);</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">witness_budget</span> <span class="o">=</span> <span class="n">witness_budget</span><span class="p">;</span>
          <span class="n">available_funds</span> <span class="o">-=</span> <span class="n">witness_budget</span><span class="p">;</span>

          <span class="n">fc</span><span class="o">::</span><span class="n">uint128_t</span> <span class="n">worker_budget_u128</span> <span class="o">=</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">worker_budget_per_day</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
          <span class="n">worker_budget_u128</span> <span class="o">*=</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="n">time_to_maint</span><span class="p">);</span>
          <span class="n">worker_budget_u128</span> <span class="o">/=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span>

          <span class="n">share_type</span> <span class="n">worker_budget</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">worker_budget_u128</span> <span class="o">&gt;=</span> <span class="n">available_funds</span><span class="p">.</span><span class="n">value</span> <span class="p">)</span>
                 <span class="n">worker_budget</span> <span class="o">=</span> <span class="n">available_funds</span><span class="p">;</span>
          <span class="k">else</span>
                 <span class="n">worker_budget</span> <span class="o">=</span> <span class="n">worker_budget_u128</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">();</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">worker_budget</span> <span class="o">=</span> <span class="n">worker_budget</span><span class="p">;</span>
          <span class="n">available_funds</span> <span class="o">-=</span> <span class="n">worker_budget</span><span class="p">;</span>

          <span class="n">share_type</span> <span class="n">leftover_worker_funds</span> <span class="o">=</span> <span class="n">worker_budget</span><span class="p">;</span>
          <span class="n">pay_workers</span><span class="p">(</span><span class="n">leftover_worker_funds</span><span class="p">);</span>
          <span class="n">rec</span><span class="p">.</span><span class="n">leftover_worker_funds</span> <span class="o">=</span> <span class="n">leftover_worker_funds</span><span class="p">;</span>
          <span class="n">available_funds</span> <span class="o">+=</span> <span class="n">leftover_worker_funds</span><span class="p">;</span>

          <span class="n">rec</span><span class="p">.</span><span class="n">supply_delta</span> <span class="o">=</span> <span class="n">rec</span><span class="p">.</span><span class="n">witness_budget</span>
                 <span class="o">+</span> <span class="n">rec</span><span class="p">.</span><span class="n">worker_budget</span>
                 <span class="o">-</span> <span class="n">rec</span><span class="p">.</span><span class="n">leftover_worker_funds</span>
                 <span class="o">-</span> <span class="n">rec</span><span class="p">.</span><span class="n">from_accumulated_fees</span>
                 <span class="o">-</span> <span class="n">rec</span><span class="p">.</span><span class="n">from_unused_witness_budget</span><span class="p">;</span>

          <span class="n">modify</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">_core</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_core</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">=</span> <span class="p">(</span><span class="n">_core</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">+</span> <span class="n">rec</span><span class="p">.</span><span class="n">supply_delta</span> <span class="p">);</span>

                 <span class="n">assert</span><span class="p">(</span> <span class="n">rec</span><span class="p">.</span><span class="n">supply_delta</span> <span class="o">==</span>
                                                                   <span class="n">witness_budget</span>
                                                                 <span class="o">+</span> <span class="n">worker_budget</span>
                                                                 <span class="o">-</span> <span class="n">leftover_worker_funds</span>
                                                                 <span class="o">-</span> <span class="n">_core</span><span class="p">.</span><span class="n">accumulated_fees</span>
                                                                 <span class="o">-</span> <span class="n">dpo</span><span class="p">.</span><span class="n">witness_budget</span>
                                                                <span class="p">);</span>
                 <span class="n">_core</span><span class="p">.</span><span class="n">accumulated_fees</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="n">modify</span><span class="p">(</span><span class="n">dpo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">_dpo</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// Since initial witness_budget was rolled into</span>
                 <span class="c1">// available_funds, we replace it with witness_budget</span>
                 <span class="c1">// instead of adding it.</span>
                 <span class="n">_dpo</span><span class="p">.</span><span class="n">witness_budget</span> <span class="o">=</span> <span class="n">witness_budget</span><span class="p">;</span>
                 <span class="n">_dpo</span><span class="p">.</span><span class="n">last_budget_time</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="n">create</span><span class="o">&lt;</span> <span class="n">budget_record_object</span> <span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">budget_record_object</span><span class="o">&amp;</span> <span class="n">_rec</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_rec</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>
                 <span class="n">_rec</span><span class="p">.</span><span class="n">record</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="c1">// available_funds is money we could spend, but don&#39;t want to.</span>
          <span class="c1">// we simply let it evaporate back into the reserve.</span>
   <span class="p">}</span>
   <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="visit-special-authorities">
<h3><a class="toc-backref" href="#id60">visit_special_authorities</a><a class="headerlink" href="#visit-special-authorities" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">Visitor</span> <span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">visit_special_authorities</span><span class="p">(</span> <span class="k">const</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">,</span> <span class="n">Visitor</span> <span class="n">visit</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">sa_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">special_authority_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_id</span><span class="o">&gt;</span><span class="p">();</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">special_authority_object</span><span class="o">&amp;</span> <span class="nl">sao</span> <span class="p">:</span> <span class="n">sa_idx</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">acct</span> <span class="o">=</span> <span class="n">sao</span><span class="p">.</span><span class="n">account</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">acct</span><span class="p">.</span><span class="n">owner_special_authority</span><span class="p">.</span><span class="n">which</span><span class="p">()</span> <span class="o">!=</span> <span class="n">special_authority</span><span class="o">::</span><span class="n">tag</span><span class="o">&lt;</span> <span class="n">no_special_authority</span> <span class="o">&gt;::</span><span class="n">value</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">visit</span><span class="p">(</span> <span class="n">acct</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">acct</span><span class="p">.</span><span class="n">owner_special_authority</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">acct</span><span class="p">.</span><span class="n">active_special_authority</span><span class="p">.</span><span class="n">which</span><span class="p">()</span> <span class="o">!=</span> <span class="n">special_authority</span><span class="o">::</span><span class="n">tag</span><span class="o">&lt;</span> <span class="n">no_special_authority</span> <span class="o">&gt;::</span><span class="n">value</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">visit</span><span class="p">(</span> <span class="n">acct</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">acct</span><span class="p">.</span><span class="n">active_special_authority</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-top-n-authorities">
<h3><a class="toc-backref" href="#id61">update_top_n_authorities</a><a class="headerlink" href="#update-top-n-authorities" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">update_top_n_authorities</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">visit_special_authorities</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span>
   <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">acct</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_owner</span><span class="p">,</span> <span class="k">const</span> <span class="n">special_authority</span><span class="o">&amp;</span> <span class="n">auth</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">auth</span><span class="p">.</span><span class="n">which</span><span class="p">()</span> <span class="o">==</span> <span class="n">special_authority</span><span class="o">::</span><span class="n">tag</span><span class="o">&lt;</span> <span class="n">top_holders_special_authority</span> <span class="o">&gt;::</span><span class="n">value</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// use index to grab the top N holders of the asset and vote_counter to obtain the weights</span>

                 <span class="k">const</span> <span class="n">top_holders_special_authority</span><span class="o">&amp;</span> <span class="n">tha</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">top_holders_special_authority</span> <span class="o">&gt;</span><span class="p">();</span>
                 <span class="n">vote_counter</span> <span class="n">vc</span><span class="p">;</span>
                 <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bal_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">account_balance_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">by_asset_balance</span> <span class="o">&gt;</span><span class="p">();</span>
                 <span class="kt">uint8_t</span> <span class="n">num_needed</span> <span class="o">=</span> <span class="n">tha</span><span class="p">.</span><span class="n">num_top_holders</span><span class="p">;</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">num_needed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="k">return</span><span class="p">;</span>

                 <span class="c1">// find accounts</span>
                 <span class="k">const</span> <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">equal_range</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">tha</span><span class="p">.</span><span class="n">asset</span> <span class="p">)</span> <span class="p">);</span>
                 <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">account_balance_object</span><span class="o">&amp;</span> <span class="nl">bal</span> <span class="p">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_iterator_range</span><span class="p">(</span> <span class="n">range</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">second</span> <span class="p">)</span> <span class="p">)</span>
                 <span class="p">{</span>
                         <span class="n">assert</span><span class="p">(</span> <span class="n">bal</span><span class="p">.</span><span class="n">asset_type</span> <span class="o">==</span> <span class="n">tha</span><span class="p">.</span><span class="n">asset</span> <span class="p">);</span>
                         <span class="k">if</span><span class="p">(</span> <span class="n">bal</span><span class="p">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">acct</span><span class="p">.</span><span class="n">id</span> <span class="p">)</span>
                                <span class="k">continue</span><span class="p">;</span>
                         <span class="n">vc</span><span class="p">.</span><span class="n">add</span><span class="p">(</span> <span class="n">bal</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">bal</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">value</span> <span class="p">);</span>
                         <span class="o">--</span><span class="n">num_needed</span><span class="p">;</span>
                         <span class="k">if</span><span class="p">(</span> <span class="n">num_needed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                                <span class="k">break</span><span class="p">;</span>
                 <span class="p">}</span>

                 <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">acct</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">a</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">vc</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span> <span class="n">is_owner</span> <span class="o">?</span> <span class="n">a</span><span class="p">.</span><span class="nl">owner</span> <span class="p">:</span> <span class="n">a</span><span class="p">.</span><span class="n">active</span> <span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">vc</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="p">)</span>
                           <span class="n">a</span><span class="p">.</span><span class="n">top_n_control_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">is_owner</span> <span class="o">?</span> <span class="n">account_object</span><span class="o">::</span><span class="nl">top_n_control_owner</span> <span class="p">:</span> <span class="n">account_object</span><span class="o">::</span><span class="n">top_n_control_active</span><span class="p">);</span>
                 <span class="p">}</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="split-fba-balance">
<h3><a class="toc-backref" href="#id62">split_fba_balance</a><a class="headerlink" href="#split-fba-balance" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">split_fba_balance</span><span class="p">(</span>
   <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">,</span>
   <span class="kt">uint64_t</span> <span class="n">fba_id</span><span class="p">,</span>
   <span class="kt">uint16_t</span> <span class="n">network_pct</span><span class="p">,</span>
   <span class="kt">uint16_t</span> <span class="n">designated_asset_buyback_pct</span><span class="p">,</span>
   <span class="kt">uint16_t</span> <span class="n">designated_asset_issuer_pct</span>
<span class="p">)</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="kt">uint32_t</span><span class="p">(</span><span class="n">network_pct</span><span class="p">)</span> <span class="o">+</span> <span class="kt">uint32_t</span><span class="p">(</span><span class="n">designated_asset_buyback_pct</span><span class="p">)</span> <span class="o">+</span> <span class="kt">uint32_t</span><span class="p">(</span><span class="n">designated_asset_issuer_pct</span><span class="p">)</span> <span class="o">==</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="p">);</span>
   <span class="k">const</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="n">fba</span> <span class="o">=</span> <span class="n">fba_accumulator_id_type</span><span class="p">(</span> <span class="n">fba_id</span> <span class="p">)(</span><span class="n">db</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span><span class="p">;</span>

   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">core_dd</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_core_dynamic_data</span><span class="p">();</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">fba</span><span class="p">.</span><span class="n">is_configured</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;${n} core given to network at block ${b} due to non-configured FBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span><span class="p">)(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_time</span><span class="p">())</span> <span class="p">);</span>
          <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">core_dd</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">_core_dd</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_core_dd</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">-=</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
          <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">fba</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="n">_fba</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">fc</span><span class="o">::</span><span class="n">uint128_t</span> <span class="n">buyback_amount_128</span> <span class="o">=</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
   <span class="n">buyback_amount_128</span> <span class="o">*=</span> <span class="n">designated_asset_buyback_pct</span><span class="p">;</span>
   <span class="n">buyback_amount_128</span> <span class="o">/=</span> <span class="n">GRAPHENE_100_PERCENT</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">buyback_amount</span> <span class="o">=</span> <span class="n">buyback_amount_128</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">();</span>

   <span class="n">fc</span><span class="o">::</span><span class="n">uint128_t</span> <span class="n">issuer_amount_128</span> <span class="o">=</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
   <span class="n">issuer_amount_128</span> <span class="o">*=</span> <span class="n">designated_asset_issuer_pct</span><span class="p">;</span>
   <span class="n">issuer_amount_128</span> <span class="o">/=</span> <span class="n">GRAPHENE_100_PERCENT</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">issuer_amount</span> <span class="o">=</span> <span class="n">issuer_amount_128</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">();</span>

   <span class="c1">// this assert should never fail</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">buyback_amount</span> <span class="o">+</span> <span class="n">issuer_amount</span> <span class="o">&lt;=</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="p">);</span>

   <span class="n">share_type</span> <span class="n">network_amount</span> <span class="o">=</span> <span class="n">fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">-</span> <span class="p">(</span><span class="n">buyback_amount</span> <span class="o">+</span> <span class="n">issuer_amount</span><span class="p">);</span>

   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">designated_asset</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fba</span><span class="p">.</span><span class="n">designated_asset</span><span class="p">)(</span><span class="n">db</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">network_amount</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">core_dd</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">_core_dd</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_core_dd</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">-=</span> <span class="n">network_amount</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="n">fba_distribute_operation</span> <span class="n">vop</span><span class="p">;</span>
   <span class="n">vop</span><span class="p">.</span><span class="n">account_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">designated_asset</span><span class="p">.</span><span class="n">buyback_account</span><span class="p">;</span>
   <span class="n">vop</span><span class="p">.</span><span class="n">fba_id</span> <span class="o">=</span> <span class="n">fba</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
   <span class="n">vop</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">buyback_amount</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">vop</span><span class="p">.</span><span class="n">amount</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">db</span><span class="p">.</span><span class="n">adjust_balance</span><span class="p">(</span> <span class="o">*</span><span class="n">designated_asset</span><span class="p">.</span><span class="n">buyback_account</span><span class="p">,</span> <span class="n">asset</span><span class="p">(</span><span class="n">buyback_amount</span><span class="p">)</span> <span class="p">);</span>
          <span class="n">db</span><span class="p">.</span><span class="n">push_applied_operation</span><span class="p">(</span><span class="n">vop</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">vop</span><span class="p">.</span><span class="n">account_id</span> <span class="o">=</span> <span class="n">designated_asset</span><span class="p">.</span><span class="n">issuer</span><span class="p">;</span>
   <span class="n">vop</span><span class="p">.</span><span class="n">fba_id</span> <span class="o">=</span> <span class="n">fba</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
   <span class="n">vop</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">issuer_amount</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">vop</span><span class="p">.</span><span class="n">amount</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">db</span><span class="p">.</span><span class="n">adjust_balance</span><span class="p">(</span> <span class="n">designated_asset</span><span class="p">.</span><span class="n">issuer</span><span class="p">,</span> <span class="n">asset</span><span class="p">(</span><span class="n">issuer_amount</span><span class="p">)</span> <span class="p">);</span>
          <span class="n">db</span><span class="p">.</span><span class="n">push_applied_operation</span><span class="p">(</span><span class="n">vop</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">fba</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">fba_accumulator_object</span><span class="o">&amp;</span> <span class="n">_fba</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_fba</span><span class="p">.</span><span class="n">accumulated_fba_fees</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="distribute-fba-balances">
<h3><a class="toc-backref" href="#id63">distribute_fba_balances</a><a class="headerlink" href="#distribute-fba-balances" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">distribute_fba_balances</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">split_fba_balance</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span> <span class="n">fba_accumulator_id_transfer_to_blind</span>  <span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span> <span class="p">);</span>
   <span class="n">split_fba_balance</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span> <span class="n">fba_accumulator_id_blind_transfer</span>     <span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span> <span class="p">);</span>
   <span class="n">split_fba_balance</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span> <span class="n">fba_accumulator_id_transfer_from_blind</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span><span class="p">,</span> <span class="mi">60</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">GRAPHENE_1_PERCENT</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="create-buyback-orders">
<h3><a class="toc-backref" href="#id64">create_buyback_orders</a><a class="headerlink" href="#create-buyback-orders" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">create_buyback_orders</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bbo_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">buyback_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_id</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bal_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">account_balance_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">by_account_asset</span> <span class="o">&gt;</span><span class="p">();</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">buyback_object</span><span class="o">&amp;</span> <span class="nl">bbo</span> <span class="p">:</span> <span class="n">bbo_idx</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">asset_to_buy</span> <span class="o">=</span> <span class="n">bbo</span><span class="p">.</span><span class="n">asset_to_buy</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
          <span class="n">assert</span><span class="p">(</span> <span class="n">asset_to_buy</span><span class="p">.</span><span class="n">buyback_account</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">);</span>

          <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">buyback_account</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">asset_to_buy</span><span class="p">.</span><span class="n">buyback_account</span><span class="p">))(</span><span class="n">db</span><span class="p">);</span>
          <span class="n">asset_id_type</span> <span class="n">next_asset</span> <span class="o">=</span> <span class="n">asset_id_type</span><span class="p">();</span>

          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">buyback_account</span><span class="p">.</span><span class="n">allowed_assets</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;skipping buyback account ${b} at block ${n} because allowed_assets does not exist&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">buyback_account</span><span class="p">)(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">buyback_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">next_asset</span> <span class="p">)</span> <span class="p">);</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">it</span> <span class="o">==</span> <span class="n">bal_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">buyback_account</span><span class="p">.</span><span class="n">id</span> <span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                 <span class="n">asset_id_type</span> <span class="n">asset_to_sell</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">asset_type</span><span class="p">;</span>
                 <span class="n">share_type</span> <span class="n">amount_to_sell</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">balance</span><span class="p">;</span>
                 <span class="n">next_asset</span> <span class="o">=</span> <span class="n">asset_to_sell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">asset_to_sell</span> <span class="o">==</span> <span class="n">asset_to_buy</span><span class="p">.</span><span class="n">id</span> <span class="p">)</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">amount_to_sell</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">buyback_account</span><span class="p">.</span><span class="n">allowed_assets</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span> <span class="n">asset_to_sell</span> <span class="p">)</span> <span class="o">==</span> <span class="n">buyback_account</span><span class="p">.</span><span class="n">allowed_assets</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;buyback account ${b} not selling disallowed holdings of asset ${a} at block ${n}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">buyback_account</span><span class="p">)(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">asset_to_sell</span><span class="p">)(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="p">}</span>

                 <span class="k">try</span>
                 <span class="p">{</span>
                        <span class="n">transaction_evaluation_state</span> <span class="n">buyback_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
                        <span class="n">buyback_context</span><span class="p">.</span><span class="n">skip_fee_schedule_check</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

                        <span class="n">limit_order_create_operation</span> <span class="n">create_vop</span><span class="p">;</span>
                        <span class="n">create_vop</span><span class="p">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">);</span>
                        <span class="n">create_vop</span><span class="p">.</span><span class="n">seller</span> <span class="o">=</span> <span class="n">buyback_account</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                        <span class="n">create_vop</span><span class="p">.</span><span class="n">amount_to_sell</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="n">amount_to_sell</span><span class="p">,</span> <span class="n">asset_to_sell</span> <span class="p">);</span>
                        <span class="n">create_vop</span><span class="p">.</span><span class="n">min_to_receive</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">asset_to_buy</span><span class="p">.</span><span class="n">id</span> <span class="p">);</span>
                        <span class="n">create_vop</span><span class="p">.</span><span class="n">expiration</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="o">::</span><span class="n">maximum</span><span class="p">();</span>
                        <span class="n">create_vop</span><span class="p">.</span><span class="n">fill_or_kill</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

                        <span class="n">limit_order_id_type</span> <span class="n">order_id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">apply_operation</span><span class="p">(</span> <span class="n">buyback_context</span><span class="p">,</span> <span class="n">create_vop</span> <span class="p">).</span><span class="n">get</span><span class="o">&lt;</span> <span class="n">object_id_type</span> <span class="o">&gt;</span><span class="p">();</span>

                        <span class="k">if</span><span class="p">(</span> <span class="n">db</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">order_id</span> <span class="p">)</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">limit_order_cancel_operation</span> <span class="n">cancel_vop</span><span class="p">;</span>
                           <span class="n">cancel_vop</span><span class="p">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">);</span>
                           <span class="n">cancel_vop</span><span class="p">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order_id</span><span class="p">;</span>
                           <span class="n">cancel_vop</span><span class="p">.</span><span class="n">fee_paying_account</span> <span class="o">=</span> <span class="n">buyback_account</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

                           <span class="n">db</span><span class="p">.</span><span class="n">apply_operation</span><span class="p">(</span> <span class="n">buyback_context</span><span class="p">,</span> <span class="n">cancel_vop</span> <span class="p">);</span>
                        <span class="p">}</span>
                 <span class="p">}</span>
                 <span class="k">catch</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="c1">// we can in fact get here, e.g. if asset issuer of buy/sell asset blacklists/whitelists the buyback account</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Skipping buyback processing selling ${as} for ${ab} for buyback account ${b} at block ${n}; exception was ${e}&quot;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="s">&quot;as&quot;</span><span class="p">,</span> <span class="n">asset_to_sell</span><span class="p">)(</span><span class="s">&quot;ab&quot;</span><span class="p">,</span> <span class="n">asset_to_buy</span><span class="p">)(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="n">buyback_account</span><span class="p">)(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">())</span> <span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deprecate-annual-members">
<h3><a class="toc-backref" href="#id65">deprecate_annual_members</a><a class="headerlink" href="#deprecate-annual-members" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">deprecate_annual_members</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">account_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">account_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_id</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">now</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_time</span><span class="p">();</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="nl">acct</span> <span class="p">:</span> <span class="n">account_idx</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">try</span>
          <span class="p">{</span>
                 <span class="n">transaction_evaluation_state</span> <span class="n">upgrade_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db</span><span class="p">);</span>
                 <span class="n">upgrade_context</span><span class="p">.</span><span class="n">skip_fee_schedule_check</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

                 <span class="k">if</span><span class="p">(</span> <span class="n">acct</span><span class="p">.</span><span class="n">is_annual_member</span><span class="p">(</span> <span class="n">now</span> <span class="p">)</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">account_upgrade_operation</span> <span class="n">upgrade_vop</span><span class="p">;</span>
                        <span class="n">upgrade_vop</span><span class="p">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">);</span>
                        <span class="n">upgrade_vop</span><span class="p">.</span><span class="n">account_to_upgrade</span> <span class="o">=</span> <span class="n">acct</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                        <span class="n">upgrade_vop</span><span class="p">.</span><span class="n">upgrade_to_lifetime_member</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">db</span><span class="p">.</span><span class="n">apply_operation</span><span class="p">(</span> <span class="n">upgrade_context</span><span class="p">,</span> <span class="n">upgrade_vop</span> <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">catch</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// we can in fact get here, e.g. if asset issuer of buy/sell asset blacklists/whitelists the buyback account</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Skipping annual member deprecate processing for account ${a} (${an}) at block ${n}; exception was ${e}&quot;</span><span class="p">,</span>
                           <span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">acct</span><span class="p">.</span><span class="n">id</span><span class="p">)(</span><span class="s">&quot;an&quot;</span><span class="p">,</span> <span class="n">acct</span><span class="p">.</span><span class="n">name</span><span class="p">)(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">())</span> <span class="p">);</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="process-bids">
<h3><a class="toc-backref" href="#id66">process_bids</a><a class="headerlink" href="#process-bids" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">process_bids</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">bad</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">is_prediction_market</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="n">asset_id_type</span> <span class="n">to_revive_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">asset</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bad</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span> <span class="p">)</span> <span class="o">*</span> <span class="n">bad</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">).</span><span class="n">asset_id</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">to_revive</span> <span class="o">=</span> <span class="n">to_revive_id</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">bdd</span> <span class="o">=</span> <span class="n">to_revive</span><span class="p">.</span><span class="n">dynamic_data</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bid_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">collateral_bid_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">bid_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">to_revive_id</span><span class="p">,</span> <span class="n">price</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span> <span class="n">to_revive_id</span> <span class="p">),</span> <span class="n">collateral_bid_id_type</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>

   <span class="n">share_type</span> <span class="n">covered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">covered</span> <span class="o">&lt;</span> <span class="n">bdd</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">&amp;&amp;</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">bid_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">to_revive_id</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">bid</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
          <span class="n">asset</span> <span class="n">total_collateral</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span> <span class="o">*</span> <span class="n">bad</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">;</span>
          <span class="n">total_collateral</span> <span class="o">+=</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
          <span class="n">price</span> <span class="n">call_price</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">call_price</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">,</span> <span class="n">total_collateral</span><span class="p">,</span> <span class="n">bad</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">maintenance_collateral_ratio</span> <span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">~</span><span class="n">call_price</span> <span class="o">&gt;=</span> <span class="n">bad</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="n">covered</span> <span class="o">+=</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">covered</span> <span class="o">&lt;</span> <span class="n">bdd</span><span class="p">.</span><span class="n">current_supply</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

   <span class="k">const</span> <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">itr</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">to_cover</span> <span class="o">=</span> <span class="n">bdd</span><span class="p">.</span><span class="n">current_supply</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">remaining_fund</span> <span class="o">=</span> <span class="n">bad</span><span class="p">.</span><span class="n">settlement_fund</span><span class="p">;</span>
   <span class="k">for</span><span class="p">(</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">bid</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
          <span class="n">share_type</span> <span class="n">debt</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="n">share_type</span> <span class="n">collateral</span> <span class="o">=</span> <span class="p">(</span><span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span> <span class="o">*</span> <span class="n">bad</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">).</span><span class="n">amount</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;=</span> <span class="n">to_cover</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">debt</span> <span class="o">=</span> <span class="n">to_cover</span><span class="p">;</span>
                 <span class="n">collateral</span> <span class="o">=</span> <span class="n">remaining_fund</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">to_cover</span> <span class="o">-=</span> <span class="n">debt</span><span class="p">;</span>
          <span class="n">remaining_fund</span> <span class="o">-=</span> <span class="n">collateral</span><span class="p">;</span>
          <span class="n">execute_bid</span><span class="p">(</span> <span class="n">bid</span><span class="p">,</span> <span class="n">debt</span><span class="p">,</span> <span class="n">collateral</span><span class="p">,</span> <span class="n">bad</span><span class="p">.</span><span class="n">current_feed</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">remaining_fund</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">to_cover</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>

   <span class="n">_cancel_bids_and_revive_mpa</span><span class="p">(</span> <span class="n">to_revive</span><span class="p">,</span> <span class="n">bad</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-and-match-call-orders">
<h3><a class="toc-backref" href="#id67">update_and_match_call_orders</a><a class="headerlink" href="#update-and-match-call-orders" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">update_and_match_call_orders</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// Update call_price</span>
   <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Updating all call orders for hardfork core-343 at block ${n}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
   <span class="n">asset_id_type</span> <span class="n">current_asset</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">*</span> <span class="n">abd</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
   <span class="c1">// by_collateral index won&#39;t change after call_price updated, so it&#39;s safe to iterate</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">call_obj</span> <span class="p">:</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">call_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_collateral</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">current_asset</span> <span class="o">!=</span> <span class="n">call_obj</span><span class="p">.</span><span class="n">debt_type</span><span class="p">()</span> <span class="p">)</span> <span class="c1">// debt type won&#39;t be asset_id_type(), abd will always get initialized</span>
          <span class="p">{</span>
                 <span class="n">current_asset</span> <span class="o">=</span> <span class="n">call_obj</span><span class="p">.</span><span class="n">debt_type</span><span class="p">();</span>
                 <span class="n">abd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_asset</span><span class="p">(</span><span class="n">db</span><span class="p">).</span><span class="n">bitasset_data</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">abd</span> <span class="o">||</span> <span class="n">abd</span><span class="o">-&gt;</span><span class="n">is_prediction_market</span> <span class="p">)</span> <span class="c1">// nothing to do with PM&#39;s; check !abd just to be safe</span>
                 <span class="k">continue</span><span class="p">;</span>
          <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">call_obj</span><span class="p">,</span> <span class="p">[</span><span class="n">abd</span><span class="p">](</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">call</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="n">call</span><span class="p">.</span><span class="n">call_price</span>  <span class="o">=</span>  <span class="n">price</span><span class="o">::</span><span class="n">call_price</span><span class="p">(</span> <span class="n">call</span><span class="p">.</span><span class="n">get_debt</span><span class="p">(),</span> <span class="n">call</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">(),</span>
                                                                                                <span class="n">abd</span><span class="o">-&gt;</span><span class="n">current_feed</span><span class="p">.</span><span class="n">maintenance_collateral_ratio</span> <span class="p">);</span>
          <span class="p">});</span>
   <span class="p">}</span>
   <span class="c1">// Match call orders</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">asset_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_type</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">asset_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="nb">true</span> <span class="cm">/** market issued */</span> <span class="p">);</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">asset_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
          <span class="c1">// be here, next_maintenance_time should have been updated already</span>
          <span class="n">db</span><span class="p">.</span><span class="n">check_call_orders</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span> <span class="c1">// allow black swan, and call orders are taker</span>
   <span class="p">}</span>
   <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Done updating all call orders for hardfork core-343 at block ${n}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="process-bitassets">
<h3><a class="toc-backref" href="#id68">process_bitassets</a><a class="headerlink" href="#process-bitassets" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">process_bitassets</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">time_point_sec</span> <span class="n">head_time</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>
   <span class="kt">uint32_t</span> <span class="n">head_epoch_seconds</span> <span class="o">=</span> <span class="n">head_time</span><span class="p">.</span><span class="n">sec_since_epoch</span><span class="p">();</span>
   <span class="kt">bool</span> <span class="n">after_hf_core_518</span> <span class="o">=</span> <span class="p">(</span> <span class="n">head_time</span> <span class="o">&gt;=</span> <span class="n">HARDFORK_CORE_518_TIME</span> <span class="p">);</span> <span class="c1">// clear expired feeds</span>

   <span class="k">const</span> <span class="k">auto</span> <span class="n">update_bitasset</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="n">head_time</span><span class="p">,</span><span class="n">head_epoch_seconds</span><span class="p">,</span><span class="n">after_hf_core_518</span><span class="p">](</span> <span class="n">asset_bitasset_data_object</span> <span class="o">&amp;</span><span class="n">o</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">o</span><span class="p">.</span><span class="n">force_settled_volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Reset all BitAsset force settlement volumes to zero</span>

          <span class="c1">// clear expired feeds</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">after_hf_core_518</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">asset</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span> <span class="n">o</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
                 <span class="k">auto</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
                 <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">witness_fed_asset</span> <span class="o">|</span> <span class="n">committee_fed_asset</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                          <span class="n">o</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">feed_lifetime_sec</span> <span class="o">&lt;</span> <span class="n">head_epoch_seconds</span> <span class="p">)</span> <span class="c1">// if smartcoin &amp;&amp; check overflow</span>
                 <span class="p">{</span>
                        <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">calculated</span> <span class="o">=</span> <span class="n">head_time</span> <span class="o">-</span> <span class="n">o</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">feed_lifetime_sec</span><span class="p">;</span>
                        <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">o</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">rend</span><span class="p">();</span> <span class="p">)</span> <span class="c1">// loop feeds</span>
                        <span class="p">{</span>
                           <span class="k">auto</span> <span class="n">feed_time</span> <span class="o">=</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
                           <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span> <span class="n">itr</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
                           <span class="k">if</span><span class="p">(</span> <span class="n">feed_time</span> <span class="o">&lt;</span> <span class="n">calculated</span> <span class="p">)</span>
                                  <span class="n">o</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span> <span class="n">itr</span><span class="p">.</span><span class="n">base</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// delete expired feed</span>
                        <span class="p">}</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">};</span>

   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">d</span> <span class="p">:</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_bitasset_data_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">d</span><span class="p">,</span> <span class="n">update_bitasset</span> <span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">d</span><span class="p">.</span><span class="n">has_settlement</span><span class="p">()</span> <span class="p">)</span>
                 <span class="n">process_bids</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="process-hf-868-890">
<h3><a class="toc-backref" href="#id69">process_hf_868_890</a><a class="headerlink" href="#process-hf-868-890" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/******</span>
<span class="cm"> * @brief one-time data process for hard fork core-868-890</span>
<span class="cm"> *</span>
<span class="cm"> * Prior to hardfork 868, switching a bitasset&#39;s shorting asset would not reset its</span>
<span class="cm"> * feeds. This method will run at the hardfork time, and erase (or nullify) feeds</span>
<span class="cm"> * that have incorrect backing assets.</span>
<span class="cm"> * https://github.com/bitshares/bitshares-core/issues/868</span>
<span class="cm"> *</span>
<span class="cm"> * Prior to hardfork 890, changing a bitasset&#39;s feed expiration time would not</span>
<span class="cm"> * trigger a median feed update. This method will run at the hardfork time, and</span>
<span class="cm"> * correct all median feed data.</span>
<span class="cm"> * https://github.com/bitshares/bitshares-core/issues/890</span>
<span class="cm"> *</span>
<span class="cm"> * @param db the database</span>
<span class="cm"> * @param skip_check_call_orders true if check_call_orders() should not be called</span>
<span class="cm"> */</span>
<span class="c1">// TODO: for better performance, this function can be removed if it actually updated nothing at hf time.</span>
<span class="c1">//       * Also need to update related test cases</span>
<span class="c1">//       * NOTE: the removal can&#39;t be applied to testnet</span>
<span class="kt">void</span> <span class="nf">process_hf_868_890</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">skip_check_call_orders</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">head_time</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_time</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">head_num</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">();</span>
   <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Processing hard fork core-868-890 at block ${n}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">head_num</span><span class="p">)</span> <span class="p">);</span>
   <span class="c1">// for each market issued asset</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">asset_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_type</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">asset_itr</span> <span class="o">=</span> <span class="n">asset_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span> <span class="n">asset_itr</span> <span class="o">!=</span> <span class="n">asset_idx</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">asset_itr</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">current_asset</span> <span class="o">=</span> <span class="o">*</span><span class="n">asset_itr</span><span class="p">;</span>
          <span class="c1">// Incorrect witness &amp; committee feeds can simply be removed.</span>
          <span class="c1">// For non-witness-fed and non-committee-fed assets, set incorrect</span>
          <span class="c1">// feeds to price(), since we can&#39;t simply remove them. For more information:</span>
          <span class="c1">// https://github.com/bitshares/bitshares-core/pull/832#issuecomment-384112633</span>
          <span class="kt">bool</span> <span class="n">is_witness_or_committee_fed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">witness_fed_asset</span> <span class="o">|</span> <span class="n">committee_fed_asset</span> <span class="p">)</span> <span class="p">)</span>
                 <span class="n">is_witness_or_committee_fed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

          <span class="c1">// for each feed</span>
          <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">bitasset_data</span> <span class="o">=</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
          <span class="c1">// NOTE: We&#39;ll only need old_feed if HF343 hasn&#39;t rolled out yet</span>
          <span class="k">auto</span> <span class="n">old_feed</span> <span class="o">=</span> <span class="n">bitasset_data</span><span class="p">.</span><span class="n">current_feed</span><span class="p">;</span>
          <span class="kt">bool</span> <span class="n">feeds_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// did any feed change</span>
          <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">bitasset_data</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
          <span class="k">while</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">bitasset_data</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// If the feed is invalid</span>
                 <span class="k">if</span> <span class="p">(</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">bitasset_data</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span>
                           <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">is_witness_or_committee_fed</span> <span class="o">||</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">settlement_price</span> <span class="o">!=</span> <span class="n">price</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">feeds_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">bitasset_data</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">itr</span><span class="p">,</span> <span class="n">is_witness_or_committee_fed</span><span class="p">](</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="k">if</span><span class="p">(</span> <span class="n">is_witness_or_committee_fed</span> <span class="p">)</span>
                           <span class="p">{</span>
                                  <span class="c1">// erase the invalid feed</span>
                                  <span class="n">itr</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">feeds</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">itr</span><span class="p">);</span>
                           <span class="p">}</span>
                           <span class="k">else</span>
                           <span class="p">{</span>
                                  <span class="c1">// nullify the invalid feed</span>
                                  <span class="n">obj</span><span class="p">.</span><span class="n">feeds</span><span class="p">[</span><span class="n">itr</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">settlement_price</span> <span class="o">=</span> <span class="n">price</span><span class="p">();</span>
                                  <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
                           <span class="p">}</span>
                        <span class="p">});</span>
                 <span class="p">}</span>
                 <span class="k">else</span>
                 <span class="p">{</span>
                        <span class="c1">// Feed is valid. Skip it.</span>
                        <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
                 <span class="p">}</span>
          <span class="p">}</span> <span class="c1">// end loop of each feed</span>

          <span class="c1">// if any feed was modified, print a warning message</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">feeds_changed</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Found invalid feed for asset ${asset_sym} (${asset_id}) during hardfork core-868-890&quot;</span><span class="p">,</span>
                           <span class="p">(</span><span class="s">&quot;asset_sym&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">symbol</span><span class="p">)(</span><span class="s">&quot;asset_id&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="c1">// always update the median feed due to https://github.com/bitshares/bitshares-core/issues/890</span>
          <span class="n">db</span><span class="p">.</span><span class="n">modify</span><span class="p">(</span> <span class="n">bitasset_data</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">head_time</span><span class="p">](</span> <span class="n">asset_bitasset_data_object</span> <span class="o">&amp;</span><span class="n">obj</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">update_median_feeds</span><span class="p">(</span> <span class="n">head_time</span> <span class="p">);</span>
          <span class="p">});</span>

          <span class="kt">bool</span> <span class="n">median_changed</span> <span class="o">=</span> <span class="p">(</span> <span class="n">old_feed</span><span class="p">.</span><span class="n">settlement_price</span> <span class="o">!=</span> <span class="n">bitasset_data</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span> <span class="p">);</span>
          <span class="kt">bool</span> <span class="n">median_feed_changed</span> <span class="o">=</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="n">old_feed</span> <span class="o">==</span> <span class="n">bitasset_data</span><span class="p">.</span><span class="n">current_feed</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">median_feed_changed</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Median feed for asset ${asset_sym} (${asset_id}) changed during hardfork core-868-890&quot;</span><span class="p">,</span>
                           <span class="p">(</span><span class="s">&quot;asset_sym&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">symbol</span><span class="p">)(</span><span class="s">&quot;asset_id&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="c1">// Note: due to bitshares-core issue #935, the check below (using median_changed) is incorrect.</span>
          <span class="c1">//       However, `skip_check_call_orders` will likely be true in both testnet and mainnet,</span>
          <span class="c1">//         so effectively the incorrect code won&#39;t make a difference.</span>
          <span class="c1">//       Additionally, we have code to update all call orders again during hardfork core-935</span>
          <span class="c1">// TODO cleanup after hard fork</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">skip_check_call_orders</span> <span class="o">&amp;&amp;</span> <span class="n">median_changed</span> <span class="p">)</span> <span class="c1">// check_call_orders should be called</span>
          <span class="p">{</span>
                 <span class="n">db</span><span class="p">.</span><span class="n">check_call_orders</span><span class="p">(</span> <span class="n">current_asset</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">skip_check_call_orders</span> <span class="o">&amp;&amp;</span> <span class="n">median_feed_changed</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Incorrectly skipped check_call_orders for asset ${asset_sym} (${asset_id}) during hardfork core-868-890&quot;</span><span class="p">,</span>
                           <span class="p">(</span><span class="s">&quot;asset_sym&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">symbol</span><span class="p">)(</span><span class="s">&quot;asset_id&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span> <span class="c1">// for each market issued asset</span>
   <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Done processing hard fork core-868-890 at block ${n}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">head_num</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="process-hf-935">
<h3><a class="toc-backref" href="#id70">process_hf_935</a><a class="headerlink" href="#process-hf-935" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/******</span>
<span class="cm"> * @brief one-time data process for hard fork core-935</span>
<span class="cm"> *</span>
<span class="cm"> * Prior to hardfork 935, `check_call_orders` may be unintendedly skipped when</span>
<span class="cm"> * median price feed has changed. This method will run at the hardfork time, and</span>
<span class="cm"> * call `check_call_orders` for all markets.</span>
<span class="cm"> * https://github.com/bitshares/bitshares-core/issues/935</span>
<span class="cm"> *</span>
<span class="cm"> * @param db the database</span>
<span class="cm"> */</span>
<span class="c1">// TODO: for better performance, this function can be removed if it actually updated nothing at hf time.</span>
<span class="c1">//       * Also need to update related test cases</span>
<span class="c1">//       * NOTE: perhaps the removal can&#39;t be applied to testnet</span>
<span class="kt">void</span> <span class="nf">process_hf_935</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="kt">bool</span> <span class="n">changed_something</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">*</span> <span class="n">bitasset</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">settled_before_check_call</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">settled_after_check_call</span><span class="p">;</span>
   <span class="c1">// for each market issued asset</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">asset_idx</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_type</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">asset_itr</span> <span class="o">=</span> <span class="n">asset_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span> <span class="n">asset_itr</span> <span class="o">!=</span> <span class="n">asset_idx</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">asset_itr</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">current_asset</span> <span class="o">=</span> <span class="o">*</span><span class="n">asset_itr</span><span class="p">;</span>

          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">changed_something</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">bitasset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_asset</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span> <span class="n">db</span> <span class="p">);</span>
                 <span class="n">settled_before_check_call</span> <span class="o">=</span> <span class="n">bitasset</span><span class="o">-&gt;</span><span class="n">has_settlement</span><span class="p">();</span> <span class="c1">// whether already force settled</span>
          <span class="p">}</span>

          <span class="kt">bool</span> <span class="n">called_some</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">check_call_orders</span><span class="p">(</span> <span class="n">current_asset</span> <span class="p">);</span>

          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">changed_something</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">settled_after_check_call</span> <span class="o">=</span> <span class="n">bitasset</span><span class="o">-&gt;</span><span class="n">has_settlement</span><span class="p">();</span> <span class="c1">// whether already force settled</span>

                 <span class="k">if</span><span class="p">(</span> <span class="n">settled_before_check_call</span> <span class="o">!=</span> <span class="n">settled_after_check_call</span> <span class="o">||</span> <span class="n">called_some</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">changed_something</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;process_hf_935 changed something&quot;</span> <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="perform-chain-maintenance">
<h3><a class="toc-backref" href="#id71">perform_chain_maintenance</a><a class="headerlink" href="#perform-chain-maintenance" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">perform_chain_maintenance</span><span class="p">(</span><span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">next_block</span><span class="p">,</span> <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">global_props</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>

   <span class="n">distribute_fba_balances</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">create_buyback_orders</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="k">struct</span> <span class="n">vote_tally_helper</span> <span class="p">{</span>
          <span class="n">database</span><span class="o">&amp;</span> <span class="n">d</span><span class="p">;</span>
          <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">props</span><span class="p">;</span>

          <span class="n">vote_tally_helper</span><span class="p">(</span><span class="n">database</span><span class="o">&amp;</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span><span class="p">)</span>
                 <span class="o">:</span> <span class="n">d</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">props</span><span class="p">(</span><span class="n">gpo</span><span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">d</span><span class="p">.</span><span class="n">_vote_tally_buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">props</span><span class="p">.</span><span class="n">next_available_vote_id</span><span class="p">);</span>
                 <span class="n">d</span><span class="p">.</span><span class="n">_witness_count_histogram_buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">props</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">maximum_witness_count</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                 <span class="n">d</span><span class="p">.</span><span class="n">_committee_count_histogram_buffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">props</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">maximum_committee_count</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                 <span class="n">d</span><span class="p">.</span><span class="n">_total_voting_stake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">stake_account</span><span class="p">,</span> <span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">stats</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">props</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">count_non_member_votes</span> <span class="o">||</span> <span class="n">stake_account</span><span class="p">.</span><span class="n">is_member</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">head_block_time</span><span class="p">())</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="c1">// There may be a difference between the account whose stake is voting and the one specifying opinions.</span>
                        <span class="c1">// Usually they&#39;re the same, but if the stake account has specified a voting_account, that account is the one</span>
                        <span class="c1">// specifying the opinions.</span>
                        <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">opinion_account</span> <span class="o">=</span>
                                  <span class="p">(</span><span class="n">stake_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">voting_account</span> <span class="o">==</span>
                                   <span class="n">GRAPHENE_PROXY_TO_SELF_ACCOUNT</span><span class="p">)</span><span class="o">?</span> <span class="nl">stake_account</span>
                                                                         <span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">stake_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">voting_account</span><span class="p">);</span>

                        <span class="kt">uint64_t</span> <span class="n">voting_stake</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">total_core_in_orders</span><span class="p">.</span><span class="n">value</span>
                                  <span class="o">+</span> <span class="p">(</span><span class="n">stake_account</span><span class="p">.</span><span class="n">cashback_vb</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="o">?</span> <span class="p">(</span><span class="o">*</span><span class="n">stake_account</span><span class="p">.</span><span class="n">cashback_vb</span><span class="p">)(</span><span class="n">d</span><span class="p">).</span><span class="n">balance</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="nl">value</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
                                  <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">core_in_balance</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

                        <span class="k">for</span><span class="p">(</span> <span class="n">vote_id_type</span> <span class="nl">id</span> <span class="p">:</span> <span class="n">opinion_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">votes</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="kt">uint32_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">instance</span><span class="p">();</span>
                           <span class="c1">// if they somehow managed to specify an illegal offset, ignore it.</span>
                           <span class="k">if</span><span class="p">(</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">.</span><span class="n">_vote_tally_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span>
                                  <span class="n">d</span><span class="p">.</span><span class="n">_vote_tally_buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+=</span> <span class="n">voting_stake</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">if</span><span class="p">(</span> <span class="n">opinion_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">num_witness</span> <span class="o">&lt;=</span> <span class="n">props</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">maximum_witness_count</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="kt">uint16_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="kt">size_t</span><span class="p">(</span><span class="n">opinion_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">num_witness</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                                                                                  <span class="n">d</span><span class="p">.</span><span class="n">_witness_count_histogram_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                           <span class="c1">// votes for a number greater than maximum_witness_count</span>
                           <span class="c1">// are turned into votes for maximum_witness_count.</span>
                           <span class="c1">//</span>
                           <span class="c1">// in particular, this takes care of the case where a</span>
                           <span class="c1">// member was voting for a high number, then the</span>
                           <span class="c1">// parameter was lowered.</span>
                           <span class="n">d</span><span class="p">.</span><span class="n">_witness_count_histogram_buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+=</span> <span class="n">voting_stake</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">opinion_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">num_committee</span> <span class="o">&lt;=</span> <span class="n">props</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">maximum_committee_count</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="kt">uint16_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="kt">size_t</span><span class="p">(</span><span class="n">opinion_account</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">num_committee</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                                                                                  <span class="n">d</span><span class="p">.</span><span class="n">_committee_count_histogram_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                           <span class="c1">// votes for a number greater than maximum_committee_count</span>
                           <span class="c1">// are turned into votes for maximum_committee_count.</span>
                           <span class="c1">//</span>
                           <span class="c1">// same rationale as for witnesses</span>
                           <span class="n">d</span><span class="p">.</span><span class="n">_committee_count_histogram_buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">+=</span> <span class="n">voting_stake</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="n">d</span><span class="p">.</span><span class="n">_total_voting_stake</span> <span class="o">+=</span> <span class="n">voting_stake</span><span class="p">;</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span> <span class="n">tally_helper</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">gpo</span><span class="p">);</span>

   <span class="n">perform_account_maintenance</span><span class="p">(</span> <span class="n">tally_helper</span> <span class="p">);</span>

   <span class="k">struct</span> <span class="n">clear_canary</span> <span class="p">{</span>
          <span class="n">clear_canary</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;&amp;</span> <span class="n">target</span><span class="p">)</span><span class="o">:</span> <span class="n">target</span><span class="p">(</span><span class="n">target</span><span class="p">){}</span>
          <span class="o">~</span><span class="n">clear_canary</span><span class="p">()</span> <span class="p">{</span> <span class="n">target</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span> <span class="p">}</span>
   <span class="k">private</span><span class="o">:</span>
          <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;&amp;</span> <span class="n">target</span><span class="p">;</span>
   <span class="p">};</span>
   <span class="n">clear_canary</span> <span class="nf">a</span><span class="p">(</span><span class="n">_witness_count_histogram_buffer</span><span class="p">),</span>
                                <span class="n">b</span><span class="p">(</span><span class="n">_committee_count_histogram_buffer</span><span class="p">),</span>
                                <span class="n">c</span><span class="p">(</span><span class="n">_vote_tally_buffer</span><span class="p">);</span>

   <span class="n">update_top_n_authorities</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">update_active_witnesses</span><span class="p">();</span>
   <span class="n">update_active_committee_members</span><span class="p">();</span>
   <span class="n">update_worker_votes</span><span class="p">();</span>

   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dgpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>

   <span class="n">modify</span><span class="p">(</span><span class="n">gpo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">dgpo</span><span class="p">](</span><span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Remove scaling of account registration fee</span>
          <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">current_fees</span><span class="o">-&gt;</span><span class="n">get</span><span class="o">&lt;</span><span class="n">account_create_operation</span><span class="o">&gt;</span><span class="p">().</span><span class="n">basic_fee</span> <span class="o">&gt;&gt;=</span> <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">account_fee_scale_bitshifts</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">dgpo</span><span class="p">.</span><span class="n">accounts_registered_this_interval</span> <span class="o">/</span> <span class="n">p</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">accounts_per_fee_scale</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">pending_parameters</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">p</span><span class="p">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">.</span><span class="n">pending_parameters</span><span class="p">);</span>
                 <span class="n">p</span><span class="p">.</span><span class="n">pending_parameters</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
          <span class="p">}</span>
   <span class="p">});</span>

   <span class="k">auto</span> <span class="n">next_maintenance_time</span> <span class="o">=</span> <span class="n">dgpo</span><span class="p">.</span><span class="n">next_maintenance_time</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">maintenance_interval</span> <span class="o">=</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">maintenance_interval</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">next_maintenance_time</span> <span class="o">&lt;=</span> <span class="n">next_block</span><span class="p">.</span><span class="n">timestamp</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">next_block</span><span class="p">.</span><span class="n">block_num</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
                 <span class="n">next_maintenance_time</span> <span class="o">=</span> <span class="n">time_point_sec</span><span class="p">()</span> <span class="o">+</span>
                           <span class="p">(((</span><span class="n">next_block</span><span class="p">.</span><span class="n">timestamp</span><span class="p">.</span><span class="n">sec_since_epoch</span><span class="p">()</span> <span class="o">/</span> <span class="n">maintenance_interval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">maintenance_interval</span><span class="p">);</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="c1">// We want to find the smallest k such that next_maintenance_time + k * maintenance_interval &gt; head_block_time()</span>
                 <span class="c1">//  This implies k &gt; ( head_block_time() - next_maintenance_time ) / maintenance_interval</span>
                 <span class="c1">//</span>
                 <span class="c1">// Let y be the right-hand side of this inequality, i.e.</span>
                 <span class="c1">// y = ( head_block_time() - next_maintenance_time ) / maintenance_interval</span>
                 <span class="c1">//</span>
                 <span class="c1">// and let the fractional part f be y-floor(y).  Clearly 0 &lt;= f &lt; 1.</span>
                 <span class="c1">// We can rewrite f = y-floor(y) as floor(y) = y-f.</span>
                 <span class="c1">//</span>
                 <span class="c1">// Clearly k = floor(y)+1 has k &gt; y as desired.  Now we must</span>
                 <span class="c1">// show that this is the least such k, i.e. k-1 &lt;= y.</span>
                 <span class="c1">//</span>
                 <span class="c1">// But k-1 = floor(y)+1-1 = floor(y) = y-f &lt;= y.</span>
                 <span class="c1">// So this k suffices.</span>
                 <span class="c1">//</span>
                 <span class="k">auto</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">head_block_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">next_maintenance_time</span><span class="p">).</span><span class="n">to_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="n">maintenance_interval</span><span class="p">;</span>
                 <span class="n">next_maintenance_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">maintenance_interval</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">dgpo</span><span class="p">.</span><span class="n">next_maintenance_time</span> <span class="o">&lt;</span> <span class="n">HARDFORK_613_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next_maintenance_time</span> <span class="o">&gt;=</span> <span class="n">HARDFORK_613_TIME</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">deprecate_annual_members</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="c1">// To reset call_price of all call orders, then match by new rule</span>
   <span class="kt">bool</span> <span class="n">to_update_and_match_call_orders</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">dgpo</span><span class="p">.</span><span class="n">next_maintenance_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_343_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next_maintenance_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_343_TIME</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">to_update_and_match_call_orders</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

   <span class="c1">// Process inconsistent price feeds</span>
   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">dgpo</span><span class="p">.</span><span class="n">next_maintenance_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_868_890_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next_maintenance_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_868_890_TIME</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">process_hf_868_890</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">to_update_and_match_call_orders</span> <span class="p">);</span>

   <span class="c1">// Explicitly call check_call_orders of all markets</span>
   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">dgpo</span><span class="p">.</span><span class="n">next_maintenance_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_935_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">next_maintenance_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_935_TIME</span><span class="p">)</span>
                 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">to_update_and_match_call_orders</span> <span class="p">)</span>
          <span class="n">process_hf_935</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>

   <span class="n">modify</span><span class="p">(</span><span class="n">dgpo</span><span class="p">,</span> <span class="p">[</span><span class="n">next_maintenance_time</span><span class="p">](</span><span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">d</span><span class="p">.</span><span class="n">next_maintenance_time</span> <span class="o">=</span> <span class="n">next_maintenance_time</span><span class="p">;</span>
          <span class="n">d</span><span class="p">.</span><span class="n">accounts_registered_this_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">});</span>

   <span class="c1">// We need to do it after updated next_maintenance_time, to apply new rules here</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">to_update_and_match_call_orders</span> <span class="p">)</span>
          <span class="n">update_and_match_call_orders</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="n">process_bitassets</span><span class="p">();</span>

   <span class="c1">// process_budget needs to run at the bottom because</span>
   <span class="c1">//   it needs to know the next_maintenance_time</span>
   <span class="n">process_budget</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-management">
<h2><a class="toc-backref" href="#id72">db_management</a><a class="headerlink" href="#db-management" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">database</span><span class="o">::</span><span class="n">database</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">initialize_indexes</span><span class="p">();</span>
   <span class="n">initialize_evaluators</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">database</span><span class="o">::~</span><span class="n">database</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">clear_pending</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="reindex">
<h3><a class="toc-backref" href="#id73">reindex</a><a class="headerlink" href="#reindex" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">reindex</span><span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span> <span class="n">data_dir</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="k">auto</span> <span class="n">last_block</span> <span class="o">=</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">last</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">last_block</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;!no last block&quot;</span> <span class="p">);</span>
          <span class="n">edump</span><span class="p">((</span><span class="n">last_block</span><span class="p">));</span>
          <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">last_block</span><span class="o">-&gt;</span><span class="n">block_num</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">head_block_num</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>

   <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;reindexing blockchain&quot;</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">time_point</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">last_block_num</span> <span class="o">=</span> <span class="n">last_block</span><span class="o">-&gt;</span><span class="n">block_num</span><span class="p">();</span>
   <span class="kt">uint32_t</span> <span class="n">flush_point</span> <span class="o">=</span> <span class="n">last_block_num</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">last_block_num</span> <span class="o">-</span> <span class="mi">10000</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">undo_point</span> <span class="o">=</span> <span class="n">last_block_num</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">last_block_num</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span>

   <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Replaying blocks, starting at ${next}...&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">undo_point</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
                 <span class="n">_fork_db</span><span class="p">.</span><span class="n">start_block</span><span class="p">(</span> <span class="o">*</span><span class="n">fetch_block_by_number</span><span class="p">(</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span>
          <span class="n">_undo_db</span><span class="p">.</span><span class="n">disable</span><span class="p">();</span>
   <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last_block_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;   &quot;</span> <span class="o">&lt;&lt;</span> <span class="kt">double</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="n">last_block_num</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%   &quot;</span><span class="o">&lt;&lt;</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; of &quot;</span> <span class="o">&lt;&lt;</span><span class="n">last_block_num</span><span class="o">&lt;&lt;</span><span class="s">&quot;   </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">flush_point</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Writing database to disk at block ${i}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">);</span>
                 <span class="n">flush</span><span class="p">();</span>
                 <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Done&quot;</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span> <span class="n">signed_block</span> <span class="o">&gt;</span> <span class="n">block</span> <span class="o">=</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">fetch_by_number</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">block</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Reindexing terminated due to gap:  Block ${i} does not exist!&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">);</span>
                 <span class="kt">uint32_t</span> <span class="n">dropped_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="k">while</span><span class="p">(</span> <span class="nb">true</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">fc</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span> <span class="n">block_id_type</span> <span class="o">&gt;</span> <span class="n">last_id</span> <span class="o">=</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">last_id</span><span class="p">();</span>
                        <span class="c1">// this can trigger if we attempt to e.g. read a file that has block #2 but no block #1</span>
                        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">last_id</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
                           <span class="k">break</span><span class="p">;</span>
                        <span class="c1">// we&#39;ve caught up to the gap</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">block_header</span><span class="o">::</span><span class="n">num_from_id</span><span class="p">(</span> <span class="o">*</span><span class="n">last_id</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="p">)</span>
                           <span class="k">break</span><span class="p">;</span>
                        <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span> <span class="o">*</span><span class="n">last_id</span> <span class="p">);</span>
                        <span class="n">dropped_count</span><span class="o">++</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Dropped ${n} blocks from after the gap&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="n">dropped_count</span><span class="p">)</span> <span class="p">);</span>
                 <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">undo_point</span> <span class="p">)</span>
                 <span class="n">apply_block</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="n">skip_witness_signature</span> <span class="o">|</span>
                                                         <span class="n">skip_transaction_signatures</span> <span class="o">|</span>
                                                         <span class="n">skip_transaction_dupe_check</span> <span class="o">|</span>
                                                         <span class="n">skip_tapos_check</span> <span class="o">|</span>
                                                         <span class="n">skip_witness_schedule_check</span> <span class="o">|</span>
                                                         <span class="n">skip_authority_check</span><span class="p">);</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="n">_undo_db</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
                 <span class="n">push_block</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="n">skip_witness_signature</span> <span class="o">|</span>
                                                        <span class="n">skip_transaction_signatures</span> <span class="o">|</span>
                                                        <span class="n">skip_transaction_dupe_check</span> <span class="o">|</span>
                                                        <span class="n">skip_tapos_check</span> <span class="o">|</span>
                                                        <span class="n">skip_witness_schedule_check</span> <span class="o">|</span>
                                                        <span class="n">skip_authority_check</span><span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">_undo_db</span><span class="p">.</span><span class="n">enable</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">fc</span><span class="o">::</span><span class="n">time_point</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
   <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Done reindexing, elapsed time: ${t} sec&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">,</span><span class="kt">double</span><span class="p">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">())</span><span class="o">/</span><span class="mf">1000000.0</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="wipe">
<h3><a class="toc-backref" href="#id74">wipe</a><a class="headerlink" href="#wipe" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">wipe</span><span class="p">(</span><span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">data_dir</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">include_blocks</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">ilog</span><span class="p">(</span><span class="s">&quot;Wiping database&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;include_blocks&quot;</span><span class="p">,</span> <span class="n">include_blocks</span><span class="p">));</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">_opened</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">close</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="n">object_database</span><span class="o">::</span><span class="n">wipe</span><span class="p">(</span><span class="n">data_dir</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">include_blocks</span> <span class="p">)</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">remove_all</span><span class="p">(</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s">&quot;database&quot;</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="open">
<h3><a class="toc-backref" href="#id75">open</a><a class="headerlink" href="#open" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">open</span><span class="p">(</span>
   <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">path</span><span class="o">&amp;</span> <span class="n">data_dir</span><span class="p">,</span>
   <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">genesis_state_type</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">genesis_loader</span><span class="p">,</span>
   <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">db_version</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">try</span>
   <span class="p">{</span>
          <span class="kt">bool</span> <span class="n">wipe_object_db</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">fc</span><span class="o">::</span><span class="n">exists</span><span class="p">(</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s">&quot;db_version&quot;</span> <span class="p">)</span> <span class="p">)</span>
                 <span class="n">wipe_object_db</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">version_string</span><span class="p">;</span>
                 <span class="n">fc</span><span class="o">::</span><span class="n">read_file_contents</span><span class="p">(</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="s">&quot;db_version&quot;</span><span class="p">,</span> <span class="n">version_string</span> <span class="p">);</span>
                 <span class="n">wipe_object_db</span> <span class="o">=</span> <span class="p">(</span> <span class="n">version_string</span> <span class="o">!=</span> <span class="n">db_version</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">wipe_object_db</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="n">ilog</span><span class="p">(</span><span class="s">&quot;Wiping object_database due to missing or wrong version&quot;</span><span class="p">);</span>
                  <span class="n">object_database</span><span class="o">::</span><span class="n">wipe</span><span class="p">(</span> <span class="n">data_dir</span> <span class="p">);</span>
                  <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">version_file</span><span class="p">(</span> <span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s">&quot;db_version&quot;</span><span class="p">).</span><span class="n">generic_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
                                                                          <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">out</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span> <span class="o">|</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">trunc</span> <span class="p">);</span>
                  <span class="n">version_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span> <span class="n">db_version</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">db_version</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
                  <span class="n">version_file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="p">}</span>

          <span class="n">object_database</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="n">data_dir</span><span class="p">);</span>

          <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s">&quot;database&quot;</span> <span class="o">/</span> <span class="s">&quot;block_num_to_block&quot;</span><span class="p">);</span>

          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">find</span><span class="p">(</span><span class="n">global_property_id_type</span><span class="p">())</span> <span class="p">)</span>
                 <span class="n">init_genesis</span><span class="p">(</span><span class="n">genesis_loader</span><span class="p">());</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="n">_p_core_asset_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">);</span>
                 <span class="n">_p_core_dynamic_data_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span> <span class="n">asset_dynamic_data_id_type</span><span class="p">()</span> <span class="p">);</span>
                 <span class="n">_p_global_prop_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span> <span class="n">global_property_id_type</span><span class="p">()</span> <span class="p">);</span>
                 <span class="n">_p_chain_property_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span> <span class="n">chain_property_id_type</span><span class="p">()</span> <span class="p">);</span>
                 <span class="n">_p_dyn_global_prop_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span> <span class="n">dynamic_global_property_id_type</span><span class="p">()</span> <span class="p">);</span>
                 <span class="n">_p_witness_schedule_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span> <span class="n">witness_schedule_id_type</span><span class="p">()</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="n">fc</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">block_id_type</span><span class="o">&gt;</span> <span class="n">last_block</span> <span class="o">=</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">last_id</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">last_block</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">*</span><span class="n">last_block</span> <span class="o">&gt;=</span> <span class="n">head_block_id</span><span class="p">(),</span>
                                        <span class="s">&quot;last block ID does not match current chain state&quot;</span><span class="p">,</span>
                                        <span class="p">(</span><span class="s">&quot;last_block-&gt;id&quot;</span><span class="p">,</span> <span class="n">last_block</span><span class="p">)(</span><span class="s">&quot;head_block_id&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
                 <span class="n">reindex</span><span class="p">(</span> <span class="n">data_dir</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="n">_opened</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">FC_CAPTURE_LOG_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="close">
<h3><a class="toc-backref" href="#id76">close</a><a class="headerlink" href="#close" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="kt">bool</span> <span class="n">rewind</span><span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// TODO:  Save pending tx&#39;s on close()</span>
   <span class="n">clear_pending</span><span class="p">();</span>

   <span class="c1">// pop all of the blocks that we can given our undo history, this should</span>
   <span class="c1">// throw when there is no more undo history to pop</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">rewind</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">try</span>
          <span class="p">{</span>
                 <span class="kt">uint32_t</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">last_irreversible_block_num</span><span class="p">;</span>

                 <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Rewinding from ${head} to ${cutoff}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;cutoff&quot;</span><span class="p">,</span><span class="n">cutoff</span><span class="p">)</span> <span class="p">);</span>
                 <span class="k">while</span><span class="p">(</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">block_id_type</span> <span class="n">popped_block_id</span> <span class="o">=</span> <span class="n">head_block_id</span><span class="p">();</span>
                        <span class="n">pop_block</span><span class="p">();</span>
                        <span class="n">_fork_db</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">popped_block_id</span><span class="p">);</span> <span class="c1">// doesn&#39;t throw on missing</span>
                 <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Database close unexpected exception: ${e}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// Since pop_block() will move tx&#39;s in the popped blocks into pending,</span>
   <span class="c1">// we have to clear_pending() after we&#39;re done popping to get a clean</span>
   <span class="c1">// DB state (issue #336).</span>
   <span class="n">clear_pending</span><span class="p">();</span>

   <span class="n">object_database</span><span class="o">::</span><span class="n">flush</span><span class="p">();</span>
   <span class="n">object_database</span><span class="o">::</span><span class="n">close</span><span class="p">();</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">is_open</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">_block_id_to_block</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

   <span class="n">_fork_db</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>

   <span class="n">_opened</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-market">
<h2><a class="toc-backref" href="#id77">db_market</a><a class="headerlink" href="#db-market" title="Permalink to this headline">¶</a></h2>
<div class="section" id="globally-settle-asset">
<h3><a class="toc-backref" href="#id78">globally_settle_asset</a><a class="headerlink" href="#globally-settle-asset" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>All margin positions are force closed at the swan price</li>
<li>Collateral received goes into a force-settlement fund</li>
<li>No new margin positions can be created for this asset</li>
<li>Force settlement happens without delay at the swan price, deducting from force-settlement fund</li>
<li>No more asset updates may be issued.</li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">globally_settle_asset</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">mia</span><span class="p">,</span> <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">settlement_price</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="cm">/*</span>
<span class="cm">   elog( &quot;BLACK SWAN!&quot; );</span>
<span class="cm">   debug_dump();</span>
<span class="cm">   edump( (mia.symbol)(settlement_price) );</span>
<span class="cm">   */</span>

   <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">bitasset</span> <span class="o">=</span> <span class="n">mia</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">bitasset</span><span class="p">.</span><span class="n">has_settlement</span><span class="p">(),</span> <span class="s">&quot;black swan already occurred, it should not happen again&quot;</span> <span class="p">);</span>

   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">backing_asset</span> <span class="o">=</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">asset</span> <span class="n">collateral_gathered</span> <span class="o">=</span> <span class="n">backing_asset</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">mia_dyn</span> <span class="o">=</span> <span class="n">mia</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="k">auto</span> <span class="n">original_mia_supply</span> <span class="o">=</span> <span class="n">mia_dyn</span><span class="p">.</span><span class="n">current_supply</span><span class="p">;</span>

   <span class="k">const</span> <span class="n">call_order_index</span><span class="o">&amp;</span> <span class="n">call_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">call_order_index</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">call_price_index</span> <span class="o">=</span> <span class="n">call_index</span><span class="p">.</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>

   <span class="k">auto</span> <span class="n">maint_time</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">next_maintenance_time</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">before_core_hardfork_342</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_342_TIME</span> <span class="p">);</span> <span class="c1">// better rounding</span>

   <span class="c1">// cancel all call orders and accumulate it into collateral_gathered</span>
   <span class="k">auto</span> <span class="n">call_itr</span> <span class="o">=</span> <span class="n">call_price_index</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">price</span><span class="o">::</span><span class="n">min</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span> <span class="n">mia</span><span class="p">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">call_end</span> <span class="o">=</span> <span class="n">call_price_index</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span> <span class="n">price</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span> <span class="n">mia</span><span class="p">.</span><span class="n">id</span> <span class="p">)</span> <span class="p">);</span>
   <span class="n">asset</span> <span class="n">pays</span><span class="p">;</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">call_itr</span> <span class="o">!=</span> <span class="n">call_end</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">pays</span> <span class="o">=</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">get_debt</span><span class="p">()</span> <span class="o">*</span> <span class="n">settlement_price</span><span class="p">;</span> <span class="c1">// round down, in favor of call order</span>

                 <span class="c1">// Be here, the call order can be paying nothing</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bitasset</span><span class="p">.</span><span class="n">is_prediction_market</span> <span class="p">)</span> <span class="c1">// TODO remove this warning after hard fork core-342</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Something for nothing issue (#184, variant E) occurred at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
                 <span class="n">pays</span> <span class="o">=</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">get_debt</span><span class="p">().</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">settlement_price</span> <span class="p">);</span> <span class="c1">// round up, in favor of global settlement fund</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">pays</span> <span class="o">&gt;</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">get_collateral</span><span class="p">()</span> <span class="p">)</span>
                 <span class="n">pays</span> <span class="o">=</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">get_collateral</span><span class="p">();</span>

          <span class="n">collateral_gathered</span> <span class="o">+=</span> <span class="n">pays</span><span class="p">;</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span>  <span class="n">order</span> <span class="o">=</span> <span class="o">*</span><span class="n">call_itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">call_itr</span><span class="p">;</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">fill_call_order</span><span class="p">(</span> <span class="n">order</span><span class="p">,</span> <span class="n">pays</span><span class="p">,</span> <span class="n">order</span><span class="p">.</span><span class="n">get_debt</span><span class="p">(),</span> <span class="n">settlement_price</span><span class="p">,</span> <span class="nb">true</span> <span class="p">)</span> <span class="p">);</span> <span class="c1">// call order is maker</span>
   <span class="p">}</span>

   <span class="n">modify</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){</span>
                   <span class="n">assert</span><span class="p">(</span> <span class="n">collateral_gathered</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">settlement_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
                   <span class="n">obj</span><span class="p">.</span><span class="n">settlement_price</span> <span class="o">=</span> <span class="n">mia</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="n">original_mia_supply</span><span class="p">)</span> <span class="o">/</span> <span class="n">collateral_gathered</span><span class="p">;</span> <span class="c1">//settlement_price;</span>
                   <span class="n">obj</span><span class="p">.</span><span class="n">settlement_fund</span>  <span class="o">=</span> <span class="n">collateral_gathered</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                   <span class="p">});</span>

   <span class="c1">/// After all margin positions are closed, the current supply will be reported as 0, but</span>
   <span class="c1">/// that is a lie, the supply didn&#39;t change.   We need to capture the current supply before</span>
   <span class="c1">/// filling all call orders and then restore it afterward.   Then in the force settlement</span>
   <span class="c1">/// evaluator reduce the supply</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">mia_dyn</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){</span>
                   <span class="n">obj</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">=</span> <span class="n">original_mia_supply</span><span class="p">;</span>
                 <span class="p">});</span>

<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">mia</span><span class="p">)(</span><span class="n">settlement_price</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="revive-bitasset">
<h3><a class="toc-backref" href="#id79">revive_bitasset</a><a class="headerlink" href="#revive-bitasset" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">revive_bitasset</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">bitasset</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">is_market_issued</span><span class="p">()</span> <span class="p">);</span>
   <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">has_settlement</span><span class="p">()</span> <span class="p">);</span>
   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">bdd</span> <span class="o">=</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">bad</span><span class="p">.</span><span class="n">is_prediction_market</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">bad</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">bdd</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="c1">// Create + execute a &quot;bid&quot; with 0 additional collateral</span>
          <span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">pseudo_bid</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">collateral_bid_object</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">bid</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">bid</span><span class="p">.</span><span class="n">bidder</span> <span class="o">=</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">issuer</span><span class="p">;</span>
                 <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bad</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">)</span>
                                                          <span class="o">/</span> <span class="n">asset</span><span class="p">(</span><span class="n">bdd</span><span class="p">.</span><span class="n">current_supply</span><span class="p">,</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
          <span class="p">});</span>
          <span class="n">execute_bid</span><span class="p">(</span> <span class="n">pseudo_bid</span><span class="p">,</span> <span class="n">bdd</span><span class="p">.</span><span class="n">current_supply</span><span class="p">,</span> <span class="n">bad</span><span class="p">.</span><span class="n">settlement_fund</span><span class="p">,</span> <span class="n">bad</span><span class="p">.</span><span class="n">current_feed</span> <span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">settlement_fund</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>

   <span class="n">_cancel_bids_and_revive_mpa</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">,</span> <span class="n">bad</span> <span class="p">);</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">bitasset</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cancel-bids-and-revive-mpa">
<h3><a class="toc-backref" href="#id80">_cancel_bids_and_revive_mpa</a><a class="headerlink" href="#cancel-bids-and-revive-mpa" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">_cancel_bids_and_revive_mpa</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">bitasset</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">bad</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">is_market_issued</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">has_settlement</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="o">!</span><span class="n">bad</span><span class="p">.</span><span class="n">is_prediction_market</span> <span class="p">);</span>

   <span class="c1">// cancel remaining bids</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">bid_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span> <span class="n">collateral_bid_index</span> <span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">bid_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">price</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">bad</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">id</span> <span class="p">),</span> <span class="n">collateral_bid_id_type</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">bid_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">id</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">bid</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">itr</span><span class="p">;</span>
          <span class="n">cancel_bid</span><span class="p">(</span> <span class="n">bid</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// revive</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">bad</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){</span>
                          <span class="n">obj</span><span class="p">.</span><span class="n">settlement_price</span> <span class="o">=</span> <span class="n">price</span><span class="p">();</span>
                          <span class="n">obj</span><span class="p">.</span><span class="n">settlement_fund</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                   <span class="p">});</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">bitasset</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cancel-bid">
<h3><a class="toc-backref" href="#id81">cancel_bid</a><a class="headerlink" href="#cancel-bid" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">cancel_bid</span><span class="p">(</span><span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">bid</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">create_virtual_op</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">adjust_balance</span><span class="p">(</span><span class="n">bid</span><span class="p">.</span><span class="n">bidder</span><span class="p">,</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">create_virtual_op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">bid_collateral_operation</span> <span class="n">vop</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">bidder</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">bidder</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">additional_collateral</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">debt_covered</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
          <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">vop</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="n">remove</span><span class="p">(</span><span class="n">bid</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="execute-bid">
<h3><a class="toc-backref" href="#id82">execute_bid</a><a class="headerlink" href="#execute-bid" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">execute_bid</span><span class="p">(</span> <span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">&amp;</span> <span class="n">bid</span><span class="p">,</span> <span class="n">share_type</span> <span class="n">debt_covered</span><span class="p">,</span> <span class="n">share_type</span> <span class="n">collateral_from_fund</span><span class="p">,</span> <span class="k">const</span> <span class="n">price_feed</span><span class="o">&amp;</span> <span class="n">current_feed</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">call_obj</span> <span class="o">=</span> <span class="n">create</span><span class="o">&lt;</span><span class="n">call_order_object</span><span class="o">&gt;</span><span class="p">(</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">call</span> <span class="p">){</span>
                 <span class="n">call</span><span class="p">.</span><span class="n">borrower</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">bidder</span><span class="p">;</span>
                 <span class="n">call</span><span class="p">.</span><span class="n">collateral</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">collateral_from_fund</span><span class="p">;</span>
                 <span class="n">call</span><span class="p">.</span><span class="n">debt</span> <span class="o">=</span> <span class="n">debt_covered</span><span class="p">;</span>
                 <span class="n">call</span><span class="p">.</span><span class="n">call_price</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">call_price</span><span class="p">(</span><span class="n">asset</span><span class="p">(</span><span class="n">debt_covered</span><span class="p">,</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span><span class="p">),</span>
                                                                                         <span class="n">asset</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">collateral</span><span class="p">,</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span><span class="p">),</span>
                                                                                         <span class="n">current_feed</span><span class="p">.</span><span class="n">maintenance_collateral_ratio</span><span class="p">);</span>
          <span class="p">});</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">modify</span><span class="p">(</span><span class="n">bid</span><span class="p">.</span><span class="n">bidder</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">statistics</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">stats</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">+=</span> <span class="n">call_obj</span><span class="p">.</span><span class="n">collateral</span><span class="p">;</span>
          <span class="p">});</span>

   <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">execute_bid_operation</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">bidder</span><span class="p">,</span> <span class="n">asset</span><span class="p">(</span> <span class="n">call_obj</span><span class="p">.</span><span class="n">collateral</span><span class="p">,</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">),</span>
                                                                                                  <span class="n">asset</span><span class="p">(</span> <span class="n">debt_covered</span><span class="p">,</span> <span class="n">bid</span><span class="p">.</span><span class="n">inv_swan_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>

   <span class="n">remove</span><span class="p">(</span><span class="n">bid</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cancel-settle-order">
<h3><a class="toc-backref" href="#id83">cancel_settle_order</a><a class="headerlink" href="#cancel-settle-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">cancel_settle_order</span><span class="p">(</span><span class="k">const</span> <span class="n">force_settlement_object</span><span class="o">&amp;</span> <span class="n">order</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">create_virtual_op</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">adjust_balance</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">order</span><span class="p">.</span><span class="n">balance</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">create_virtual_op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">asset_settle_cancel_operation</span> <span class="n">vop</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">settlement</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">balance</span><span class="p">;</span>
          <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">vop</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cancel-limit-order">
<h3><a class="toc-backref" href="#id84">cancel_limit_order</a><a class="headerlink" href="#cancel-limit-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">cancel_limit_order</span><span class="p">(</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">order</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">create_virtual_op</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">skip_cancel_fee</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// if need to create a virtual op, try deduct a cancellation fee here.</span>
   <span class="c1">// there are two scenarios when order is cancelled and need to create a virtual op:</span>
   <span class="c1">// 1. due to expiration: always deduct a fee if there is any fee deferred</span>
   <span class="c1">// 2. due to cull_small: deduct a fee after hard fork 604, but not before (will set skip_cancel_fee)</span>
   <span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">*</span> <span class="n">seller_acc_stats</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">*</span> <span class="n">fee_asset_dyn_data</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
   <span class="n">limit_order_cancel_operation</span> <span class="n">vop</span><span class="p">;</span>
   <span class="n">share_type</span> <span class="n">deferred_fee</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_fee</span><span class="p">;</span>
   <span class="n">asset</span> <span class="n">deferred_paid_fee</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_paid_fee</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">create_virtual_op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
          <span class="n">vop</span><span class="p">.</span><span class="n">fee_paying_account</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">;</span>
          <span class="c1">// only deduct fee if not skipping fee, and there is any fee deferred</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">skip_cancel_fee</span> <span class="o">&amp;&amp;</span> <span class="n">deferred_fee</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">asset</span> <span class="n">core_cancel_fee</span> <span class="o">=</span> <span class="n">current_fee_schedule</span><span class="p">().</span><span class="n">calculate_fee</span><span class="p">(</span> <span class="n">vop</span> <span class="p">);</span>
                 <span class="c1">// cap the fee</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">core_cancel_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">deferred_fee</span> <span class="p">)</span>
                        <span class="n">core_cancel_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">deferred_fee</span><span class="p">;</span>
                 <span class="c1">// if there is any CORE fee to deduct, redirect it to referral program</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">core_cancel_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">seller_acc_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">).</span><span class="n">statistics</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
                        <span class="n">modify</span><span class="p">(</span> <span class="o">*</span><span class="n">seller_acc_stats</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="p">{</span>
                           <span class="n">obj</span><span class="p">.</span><span class="n">pay_fee</span><span class="p">(</span> <span class="n">core_cancel_fee</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">cashback_vesting_threshold</span> <span class="p">);</span>
                        <span class="p">}</span> <span class="p">);</span>
                        <span class="n">deferred_fee</span> <span class="o">-=</span> <span class="n">core_cancel_fee</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                        <span class="c1">// handle originally paid fee if any:</span>
                        <span class="c1">//    to_deduct = round_up( paid_fee * core_cancel_fee / deferred_core_fee_before_deduct )</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">vop</span><span class="p">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">core_cancel_fee</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                           <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span> <span class="n">fee128</span><span class="p">(</span> <span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="n">value</span> <span class="p">);</span>
                           <span class="n">fee128</span> <span class="o">*=</span> <span class="n">core_cancel_fee</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                           <span class="c1">// to round up</span>
                           <span class="n">fee128</span> <span class="o">+=</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_fee</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                           <span class="n">fee128</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                           <span class="n">fee128</span> <span class="o">/=</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_fee</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
                           <span class="n">share_type</span> <span class="n">cancel_fee_amount</span> <span class="o">=</span> <span class="n">fee128</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">();</span>
                           <span class="c1">// cancel_fee should be positive, pay it to asset&#39;s accumulated_fees</span>
                           <span class="n">fee_asset_dyn_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
                           <span class="n">modify</span><span class="p">(</span> <span class="o">*</span><span class="n">fee_asset_dyn_data</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">addo</span><span class="p">)</span> <span class="p">{</span>
                                  <span class="n">addo</span><span class="p">.</span><span class="n">accumulated_fees</span> <span class="o">+=</span> <span class="n">cancel_fee_amount</span><span class="p">;</span>
                           <span class="p">});</span>
                           <span class="c1">// cancel_fee should be no more than deferred_paid_fee</span>
                           <span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">-=</span> <span class="n">cancel_fee_amount</span><span class="p">;</span>
                           <span class="n">vop</span><span class="p">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">asset</span><span class="p">(</span> <span class="n">cancel_fee_amount</span><span class="p">,</span> <span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
                        <span class="p">}</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// refund funds in order</span>
   <span class="k">auto</span> <span class="n">refunded</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">refunded</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">seller_acc_stats</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="p">)</span>
                 <span class="n">seller_acc_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">).</span><span class="n">statistics</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
          <span class="n">modify</span><span class="p">(</span> <span class="o">*</span><span class="n">seller_acc_stats</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">-=</span> <span class="n">refunded</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>
   <span class="n">adjust_balance</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">,</span> <span class="n">refunded</span><span class="p">);</span>

   <span class="c1">// refund fee</span>
   <span class="c1">// could be virtual op or real op here</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="c1">// be here, order.create_time &lt;= HARDFORK_CORE_604_TIME, or fee paid in CORE, or no fee to refund.</span>
          <span class="c1">// if order was created before hard fork 604 then cancelled no matter before or after hard fork 604,</span>
          <span class="c1">//    see it as fee paid in CORE, deferred_fee should be refunded to order owner but not fee pool</span>
          <span class="n">adjust_balance</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">,</span> <span class="n">deferred_fee</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="c1">// need to refund fee in originally paid asset</span>
   <span class="p">{</span>
          <span class="n">adjust_balance</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">,</span> <span class="n">deferred_paid_fee</span><span class="p">);</span>
          <span class="c1">// be here, must have: fee_asset != CORE</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">fee_asset_dyn_data</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="p">)</span>
                 <span class="n">fee_asset_dyn_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
          <span class="n">modify</span><span class="p">(</span> <span class="o">*</span><span class="n">fee_asset_dyn_data</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">addo</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">addo</span><span class="p">.</span><span class="n">fee_pool</span> <span class="o">+=</span> <span class="n">deferred_fee</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">create_virtual_op</span> <span class="p">)</span>
          <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">vop</span> <span class="p">);</span>

   <span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="maybe-cull-small-order">
<h3><a class="toc-backref" href="#id85">maybe_cull_small_order</a><a class="headerlink" href="#maybe-cull-small-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="nf">maybe_cull_small_order</span><span class="p">(</span> <span class="n">database</span><span class="o">&amp;</span> <span class="n">db</span><span class="p">,</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">order</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="cm">/**</span>
<span class="cm">        *  There are times when the AMOUNT_FOR_SALE * SALE_PRICE == 0 which means that we</span>
<span class="cm">        *  have hit the limit where the seller is asking for nothing in return.  When this</span>
<span class="cm">        *  happens we must refund any balance back to the seller, it is too small to be</span>
<span class="cm">        *  sold at the sale price.</span>
<span class="cm">        *</span>
<span class="cm">        *  If the order is a taker order (as opposed to a maker order), so the price is</span>
<span class="cm">        *  set by the counterparty, this check is deferred until the order becomes unmatched</span>
<span class="cm">        *  (see #555) -- however, detecting this condition is the responsibility of the caller.</span>
<span class="cm">        */</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">amount_to_receive</span><span class="p">().</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_fee</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">db</span><span class="p">.</span><span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_604_TIME</span> <span class="p">)</span>
          <span class="p">{</span> <span class="c1">// TODO remove this warning after hard fork core-604</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;At block ${n}, cancelling order without charging a fee: ${o}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="n">db</span><span class="p">.</span><span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;o&quot;</span><span class="p">,</span><span class="n">order</span><span class="p">)</span> <span class="p">);</span>
                 <span class="n">db</span><span class="p">.</span><span class="n">cancel_limit_order</span><span class="p">(</span> <span class="n">order</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
                 <span class="n">db</span><span class="p">.</span><span class="n">cancel_limit_order</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apply-order-before-hardfork-625">
<h3><a class="toc-backref" href="#id86">apply_order_before_hardfork_625</a><a class="headerlink" href="#apply-order-before-hardfork-625" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="p">(</span><span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">new_order_object</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">allow_black_swan</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">order_id</span> <span class="o">=</span> <span class="n">new_order_object</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">sell_asset</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">new_order_object</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">().</span><span class="n">asset_id</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">receive_asset</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">new_order_object</span><span class="p">.</span><span class="n">amount_to_receive</span><span class="p">().</span><span class="n">asset_id</span><span class="p">);</span>

   <span class="c1">// Possible optimization: We only need to check calls if both are true:</span>
   <span class="c1">//  - The new order is at the front of the book</span>
   <span class="c1">//  - The new order is below the call limit price</span>
   <span class="kt">bool</span> <span class="n">called_some</span> <span class="o">=</span> <span class="n">check_call_orders</span><span class="p">(</span><span class="n">sell_asset</span><span class="p">,</span> <span class="n">allow_black_swan</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="c1">// the first time when checking, call order is maker</span>
   <span class="n">called_some</span> <span class="o">|=</span> <span class="n">check_call_orders</span><span class="p">(</span><span class="n">receive_asset</span><span class="p">,</span> <span class="n">allow_black_swan</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="c1">// the other side, same as above</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">called_some</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">find_object</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// then we were filled by call order</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">limit_price_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">limit_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>

   <span class="c1">// TODO: it should be possible to simply check the NEXT/PREV iterator after new_order_object to</span>
   <span class="c1">// determine whether or not this order has &quot;changed the book&quot; in a way that requires us to</span>
   <span class="c1">// check orders. For now I just lookup the lower bound and check for equality... this is log(n) vs</span>
   <span class="c1">// constant time check. Potential optimization.</span>

   <span class="k">auto</span> <span class="n">max_price</span> <span class="o">=</span> <span class="o">~</span><span class="n">new_order_object</span><span class="p">.</span><span class="n">sell_price</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">limit_itr</span> <span class="o">=</span> <span class="n">limit_price_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">max_price</span><span class="p">.</span><span class="n">max</span><span class="p">());</span>
   <span class="k">auto</span> <span class="n">limit_end</span> <span class="o">=</span> <span class="n">limit_price_idx</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">max_price</span><span class="p">);</span>

   <span class="kt">bool</span> <span class="n">finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">finished</span> <span class="o">&amp;&amp;</span> <span class="n">limit_itr</span> <span class="o">!=</span> <span class="n">limit_end</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">auto</span> <span class="n">old_limit_itr</span> <span class="o">=</span> <span class="n">limit_itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">limit_itr</span><span class="p">;</span>
          <span class="c1">// match returns 2 when only the old order was fully filled. In this case, we keep matching; otherwise, we stop.</span>
          <span class="n">finished</span> <span class="o">=</span> <span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="n">new_order_object</span><span class="p">,</span> <span class="o">*</span><span class="n">old_limit_itr</span><span class="p">,</span> <span class="n">old_limit_itr</span><span class="o">-&gt;</span><span class="n">sell_price</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">//Possible optimization: only check calls if the new order completely filled some old order</span>
   <span class="c1">//Do I need to check both assets?</span>
   <span class="n">check_call_orders</span><span class="p">(</span><span class="n">sell_asset</span><span class="p">,</span> <span class="n">allow_black_swan</span><span class="p">);</span> <span class="c1">// after the new limit order filled some orders on the book,</span>
                                                                                                        <span class="c1">// if a call order matches another order, the call order is taker</span>
   <span class="n">check_call_orders</span><span class="p">(</span><span class="n">receive_asset</span><span class="p">,</span> <span class="n">allow_black_swan</span><span class="p">);</span> <span class="c1">// the other side, same as above</span>

   <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">*</span> <span class="n">updated_order_object</span> <span class="o">=</span> <span class="n">find</span><span class="o">&lt;</span> <span class="n">limit_order_object</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">order_id</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">updated_order_object</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="p">)</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_555_TIME</span> <span class="p">)</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="c1">// before #555 we would have done maybe_cull_small_order() logic as a result of fill_order() being called by match() above</span>
   <span class="c1">// however after #555 we need to get rid of small orders -- #555 hardfork defers logic that was done too eagerly before, and</span>
   <span class="c1">// this is the point it&#39;s deferred to.</span>
   <span class="k">return</span> <span class="nf">maybe_cull_small_order</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">*</span><span class="n">updated_order_object</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="apply-order">
<h3><a class="toc-backref" href="#id87">apply_order</a><a class="headerlink" href="#apply-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">apply_order</span><span class="p">(</span><span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">new_order_object</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">allow_black_swan</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">order_id</span> <span class="o">=</span> <span class="n">new_order_object</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
   <span class="n">asset_id_type</span> <span class="n">sell_asset_id</span> <span class="o">=</span> <span class="n">new_order_object</span><span class="p">.</span><span class="n">sell_asset_id</span><span class="p">();</span>
   <span class="n">asset_id_type</span> <span class="n">recv_asset_id</span> <span class="o">=</span> <span class="n">new_order_object</span><span class="p">.</span><span class="n">receive_asset_id</span><span class="p">();</span>

   <span class="c1">// We only need to check if the new order will match with others if it is at the front of the book</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">limit_price_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">limit_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">limit_itr</span> <span class="o">=</span> <span class="n">limit_price_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span> <span class="n">new_order_object</span><span class="p">.</span><span class="n">sell_price</span><span class="p">,</span> <span class="n">order_id</span> <span class="p">)</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">limit_itr</span> <span class="o">!=</span> <span class="n">limit_price_idx</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="o">--</span><span class="n">limit_itr</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">limit_itr</span><span class="o">-&gt;</span><span class="n">sell_asset_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">sell_asset_id</span> <span class="o">&amp;&amp;</span> <span class="n">limit_itr</span><span class="o">-&gt;</span><span class="n">receive_asset_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">recv_asset_id</span> <span class="p">)</span>
                 <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// this is the opposite side (on the book)</span>
   <span class="k">auto</span> <span class="n">max_price</span> <span class="o">=</span> <span class="o">~</span><span class="n">new_order_object</span><span class="p">.</span><span class="n">sell_price</span><span class="p">;</span>
   <span class="n">limit_itr</span> <span class="o">=</span> <span class="n">limit_price_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">max_price</span><span class="p">.</span><span class="n">max</span><span class="p">()</span> <span class="p">);</span>
   <span class="k">auto</span> <span class="n">limit_end</span> <span class="o">=</span> <span class="n">limit_price_idx</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span> <span class="n">max_price</span> <span class="p">);</span>

   <span class="c1">// Order matching should be in favor of the taker.</span>
   <span class="c1">// When a new limit order is created, e.g. an ask, need to check if it will match the highest bid.</span>
   <span class="c1">// We were checking call orders first. However, due to MSSR (maximum_short_squeeze_ratio),</span>
   <span class="c1">// effective price of call orders may be worse than limit orders, so we should also check limit orders here.</span>

   <span class="c1">// Question: will a new limit order trigger a black swan event?</span>
   <span class="c1">//</span>
   <span class="c1">// 1. as of writing, it&#39;s possible due to the call-order-and-limit-order overlapping issue:</span>
   <span class="c1">//       https://github.com/bitshares/bitshares-core/issues/606 .</span>
   <span class="c1">//    when it happens, a call order can be very big but don&#39;t match with the opposite,</span>
   <span class="c1">//    even when price feed is too far away, further than swan price,</span>
   <span class="c1">//    if the new limit order is in the same direction with the call orders, it can eat up all the opposite,</span>
   <span class="c1">//    then the call order will lose support and trigger a black swan event.</span>
   <span class="c1">// 2. after issue 606 is fixed, there will be no limit order on the opposite side &quot;supporting&quot; the call order,</span>
   <span class="c1">//    so a new order in the same direction with the call order won&#39;t trigger a black swan event.</span>
   <span class="c1">// 3. calling is one direction. if the new limit order is on the opposite direction,</span>
   <span class="c1">//    no matter if matches with the call, it won&#39;t trigger a black swan event.</span>
   <span class="c1">//    (if a match at MSSP caused a black swan event, it means the call order is already undercollateralized,</span>
   <span class="c1">//      which should trigger a black swan event earlier.)</span>
   <span class="c1">//</span>
   <span class="c1">// Since it won&#39;t trigger a black swan, no need to check here.</span>

   <span class="c1">// currently we don&#39;t do cross-market (triangle) matching.</span>
   <span class="c1">// the limit order will only match with a call order if meet all of these:</span>
   <span class="c1">// 1. it&#39;s buying collateral, which means sell_asset is the MIA, receive_asset is the backing asset.</span>
   <span class="c1">// 2. sell_asset is not a prediction market</span>
   <span class="c1">// 3. sell_asset is not globally settled</span>
   <span class="c1">// 4. sell_asset has a valid price feed</span>
   <span class="c1">// 5. the call order&#39;s collateral ratio is below or equals to MCR</span>
   <span class="c1">// 6. the limit order provided a good price</span>

   <span class="kt">bool</span> <span class="n">to_check_call_orders</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">sell_asset</span> <span class="o">=</span> <span class="n">sell_asset_id</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
   <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">*</span> <span class="n">sell_abd</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
   <span class="n">price</span> <span class="n">call_match_price</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">sell_asset</span><span class="p">.</span><span class="n">is_market_issued</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">sell_abd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sell_asset</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span> <span class="o">==</span> <span class="n">recv_asset_id</span>
                  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">is_prediction_market</span>
                  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">has_settlement</span><span class="p">()</span>
                  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">call_match_price</span> <span class="o">=</span> <span class="o">~</span><span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">current_feed</span><span class="p">.</span><span class="n">max_short_squeeze_price</span><span class="p">();</span>
                 <span class="k">if</span><span class="p">(</span> <span class="o">~</span><span class="n">new_order_object</span><span class="p">.</span><span class="n">sell_price</span> <span class="o">&lt;=</span> <span class="n">call_match_price</span> <span class="p">)</span> <span class="c1">// new limit order price is good enough to match a call</span>
                        <span class="n">to_check_call_orders</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="kt">bool</span> <span class="n">finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// whether the new order is gone</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">to_check_call_orders</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="c1">// check limit orders first, match the ones with better price in comparison to call orders</span>
          <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">finished</span> <span class="o">&amp;&amp;</span> <span class="n">limit_itr</span> <span class="o">!=</span> <span class="n">limit_end</span> <span class="o">&amp;&amp;</span> <span class="n">limit_itr</span><span class="o">-&gt;</span><span class="n">sell_price</span> <span class="o">&gt;</span> <span class="n">call_match_price</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">auto</span> <span class="n">old_limit_itr</span> <span class="o">=</span> <span class="n">limit_itr</span><span class="p">;</span>
                 <span class="o">++</span><span class="n">limit_itr</span><span class="p">;</span>
                 <span class="c1">// match returns 2 when only the old order was fully filled. In this case, we keep matching; otherwise, we stop.</span>
                 <span class="n">finished</span> <span class="o">=</span> <span class="p">(</span> <span class="n">match</span><span class="p">(</span> <span class="n">new_order_object</span><span class="p">,</span> <span class="o">*</span><span class="n">old_limit_itr</span><span class="p">,</span> <span class="n">old_limit_itr</span><span class="o">-&gt;</span><span class="n">sell_price</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="p">}</span>

          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">finished</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="c1">// check if there are margin calls</span>
                 <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">call_price_idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">call_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>
                 <span class="k">auto</span> <span class="n">call_min</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">min</span><span class="p">(</span> <span class="n">recv_asset_id</span><span class="p">,</span> <span class="n">sell_asset_id</span> <span class="p">);</span>
                 <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">finished</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="c1">// assume hard fork core-343 and core-625 will take place at same time, always check call order with least call_price</span>
                        <span class="k">auto</span> <span class="n">call_itr</span> <span class="o">=</span> <span class="n">call_price_idx</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">call_min</span> <span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">call_itr</span> <span class="o">==</span> <span class="n">call_price_idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span>
                                  <span class="o">||</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">debt_type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">sell_asset_id</span>
                                  <span class="c1">// feed protected https://github.com/cryptonomex/graphene/issues/436</span>
                                  <span class="o">||</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">call_price</span> <span class="o">&gt;</span> <span class="o">~</span><span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span> <span class="p">)</span>
                           <span class="k">break</span><span class="p">;</span>
                        <span class="c1">// assume hard fork core-338 and core-625 will take place at same time, not checking HARDFORK_CORE_338_TIME here.</span>
                        <span class="kt">int</span> <span class="n">match_result</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span> <span class="n">new_order_object</span><span class="p">,</span> <span class="o">*</span><span class="n">call_itr</span><span class="p">,</span> <span class="n">call_match_price</span><span class="p">,</span>
                                                                          <span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">,</span>
                                                                          <span class="n">sell_abd</span><span class="o">-&gt;</span><span class="n">current_feed</span><span class="p">.</span><span class="n">maintenance_collateral_ratio</span> <span class="p">);</span>
                        <span class="c1">// match returns 1 or 3 when the new order was fully filled. In this case, we stop matching; otherwise keep matching.</span>
                        <span class="c1">// since match can return 0 due to BSIP38 (hard fork core-834), we no longer only check if the result is 2.</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">match_result</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">match_result</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
                           <span class="n">finished</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// still need to check limit orders</span>
   <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">finished</span> <span class="o">&amp;&amp;</span> <span class="n">limit_itr</span> <span class="o">!=</span> <span class="n">limit_end</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">auto</span> <span class="n">old_limit_itr</span> <span class="o">=</span> <span class="n">limit_itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">limit_itr</span><span class="p">;</span>
          <span class="c1">// match returns 2 when only the old order was fully filled. In this case, we keep matching; otherwise, we stop.</span>
          <span class="n">finished</span> <span class="o">=</span> <span class="p">(</span> <span class="n">match</span><span class="p">(</span> <span class="n">new_order_object</span><span class="p">,</span> <span class="o">*</span><span class="n">old_limit_itr</span><span class="p">,</span> <span class="n">old_limit_itr</span><span class="o">-&gt;</span><span class="n">sell_price</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">*</span> <span class="n">updated_order_object</span> <span class="o">=</span> <span class="n">find</span><span class="o">&lt;</span> <span class="n">limit_order_object</span> <span class="o">&gt;</span><span class="p">(</span> <span class="n">order_id</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">updated_order_object</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="p">)</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

   <span class="c1">// before #555 we would have done maybe_cull_small_order() logic as a result of fill_order() being called by match() above</span>
   <span class="c1">// however after #555 we need to get rid of small orders -- #555 hardfork defers logic that was done too eagerly before, and</span>
   <span class="c1">// this is the point it&#39;s deferred to.</span>
   <span class="k">return</span> <span class="nf">maybe_cull_small_order</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">*</span><span class="n">updated_order_object</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="match-int-database">
<h3><a class="toc-backref" href="#id88">match (int database)</a><a class="headerlink" href="#match-int-database" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  Matches the two orders, the first parameter is taker, the second is maker.</span>
<span class="cm"> *</span>
<span class="cm"> *  @return a bit field indicating which orders were filled (and thus removed)</span>
<span class="cm"> *</span>
<span class="cm"> *  0 - no orders were matched</span>
<span class="cm"> *  1 - taker was filled</span>
<span class="cm"> *  2 - maker was filled</span>
<span class="cm"> *  3 - both were filled</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">database</span><span class="o">::</span><span class="n">match</span><span class="p">(</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">usd</span><span class="p">,</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">core</span><span class="p">,</span> <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">match_price</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">usd</span><span class="p">.</span><span class="n">sell_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">core</span><span class="p">.</span><span class="n">sell_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">usd</span><span class="p">.</span><span class="n">sell_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span>  <span class="o">==</span> <span class="n">core</span><span class="p">.</span><span class="n">sell_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">usd</span><span class="p">.</span><span class="n">for_sale</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">core</span><span class="p">.</span><span class="n">for_sale</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>

   <span class="k">auto</span> <span class="n">usd_for_sale</span> <span class="o">=</span> <span class="n">usd</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">core_for_sale</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">();</span>

   <span class="n">asset</span> <span class="n">usd_pays</span><span class="p">,</span> <span class="n">usd_receives</span><span class="p">,</span> <span class="n">core_pays</span><span class="p">,</span> <span class="n">core_receives</span><span class="p">;</span>

   <span class="k">auto</span> <span class="n">maint_time</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">next_maintenance_time</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">before_core_hardfork_342</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_342_TIME</span> <span class="p">);</span> <span class="c1">// better rounding</span>

   <span class="kt">bool</span> <span class="n">cull_taker</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">usd_for_sale</span> <span class="o">&lt;=</span> <span class="n">core_for_sale</span> <span class="o">*</span> <span class="n">match_price</span> <span class="p">)</span> <span class="c1">// rounding down here should be fine</span>
   <span class="p">{</span>
          <span class="n">usd_receives</span>  <span class="o">=</span> <span class="n">usd_for_sale</span> <span class="o">*</span> <span class="n">match_price</span><span class="p">;</span> <span class="c1">// round down, in favor of bigger order</span>

          <span class="c1">// Be here, it&#39;s possible that taker is paying something for nothing due to partially filled in last loop.</span>
          <span class="c1">// In this case, we see it as filled and cancel it later</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">usd_receives</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">maint_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_184_TIME</span> <span class="p">)</span>
                 <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
                 <span class="n">core_receives</span> <span class="o">=</span> <span class="n">usd_for_sale</span><span class="p">;</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="c1">// The remaining amount in order `usd` would be too small,</span>
                 <span class="c1">//   so we should cull the order in fill_limit_order() below.</span>
                 <span class="c1">// The order would receive 0 even at `match_price`, so it would receive 0 at its own price,</span>
                 <span class="c1">//   so calling maybe_cull_small() will always cull it.</span>
                 <span class="n">core_receives</span> <span class="o">=</span> <span class="n">usd_receives</span><span class="p">.</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">match_price</span> <span class="p">);</span>
                 <span class="n">cull_taker</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
          <span class="c1">//This line once read: assert( core_for_sale &lt; usd_for_sale * match_price );</span>
          <span class="c1">//This assert is not always true -- see trade_amount_equals_zero in operation_tests.cpp</span>
          <span class="c1">//Although usd_for_sale is greater than core_for_sale * match_price, core_for_sale == usd_for_sale * match_price</span>
          <span class="c1">//Removing the assert seems to be safe -- apparently no asset is created or destroyed.</span>

          <span class="c1">// The maker won&#39;t be paying something for nothing, since if it would, it would have been cancelled already.</span>
          <span class="n">core_receives</span> <span class="o">=</span> <span class="n">core_for_sale</span> <span class="o">*</span> <span class="n">match_price</span><span class="p">;</span> <span class="c1">// round down, in favor of bigger order</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
                 <span class="n">usd_receives</span> <span class="o">=</span> <span class="n">core_for_sale</span><span class="p">;</span>
          <span class="k">else</span>
                 <span class="c1">// The remaining amount in order `core` would be too small,</span>
                 <span class="c1">//   so the order will be culled in fill_limit_order() below</span>
                 <span class="n">usd_receives</span> <span class="o">=</span> <span class="n">core_receives</span><span class="p">.</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">match_price</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="n">core_pays</span> <span class="o">=</span> <span class="n">usd_receives</span><span class="p">;</span>
   <span class="n">usd_pays</span>  <span class="o">=</span> <span class="n">core_receives</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">usd_pays</span> <span class="o">==</span> <span class="n">usd</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">()</span> <span class="o">||</span>
                                 <span class="n">core_pays</span> <span class="o">==</span> <span class="n">core</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">()</span> <span class="p">);</span>

   <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">result</span> <span class="o">|=</span> <span class="n">fill_limit_order</span><span class="p">(</span> <span class="n">usd</span><span class="p">,</span> <span class="n">usd_pays</span><span class="p">,</span> <span class="n">usd_receives</span><span class="p">,</span> <span class="n">cull_taker</span><span class="p">,</span> <span class="n">match_price</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span> <span class="c1">// the first param is taker</span>
   <span class="n">result</span> <span class="o">|=</span> <span class="n">fill_limit_order</span><span class="p">(</span> <span class="n">core</span><span class="p">,</span> <span class="n">core_pays</span><span class="p">,</span> <span class="n">core_receives</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">match_price</span><span class="p">,</span> <span class="nb">true</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// the second param is maker</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">database</span><span class="o">::</span><span class="n">match</span><span class="p">(</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">bid</span><span class="p">,</span> <span class="k">const</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">ask</span><span class="p">,</span> <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">match_price</span><span class="p">,</span>
                                         <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">feed_price</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">maintenance_collateral_ratio</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">sell_asset_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">ask</span><span class="p">.</span><span class="n">debt_type</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">receive_asset_id</span><span class="p">()</span> <span class="o">==</span> <span class="n">ask</span><span class="p">.</span><span class="n">collateral_type</span><span class="p">()</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">bid</span><span class="p">.</span><span class="n">for_sale</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ask</span><span class="p">.</span><span class="n">debt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ask</span><span class="p">.</span><span class="n">collateral</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">);</span>

   <span class="k">auto</span> <span class="n">maint_time</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">next_maintenance_time</span><span class="p">;</span>
   <span class="c1">// TODO remove when we&#39;re sure it&#39;s always false</span>
   <span class="kt">bool</span> <span class="n">before_core_hardfork_184</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_184_TIME</span> <span class="p">);</span> <span class="c1">// something-for-nothing</span>
   <span class="c1">// TODO remove when we&#39;re sure it&#39;s always false</span>
   <span class="kt">bool</span> <span class="n">before_core_hardfork_342</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_342_TIME</span> <span class="p">);</span> <span class="c1">// better rounding</span>
   <span class="c1">// TODO remove when we&#39;re sure it&#39;s always false</span>
   <span class="kt">bool</span> <span class="n">before_core_hardfork_834</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_834_TIME</span> <span class="p">);</span> <span class="c1">// target collateral ratio option</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_184</span> <span class="p">)</span>
          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;match(limit,call) is called before hardfork core-184 at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;match(limit,call) is called before hardfork core-342 at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_834</span> <span class="p">)</span>
          <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;match(limit,call) is called before hardfork core-834 at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>

   <span class="kt">bool</span> <span class="n">cull_taker</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

   <span class="n">asset</span> <span class="n">usd_for_sale</span> <span class="o">=</span> <span class="n">bid</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">();</span>
   <span class="c1">// TODO if we&#39;re sure `before_core_hardfork_834` is always false, remove the check</span>
   <span class="n">asset</span> <span class="n">usd_to_buy</span>   <span class="o">=</span> <span class="p">(</span> <span class="n">before_core_hardfork_834</span> <span class="o">?</span>
                                                  <span class="n">ask</span><span class="p">.</span><span class="n">get_debt</span><span class="p">()</span> <span class="o">:</span>
                                                  <span class="n">asset</span><span class="p">(</span> <span class="n">ask</span><span class="p">.</span><span class="n">get_max_debt_to_cover</span><span class="p">(</span> <span class="n">match_price</span><span class="p">,</span> <span class="n">feed_price</span><span class="p">,</span> <span class="n">maintenance_collateral_ratio</span> <span class="p">),</span>
                                                                 <span class="n">ask</span><span class="p">.</span><span class="n">debt_type</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>

   <span class="n">asset</span> <span class="n">call_pays</span><span class="p">,</span> <span class="n">call_receives</span><span class="p">,</span> <span class="n">order_pays</span><span class="p">,</span> <span class="n">order_receives</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">usd_to_buy</span> <span class="o">&gt;</span> <span class="n">usd_for_sale</span> <span class="p">)</span>
   <span class="p">{</span>  <span class="c1">// fill limit order</span>
          <span class="n">order_receives</span>  <span class="o">=</span> <span class="n">usd_for_sale</span> <span class="o">*</span> <span class="n">match_price</span><span class="p">;</span> <span class="c1">// round down here, in favor of call order</span>

          <span class="c1">// Be here, it&#39;s possible that taker is paying something for nothing due to partially filled in last loop.</span>
          <span class="c1">// In this case, we see it as filled and cancel it later</span>
          <span class="c1">// TODO remove hardfork check when we&#39;re sure it&#39;s always after hard fork (but keep the zero amount check)</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">order_receives</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">before_core_hardfork_184</span> <span class="p">)</span>
                 <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span> <span class="c1">// TODO remove this &quot;if&quot; when we&#39;re sure it&#39;s always false (keep the code in else)</span>
                 <span class="n">call_receives</span> <span class="o">=</span> <span class="n">usd_for_sale</span><span class="p">;</span>
          <span class="k">else</span>
          <span class="p">{</span>
                 <span class="c1">// The remaining amount in the limit order would be too small,</span>
                 <span class="c1">//   so we should cull the order in fill_limit_order() below.</span>
                 <span class="c1">// The order would receive 0 even at `match_price`, so it would receive 0 at its own price,</span>
                 <span class="c1">//   so calling maybe_cull_small() will always cull it.</span>
                 <span class="n">call_receives</span> <span class="o">=</span> <span class="n">order_receives</span><span class="p">.</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">match_price</span> <span class="p">);</span>
                 <span class="n">cull_taker</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>  <span class="c1">// fill call order</span>
          <span class="n">call_receives</span>  <span class="o">=</span> <span class="n">usd_to_buy</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span> <span class="c1">// TODO remove this &quot;if&quot; when we&#39;re sure it&#39;s always false (keep the code in else)</span>
          <span class="p">{</span>
                 <span class="n">order_receives</span> <span class="o">=</span> <span class="n">usd_to_buy</span> <span class="o">*</span> <span class="n">match_price</span><span class="p">;</span> <span class="c1">// round down here, in favor of call order</span>
                 <span class="c1">// TODO remove hardfork check when we&#39;re sure it&#39;s always after hard fork (but keep the zero amount check)</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">order_receives</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">before_core_hardfork_184</span> <span class="p">)</span>
                        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="c1">// has hardfork core-342</span>
                 <span class="n">order_receives</span> <span class="o">=</span> <span class="n">usd_to_buy</span><span class="p">.</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">match_price</span> <span class="p">);</span> <span class="c1">// round up here, in favor of limit order</span>
   <span class="p">}</span>

   <span class="n">call_pays</span>  <span class="o">=</span> <span class="n">order_receives</span><span class="p">;</span>
   <span class="n">order_pays</span> <span class="o">=</span> <span class="n">call_receives</span><span class="p">;</span>

   <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">result</span> <span class="o">|=</span> <span class="n">fill_limit_order</span><span class="p">(</span> <span class="n">bid</span><span class="p">,</span> <span class="n">order_pays</span><span class="p">,</span> <span class="n">order_receives</span><span class="p">,</span> <span class="n">cull_taker</span><span class="p">,</span> <span class="n">match_price</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span> <span class="c1">// the limit order is taker</span>
   <span class="n">result</span> <span class="o">|=</span> <span class="n">fill_call_order</span><span class="p">(</span> <span class="n">ask</span><span class="p">,</span> <span class="n">call_pays</span><span class="p">,</span> <span class="n">call_receives</span><span class="p">,</span> <span class="n">match_price</span><span class="p">,</span> <span class="nb">true</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>      <span class="c1">// the call order is maker</span>
   <span class="c1">// result can be 0 when call order has target_collateral_ratio option set.</span>

   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="match-asset-database">
<h3><a class="toc-backref" href="#id89">match (asset database)</a><a class="headerlink" href="#match-asset-database" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">asset</span> <span class="n">database</span><span class="o">::</span><span class="n">match</span><span class="p">(</span> <span class="k">const</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">call</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">force_settlement_object</span><span class="o">&amp;</span> <span class="n">settle</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">match_price</span><span class="p">,</span>
                                           <span class="n">asset</span> <span class="n">max_settlement</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">fill_price</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">get_debt</span><span class="p">().</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">debt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">call</span><span class="p">.</span><span class="n">collateral</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

   <span class="k">auto</span> <span class="n">maint_time</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">next_maintenance_time</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">before_core_hardfork_342</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_342_TIME</span> <span class="p">);</span> <span class="c1">// better rounding</span>

   <span class="k">auto</span> <span class="n">settle_for_sale</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">settle</span><span class="p">.</span><span class="n">balance</span><span class="p">,</span> <span class="n">max_settlement</span><span class="p">);</span>
   <span class="k">auto</span> <span class="n">call_debt</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">get_debt</span><span class="p">();</span>

   <span class="n">asset</span> <span class="n">call_receives</span>   <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">settle_for_sale</span><span class="p">,</span> <span class="n">call_debt</span><span class="p">);</span>
   <span class="n">asset</span> <span class="n">call_pays</span>       <span class="o">=</span> <span class="n">call_receives</span> <span class="o">*</span> <span class="n">match_price</span><span class="p">;</span> <span class="c1">// round down here, in favor of call order, for first check</span>
                                                                                                                <span class="c1">// TODO possible optimization: check need to round up or down first</span>

   <span class="c1">// Be here, the call order may be paying nothing.</span>
   <span class="kt">bool</span> <span class="n">cull_settle_order</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// whether need to cancel dust settle order</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">call_pays</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">maint_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_184_TIME</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">call_receives</span> <span class="o">==</span> <span class="n">call_debt</span> <span class="p">)</span> <span class="c1">// the call order is smaller than or equal to the settle order</span>
                 <span class="p">{</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Something for nothing issue (#184, variant C-1) handled at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
                        <span class="n">call_pays</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="k">else</span>
                 <span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">call_receives</span> <span class="o">==</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span> <span class="p">)</span> <span class="c1">// the settle order is smaller</span>
                        <span class="p">{</span>
                           <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Something for nothing issue (#184, variant C-2) handled at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
                           <span class="n">cancel_settle_order</span><span class="p">(</span> <span class="n">settle</span> <span class="p">);</span>
                        <span class="p">}</span>
                        <span class="c1">// else do nothing: neither order will be completely filled, perhaps due to max_settlement too small</span>

                        <span class="k">return</span> <span class="n">asset</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="c1">// TODO remove this warning after hard fork core-184</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Something for nothing issue (#184, variant C) occurred at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="c1">// the call order is not paying nothing, but still possible it&#39;s paying more than minimum required due to rounding</span>
   <span class="p">{</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">before_core_hardfork_342</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">call_receives</span> <span class="o">==</span> <span class="n">call_debt</span> <span class="p">)</span> <span class="c1">// the call order is smaller than or equal to the settle order</span>
                 <span class="p">{</span>
                        <span class="n">call_pays</span> <span class="o">=</span> <span class="n">call_receives</span><span class="p">.</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">match_price</span> <span class="p">);</span> <span class="c1">// round up here, in favor of settle order</span>
                        <span class="c1">// be here, we should have: call_pays &lt;= call_collateral</span>
                 <span class="p">}</span>
                 <span class="k">else</span>
                 <span class="p">{</span>
                        <span class="c1">// be here, call_pays has been rounded down</span>

                        <span class="c1">// be here, we should have: call_pays &lt;= call_collateral</span>

                        <span class="k">if</span><span class="p">(</span> <span class="n">call_receives</span> <span class="o">==</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span> <span class="p">)</span> <span class="c1">// the settle order will be completely filled, assuming we need to cull it</span>
                           <span class="n">cull_settle_order</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="c1">// else do nothing, since we can&#39;t cull the settle order</span>

                        <span class="n">call_receives</span> <span class="o">=</span> <span class="n">call_pays</span><span class="p">.</span><span class="n">multiply_and_round_up</span><span class="p">(</span> <span class="n">match_price</span> <span class="p">);</span> <span class="c1">// round up here to mitigate rounding issue (core-342).</span>
                                                                                                                                                        <span class="c1">// It is important to understand here that the newly</span>
                                                                                                                                                        <span class="c1">// rounded up call_receives won&#39;t be greater than the</span>
                                                                                                                                                        <span class="c1">// old call_receives.</span>

                        <span class="k">if</span><span class="p">(</span> <span class="n">call_receives</span> <span class="o">==</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span> <span class="p">)</span> <span class="c1">// the settle order will be completely filled, no need to cull</span>
                           <span class="n">cull_settle_order</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                        <span class="c1">// else do nothing, since we still need to cull the settle order or still can&#39;t cull the settle order</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">asset</span> <span class="n">settle_pays</span>     <span class="o">=</span> <span class="n">call_receives</span><span class="p">;</span>
   <span class="n">asset</span> <span class="n">settle_receives</span> <span class="o">=</span> <span class="n">call_pays</span><span class="p">;</span>

   <span class="cm">/**</span>
<span class="cm">        *  If the least collateralized call position lacks sufficient</span>
<span class="cm">        *  collateral to cover at the match price then this indicates a black</span>
<span class="cm">        *  swan event according to the price feed, but only the market</span>
<span class="cm">        *  can trigger a black swan.  So now we must cancel the forced settlement</span>
<span class="cm">        *  object.</span>
<span class="cm">        */</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">auto</span> <span class="n">call_collateral</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">call_pays</span> <span class="o">==</span> <span class="n">call_collateral</span> <span class="p">)</span> <span class="c1">// TODO remove warning after hard fork core-342</span>
                 <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Incorrectly captured black swan event at block #${block}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;block&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span> <span class="p">);</span>
          <span class="n">GRAPHENE_ASSERT</span><span class="p">(</span> <span class="n">call_pays</span> <span class="o">&lt;</span> <span class="n">call_collateral</span><span class="p">,</span> <span class="n">black_swan_exception</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">);</span>

          <span class="n">assert</span><span class="p">(</span> <span class="n">settle_pays</span> <span class="o">==</span> <span class="n">settle_for_sale</span> <span class="o">||</span> <span class="n">call_receives</span> <span class="o">==</span> <span class="n">call</span><span class="p">.</span><span class="n">get_debt</span><span class="p">()</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="c1">// else do nothing, since black swan event won&#39;t happen, and the assertion is no longer true</span>

   <span class="n">fill_call_order</span><span class="p">(</span> <span class="n">call</span><span class="p">,</span> <span class="n">call_pays</span><span class="p">,</span> <span class="n">call_receives</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="nb">true</span> <span class="p">);</span> <span class="c1">// call order is maker</span>
   <span class="n">fill_settle_order</span><span class="p">(</span> <span class="n">settle</span><span class="p">,</span> <span class="n">settle_pays</span><span class="p">,</span> <span class="n">settle_receives</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span> <span class="c1">// force settlement order is taker</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">cull_settle_order</span> <span class="p">)</span>
          <span class="n">cancel_settle_order</span><span class="p">(</span> <span class="n">settle</span> <span class="p">);</span>

   <span class="k">return</span> <span class="n">call_receives</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">call</span><span class="p">)(</span><span class="n">settle</span><span class="p">)(</span><span class="n">match_price</span><span class="p">)(</span><span class="n">max_settlement</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fill-limit-order">
<h3><a class="toc-backref" href="#id90">fill_limit_order</a><a class="headerlink" href="#fill-limit-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">fill_limit_order</span><span class="p">(</span> <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">order</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">pays</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">receives</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cull_if_small</span><span class="p">,</span>
                                                   <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">fill_price</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_maker</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="n">cull_if_small</span> <span class="o">|=</span> <span class="p">(</span><span class="n">head_block_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">HARDFORK_555_TIME</span><span class="p">);</span>

   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">().</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>

   <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">seller</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">recv_asset</span> <span class="o">=</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="k">auto</span> <span class="n">issuer_fees</span> <span class="o">=</span> <span class="n">pay_market_fees</span><span class="p">(</span> <span class="n">recv_asset</span><span class="p">,</span> <span class="n">receives</span> <span class="p">);</span>
   <span class="n">pay_order</span><span class="p">(</span> <span class="n">seller</span><span class="p">,</span> <span class="n">receives</span> <span class="o">-</span> <span class="n">issuer_fees</span><span class="p">,</span> <span class="n">pays</span> <span class="p">);</span>

   <span class="n">assert</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">fill_order_operation</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">order</span><span class="p">.</span><span class="n">seller</span><span class="p">,</span> <span class="n">pays</span><span class="p">,</span> <span class="n">receives</span><span class="p">,</span> <span class="n">issuer_fees</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">is_maker</span> <span class="p">)</span> <span class="p">);</span>

   <span class="c1">// conditional because cheap integer comparison may allow us to avoid two expensive modify() and object lookups</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_fee</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">seller</span><span class="p">.</span><span class="n">statistics</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">statistics</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">statistics</span><span class="p">.</span><span class="n">pay_fee</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_fee</span><span class="p">,</span> <span class="n">get_global_properties</span><span class="p">().</span><span class="n">parameters</span><span class="p">.</span><span class="n">cashback_vesting_threshold</span> <span class="p">);</span>
          <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="c1">// implies head_block_time() &gt; HARDFORK_CORE_604_TIME</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">fee_asset_dyn_data</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">fee_asset_dyn_data</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">addo</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">addo</span><span class="p">.</span><span class="n">accumulated_fees</span> <span class="o">+=</span> <span class="n">order</span><span class="p">.</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">pays</span> <span class="o">==</span> <span class="n">order</span><span class="p">.</span><span class="n">amount_for_sale</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">remove</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span> <span class="p">{</span>
                                                         <span class="n">b</span><span class="p">.</span><span class="n">for_sale</span> <span class="o">-=</span> <span class="n">pays</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                                                         <span class="n">b</span><span class="p">.</span><span class="n">deferred_fee</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                                         <span class="n">b</span><span class="p">.</span><span class="n">deferred_paid_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                                  <span class="p">});</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">cull_if_small</span> <span class="p">)</span>
                 <span class="k">return</span> <span class="n">maybe_cull_small_order</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">order</span> <span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">order</span><span class="p">)(</span><span class="n">pays</span><span class="p">)(</span><span class="n">receives</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fill-call-order">
<h3><a class="toc-backref" href="#id91">fill_call_order</a><a class="headerlink" href="#fill-call-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">fill_call_order</span><span class="p">(</span> <span class="k">const</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">order</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">pays</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">receives</span><span class="p">,</span>
                                                                <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">fill_price</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_maker</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="c1">//idump((pays)(receives)(order));</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">get_debt</span><span class="p">().</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">().</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">pays</span> <span class="p">);</span>

   <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">mia</span> <span class="o">=</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">is_market_issued</span><span class="p">()</span> <span class="p">);</span>

   <span class="n">optional</span><span class="o">&lt;</span><span class="n">asset</span><span class="o">&gt;</span> <span class="n">collateral_freed</span><span class="p">;</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">call_order_object</span><span class="o">&amp;</span> <span class="n">o</span> <span class="p">){</span>
                        <span class="n">o</span><span class="p">.</span><span class="n">debt</span>       <span class="o">-=</span> <span class="n">receives</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                        <span class="n">o</span><span class="p">.</span><span class="n">collateral</span> <span class="o">-=</span> <span class="n">pays</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">o</span><span class="p">.</span><span class="n">debt</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="p">{</span>
                          <span class="n">collateral_freed</span> <span class="o">=</span> <span class="n">o</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">();</span>
                          <span class="n">o</span><span class="p">.</span><span class="n">collateral</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">next_maintenance_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_343_TIME</span> <span class="p">)</span>
                          <span class="n">o</span><span class="p">.</span><span class="n">call_price</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">call_price</span><span class="p">(</span> <span class="n">o</span><span class="p">.</span><span class="n">get_debt</span><span class="p">(),</span> <span class="n">o</span><span class="p">.</span><span class="n">get_collateral</span><span class="p">(),</span>
                                                                <span class="n">mia</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">current_feed</span><span class="p">.</span><span class="n">maintenance_collateral_ratio</span> <span class="p">);</span>
           <span class="p">});</span>

   <span class="k">const</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">mia_ddo</span> <span class="o">=</span> <span class="n">mia</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

   <span class="n">modify</span><span class="p">(</span> <span class="n">mia_ddo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">ao</span> <span class="p">){</span>
           <span class="c1">//idump((receives));</span>
                <span class="n">ao</span><span class="p">.</span><span class="n">current_supply</span> <span class="o">-=</span> <span class="n">receives</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="p">});</span>

   <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">borrower</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">borrower</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">collateral_freed</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="o">||</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">borrower_statistics</span> <span class="o">=</span> <span class="n">borrower</span><span class="p">.</span><span class="n">statistics</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">collateral_freed</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
                 <span class="n">adjust_balance</span><span class="p">(</span><span class="n">borrower</span><span class="p">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="o">*</span><span class="n">collateral_freed</span><span class="p">);</span>

          <span class="n">modify</span><span class="p">(</span> <span class="n">borrower_statistics</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">){</span>
                          <span class="k">if</span><span class="p">(</span> <span class="n">collateral_freed</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">collateral_freed</span><span class="o">-&gt;</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">collateral_freed</span><span class="o">-&gt;</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span>
                                <span class="n">b</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">-=</span> <span class="n">collateral_freed</span><span class="o">-&gt;</span><span class="n">amount</span><span class="p">;</span>
                          <span class="k">if</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span>
                                <span class="n">b</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">-=</span> <span class="n">pays</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>

                          <span class="n">assert</span><span class="p">(</span> <span class="n">b</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">);</span>
                   <span class="p">});</span>
   <span class="p">}</span>

   <span class="n">assert</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">fill_order_operation</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">order</span><span class="p">.</span><span class="n">borrower</span><span class="p">,</span> <span class="n">pays</span><span class="p">,</span> <span class="n">receives</span><span class="p">,</span>
                                                                                                 <span class="n">asset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span><span class="p">),</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">is_maker</span> <span class="p">)</span> <span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">collateral_freed</span><span class="p">.</span><span class="n">valid</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">remove</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>

   <span class="k">return</span> <span class="n">collateral_freed</span><span class="p">.</span><span class="n">valid</span><span class="p">();</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">order</span><span class="p">)(</span><span class="n">pays</span><span class="p">)(</span><span class="n">receives</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="fill-settle-order">
<h3><a class="toc-backref" href="#id92">fill_settle_order</a><a class="headerlink" href="#fill-settle-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">fill_settle_order</span><span class="p">(</span> <span class="k">const</span> <span class="n">force_settlement_object</span><span class="o">&amp;</span> <span class="n">settle</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">pays</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">receives</span><span class="p">,</span>
                                                                  <span class="k">const</span> <span class="n">price</span><span class="o">&amp;</span> <span class="n">fill_price</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_maker</span> <span class="p">)</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="kt">bool</span> <span class="n">filled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

   <span class="k">auto</span> <span class="n">issuer_fees</span> <span class="o">=</span> <span class="n">pay_market_fees</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span><span class="p">),</span> <span class="n">receives</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">pays</span> <span class="o">&lt;</span> <span class="n">settle</span><span class="p">.</span><span class="n">balance</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span><span class="n">settle</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">pays</span><span class="p">](</span><span class="n">force_settlement_object</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">s</span><span class="p">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">pays</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="n">filled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">filled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">adjust_balance</span><span class="p">(</span><span class="n">settle</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">receives</span> <span class="o">-</span> <span class="n">issuer_fees</span><span class="p">);</span>

   <span class="n">assert</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">receives</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
   <span class="n">push_applied_operation</span><span class="p">(</span> <span class="n">fill_order_operation</span><span class="p">(</span> <span class="n">settle</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">settle</span><span class="p">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">pays</span><span class="p">,</span> <span class="n">receives</span><span class="p">,</span> <span class="n">issuer_fees</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">is_maker</span> <span class="p">)</span> <span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">filled</span><span class="p">)</span>
          <span class="n">remove</span><span class="p">(</span><span class="n">settle</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">filled</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">(</span> <span class="p">(</span><span class="n">settle</span><span class="p">)(</span><span class="n">pays</span><span class="p">)(</span><span class="n">receives</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="check-call-orders">
<h3><a class="toc-backref" href="#id93">check_call_orders</a><a class="headerlink" href="#check-call-orders" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>/**
 *  Starting with the least collateralized orders, fill them if their
 *  call price is above the max(lowest bid,call_limit).
 *
 *  This method will return true if it filled a short or limit
 *
 *  @param mia - the market issued asset that should be called.
 *  @param enable_black_swan - when adjusting collateral, triggering a black swan is invalid and will throw
 *                             if enable_black_swan is not set to true.
 *  @param for_new_limit_order - true if this function is called when matching call orders with a new limit order
 *
 *  @return true if a margin call was executed.
 */
bool database::check_call_orders( const asset_object&amp; mia, bool enable_black_swan, bool for_new_limit_order,
                                                                  const asset_bitasset_data_object* bitasset_ptr )
{ try {
        const auto&amp; dyn_prop = get_dynamic_global_properties();
        auto maint_time = dyn_prop.next_maintenance_time;
        if( for_new_limit_order )
           FC_ASSERT( maint_time &lt;= HARDFORK_CORE_625_TIME ); // `for_new_limit_order` is only true before HF 338 / 625

        if( !mia.is_market_issued() ) return false;

        const asset_bitasset_data_object&amp; bitasset = ( bitasset_ptr ? *bitasset_ptr : mia.bitasset_data(*this) );

        if( check_for_blackswan( mia, enable_black_swan, &amp;bitasset ) )
           return false;

        if( bitasset.is_prediction_market ) return false;
        if( bitasset.current_feed.settlement_price.is_null() ) return false;

        const call_order_index&amp; call_index = get_index_type&lt;call_order_index&gt;();
        const auto&amp; call_price_index = call_index.indices().get&lt;by_price&gt;();

        const limit_order_index&amp; limit_index = get_index_type&lt;limit_order_index&gt;();
        const auto&amp; limit_price_index = limit_index.indices().get&lt;by_price&gt;();

        // looking for limit orders selling the most USD for the least CORE
        auto max_price = price::max( mia.id, bitasset.options.short_backing_asset );
        // stop when limit orders are selling too little USD for too much CORE
        auto min_price = bitasset.current_feed.max_short_squeeze_price();

        assert( max_price.base.asset_id == min_price.base.asset_id );
        // NOTE limit_price_index is sorted from greatest to least
        auto limit_itr = limit_price_index.lower_bound( max_price );
        auto limit_end = limit_price_index.upper_bound( min_price );

        if( limit_itr == limit_end )
           return false;

        auto call_min = price::min( bitasset.options.short_backing_asset, mia.id );
        auto call_max = price::max( bitasset.options.short_backing_asset, mia.id );
        auto call_itr = call_price_index.lower_bound( call_min );
        auto call_end = call_price_index.upper_bound( call_max );

        bool filled_limit = false;
        bool margin_called = false;

        auto head_time = head_block_time();
        auto head_num = head_block_num();

        bool before_hardfork_615 = ( head_time &lt; HARDFORK_615_TIME );
        bool after_hardfork_436 = ( head_time &gt; HARDFORK_436_TIME );

        bool before_core_hardfork_184 = ( maint_time &lt;= HARDFORK_CORE_184_TIME ); // something-for-nothing
        bool before_core_hardfork_342 = ( maint_time &lt;= HARDFORK_CORE_342_TIME ); // better rounding
        bool before_core_hardfork_343 = ( maint_time &lt;= HARDFORK_CORE_343_TIME ); // update call_price after partially filled
        bool before_core_hardfork_453 = ( maint_time &lt;= HARDFORK_CORE_453_TIME ); // multiple matching issue
        bool before_core_hardfork_606 = ( maint_time &lt;= HARDFORK_CORE_606_TIME ); // feed always trigger call
        bool before_core_hardfork_834 = ( maint_time &lt;= HARDFORK_CORE_834_TIME ); // target collateral ratio option

        while( !check_for_blackswan( mia, enable_black_swan, &amp;bitasset ) &amp;&amp; call_itr != call_end )
        {
           bool  filled_call      = false;
           price match_price;
           asset usd_for_sale;
           if( limit_itr != limit_end )
           {
                  assert( limit_itr != limit_price_index.end() );
                  match_price      = limit_itr-&gt;sell_price;
                  usd_for_sale     = limit_itr-&gt;amount_for_sale();
           }
           else return margin_called;

           match_price.validate();

           // Feed protected (don&#39;t call if CR&gt;MCR) https://github.com/cryptonomex/graphene/issues/436
           if( after_hardfork_436 &amp;&amp; ( bitasset.current_feed.settlement_price &gt; ~call_itr-&gt;call_price ) )
                  return margin_called;

           // Old rule: margin calls can only buy high https://github.com/bitshares/bitshares-core/issues/606
           if( before_core_hardfork_606 &amp;&amp; match_price &gt; ~call_itr-&gt;call_price )
                  return margin_called;

           margin_called = true;

           auto usd_to_buy   = call_itr-&gt;get_debt();

           if( usd_to_buy * match_price &gt; call_itr-&gt;get_collateral() )
           {
                  elog( &quot;black swan detected on asset ${symbol} (${id}) at block ${b}&quot;,
                                (&quot;id&quot;,mia.id)(&quot;symbol&quot;,mia.symbol)(&quot;b&quot;,head_num) );
                  edump((enable_black_swan));
                  FC_ASSERT( enable_black_swan );
                  globally_settle_asset(mia, bitasset.current_feed.settlement_price );
                  return true;
           }

           if( !before_core_hardfork_834 )
                  usd_to_buy.amount = call_itr-&gt;get_max_debt_to_cover( match_price,
                                                                                                                           bitasset.current_feed.settlement_price,
                                                                                                                           bitasset.current_feed.maintenance_collateral_ratio );

           asset call_pays, call_receives, order_pays, order_receives;
           if( usd_to_buy &gt; usd_for_sale )
           {  // fill order
                  order_receives  = usd_for_sale * match_price; // round down, in favor of call order

                  // Be here, the limit order won&#39;t be paying something for nothing, since if it would, it would have
                  //   been cancelled elsewhere already (a maker limit order won&#39;t be paying something for nothing):
                  // * after hard fork core-625, the limit order will be always a maker if entered this function;
                  // * before hard fork core-625,
                  //   * when the limit order is a taker, it could be paying something for nothing only when
                  //     the call order is smaller and is too small
                  //   * when the limit order is a maker, it won&#39;t be paying something for nothing
                  if( order_receives.amount == 0 ) // TODO this should not happen. remove the warning after confirmed
                  {
                         if( before_core_hardfork_184 )
                                wlog( &quot;Something for nothing issue (#184, variant D-1) occurred at block #${block}&quot;, (&quot;block&quot;,head_num) );
                         else
                                wlog( &quot;Something for nothing issue (#184, variant D-2) occurred at block #${block}&quot;, (&quot;block&quot;,head_num) );
                  }

                  if( before_core_hardfork_342 )
                         call_receives = usd_for_sale;
                  else
                         // The remaining amount in the limit order would be too small,
                         //   so we should cull the order in fill_limit_order() below.
                         // The order would receive 0 even at `match_price`, so it would receive 0 at its own price,
                         //   so calling maybe_cull_small() will always cull it.
                         call_receives = order_receives.multiply_and_round_up( match_price );

                  filled_limit = true;

           } else { // fill call
                  call_receives  = usd_to_buy;

                  if( before_core_hardfork_342 )
                  {
                         order_receives = usd_to_buy * match_price; // round down, in favor of call order

                         // Be here, the limit order would be paying something for nothing
                         if( order_receives.amount == 0 ) // TODO remove warning after hard fork core-342
                                wlog( &quot;Something for nothing issue (#184, variant D) occurred at block #${block}&quot;, (&quot;block&quot;,head_num) );
                  }
                  else
                         order_receives = usd_to_buy.multiply_and_round_up( match_price ); // round up, in favor of limit order

                  filled_call    = true; // this is safe, since BSIP38 (hard fork core-834) depends on BSIP31 (hard fork core-343)

                  if( usd_to_buy == usd_for_sale )
                         filled_limit = true;
                  else if( filled_limit &amp;&amp; maint_time &lt;= HARDFORK_CORE_453_TIME ) // TODO remove warning after hard fork core-453
                  {
                         wlog( &quot;Multiple limit match problem (issue 453) occurred at block #${block}&quot;, (&quot;block&quot;,head_num) );
                         if( before_hardfork_615 )
                                _issue_453_affected_assets.insert( bitasset.asset_id );
                  }
           }

           call_pays  = order_receives;
           order_pays = call_receives;

           auto old_call_itr = call_itr;
           if( filled_call &amp;&amp; before_core_hardfork_343 )
                  ++call_itr;
           // when for_new_limit_order is true, the call order is maker, otherwise the call order is taker
           fill_call_order(*old_call_itr, call_pays, call_receives, match_price, for_new_limit_order );
           if( !before_core_hardfork_343 )
                  call_itr = call_price_index.lower_bound( call_min );

           auto next_limit_itr = std::next( limit_itr );
           // when for_new_limit_order is true, the limit order is taker, otherwise the limit order is maker
           bool really_filled = fill_limit_order( *limit_itr, order_pays, order_receives, true, match_price, !for_new_limit_order );
           if( really_filled || ( filled_limit &amp;&amp; before_core_hardfork_453 ) )
                  limit_itr = next_limit_itr;

        } // while call_itr != call_end

        return margin_called;
} FC_CAPTURE_AND_RETHROW() }
</pre></div>
</div>
</div>
<div class="section" id="pay-order">
<h3><a class="toc-backref" href="#id94">pay_order</a><a class="headerlink" href="#pay-order" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">pay_order</span><span class="p">(</span> <span class="k">const</span> <span class="n">account_object</span><span class="o">&amp;</span> <span class="n">receiver</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">receives</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">pays</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">balances</span> <span class="o">=</span> <span class="n">receiver</span><span class="p">.</span><span class="n">statistics</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">balances</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">account_statistics_object</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">){</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">pays</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">asset_id_type</span><span class="p">()</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">b</span><span class="p">.</span><span class="n">total_core_in_orders</span> <span class="o">-=</span> <span class="n">pays</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                 <span class="p">}</span>
   <span class="p">});</span>
   <span class="n">adjust_balance</span><span class="p">(</span><span class="n">receiver</span><span class="p">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="n">receives</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="calculate-market-fee">
<h3><a class="toc-backref" href="#id95">calculate_market_fee</a><a class="headerlink" href="#calculate-market-fee" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">asset</span> <span class="n">database</span><span class="o">::</span><span class="n">calculate_market_fee</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">trade_asset</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">trade_amount</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">assert</span><span class="p">(</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">trade_amount</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">trade_asset</span><span class="p">.</span><span class="n">charges_market_fees</span><span class="p">()</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">market_fee_percent</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

   <span class="n">fc</span><span class="o">::</span><span class="n">uint128</span> <span class="n">a</span><span class="p">(</span><span class="n">trade_amount</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
   <span class="n">a</span> <span class="o">*=</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">market_fee_percent</span><span class="p">;</span>
   <span class="n">a</span> <span class="o">/=</span> <span class="n">GRAPHENE_100_PERCENT</span><span class="p">;</span>
   <span class="n">asset</span> <span class="n">percent_fee</span> <span class="o">=</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">to_uint64</span><span class="p">());</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">percent_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">max_market_fee</span> <span class="p">)</span>
          <span class="n">percent_fee</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">trade_asset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">max_market_fee</span><span class="p">;</span>

   <span class="k">return</span> <span class="n">percent_fee</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pay-market-fees">
<h3><a class="toc-backref" href="#id96">pay_market_fees</a><a class="headerlink" href="#pay-market-fees" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">asset</span> <span class="n">database</span><span class="o">::</span><span class="n">pay_market_fees</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">recv_asset</span><span class="p">,</span> <span class="k">const</span> <span class="n">asset</span><span class="o">&amp;</span> <span class="n">receives</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">issuer_fees</span> <span class="o">=</span> <span class="n">calculate_market_fee</span><span class="p">(</span> <span class="n">recv_asset</span><span class="p">,</span> <span class="n">receives</span> <span class="p">);</span>
   <span class="n">assert</span><span class="p">(</span><span class="n">issuer_fees</span> <span class="o">&lt;=</span> <span class="n">receives</span> <span class="p">);</span>

   <span class="c1">//Don&#39;t dirty undo state if not actually collecting any fees</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">issuer_fees</span><span class="p">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">recv_dyn_data</span> <span class="o">=</span> <span class="n">recv_asset</span><span class="p">.</span><span class="n">dynamic_asset_data_id</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">recv_dyn_data</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">asset_dynamic_data_object</span><span class="o">&amp;</span> <span class="n">obj</span> <span class="p">){</span>
                                   <span class="c1">//idump((issuer_fees));</span>
                 <span class="n">obj</span><span class="p">.</span><span class="n">accumulated_fees</span> <span class="o">+=</span> <span class="n">issuer_fees</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
          <span class="p">});</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">issuer_fees</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-notify">
<h2><a class="toc-backref" href="#id97">db_notify</a><a class="headerlink" href="#db-notify" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-impacted-account-visitor">
<h3><a class="toc-backref" href="#id98">get_impacted_account_visitor</a><a class="headerlink" href="#get-impacted-account-visitor" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">get_impacted_account_visitor</span>
<span class="p">{</span>
   <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;&amp;</span> <span class="n">_impacted</span><span class="p">;</span>
   <span class="n">get_impacted_account_visitor</span><span class="p">(</span> <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;&amp;</span> <span class="n">impact</span> <span class="p">)</span><span class="o">:</span><span class="n">_impacted</span><span class="p">(</span><span class="n">impact</span><span class="p">)</span> <span class="p">{}</span>
   <span class="k">typedef</span> <span class="kt">void</span> <span class="n">result_type</span><span class="p">;</span>

   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">transfer_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">to</span> <span class="p">);</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// from</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_claim_fees_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_claim_pool_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">limit_order_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// seller</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">limit_order_cancel_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// fee_paying_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">call_order_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// funding_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">bid_collateral_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// bidder</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">fill_order_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account_id</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">execute_bid_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// bidder</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">account_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// registrar</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">referrer</span> <span class="p">);</span>
          <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="n">owner</span> <span class="p">);</span>
          <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="n">active</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">account_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">owner</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">owner</span><span class="p">)</span> <span class="p">);</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">active</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">account_whitelist_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// authorizing_account</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">account_to_list</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">account_upgrade_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account_to_upgrade</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">account_transfer_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account_id</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">new_issuer</span> <span class="p">)</span>
                 <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="n">new_issuer</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_update_issuer_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">new_issuer</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_update_bitasset_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_update_feed_producers_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_issue_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">issue_to_account</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_reserve_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// payer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_fund_fee_pool_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// from_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_settle_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_global_settle_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_publish_feed_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// publisher</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">witness_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// witness_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">witness_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// witness_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">proposal_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// fee_paying_account</span>
          <span class="n">vector</span><span class="o">&lt;</span><span class="n">authority</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">proposed_op</span> <span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">proposed_ops</span> <span class="p">)</span>
                 <span class="n">operation_get_required_authorities</span><span class="p">(</span> <span class="n">proposed_op</span><span class="p">.</span><span class="n">op</span><span class="p">,</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">other</span> <span class="p">);</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">o</span> <span class="p">:</span> <span class="n">other</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">o</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">proposal_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// fee_paying_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">proposal_delete_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// fee_paying_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">withdraw_permission_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// withdraw_from_account</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">authorized_account</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">withdraw_permission_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// withdraw_from_account</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">authorized_account</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">withdraw_permission_claim_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// withdraw_to_account</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">withdraw_from_account</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">withdraw_permission_delete_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// withdraw_from_account</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">authorized_account</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">committee_member_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// committee_member_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">committee_member_update_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// committee_member_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">committee_member_update_global_parameters_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account_id_type()</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">vesting_balance_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// creator</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">owner</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">vesting_balance_withdraw_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// owner</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">worker_create_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// owner</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">custom_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// payer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">assert_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// fee_paying_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">balance_claim_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// deposit_to_account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">override_transfer_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">to</span> <span class="p">);</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">from</span> <span class="p">);</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// issuer</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">transfer_to_blind_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// from</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">out</span> <span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">outputs</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">owner</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">blind_transfer_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// GRAPHENE_TEMP_ACCOUNT</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">in</span> <span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">inputs</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">in</span><span class="p">.</span><span class="n">owner</span> <span class="p">);</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">out</span> <span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">outputs</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">owner</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">transfer_from_blind_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// GRAPHENE_TEMP_ACCOUNT</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">to</span> <span class="p">);</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">in</span> <span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">inputs</span> <span class="p">)</span>
                 <span class="n">add_authority_accounts</span><span class="p">(</span> <span class="n">_impacted</span><span class="p">,</span> <span class="n">in</span><span class="p">.</span><span class="n">owner</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">asset_settle_cancel_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account</span>
   <span class="p">}</span>
   <span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span> <span class="k">const</span> <span class="n">fba_distribute_operation</span><span class="o">&amp;</span> <span class="n">op</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_impacted</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">op</span><span class="p">.</span><span class="n">fee_payer</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// account_id</span>
   <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="operation-get-impacted-accounts">
<h3><a class="toc-backref" href="#id99">operation_get_impacted_accounts</a><a class="headerlink" href="#operation-get-impacted-accounts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">graphene</span><span class="o">::</span><span class="n">chain</span><span class="o">::</span><span class="n">operation_get_impacted_accounts</span><span class="p">(</span> <span class="k">const</span> <span class="n">operation</span><span class="o">&amp;</span> <span class="n">op</span><span class="p">,</span> <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;&amp;</span> <span class="n">result</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">get_impacted_account_visitor</span> <span class="n">vtor</span> <span class="o">=</span> <span class="n">get_impacted_account_visitor</span><span class="p">(</span> <span class="n">result</span> <span class="p">);</span>
  <span class="n">op</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span> <span class="n">vtor</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="transaction-get-impacted-accounts">
<h3><a class="toc-backref" href="#id100">transaction_get_impacted_accounts</a><a class="headerlink" href="#transaction-get-impacted-accounts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">graphene</span><span class="o">::</span><span class="n">chain</span><span class="o">::</span><span class="n">transaction_get_impacted_accounts</span><span class="p">(</span> <span class="k">const</span> <span class="n">transaction</span><span class="o">&amp;</span> <span class="n">tx</span><span class="p">,</span> <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;&amp;</span> <span class="n">result</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">op</span> <span class="p">:</span> <span class="n">tx</span><span class="p">.</span><span class="n">operations</span> <span class="p">)</span>
        <span class="n">operation_get_impacted_accounts</span><span class="p">(</span> <span class="n">op</span><span class="p">,</span> <span class="n">result</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-relevant-accounts">
<h3><a class="toc-backref" href="#id101">get_relevant_accounts</a><a class="headerlink" href="#get-relevant-accounts" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">get_relevant_accounts</span><span class="p">(</span> <span class="k">const</span> <span class="n">object</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;&amp;</span> <span class="n">accounts</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">()</span> <span class="o">==</span> <span class="n">protocol_ids</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">switch</span><span class="p">(</span> <span class="p">(</span><span class="n">object_type</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                <span class="k">case</span> <span class="nl">null_object_type</span><span class="p">:</span>
                <span class="k">case</span> <span class="nl">base_object_type</span><span class="p">:</span>
                <span class="k">case</span> <span class="nl">OBJECT_TYPE_COUNT</span><span class="p">:</span>
                   <span class="k">return</span><span class="p">;</span>
                <span class="k">case</span> <span class="nl">account_object_type</span><span class="p">:{</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">asset_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">asset_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">issuer</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">force_settlement_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">force_settlement_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">committee_member_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">committee_member_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">committee_member_account</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">witness_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">witness_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">witness_account</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">limit_order_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">limit_order_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">seller</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">call_order_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">call_order_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">borrower</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">custom_object_type</span><span class="p">:{</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">proposal_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">proposal_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">transaction_get_impacted_accounts</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">proposed_transaction</span><span class="p">,</span> <span class="n">accounts</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">operation_history_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">operation_history_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">operation_get_impacted_accounts</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">accounts</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">withdraw_permission_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">withdraw_permission_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">withdraw_from_account</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">authorized_account</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">vesting_balance_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">vesting_balance_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">worker_object_type</span><span class="p">:{</span>
                   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">worker_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                   <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">worker_account</span> <span class="p">);</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">case</span> <span class="nl">balance_object_type</span><span class="p">:{</span>
                   <span class="cm">/** these are free from any accounts */</span>
                   <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">()</span> <span class="o">==</span> <span class="n">implementation_ids</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">switch</span><span class="p">(</span> <span class="p">(</span><span class="n">impl_object_type</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                         <span class="k">case</span> <span class="nl">impl_global_property_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_dynamic_global_property_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_reserved0_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_asset_dynamic_data_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_asset_bitasset_data_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_account_balance_object_type</span><span class="p">:{</span>
                          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">account_balance_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                          <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="p">);</span>
                          <span class="k">break</span><span class="p">;</span>
                   <span class="p">}</span> <span class="k">case</span> <span class="nl">impl_account_statistics_object_type</span><span class="p">:{</span>
                          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">account_statistics_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                          <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="p">);</span>
                          <span class="k">break</span><span class="p">;</span>
                   <span class="p">}</span> <span class="k">case</span> <span class="nl">impl_transaction_object_type</span><span class="p">:{</span>
                          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">transaction_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                          <span class="n">transaction_get_impacted_accounts</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">trx</span><span class="p">,</span> <span class="n">accounts</span> <span class="p">);</span>
                          <span class="k">break</span><span class="p">;</span>
                   <span class="p">}</span> <span class="k">case</span> <span class="nl">impl_blinded_balance_object_type</span><span class="p">:{</span>
                          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">blinded_balance_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                          <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">.</span><span class="n">account_auths</span> <span class="p">)</span>
                                <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">first</span> <span class="p">);</span>
                          <span class="k">break</span><span class="p">;</span>
                   <span class="p">}</span> <span class="k">case</span> <span class="nl">impl_block_summary_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_account_transaction_history_object_type</span><span class="p">:</span> <span class="p">{</span>
                          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">account_transaction_history_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                          <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">account</span> <span class="p">);</span>
                          <span class="k">break</span><span class="p">;</span>
                   <span class="p">}</span> <span class="k">case</span> <span class="nl">impl_chain_property_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_witness_schedule_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_budget_record_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_special_authority_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_buyback_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_fba_accumulator_object_type</span><span class="p">:</span>
                          <span class="k">break</span><span class="p">;</span>
                         <span class="k">case</span> <span class="nl">impl_collateral_bid_object_type</span><span class="p">:{</span>
                          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">aobj</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">collateral_bid_object</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
                          <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">aobj</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="p">);</span>
                          <span class="n">accounts</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">aobj</span><span class="o">-&gt;</span><span class="n">bidder</span> <span class="p">);</span>
                          <span class="k">break</span><span class="p">;</span>
                   <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span> <span class="c1">// end get_relevant_accounts( const object* obj, flat_set&lt;account_id_type&gt;&amp; accounts )</span>
</pre></div>
</div>
</div>
<div class="section" id="notify-applied-block">
<h3><a class="toc-backref" href="#id102">notify_applied_block</a><a class="headerlink" href="#notify-applied-block" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">notify_applied_block</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">block</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">GRAPHENE_TRY_NOTIFY</span><span class="p">(</span> <span class="n">applied_block</span><span class="p">,</span> <span class="n">block</span> <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="notify-on-pending-transaction">
<h3><a class="toc-backref" href="#id103">notify_on_pending_transaction</a><a class="headerlink" href="#notify-on-pending-transaction" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">notify_on_pending_transaction</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_transaction</span><span class="o">&amp;</span> <span class="n">tx</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">GRAPHENE_TRY_NOTIFY</span><span class="p">(</span> <span class="n">on_pending_transaction</span><span class="p">,</span> <span class="n">tx</span> <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="notify-changed-objects">
<h3><a class="toc-backref" href="#id104">notify_changed_objects</a><a class="headerlink" href="#notify-changed-objects" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">notify_changed_objects</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">enabled</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">head_undo</span> <span class="o">=</span> <span class="n">_undo_db</span><span class="p">.</span><span class="n">head</span><span class="p">();</span>

          <span class="c1">// New</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">new_objects</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                <span class="n">vector</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="o">&gt;</span> <span class="n">new_ids</span><span class="p">;</span>  <span class="n">new_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">head_undo</span><span class="p">.</span><span class="n">new_ids</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
                <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;</span> <span class="n">new_accounts_impacted</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">head_undo</span><span class="p">.</span><span class="n">new_ids</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">new_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
                  <span class="k">auto</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">find_object</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
                        <span class="n">get_relevant_accounts</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_accounts_impacted</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">new_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span>
                   <span class="n">GRAPHENE_TRY_NOTIFY</span><span class="p">(</span> <span class="n">new_objects</span><span class="p">,</span> <span class="n">new_ids</span><span class="p">,</span> <span class="n">new_accounts_impacted</span><span class="p">)</span>
          <span class="p">}</span>

          <span class="c1">// Changed</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">changed_objects</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                <span class="n">vector</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="o">&gt;</span> <span class="n">changed_ids</span><span class="p">;</span>  <span class="n">changed_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">head_undo</span><span class="p">.</span><span class="n">old_values</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
                <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;</span> <span class="n">changed_accounts_impacted</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">head_undo</span><span class="p">.</span><span class="n">old_values</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">changed_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
                  <span class="n">get_relevant_accounts</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">changed_accounts_impacted</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">changed_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span>
                   <span class="n">GRAPHENE_TRY_NOTIFY</span><span class="p">(</span> <span class="n">changed_objects</span><span class="p">,</span> <span class="n">changed_ids</span><span class="p">,</span> <span class="n">changed_accounts_impacted</span><span class="p">)</span>
          <span class="p">}</span>

          <span class="c1">// Removed</span>
          <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">removed_objects</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                <span class="n">vector</span><span class="o">&lt;</span><span class="n">object_id_type</span><span class="o">&gt;</span> <span class="n">removed_ids</span><span class="p">;</span> <span class="n">removed_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span> <span class="n">head_undo</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
                <span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">object</span><span class="o">*&gt;</span> <span class="n">removed</span><span class="p">;</span> <span class="n">removed</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span> <span class="n">head_undo</span><span class="p">.</span><span class="n">removed</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
                <span class="n">flat_set</span><span class="o">&lt;</span><span class="n">account_id_type</span><span class="o">&gt;</span> <span class="n">removed_accounts_impacted</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">head_undo</span><span class="p">.</span><span class="n">removed</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">removed_ids</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span> <span class="p">);</span>
                  <span class="k">auto</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
                  <span class="n">removed</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
                  <span class="n">get_relevant_accounts</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">removed_accounts_impacted</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span> <span class="n">removed_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span>
                   <span class="n">GRAPHENE_TRY_NOTIFY</span><span class="p">(</span> <span class="n">removed_objects</span><span class="p">,</span> <span class="n">removed_ids</span><span class="p">,</span> <span class="n">removed</span><span class="p">,</span> <span class="n">removed_accounts_impacted</span><span class="p">)</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_LOG</span><span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-update">
<h2><a class="toc-backref" href="#id105">db_update</a><a class="headerlink" href="#db-update" title="Permalink to this headline">¶</a></h2>
<div class="section" id="update-global-dynamic-data">
<h3><a class="toc-backref" href="#id106">update_global_dynamic_data</a><a class="headerlink" href="#update-global-dynamic-data" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_global_dynamic_data</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">missed_blocks</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">_dgp</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>

   <span class="c1">// dynamic global properties updating</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">_dgp</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">missed_blocks</span><span class="p">](</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dgp</span> <span class="p">){</span>
          <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">block_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">block_num</span><span class="p">();</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">BOOST_UNLIKELY</span><span class="p">(</span> <span class="n">block_num</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
                 <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">else</span> <span class="nf">if</span><span class="p">(</span> <span class="n">_checkpoints</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">_checkpoints</span><span class="p">.</span><span class="n">rbegin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">&gt;=</span> <span class="n">block_num</span> <span class="p">)</span>
                 <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">else</span> <span class="nf">if</span><span class="p">(</span> <span class="n">missed_blocks</span> <span class="p">)</span>
                 <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span> <span class="o">+=</span> <span class="n">GRAPHENE_RECENTLY_MISSED_COUNT_INCREMENT</span><span class="o">*</span><span class="n">missed_blocks</span><span class="p">;</span>
          <span class="k">else</span> <span class="nf">if</span><span class="p">(</span> <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span> <span class="o">&gt;</span> <span class="n">GRAPHENE_RECENTLY_MISSED_COUNT_INCREMENT</span> <span class="p">)</span>
                 <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span> <span class="o">-=</span> <span class="n">GRAPHENE_RECENTLY_MISSED_COUNT_DECREMENT</span><span class="p">;</span>
          <span class="k">else</span> <span class="nf">if</span><span class="p">(</span> <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
                 <span class="n">dgp</span><span class="p">.</span><span class="n">recently_missed_count</span><span class="o">--</span><span class="p">;</span>

          <span class="n">dgp</span><span class="p">.</span><span class="n">head_block_number</span> <span class="o">=</span> <span class="n">block_num</span><span class="p">;</span>
          <span class="n">dgp</span><span class="p">.</span><span class="n">head_block_id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">();</span>
          <span class="n">dgp</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
          <span class="n">dgp</span><span class="p">.</span><span class="n">current_witness</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">witness</span><span class="p">;</span>
          <span class="n">dgp</span><span class="p">.</span><span class="n">recent_slots_filled</span> <span class="o">=</span> <span class="p">(</span>
                   <span class="p">(</span><span class="n">dgp</span><span class="p">.</span><span class="n">recent_slots_filled</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">missed_blocks</span><span class="p">;</span>
          <span class="n">dgp</span><span class="p">.</span><span class="n">current_aslot</span> <span class="o">+=</span> <span class="n">missed_blocks</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
   <span class="p">});</span>

   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">get_node_properties</span><span class="p">().</span><span class="n">skip_flags</span> <span class="o">&amp;</span> <span class="n">skip_undo_history_check</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">GRAPHENE_ASSERT</span><span class="p">(</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">head_block_number</span> <span class="o">-</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">last_irreversible_block_num</span>  <span class="o">&lt;</span> <span class="n">GRAPHENE_MAX_UNDO_HISTORY</span><span class="p">,</span> <span class="n">undo_database_exception</span><span class="p">,</span>
                                 <span class="s">&quot;The database does not have enough undo history to support a blockchain with so many missed blocks. &quot;</span>
                                 <span class="s">&quot;Please add a checkpoint if you would like to continue applying blocks beyond this point.&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s">&quot;last_irreversible_block_num&quot;</span><span class="p">,</span><span class="n">_dgp</span><span class="p">.</span><span class="n">last_irreversible_block_num</span><span class="p">)(</span><span class="s">&quot;head&quot;</span><span class="p">,</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">head_block_number</span><span class="p">)</span>
                                 <span class="p">(</span><span class="s">&quot;recently_missed&quot;</span><span class="p">,</span><span class="n">_dgp</span><span class="p">.</span><span class="n">recently_missed_count</span><span class="p">)(</span><span class="s">&quot;max_undo&quot;</span><span class="p">,</span><span class="n">GRAPHENE_MAX_UNDO_HISTORY</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>

   <span class="n">_undo_db</span><span class="p">.</span><span class="n">set_max_size</span><span class="p">(</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">head_block_number</span> <span class="o">-</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">last_irreversible_block_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
   <span class="n">_fork_db</span><span class="p">.</span><span class="n">set_max_size</span><span class="p">(</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">head_block_number</span> <span class="o">-</span> <span class="n">_dgp</span><span class="p">.</span><span class="n">last_irreversible_block_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-signing-witness">
<h3><a class="toc-backref" href="#id107">update_signing_witness</a><a class="headerlink" href="#update-signing-witness" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_signing_witness</span><span class="p">(</span><span class="k">const</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">signing_witness</span><span class="p">,</span> <span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">new_block</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>
   <span class="kt">uint64_t</span> <span class="n">new_block_aslot</span> <span class="o">=</span> <span class="n">dpo</span><span class="p">.</span><span class="n">current_aslot</span> <span class="o">+</span> <span class="n">get_slot_at_time</span><span class="p">(</span> <span class="n">new_block</span><span class="p">.</span><span class="n">timestamp</span> <span class="p">);</span>

   <span class="n">share_type</span> <span class="n">witness_pay</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">witness_pay_per_block</span><span class="p">,</span> <span class="n">dpo</span><span class="p">.</span><span class="n">witness_budget</span> <span class="p">);</span>

   <span class="n">modify</span><span class="p">(</span> <span class="n">dpo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">_dpo</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_dpo</span><span class="p">.</span><span class="n">witness_budget</span> <span class="o">-=</span> <span class="n">witness_pay</span><span class="p">;</span>
   <span class="p">}</span> <span class="p">);</span>

   <span class="n">deposit_witness_pay</span><span class="p">(</span> <span class="n">signing_witness</span><span class="p">,</span> <span class="n">witness_pay</span> <span class="p">);</span>

   <span class="n">modify</span><span class="p">(</span> <span class="n">signing_witness</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">_wit</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">_wit</span><span class="p">.</span><span class="n">last_aslot</span> <span class="o">=</span> <span class="n">new_block_aslot</span><span class="p">;</span>
          <span class="n">_wit</span><span class="p">.</span><span class="n">last_confirmed_block_num</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">.</span><span class="n">block_num</span><span class="p">();</span>
   <span class="p">}</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-last-irreversible-block">
<h3><a class="toc-backref" href="#id108">update_last_irreversible_block</a><a class="headerlink" href="#update-last-irreversible-block" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_last_irreversible_block</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>

   <span class="c1">// TODO for better performance, move this to db_maint, because only need to do it once per maintenance interval</span>
   <span class="n">vector</span><span class="o">&lt;</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">*</span> <span class="o">&gt;</span> <span class="n">wit_objs</span><span class="p">;</span>
   <span class="n">wit_objs</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span> <span class="n">gpo</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
   <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_id_type</span><span class="o">&amp;</span> <span class="nl">wid</span> <span class="p">:</span> <span class="n">gpo</span><span class="p">.</span><span class="n">active_witnesses</span> <span class="p">)</span>
          <span class="n">wit_objs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wid</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">))</span> <span class="p">);</span>

   <span class="k">static_assert</span><span class="p">(</span> <span class="n">GRAPHENE_IRREVERSIBLE_THRESHOLD</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;irreversible threshold must be nonzero&quot;</span> <span class="p">);</span>

   <span class="c1">// 1 1 1 2 2 2 2 2 2 2 -&gt; 2     .7*10 = 7</span>
   <span class="c1">// 1 1 1 1 1 1 1 2 2 2 -&gt; 1</span>
   <span class="c1">// 3 3 3 3 3 3 3 3 3 3 -&gt; 3</span>

   <span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">GRAPHENE_IRREVERSIBLE_THRESHOLD</span><span class="p">)</span> <span class="o">*</span> <span class="n">wit_objs</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="n">GRAPHENE_100_PERCENT</span><span class="p">);</span>

   <span class="n">std</span><span class="o">::</span><span class="n">nth_element</span><span class="p">(</span> <span class="n">wit_objs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">wit_objs</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">wit_objs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
          <span class="p">[](</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">witness_object</span><span class="o">*</span> <span class="n">b</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">last_confirmed_block_num</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">last_confirmed_block_num</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>

   <span class="kt">uint32_t</span> <span class="n">new_last_irreversible_block_num</span> <span class="o">=</span> <span class="n">wit_objs</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_confirmed_block_num</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">new_last_irreversible_block_num</span> <span class="o">&gt;</span> <span class="n">dpo</span><span class="p">.</span><span class="n">last_irreversible_block_num</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">dpo</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">_dpo</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_dpo</span><span class="p">.</span><span class="n">last_irreversible_block_num</span> <span class="o">=</span> <span class="n">new_last_irreversible_block_num</span><span class="p">;</span>
          <span class="p">}</span> <span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="clear-expired-transactions">
<h3><a class="toc-backref" href="#id109">clear_expired_transactions</a><a class="headerlink" href="#clear-expired-transactions" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">clear_expired_transactions</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
   <span class="c1">//Look for expired transactions in the deduplication list, and remove them.</span>
   <span class="c1">//Transactions must have expired by at least two forking windows in order to be removed.</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">transaction_idx</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">transaction_index</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">get_mutable_index</span><span class="p">(</span><span class="n">implementation_ids</span><span class="p">,</span> <span class="n">impl_transaction_object_type</span><span class="p">));</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">dedupe_index</span> <span class="o">=</span> <span class="n">transaction_idx</span><span class="p">.</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_expiration</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">dedupe_index</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">head_block_time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">dedupe_index</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">trx</span><span class="p">.</span><span class="n">expiration</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">transaction_idx</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="o">*</span><span class="n">dedupe_index</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="clear-expired-proposals">
<h3><a class="toc-backref" href="#id110">clear_expired_proposals</a><a class="headerlink" href="#clear-expired-proposals" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">clear_expired_proposals</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">proposal_expiration_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">proposal_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_expiration</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">proposal_expiration_index</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">proposal_expiration_index</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">expiration_time</span> <span class="o">&lt;=</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">proposal_object</span><span class="o">&amp;</span> <span class="n">proposal</span> <span class="o">=</span> <span class="o">*</span><span class="n">proposal_expiration_index</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
          <span class="n">processed_transaction</span> <span class="n">result</span><span class="p">;</span>
          <span class="k">try</span> <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">proposal</span><span class="p">.</span><span class="n">is_authorized_to_execute</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">push_proposal</span><span class="p">(</span><span class="n">proposal</span><span class="p">);</span>
                        <span class="c1">//TODO: Do something with result so plugins can process it.</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="p">}</span>
          <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="k">const</span> <span class="n">fc</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="n">elog</span><span class="p">(</span><span class="s">&quot;Failed to apply proposed transaction on its expiration. Deleting it.</span><span class="se">\n</span><span class="s">${proposal}</span><span class="se">\n</span><span class="s">${error}&quot;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s">&quot;proposal&quot;</span><span class="p">,</span> <span class="n">proposal</span><span class="p">)(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">()));</span>
          <span class="p">}</span>
          <span class="n">remove</span><span class="p">(</span><span class="n">proposal</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="check-for-blackswan">
<h3><a class="toc-backref" href="#id111">check_for_blackswan</a><a class="headerlink" href="#check-for-blackswan" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  let HB = the highest bid for the collateral  (aka who will pay the most DEBT for the least collateral)</span>
<span class="cm"> *  let SP = current median feed&#39;s Settlement Price</span>
<span class="cm"> *  let LC = the least collateralized call order&#39;s swan price (debt/collateral)</span>
<span class="cm"> *</span>
<span class="cm"> *  If there is no valid price feed or no bids then there is no black swan.</span>
<span class="cm"> *</span>
<span class="cm"> *  A black swan occurs if MAX(HB,SP) &lt;= LC</span>
<span class="cm"> */</span>
<span class="kt">bool</span> <span class="n">database</span><span class="o">::</span><span class="n">check_for_blackswan</span><span class="p">(</span> <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">mia</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enable_black_swan</span><span class="p">,</span>
                                                                        <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">*</span> <span class="n">bitasset_ptr</span> <span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">mia</span><span class="p">.</span><span class="n">is_market_issued</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

        <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">bitasset</span> <span class="o">=</span> <span class="p">(</span> <span class="n">bitasset_ptr</span> <span class="o">?</span> <span class="o">*</span><span class="nl">bitasset_ptr</span> <span class="p">:</span> <span class="n">mia</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">has_settlement</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// already force settled</span>
        <span class="k">auto</span> <span class="n">settle_price</span> <span class="o">=</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">settle_price</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// no feed</span>

        <span class="k">const</span> <span class="n">call_order_index</span><span class="o">&amp;</span> <span class="n">call_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">call_order_index</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">call_price_index</span> <span class="o">=</span> <span class="n">call_index</span><span class="p">.</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>

        <span class="k">auto</span> <span class="n">call_min</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">min</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span> <span class="n">mia</span><span class="p">.</span><span class="n">id</span> <span class="p">);</span>
        <span class="k">auto</span> <span class="n">call_max</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span> <span class="n">mia</span><span class="p">.</span><span class="n">id</span> <span class="p">);</span>
        <span class="k">auto</span> <span class="n">call_itr</span> <span class="o">=</span> <span class="n">call_price_index</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">call_min</span> <span class="p">);</span>
        <span class="k">auto</span> <span class="n">call_end</span> <span class="o">=</span> <span class="n">call_price_index</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span> <span class="n">call_max</span> <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">call_itr</span> <span class="o">==</span> <span class="n">call_end</span> <span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// no call orders</span>

        <span class="n">price</span> <span class="n">highest</span> <span class="o">=</span> <span class="n">settle_price</span><span class="p">;</span>

        <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">dyn_prop</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">maint_time</span> <span class="o">=</span> <span class="n">dyn_prop</span><span class="p">.</span><span class="n">next_maintenance_time</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">maint_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_338_TIME</span> <span class="p">)</span>
           <span class="c1">// due to #338, we won&#39;t check for black swan on incoming limit order, so need to check with MSSP here</span>
           <span class="n">highest</span> <span class="o">=</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">max_short_squeeze_price</span><span class="p">();</span>

        <span class="k">const</span> <span class="n">limit_order_index</span><span class="o">&amp;</span> <span class="n">limit_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">limit_order_index</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">limit_price_index</span> <span class="o">=</span> <span class="n">limit_index</span><span class="p">.</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_price</span><span class="o">&gt;</span><span class="p">();</span>

        <span class="c1">// looking for limit orders selling the most USD for the least CORE</span>
        <span class="k">auto</span> <span class="n">highest_possible_bid</span> <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span> <span class="p">);</span>
        <span class="c1">// stop when limit orders are selling too little USD for too much CORE</span>
        <span class="k">auto</span> <span class="n">lowest_possible_bid</span>  <span class="o">=</span> <span class="n">price</span><span class="o">::</span><span class="n">min</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">bitasset</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span> <span class="p">);</span>

        <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">highest_possible_bid</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">lowest_possible_bid</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
        <span class="c1">// NOTE limit_price_index is sorted from greatest to least</span>
        <span class="k">auto</span> <span class="n">limit_itr</span> <span class="o">=</span> <span class="n">limit_price_index</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span> <span class="n">highest_possible_bid</span> <span class="p">);</span>
        <span class="k">auto</span> <span class="n">limit_end</span> <span class="o">=</span> <span class="n">limit_price_index</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span> <span class="n">lowest_possible_bid</span> <span class="p">);</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">limit_itr</span> <span class="o">!=</span> <span class="n">limit_end</span> <span class="p">)</span> <span class="p">{</span>
           <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">highest</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">==</span> <span class="n">limit_itr</span><span class="o">-&gt;</span><span class="n">sell_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="p">);</span>
           <span class="n">highest</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span> <span class="n">limit_itr</span><span class="o">-&gt;</span><span class="n">sell_price</span><span class="p">,</span> <span class="n">highest</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">auto</span> <span class="n">least_collateral</span> <span class="o">=</span> <span class="n">call_itr</span><span class="o">-&gt;</span><span class="n">collateralization</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">~</span><span class="n">least_collateral</span> <span class="o">&gt;=</span> <span class="n">highest</span>  <span class="p">)</span>
        <span class="p">{</span>
           <span class="n">wdump</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">call_itr</span><span class="p">)</span> <span class="p">);</span>
           <span class="n">elog</span><span class="p">(</span> <span class="s">&quot;Black Swan detected on asset ${symbol} (${id}) at block ${b}: </span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;   Least collateralized call: ${lc}  ${~lc}</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="c1">//  &quot;   Highest Bid:               ${hb}  ${~hb}\n&quot;</span>
                         <span class="s">&quot;   Settle Price:              ${~sp}  ${sp}</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;   Max:                       ${~h}  ${h}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="n">mia</span><span class="p">.</span><span class="n">id</span><span class="p">)(</span><span class="s">&quot;symbol&quot;</span><span class="p">,</span><span class="n">mia</span><span class="p">.</span><span class="n">symbol</span><span class="p">)(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="n">head_block_num</span><span class="p">())</span>
                        <span class="p">(</span><span class="s">&quot;lc&quot;</span><span class="p">,</span><span class="n">least_collateral</span><span class="p">.</span><span class="n">to_real</span><span class="p">())(</span><span class="s">&quot;~lc&quot;</span><span class="p">,(</span><span class="o">~</span><span class="n">least_collateral</span><span class="p">).</span><span class="n">to_real</span><span class="p">())</span>
                  <span class="c1">//  (&quot;hb&quot;,limit_itr-&gt;sell_price.to_real())(&quot;~hb&quot;,(~limit_itr-&gt;sell_price).to_real())</span>
                        <span class="p">(</span><span class="s">&quot;sp&quot;</span><span class="p">,</span><span class="n">settle_price</span><span class="p">.</span><span class="n">to_real</span><span class="p">())(</span><span class="s">&quot;~sp&quot;</span><span class="p">,(</span><span class="o">~</span><span class="n">settle_price</span><span class="p">).</span><span class="n">to_real</span><span class="p">())</span>
                        <span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span><span class="n">highest</span><span class="p">.</span><span class="n">to_real</span><span class="p">())(</span><span class="s">&quot;~h&quot;</span><span class="p">,(</span><span class="o">~</span><span class="n">highest</span><span class="p">).</span><span class="n">to_real</span><span class="p">())</span> <span class="p">);</span>
           <span class="n">edump</span><span class="p">((</span><span class="n">enable_black_swan</span><span class="p">));</span>
           <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">enable_black_swan</span><span class="p">,</span> <span class="s">&quot;Black swan was detected during a margin update which is not allowed to trigger a blackswan&quot;</span> <span class="p">);</span>
           <span class="k">if</span><span class="p">(</span> <span class="n">maint_time</span> <span class="o">&gt;</span> <span class="n">HARDFORK_CORE_338_TIME</span> <span class="o">&amp;&amp;</span> <span class="o">~</span><span class="n">least_collateral</span> <span class="o">&lt;=</span> <span class="n">settle_price</span> <span class="p">)</span>
                  <span class="c1">// global settle at feed price if possible</span>
                  <span class="n">globally_settle_asset</span><span class="p">(</span><span class="n">mia</span><span class="p">,</span> <span class="n">settle_price</span> <span class="p">);</span>
           <span class="k">else</span>
                  <span class="nf">globally_settle_asset</span><span class="p">(</span><span class="n">mia</span><span class="p">,</span> <span class="o">~</span><span class="n">least_collateral</span> <span class="p">);</span>
           <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="clear-expired-orders">
<h3><a class="toc-backref" href="#id112">clear_expired_orders</a><a class="headerlink" href="#clear-expired-orders" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">clear_expired_orders</span><span class="p">()</span>
<span class="p">{</span> <span class="k">try</span> <span class="p">{</span>
                 <span class="c1">//Cancel expired limit orders</span>
                 <span class="k">auto</span> <span class="n">head_time</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>
                 <span class="k">auto</span> <span class="n">maint_time</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">().</span><span class="n">next_maintenance_time</span><span class="p">;</span>

                 <span class="kt">bool</span> <span class="n">before_core_hardfork_184</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_184_TIME</span> <span class="p">);</span> <span class="c1">// something-for-nothing</span>
                 <span class="kt">bool</span> <span class="n">before_core_hardfork_342</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_342_TIME</span> <span class="p">);</span> <span class="c1">// better rounding</span>
                 <span class="kt">bool</span> <span class="n">before_core_hardfork_606</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maint_time</span> <span class="o">&lt;=</span> <span class="n">HARDFORK_CORE_606_TIME</span> <span class="p">);</span> <span class="c1">// feed always trigger call</span>

                 <span class="k">auto</span><span class="o">&amp;</span> <span class="n">limit_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">limit_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_expiration</span><span class="o">&gt;</span><span class="p">();</span>
                 <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">limit_index</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">limit_index</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">expiration</span> <span class="o">&lt;=</span> <span class="n">head_time</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="k">const</span> <span class="n">limit_order_object</span><span class="o">&amp;</span> <span class="n">order</span> <span class="o">=</span> <span class="o">*</span><span class="n">limit_index</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
                        <span class="k">auto</span> <span class="n">base_asset</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">sell_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span><span class="p">;</span>
                        <span class="k">auto</span> <span class="n">quote_asset</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">sell_price</span><span class="p">.</span><span class="n">quote</span><span class="p">.</span><span class="n">asset_id</span><span class="p">;</span>
                        <span class="n">cancel_limit_order</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_606</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="c1">// check call orders</span>
                           <span class="c1">// Comments below are copied from limit_order_cancel_evaluator::do_apply(...)</span>
                           <span class="c1">// Possible optimization: order can be called by cancelling a limit order</span>
                           <span class="c1">//   if the canceled order was at the top of the book.</span>
                           <span class="c1">// Do I need to check calls in both assets?</span>
                           <span class="n">check_call_orders</span><span class="p">(</span> <span class="n">base_asset</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">)</span> <span class="p">);</span>
                           <span class="n">check_call_orders</span><span class="p">(</span> <span class="n">quote_asset</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">)</span> <span class="p">);</span>
                        <span class="p">}</span>
                 <span class="p">}</span>

   <span class="c1">//Process expired force settlement orders</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">settlement_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">force_settlement_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_expiration</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">settlement_index</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">asset_id_type</span> <span class="n">current_asset</span> <span class="o">=</span> <span class="n">settlement_index</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">settlement_asset_id</span><span class="p">();</span>
          <span class="n">asset</span> <span class="n">max_settlement_volume</span><span class="p">;</span>
          <span class="n">price</span> <span class="n">settlement_fill_price</span><span class="p">;</span>
          <span class="n">price</span> <span class="n">settlement_price</span><span class="p">;</span>
          <span class="kt">bool</span> <span class="n">current_asset_finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="kt">bool</span> <span class="n">extra_dump</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

          <span class="k">auto</span> <span class="n">next_asset</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">current_asset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_asset_finished</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settlement_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extra_dump</span><span class="p">]</span> <span class="p">{</span>
                 <span class="k">auto</span> <span class="n">bound</span> <span class="o">=</span> <span class="n">settlement_index</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">current_asset</span><span class="p">);</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">bound</span> <span class="o">==</span> <span class="n">settlement_index</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">extra_dump</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;next_asset() returning false&quot;</span> <span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">extra_dump</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;next_asset returning true, bound is ${b}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">bound</span><span class="p">)</span> <span class="p">);</span>
                 <span class="p">}</span>
                 <span class="n">current_asset</span> <span class="o">=</span> <span class="n">bound</span><span class="o">-&gt;</span><span class="n">settlement_asset_id</span><span class="p">();</span>
                 <span class="n">current_asset_finished</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                 <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="kt">uint32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

          <span class="c1">// At each iteration, we either consume the current order and remove it, or we move to the next asset</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">settlement_index</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">current_asset</span><span class="p">);</span>
                   <span class="n">itr</span> <span class="o">!=</span> <span class="n">settlement_index</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
                   <span class="n">itr</span> <span class="o">=</span> <span class="n">settlement_index</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">current_asset</span><span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="o">++</span><span class="n">count</span><span class="p">;</span>
                 <span class="k">const</span> <span class="n">force_settlement_object</span><span class="o">&amp;</span> <span class="n">order</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
                 <span class="k">auto</span> <span class="n">order_id</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                 <span class="n">current_asset</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">settlement_asset_id</span><span class="p">();</span>
                 <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">mia_object</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">current_asset</span><span class="p">);</span>
                 <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">mia</span> <span class="o">=</span> <span class="n">mia_object</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>

                 <span class="n">extra_dump</span> <span class="o">=</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">1020</span><span class="p">));</span>

                 <span class="k">if</span><span class="p">(</span> <span class="n">extra_dump</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;clear_expired_orders() dumping extra data for iteration ${c}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="p">);</span>
                        <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;head_block_num is ${hb} current_asset is ${a}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;hb&quot;</span><span class="p">,</span> <span class="n">head_block_num</span><span class="p">())(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">current_asset</span><span class="p">)</span> <span class="p">);</span>
                 <span class="p">}</span>

                 <span class="k">if</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">has_settlement</span><span class="p">()</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;Canceling a force settlement because of black swan&quot;</span> <span class="p">);</span>
                        <span class="n">cancel_settle_order</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="p">}</span>

                 <span class="c1">// Has this order not reached its settlement date?</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">settlement_date</span> <span class="o">&gt;</span> <span class="n">head_time</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">next_asset</span><span class="p">()</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="k">if</span><span class="p">(</span> <span class="n">extra_dump</span> <span class="p">)</span>
                           <span class="p">{</span>
                                  <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;next_asset() returned true when order.settlement_date &gt; head_block_time()&quot;</span> <span class="p">);</span>
                           <span class="p">}</span>
                           <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="c1">// Can we still settle in this asset?</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">ilog</span><span class="p">(</span><span class="s">&quot;Canceling a force settlement in ${asset} because settlement price is null&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s">&quot;asset&quot;</span><span class="p">,</span> <span class="n">mia_object</span><span class="p">.</span><span class="n">symbol</span><span class="p">));</span>
                        <span class="n">cancel_settle_order</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">max_settlement_volume</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">current_asset</span> <span class="p">)</span>
                        <span class="n">max_settlement_volume</span> <span class="o">=</span> <span class="n">mia_object</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="n">mia</span><span class="p">.</span><span class="n">max_force_settlement_volume</span><span class="p">(</span><span class="n">mia_object</span><span class="p">.</span><span class="n">dynamic_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">current_supply</span><span class="p">));</span>
                 <span class="c1">// When current_asset_finished is true, this would be the 2nd time processing the same order.</span>
                 <span class="c1">// In this case, we move to the next asset.</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">force_settled_volume</span> <span class="o">&gt;=</span> <span class="n">max_settlement_volume</span><span class="p">.</span><span class="n">amount</span> <span class="o">||</span> <span class="n">current_asset_finished</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="cm">/*</span>
<span class="cm">                        ilog(&quot;Skipping force settlement in ${asset}; settled ${settled_volume} / ${max_volume}&quot;,</span>
<span class="cm">                                 (&quot;asset&quot;, mia_object.symbol)(&quot;settlement_price_null&quot;,mia.current_feed.settlement_price.is_null())</span>
<span class="cm">                                 (&quot;settled_volume&quot;, mia.force_settled_volume)(&quot;max_volume&quot;, max_settlement_volume));</span>
<span class="cm">                                 */</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">next_asset</span><span class="p">()</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="k">if</span><span class="p">(</span> <span class="n">extra_dump</span> <span class="p">)</span>
                           <span class="p">{</span>
                                  <span class="n">ilog</span><span class="p">(</span> <span class="s">&quot;next_asset() returned true when mia.force_settled_volume &gt;= max_settlement_volume.amount&quot;</span> <span class="p">);</span>
                           <span class="p">}</span>
                           <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                 <span class="p">}</span>

                 <span class="k">if</span><span class="p">(</span> <span class="n">settlement_fill_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">current_asset</span> <span class="p">)</span> <span class="c1">// only calculate once per asset</span>
                        <span class="n">settlement_fill_price</span> <span class="o">=</span> <span class="n">mia</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span>
                                                                        <span class="o">/</span> <span class="n">ratio_type</span><span class="p">(</span> <span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">mia</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">force_settlement_offset_percent</span><span class="p">,</span>
                                                                                                  <span class="n">GRAPHENE_100_PERCENT</span> <span class="p">);</span>

                 <span class="k">if</span><span class="p">(</span> <span class="n">before_core_hardfork_342</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="k">auto</span><span class="o">&amp;</span> <span class="n">pays</span> <span class="o">=</span> <span class="n">order</span><span class="p">.</span><span class="n">balance</span><span class="p">;</span>
                        <span class="k">auto</span> <span class="n">receives</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">balance</span> <span class="o">*</span> <span class="n">mia</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">);</span>
                        <span class="n">receives</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fc</span><span class="o">::</span><span class="n">uint128_t</span><span class="p">(</span><span class="n">receives</span><span class="p">.</span><span class="n">amount</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                                                                <span class="p">(</span><span class="n">GRAPHENE_100_PERCENT</span> <span class="o">-</span> <span class="n">mia</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">force_settlement_offset_percent</span><span class="p">)</span> <span class="o">/</span>
                                                                <span class="n">GRAPHENE_100_PERCENT</span> <span class="p">).</span><span class="n">to_uint64</span><span class="p">();</span>
                        <span class="n">assert</span><span class="p">(</span><span class="n">receives</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">.</span><span class="n">balance</span> <span class="o">*</span> <span class="n">mia</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">);</span>
                        <span class="n">settlement_price</span> <span class="o">=</span> <span class="n">pays</span> <span class="o">/</span> <span class="n">receives</span><span class="p">;</span>
                 <span class="p">}</span>
                 <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">settlement_price</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">asset_id</span> <span class="o">!=</span> <span class="n">current_asset</span> <span class="p">)</span> <span class="c1">// only calculate once per asset</span>
                        <span class="n">settlement_price</span> <span class="o">=</span> <span class="n">settlement_fill_price</span><span class="p">;</span>

                 <span class="k">auto</span><span class="o">&amp;</span> <span class="n">call_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">call_order_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_collateral</span><span class="o">&gt;</span><span class="p">();</span>
                 <span class="n">asset</span> <span class="n">settled</span> <span class="o">=</span> <span class="n">mia_object</span><span class="p">.</span><span class="n">amount</span><span class="p">(</span><span class="n">mia</span><span class="p">.</span><span class="n">force_settled_volume</span><span class="p">);</span>
                 <span class="c1">// Match against the least collateralized short until the settlement is finished or we reach max settlements</span>
                 <span class="k">while</span><span class="p">(</span> <span class="n">settled</span> <span class="o">&lt;</span> <span class="n">max_settlement_volume</span> <span class="o">&amp;&amp;</span> <span class="n">find_object</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">call_index</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">price</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">mia_object</span><span class="p">.</span><span class="n">bitasset_data</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">options</span><span class="p">.</span><span class="n">short_backing_asset</span><span class="p">,</span>
                                                                                                                                                   <span class="n">mia_object</span><span class="p">.</span><span class="n">get_id</span><span class="p">())));</span>
                        <span class="c1">// There should always be a call order, since asset exists!</span>
                        <span class="n">assert</span><span class="p">(</span><span class="n">itr</span> <span class="o">!=</span> <span class="n">call_index</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">debt_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">mia_object</span><span class="p">.</span><span class="n">get_id</span><span class="p">());</span>
                        <span class="n">asset</span> <span class="n">max_settlement</span> <span class="o">=</span> <span class="n">max_settlement_volume</span> <span class="o">-</span> <span class="n">settled</span><span class="p">;</span>

                        <span class="k">if</span><span class="p">(</span> <span class="n">order</span><span class="p">.</span><span class="n">balance</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;0 settlement detected&quot;</span> <span class="p">);</span>
                           <span class="n">cancel_settle_order</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>
                           <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">try</span> <span class="p">{</span>
                           <span class="n">asset</span> <span class="n">new_settled</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="o">*</span><span class="n">itr</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">settlement_price</span><span class="p">,</span> <span class="n">max_settlement</span><span class="p">,</span> <span class="n">settlement_fill_price</span><span class="p">);</span>
                           <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">before_core_hardfork_184</span> <span class="o">&amp;&amp;</span> <span class="n">new_settled</span><span class="p">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="c1">// unable to fill this settle order</span>
                           <span class="p">{</span>
                                  <span class="k">if</span><span class="p">(</span> <span class="n">find_object</span><span class="p">(</span> <span class="n">order_id</span> <span class="p">)</span> <span class="p">)</span> <span class="c1">// the settle order hasn&#39;t been cancelled</span>
                                         <span class="n">current_asset_finished</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                                  <span class="k">break</span><span class="p">;</span>
                           <span class="p">}</span>
                           <span class="n">settled</span> <span class="o">+=</span> <span class="n">new_settled</span><span class="p">;</span>
                           <span class="c1">// before hard fork core-342, `new_settled &gt; 0` is always true, we&#39;ll have:</span>
                           <span class="c1">// * call order is completely filled (thus itr will change in next loop), or</span>
                           <span class="c1">// * settle order is completely filled (thus find_object(order_id) will be false so will break out), or</span>
                           <span class="c1">// * reached max_settlement_volume limit (thus new_settled == max_settlement so will break out).</span>
                           <span class="c1">//</span>
                           <span class="c1">// after hard fork core-342, if new_settled &gt; 0, we&#39;ll have:</span>
                           <span class="c1">// * call order is completely filled (thus itr will change in next loop), or</span>
                           <span class="c1">// * settle order is completely filled (thus find_object(order_id) will be false so will break out), or</span>
                           <span class="c1">// * reached max_settlement_volume limit, but it&#39;s possible that new_settled &lt; max_settlement,</span>
                           <span class="c1">//   in this case, new_settled will be zero in next iteration of the loop, so no need to check here.</span>
                        <span class="p">}</span>
                        <span class="k">catch</span> <span class="p">(</span> <span class="k">const</span> <span class="n">black_swan_exception</span><span class="o">&amp;</span> <span class="n">e</span> <span class="p">)</span> <span class="p">{</span>
                           <span class="n">wlog</span><span class="p">(</span> <span class="s">&quot;Cancelling a settle_order since it may trigger a black swan: ${o}, ${e}&quot;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s">&quot;o&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">to_detail_string</span><span class="p">())</span> <span class="p">);</span>
                           <span class="n">cancel_settle_order</span><span class="p">(</span> <span class="n">order</span> <span class="p">);</span>
                           <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                 <span class="p">}</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">mia</span><span class="p">.</span><span class="n">force_settled_volume</span> <span class="o">!=</span> <span class="n">settled</span><span class="p">.</span><span class="n">amount</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">modify</span><span class="p">(</span><span class="n">mia</span><span class="p">,</span> <span class="p">[</span><span class="n">settled</span><span class="p">](</span><span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
                           <span class="n">b</span><span class="p">.</span><span class="n">force_settled_volume</span> <span class="o">=</span> <span class="n">settled</span><span class="p">.</span><span class="n">amount</span><span class="p">;</span>
                        <span class="p">});</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span> <span class="n">FC_CAPTURE_AND_RETHROW</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-expired-feeds">
<h3><a class="toc-backref" href="#id113">update_expired_feeds</a><a class="headerlink" href="#update-expired-feeds" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_expired_feeds</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">head_time</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">();</span>
   <span class="kt">bool</span> <span class="n">after_hardfork_615</span> <span class="o">=</span> <span class="p">(</span> <span class="n">head_time</span> <span class="o">&gt;=</span> <span class="n">HARDFORK_615_TIME</span> <span class="p">);</span>

   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_bitasset_data_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_feed_expiration</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">itr</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">feed_is_expired</span><span class="p">(</span> <span class="n">head_time</span> <span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
          <span class="o">++</span><span class="n">itr</span><span class="p">;</span> <span class="c1">// not always process begin() because old code skipped updating some assets before hf 615</span>
          <span class="kt">bool</span> <span class="n">update_cer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// for better performance, to only update bitasset once, also check CER in this function</span>
          <span class="k">const</span> <span class="n">asset_object</span><span class="o">*</span> <span class="n">asset_ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
          <span class="c1">// update feeds, check margin calls</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">after_hardfork_615</span> <span class="o">||</span> <span class="n">b</span><span class="p">.</span><span class="n">feed_is_expired_before_hardfork_615</span><span class="p">(</span> <span class="n">head_time</span> <span class="p">)</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">auto</span> <span class="n">old_median_feed</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">current_feed</span><span class="p">;</span>
                 <span class="n">modify</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">head_time</span><span class="p">,</span><span class="o">&amp;</span><span class="n">update_cer</span><span class="p">](</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">abdo</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">abdo</span><span class="p">.</span><span class="n">update_median_feeds</span><span class="p">(</span> <span class="n">head_time</span> <span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span> <span class="n">abdo</span><span class="p">.</span><span class="n">need_to_update_cer</span><span class="p">()</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">update_cer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                           <span class="n">abdo</span><span class="p">.</span><span class="n">asset_cer_updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                           <span class="n">abdo</span><span class="p">.</span><span class="n">feed_cer_updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                        <span class="p">}</span>
                 <span class="p">});</span>
                 <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">b</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">settlement_price</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span> <span class="n">b</span><span class="p">.</span><span class="n">current_feed</span> <span class="o">==</span> <span class="n">old_median_feed</span> <span class="p">)</span> <span class="p">)</span> <span class="c1">// `==` check is safe here</span>
                 <span class="p">{</span>
                        <span class="n">asset_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
                        <span class="n">check_call_orders</span><span class="p">(</span> <span class="o">*</span><span class="n">asset_ptr</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span> <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">}</span>
          <span class="c1">// update CER</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">update_cer</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">asset_ptr</span> <span class="p">)</span>
                        <span class="n">asset_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">asset_ptr</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">core_exchange_rate</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">modify</span><span class="p">(</span> <span class="o">*</span><span class="n">asset_ptr</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">](</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">ao</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">ao</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">;</span>
                        <span class="p">});</span>
                 <span class="p">}</span>
          <span class="p">}</span>
   <span class="p">}</span> <span class="c1">// for each asset whose feed is expired</span>

   <span class="c1">// process assets affected by bitshares-core issue 453 before hard fork 615</span>
   <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">after_hardfork_615</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span> <span class="n">asset_id_type</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">_issue_453_affected_assets</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">check_call_orders</span><span class="p">(</span> <span class="n">a</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">);</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-core-exchange-rates">
<h3><a class="toc-backref" href="#id114">update_core_exchange_rates</a><a class="headerlink" href="#update-core-exchange-rates" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_core_exchange_rates</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">asset_bitasset_data_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_cer_update</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span> <span class="k">auto</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">rbegin</span><span class="p">();</span> <span class="n">itr</span><span class="o">-&gt;</span><span class="n">need_to_update_cer</span><span class="p">();</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">idx</span><span class="p">.</span><span class="n">rbegin</span><span class="p">()</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="k">const</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
                 <span class="k">const</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">asset_id</span><span class="p">(</span> <span class="o">*</span><span class="k">this</span> <span class="p">);</span>
                 <span class="k">if</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">core_exchange_rate</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">modify</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">b</span><span class="p">](</span> <span class="n">asset_object</span><span class="o">&amp;</span> <span class="n">ao</span> <span class="p">)</span>
                        <span class="p">{</span>
                           <span class="n">ao</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">core_exchange_rate</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">current_feed</span><span class="p">.</span><span class="n">core_exchange_rate</span><span class="p">;</span>
                        <span class="p">});</span>
                 <span class="p">}</span>
                 <span class="n">modify</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="p">[](</span> <span class="n">asset_bitasset_data_object</span><span class="o">&amp;</span> <span class="n">abdo</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="n">abdo</span><span class="p">.</span><span class="n">asset_cer_updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                        <span class="n">abdo</span><span class="p">.</span><span class="n">feed_cer_updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                 <span class="p">});</span>
          <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-maintenance-flag">
<h3><a class="toc-backref" href="#id115">update_maintenance_flag</a><a class="headerlink" href="#update-maintenance-flag" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_maintenance_flag</span><span class="p">(</span> <span class="kt">bool</span> <span class="n">new_maintenance_flag</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="n">modify</span><span class="p">(</span> <span class="n">get_dynamic_global_properties</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="k">auto</span> <span class="n">maintenance_flag</span> <span class="o">=</span> <span class="n">dynamic_global_property_object</span><span class="o">::</span><span class="n">maintenance_flag</span><span class="p">;</span>
          <span class="n">dpo</span><span class="p">.</span><span class="n">dynamic_flags</span> <span class="o">=</span>
                   <span class="p">(</span><span class="n">dpo</span><span class="p">.</span><span class="n">dynamic_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">maintenance_flag</span><span class="p">)</span>
                 <span class="o">|</span> <span class="p">(</span><span class="n">new_maintenance_flag</span> <span class="o">?</span> <span class="nl">maintenance_flag</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
   <span class="p">}</span> <span class="p">);</span>
   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-withdraw-permissions">
<h3><a class="toc-backref" href="#id116">update_withdraw_permissions</a><a class="headerlink" href="#update-withdraw-permissions" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_withdraw_permissions</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">auto</span><span class="o">&amp;</span> <span class="n">permit_index</span> <span class="o">=</span> <span class="n">get_index_type</span><span class="o">&lt;</span><span class="n">withdraw_permission_index</span><span class="o">&gt;</span><span class="p">().</span><span class="n">indices</span><span class="p">().</span><span class="n">get</span><span class="o">&lt;</span><span class="n">by_expiration</span><span class="o">&gt;</span><span class="p">();</span>
   <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">permit_index</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">permit_index</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">expiration</span> <span class="o">&lt;=</span> <span class="n">head_block_time</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">remove</span><span class="p">(</span><span class="o">*</span><span class="n">permit_index</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="db-witness-schedule-cpp">
<h2><a class="toc-backref" href="#id117">db_witness_schedule.cpp</a><a class="headerlink" href="#db-witness-schedule-cpp" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">boost</span><span class="o">::</span><span class="n">container</span><span class="o">::</span><span class="n">flat_set</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="get-scheduled-witness">
<h3><a class="toc-backref" href="#id118">get_scheduled_witness</a><a class="headerlink" href="#get-scheduled-witness" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">witness_id_type</span> <span class="n">database</span><span class="o">::</span><span class="n">get_scheduled_witness</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">slot_num</span> <span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">witness_schedule_object</span><span class="o">&amp;</span> <span class="n">wso</span> <span class="o">=</span> <span class="n">get_witness_schedule_object</span><span class="p">();</span>
   <span class="kt">uint64_t</span> <span class="n">current_aslot</span> <span class="o">=</span> <span class="n">dpo</span><span class="p">.</span><span class="n">current_aslot</span> <span class="o">+</span> <span class="n">slot_num</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">[</span> <span class="n">current_aslot</span> <span class="o">%</span> <span class="n">wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-slot-time">
<h3><a class="toc-backref" href="#id119">get_slot_time</a><a class="headerlink" href="#get-slot-time" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">database</span><span class="o">::</span><span class="n">get_slot_time</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">slot_num</span><span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">slot_num</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
          <span class="k">return</span> <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span><span class="p">();</span>

   <span class="k">auto</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">block_interval</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="c1">// n.b. first block is at genesis_time plus one block interval</span>
          <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">genesis_time</span> <span class="o">=</span> <span class="n">dpo</span><span class="p">.</span><span class="n">time</span><span class="p">;</span>
          <span class="k">return</span> <span class="n">genesis_time</span> <span class="o">+</span> <span class="n">slot_num</span> <span class="o">*</span> <span class="n">interval</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kt">int64_t</span> <span class="n">head_block_abs_slot</span> <span class="o">=</span> <span class="n">head_block_time</span><span class="p">().</span><span class="n">sec_since_epoch</span><span class="p">()</span> <span class="o">/</span> <span class="n">interval</span><span class="p">;</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">head_slot_time</span><span class="p">(</span><span class="n">head_block_abs_slot</span> <span class="o">*</span> <span class="n">interval</span><span class="p">);</span>

   <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">dpo</span><span class="p">.</span><span class="n">dynamic_flags</span> <span class="o">&amp;</span> <span class="n">dynamic_global_property_object</span><span class="o">::</span><span class="n">maintenance_flag</span> <span class="p">)</span>
          <span class="n">slot_num</span> <span class="o">+=</span> <span class="n">gpo</span><span class="p">.</span><span class="n">parameters</span><span class="p">.</span><span class="n">maintenance_skip_slots</span><span class="p">;</span>

   <span class="c1">// &quot;slot 0&quot; is head_slot_time</span>
   <span class="c1">// &quot;slot 1&quot; is head_slot_time,</span>
   <span class="c1">//   plus maint interval if head block is a maint block</span>
   <span class="c1">//   plus block interval if head block is not a maint block</span>
   <span class="k">return</span> <span class="n">head_slot_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot_num</span> <span class="o">*</span> <span class="n">interval</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-slot-at-time">
<h3><a class="toc-backref" href="#id120">get_slot_at_time</a><a class="headerlink" href="#get-slot-at-time" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span> <span class="n">database</span><span class="o">::</span><span class="n">get_slot_at_time</span><span class="p">(</span><span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">when</span><span class="p">)</span><span class="k">const</span>
<span class="p">{</span>
   <span class="n">fc</span><span class="o">::</span><span class="n">time_point_sec</span> <span class="n">first_slot_time</span> <span class="o">=</span> <span class="n">get_slot_time</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">when</span> <span class="o">&lt;</span> <span class="n">first_slot_time</span> <span class="p">)</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">when</span> <span class="o">-</span> <span class="n">first_slot_time</span><span class="p">).</span><span class="n">to_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="n">block_interval</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-witness-missed-blocks">
<h3><a class="toc-backref" href="#id121">update_witness_missed_blocks</a><a class="headerlink" href="#update-witness-missed-blocks" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span> <span class="n">database</span><span class="o">::</span><span class="n">update_witness_missed_blocks</span><span class="p">(</span> <span class="k">const</span> <span class="n">signed_block</span><span class="o">&amp;</span> <span class="n">b</span> <span class="p">)</span>
<span class="p">{</span>
   <span class="kt">uint32_t</span> <span class="n">missed_blocks</span> <span class="o">=</span> <span class="n">get_slot_at_time</span><span class="p">(</span> <span class="n">b</span><span class="p">.</span><span class="n">timestamp</span> <span class="p">);</span>
   <span class="n">FC_ASSERT</span><span class="p">(</span> <span class="n">missed_blocks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Trying to push double-produced block onto current block?!&quot;</span> <span class="p">);</span>
   <span class="n">missed_blocks</span><span class="o">--</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">witnesses</span> <span class="o">=</span> <span class="n">witness_schedule_id_type</span><span class="p">()(</span><span class="o">*</span><span class="k">this</span><span class="p">).</span><span class="n">current_shuffled_witnesses</span><span class="p">;</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">missed_blocks</span> <span class="o">&lt;</span> <span class="n">witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span>
          <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">missed_blocks</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
                 <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">witness_missed</span> <span class="o">=</span> <span class="n">get_scheduled_witness</span><span class="p">(</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">)(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
                 <span class="n">modify</span><span class="p">(</span> <span class="n">witness_missed</span><span class="p">,</span> <span class="p">[](</span> <span class="n">witness_object</span><span class="o">&amp;</span> <span class="n">w</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">w</span><span class="p">.</span><span class="n">total_missed</span><span class="o">++</span><span class="p">;</span>
                 <span class="p">});</span>
          <span class="p">}</span>
   <span class="k">return</span> <span class="n">missed_blocks</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="witness-participation-rate">
<h3><a class="toc-backref" href="#id122">witness_participation_rate</a><a class="headerlink" href="#witness-participation-rate" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span> <span class="n">database</span><span class="o">::</span><span class="n">witness_participation_rate</span><span class="p">()</span><span class="k">const</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">dynamic_global_property_object</span><span class="o">&amp;</span> <span class="n">dpo</span> <span class="o">=</span> <span class="n">get_dynamic_global_properties</span><span class="p">();</span>
   <span class="k">return</span> <span class="nf">uint64_t</span><span class="p">(</span><span class="n">GRAPHENE_100_PERCENT</span><span class="p">)</span> <span class="o">*</span> <span class="n">dpo</span><span class="p">.</span><span class="n">recent_slots_filled</span><span class="p">.</span><span class="n">popcount</span><span class="p">()</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="update-witness-schedule">
<h3><a class="toc-backref" href="#id123">update_witness_schedule</a><a class="headerlink" href="#update-witness-schedule" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">database</span><span class="o">::</span><span class="n">update_witness_schedule</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="n">witness_schedule_object</span><span class="o">&amp;</span> <span class="n">wso</span> <span class="o">=</span> <span class="n">get_witness_schedule_object</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">global_property_object</span><span class="o">&amp;</span> <span class="n">gpo</span> <span class="o">=</span> <span class="n">get_global_properties</span><span class="p">();</span>

   <span class="k">if</span><span class="p">(</span> <span class="n">head_block_num</span><span class="p">()</span> <span class="o">%</span> <span class="n">gpo</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
   <span class="p">{</span>
          <span class="n">modify</span><span class="p">(</span> <span class="n">wso</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span> <span class="n">witness_schedule_object</span><span class="o">&amp;</span> <span class="n">_wso</span> <span class="p">)</span>
          <span class="p">{</span>
                 <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
                 <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span> <span class="n">gpo</span><span class="p">.</span><span class="n">active_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>

                 <span class="k">for</span><span class="p">(</span> <span class="k">const</span> <span class="n">witness_id_type</span><span class="o">&amp;</span> <span class="nl">w</span> <span class="p">:</span> <span class="n">gpo</span><span class="p">.</span><span class="n">active_witnesses</span> <span class="p">)</span>
                        <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">w</span> <span class="p">);</span>

                 <span class="k">auto</span> <span class="n">now_hi</span> <span class="o">=</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="n">head_block_time</span><span class="p">().</span><span class="n">sec_since_epoch</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
                 <span class="k">for</span><span class="p">(</span> <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
                 <span class="p">{</span>
                        <span class="c1">/// High performance random generator</span>
                        <span class="c1">/// http://xorshift.di.unimi.it/</span>
                        <span class="kt">uint64_t</span> <span class="n">k</span> <span class="o">=</span> <span class="n">now_hi</span> <span class="o">+</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2685821657736338717ULL</span><span class="p">;</span>
                        <span class="n">k</span> <span class="o">^=</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
                        <span class="n">k</span> <span class="o">^=</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
                        <span class="n">k</span> <span class="o">^=</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">);</span>
                        <span class="n">k</span> <span class="o">*=</span> <span class="mi">2685821657736338717ULL</span><span class="p">;</span>

                        <span class="kt">uint32_t</span> <span class="n">jmax</span> <span class="o">=</span> <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
                        <span class="kt">uint32_t</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">k</span><span class="o">%</span><span class="n">jmax</span><span class="p">;</span>
                        <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span> <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                           <span class="n">_wso</span><span class="p">.</span><span class="n">current_shuffled_witnesses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">);</span>
                 <span class="p">}</span>
          <span class="p">});</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lib_net.html" class="btn btn-neutral float-right" title="Net" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lib_plugins.html" class="btn btn-neutral" title="Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright BitShares Blockchain Foundation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>